# 批量分析改用阿里大模型生成文字报告技术方案

## 📋 需求分析

### 当前状态
- **批量分析**：使用 Dify 工作流生成文字报告
- **单文件分析**：使用 Dify 工作流生成文字报告 + 阿里百炼生成HTML图表

### 目标状态
- **批量分析**：使用 **阿里百炼大模型**生成文字报告 + 阿里百炼生成HTML图表
- 固定prompt模板写在代码中
- 用户输入框的prompt可以编辑后传入大模型

### 用户提供的固定Prompt模板
```
你是一个洞察能力极强的游戏公司的数据分析专家善于结合用户的问题以及用户提供的运营数据，透过数据去给出有价值的分析建议运营方面的建议，分析与统计流失用户的VIP等级与流失等级分布，并给出你的意见，形成完整的运营分析报告
```

## 🎯 技术方案设计

### 1. 架构变更

#### 当前架构（批量分析）
```
拆分后的Excel文件
    ↓
并行执行：
├─ 任务1：阿里百炼API → 生成HTML图表
└─ 任务2：Dify工作流 → 生成文字报告
    ↓
合并结果
```

#### 新架构（批量分析）
```
拆分后的Excel文件
    ↓
并行执行：
├─ 任务1：阿里百炼API → 生成HTML图表
└─ 任务2：阿里百炼API → 生成文字报告（新增）
    ↓
合并结果
```

### 2. 实现方案

#### 2.1 在 BailianService 中添加文字报告生成方法

**位置**：`backend/app/services/bailian_service.py`

**新增方法**：
```python
async def analyze_excel_and_generate_text_report(
    self,
    file_path: str,
    user_prompt: str,
    fixed_prompt_template: str = None
) -> Dict[str, Any]:
    """
    分析Excel并生成文字报告
    
    Args:
        file_path: Excel文件路径
        user_prompt: 用户输入的分析需求prompt
        fixed_prompt_template: 固定的prompt模板（写在代码中）
    
    Returns:
        {
            "success": bool,
            "text_content": str,  # 生成的文字报告内容
            "error": str
        }
    """
```

**Prompt构建逻辑**：
1. 读取Excel数据样本（前100行）
2. 合并固定prompt模板 + 用户prompt + 数据样本
3. 调用DashScope API生成文字报告

#### 2.2 修改批量分析核心逻辑

**位置**：`backend/app/api/v1/operation_batch.py`

**修改点**：
- 将 `generate_text()` 函数从调用Dify改为调用阿里百炼
- 移除Dify相关的配置和调用逻辑
- 使用新的 `BailianService.analyze_excel_and_generate_text_report()` 方法

#### 2.3 固定Prompt模板配置

**位置**：`backend/app/api/v1/operation_batch.py` 或 `backend/app/services/bailian_service.py`

**配置方式**：
- 在代码中定义常量 `FIXED_TEXT_REPORT_PROMPT`
- 每次调用时自动合并固定prompt和用户prompt

## 📝 详细实现步骤

### 阶段1：扩展 BailianService（1-2小时）

#### 1.1 添加文字报告生成方法

```python
# backend/app/services/bailian_service.py

# 固定prompt模板（写在代码中）
FIXED_TEXT_REPORT_PROMPT = """你是一个洞察能力极强的游戏公司的数据分析专家善于结合用户的问题以及用户提供的运营数据，透过数据去给出有价值的分析建议运营方面的建议，分析与统计流失用户的VIP等级与流失等级分布，并给出你的意见，形成完整的运营分析报告"""

async def analyze_excel_and_generate_text_report(
    self,
    file_path: str,
    user_prompt: str,
    fixed_prompt_template: Optional[str] = None
) -> Dict[str, Any]:
    """
    分析Excel并生成文字报告
    
    Args:
        file_path: Excel文件路径
        user_prompt: 用户输入的分析需求prompt
        fixed_prompt_template: 固定的prompt模板（如果为None，使用默认模板）
    
    Returns:
        {
            "success": bool,
            "text_content": str,  # 生成的文字报告内容
            "error": str
        }
    """
    if not self.api_key:
        return {
            "success": False,
            "text_content": None,
            "error": "DASHSCOPE_API_KEY未配置"
        }
    
    try:
        # 1. 读取Excel文件并转换为base64（可选，用于文件上传）
        with open(file_path, "rb") as f:
            file_content = f.read()
            file_base64 = base64.b64encode(file_content).decode('utf-8')
        
        # 2. 读取文件内容作为文本（用于发送给API）
        # 只发送数据样本，避免Token过多
        df = pd.read_excel(file_path)
        data_sample = df.head(100).to_string()  # 只取前100行作为样本
        
        # 3. 构建文字报告生成Prompt
        # 使用固定prompt模板 + 用户prompt + 数据样本
        fixed_template = fixed_prompt_template or FIXED_TEXT_REPORT_PROMPT
        
        prompt = self._build_text_report_prompt(
            data_sample=data_sample,
            fixed_template=fixed_template,
            user_prompt=user_prompt
        )
        
        # 4. 调用阿里百炼API
        response = await self._call_dashscope_api(prompt, file_base64, file_path)
        
        # 5. 提取文字报告内容
        text_content = self._extract_text_from_response(response)
        
        return {
            "success": True,
            "text_content": text_content,
            "error": None
        }
    
    except Exception as e:
        logger.error(f"[BailianService] 生成文字报告失败: {str(e)}")
        return {
            "success": False,
            "text_content": None,
            "error": str(e)
        }

def _build_text_report_prompt(
    self,
    data_sample: str,
    fixed_template: str,
    user_prompt: str
) -> str:
    """
    构建文字报告生成提示词
    
    格式：
    1. 固定prompt模板（角色定义和基础要求）
    2. 数据样本
    3. 用户prompt（具体分析需求）
    """
    prompt = f"""{fixed_template}

**数据样本**：
{data_sample}

**用户分析需求**：
{user_prompt}

请根据以上数据样本和用户的分析需求，生成一份完整的运营分析报告。报告应该包括：
1. 数据概览和关键指标
2. 深度分析和洞察
3. 问题识别和建议
4. 运营优化建议

请以结构化的方式输出报告，使用Markdown格式。"""
    
    return prompt

def _extract_text_from_response(self, response: Dict[str, Any]) -> str:
    """从API响应中提取文字内容（支持DashScope和OpenAI格式）"""
    try:
        if self.use_openai_format:
            # OpenAI兼容接口响应格式：choices[0].message.content
            choices = response.get("choices", [])
            if choices and len(choices) > 0:
                message = choices[0].get("message", {})
                content = message.get("content", "")
            else:
                content = ""
        else:
            # DashScope API响应格式：output.choices[0].message.content
            output = response.get("output", {})
            choices = output.get("choices", [])
            
            if choices and len(choices) > 0:
                message = choices[0].get("message", {})
                content = message.get("content", "") or message.get("text", "")
            else:
                content = output.get("text", "") or response.get("text", "")
        
        if not content:
            logger.error(f"[BailianService] API响应格式异常: {response}")
            raise Exception("API响应中未找到内容")
        
        # 移除可能的markdown代码块标记
        if "```" in content:
            # 尝试提取markdown内容
            parts = content.split("```")
            if len(parts) >= 3:
                # 如果有代码块，尝试提取markdown部分
                for i in range(0, len(parts), 2):
                    if parts[i].strip() and not parts[i].strip().startswith("markdown"):
                        content = parts[i].strip()
                        break
            else:
                content = content.replace("```", "").strip()
        
        logger.info(f"[BailianService] 提取文字报告成功，长度: {len(content)} 字符")
        return content
    
    except Exception as e:
        logger.error(f"[BailianService] 提取文字报告失败: {str(e)}")
        raise Exception(f"无法从API响应中提取文字报告: {str(e)}")
```

### 阶段2：修改批量分析逻辑（1-2小时）

#### 2.1 修改 `process_sheet_analysis` 函数

**位置**：`backend/app/api/v1/operation_batch.py`

**修改内容**：
1. 移除Dify工作流相关的配置和调用
2. 将 `generate_text()` 函数改为调用 `BailianService.analyze_excel_and_generate_text_report()`
3. 移除 `WorkflowService` 和 `DifyService` 的依赖（如果不再需要）

```python
# backend/app/api/v1/operation_batch.py

from app.services.bailian_service import BailianService, FIXED_TEXT_REPORT_PROMPT

async def process_sheet_analysis(
    sheet_report_id: int,
    split_file_path: str,
    sheet_name: str,
    analysis_request: str,  # 用户输入的分析需求
    batch_session_id: int,
    user_id: int,
    db: Session,
    chart_customization_prompt: Optional[str] = None,
    chart_generation_mode: str = "html"
) -> dict:
    """
    处理单个Sheet的分析任务
    使用阿里百炼生成文字报告和HTML图表
    """
    try:
        # ... 前面的代码保持不变 ...
        
        # 4. 并行处理：图表生成（阿里百炼API）和文字生成（阿里百炼API）
        chart_generator = ChartGenerator()
        bailian_service = BailianService()
        report_merger = ReportMerger()
        
        # 任务1：生成图表（阿里百炼API + HTML）
        async def generate_charts():
            # ... 保持不变 ...
        
        # 任务2：生成文字（阿里百炼API - 修改点）
        async def generate_text():
            logger.info(f"[批量分析] 调用阿里百炼API生成文字报告 - file_path={file_path_obj}")
            
            text_result = await bailian_service.analyze_excel_and_generate_text_report(
                file_path=str(file_path_obj),
                user_prompt=analysis_request,  # 用户输入的分析需求
                fixed_prompt_template=FIXED_TEXT_REPORT_PROMPT  # 固定prompt模板
            )
            
            if not text_result.get("success"):
                error_msg = text_result.get("error", "文字报告生成失败")
                logger.error(f"[批量分析] 文字报告生成失败 - {error_msg}")
                return f"文字生成失败：{error_msg}"
            
            text_content = text_result.get("text_content", "")
            
            if not isinstance(text_content, str):
                logger.error(f"[批量分析] text_content 不是字符串，类型: {type(text_content)}")
                return str(text_content) if text_content else "报告生成失败"
            
            logger.info(f"[批量分析] 文字报告生成成功 - 长度: {len(text_content)}")
            return text_content
        
        # 并行执行
        charts_task = generate_charts()
        text_task = generate_text()
        
        charts_result, report_text = await asyncio.gather(
            charts_task,
            text_task,
            return_exceptions=True
        )
        
        # ... 后续合并逻辑保持不变 ...
        
    except Exception as e:
        # ... 错误处理 ...
```

#### 2.2 移除Dify相关依赖（可选）

如果批量分析完全不再使用Dify，可以：
- 移除 `WorkflowService` 和 `DifyService` 的导入
- 移除工作流配置相关的代码
- 简化函数参数

**注意**：如果单文件分析仍使用Dify，则保留这些服务，只在批量分析中不使用。

### 阶段3：测试验证（1小时）

#### 3.1 功能测试
1. ✅ 测试固定prompt模板是否正确合并
2. ✅ 测试用户prompt是否正确传入
3. ✅ 测试文字报告生成是否成功
4. ✅ 测试HTML图表和文字报告是否都能正常生成
5. ✅ 测试多个Sheet并发处理是否正常

#### 3.2 边界情况测试
1. ✅ 用户prompt为空的情况
2. ✅ 用户prompt很长的情況
3. ✅ API调用失败的情况
4. ✅ Excel文件格式错误的情况

## 🔧 代码修改清单

### 必须修改的文件

1. **`backend/app/services/bailian_service.py`**
   - ✅ 添加 `FIXED_TEXT_REPORT_PROMPT` 常量
   - ✅ 添加 `analyze_excel_and_generate_text_report()` 方法
   - ✅ 添加 `_build_text_report_prompt()` 方法
   - ✅ 添加 `_extract_text_from_response()` 方法

2. **`backend/app/api/v1/operation_batch.py`**
   - ✅ 导入 `BailianService` 和 `FIXED_TEXT_REPORT_PROMPT`
   - ✅ 修改 `generate_text()` 函数，改为调用阿里百炼
   - ✅ 移除Dify相关的配置和调用（可选）

### 可选修改的文件

3. **`backend/app/api/v1/operation.py`**（如果批量分析API需要更新）
   - ⚠️ 检查 `start_batch_analysis` API是否需要调整参数

## 📊 数据流对比

### 修改前（批量分析）
```
用户上传Excel → 拆分Sheet
    ↓
每个Sheet并行处理：
├─ 阿里百炼API → HTML图表
└─ Dify工作流 → 文字报告（需要配置Dify）
    ↓
合并结果
```

### 修改后（批量分析）
```
用户上传Excel → 拆分Sheet
    ↓
每个Sheet并行处理：
├─ 阿里百炼API → HTML图表
└─ 阿里百炼API → 文字报告（统一使用阿里百炼）
    ↓
合并结果
```

## 🎨 Prompt构建示例

### 固定Prompt模板（代码中）
```
你是一个洞察能力极强的游戏公司的数据分析专家善于结合用户的问题以及用户提供的运营数据，透过数据去给出有价值的分析建议运营方面的建议，分析与统计流失用户的VIP等级与流失等级分布，并给出你的意见，形成完整的运营分析报告
```

### 用户输入Prompt（前端输入框）
```
分析新用户留存率趋势，重点关注7日留存和30日留存的变化
```

### 最终发送给大模型的完整Prompt
```
你是一个洞察能力极强的游戏公司的数据分析专家善于结合用户的问题以及用户提供的运营数据，透过数据去给出有价值的分析建议运营方面的建议，分析与统计流失用户的VIP等级与流失等级分布，并给出你的意见，形成完整的运营分析报告

**数据样本**：
[Excel数据前100行的文本格式]

**用户分析需求**：
分析新用户留存率趋势，重点关注7日留存和30日留存的变化

请根据以上数据样本和用户的分析需求，生成一份完整的运营分析报告。报告应该包括：
1. 数据概览和关键指标
2. 深度分析和洞察
3. 问题识别和建议
4. 运营优化建议

请以结构化的方式输出报告，使用Markdown格式。
```

## ⚠️ 注意事项

### 1. 固定Prompt模板的维护
- 固定prompt模板写在代码中，修改需要重新部署
- 建议将固定prompt模板提取为配置文件或环境变量，便于后续调整

### 2. Token限制
- 阿里百炼API有Token限制，数据样本只取前100行
- 如果用户prompt很长，可能需要截断或优化

### 3. 错误处理
- 如果文字报告生成失败，应该有降级方案（如返回错误提示）
- 确保HTML图表生成失败不影响文字报告生成

### 4. 性能考虑
- 批量分析中每个Sheet都会调用两次阿里百炼API（图表+文字）
- 需要控制并发数，避免API限流

### 5. 向后兼容
- 单文件分析仍使用Dify，不受影响
- 批量分析的API接口保持不变，只是内部实现改变

## ✅ 优势总结

1. **统一技术栈**：批量分析完全使用阿里百炼，减少依赖
2. **降低成本**：不需要配置和维护Dify工作流
3. **灵活性高**：固定prompt模板可以随时调整
4. **用户体验**：用户可以通过输入框自定义分析需求

## 🚧 后续优化建议

1. **Prompt模板配置化**：将固定prompt模板移到配置文件或数据库
2. **Prompt版本管理**：支持多个版本的prompt模板，可以切换
3. **Prompt优化**：根据实际使用效果优化固定prompt模板
4. **缓存机制**：对于相同的数据和分析需求，可以缓存结果

---

**文档版本**：v1.0  
**创建日期**：2025-01-10  
**状态**：待实现

