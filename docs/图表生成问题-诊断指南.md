# 图表生成问题 - 诊断指南

## 问题现象

新生成的报告没有HTML图表，按钮显示为灰色禁用状态。

## 可能的原因

### 1. 数据没有传递给大模型

**检查点**：
- 前端是否正确发送了 Excel 文件
- 后端是否正确读取了文件
- 文件路径是否正确

**诊断方法**：
```bash
# 查看后端日志中的文件读取信息
docker logs operation-analysis-v2-backend --tail 200 | grep "找到文件"
```

### 2. 大模型API调用失败

**检查点**：
- API Key 是否配置正确
- 网络连接是否正常
- API 是否返回错误

**诊断方法**：
```bash
# 查看API调用日志
docker logs operation-analysis-v2-backend --tail 200 | grep "BailianService"
```

**常见错误**：
- `DASHSCOPE_API_KEY未配置` - 需要在 `.env` 文件中配置
- `API调用失败: HTTP 401` - API Key 无效
- `API调用失败: HTTP 429` - 请求频率超限
- `连接超时` - 网络问题或代理配置问题

### 3. 大模型返回了内容但没有HTML代码

**检查点**：
- 大模型是否理解了生成HTML的要求
- 返回的内容格式是否正确
- HTML提取逻辑是否正确

**诊断方法**：
```bash
# 查看HTML提取日志
docker logs operation-analysis-v2-backend --tail 200 | grep "提取HTML"
```

### 4. Prompt 设计问题

**检查点**：
- Prompt 是否明确要求生成HTML
- Prompt 是否提供了足够的数据样本
- Prompt 是否有格式要求

**当前Prompt结构**：
```python
# 基础格式要求
base_instruction = """你是一个前端开发专家。请根据用户提供的Excel数据样本和用户的定制要求，生成一个完整的、可运行的HTML网页。

**格式要求**（必须遵守）：
1. 必须返回完整的HTML5文档（<!DOCTYPE html>开头）
2. 包含<head>和<body>标签
...
"""

# 用户自定义prompt（如果有）
if chart_customization:
    user_prompt = f"**用户的定制要求**：{chart_customization}"
else:
    user_prompt = "请根据数据样本和分析需求，生成一个包含数据可视化的HTML网页。"
```

## 诊断步骤

### 步骤1：检查环境配置

1. 检查 `.env` 文件中的配置：
```bash
cat .env | grep DASHSCOPE
```

应该看到：
```
DASHSCOPE_API_KEY=sk-xxxxx
DASHSCOPE_MODEL=qwen-plus
DASHSCOPE_API_BASE=https://dashscope.aliyuncs.com
```

2. 检查后端是否正确加载了配置：
```bash
docker logs operation-analysis-v2-backend --tail 50 | grep "BailianService.*初始化"
```

应该看到类似：
```
[BailianService] 初始化完成 - model=qwen-plus, api_url=https://..., use_openai_format=False
```

### 步骤2：生成测试报告

1. 在前端上传一个Excel文件
2. 填写分析需求（例如："分析数据趋势"）
3. **不填写**图表定制需求（测试默认行为）
4. 点击"生成报告"

### 步骤3：查看后端日志

生成报告后，立即查看日志：

```bash
# 查看完整的生成流程
docker logs operation-analysis-v2-backend --tail 300 | grep -A 5 -B 5 "生成报告\|HTML图表\|BailianService"
```

**关键日志点**：

1. **文件读取**：
```
[运营数据分析] 找到文件 - file_path=uploads/operation/project_1/xxx.xlsx
```

2. **文字报告生成**：
```
[运营数据分析] 调用阿里百炼API生成文字报告...
[运营数据分析] 文字报告生成成功 - 长度: xxxx
```

3. **HTML图表生成**：
```
[运营数据分析] 调用阿里百炼API生成默认HTML图表...
[BailianService] 调用API - model=qwen-plus, format=DashScope, prompt_length=xxxx
[BailianService] 流式响应完成，总长度: xxxx 字符
[BailianService] 提取HTML成功，长度: xxxx 字符
[运营数据分析] 默认HTML图表生成成功 - 长度: xxxx
```

4. **失败情况**：
```
[运营数据分析] HTML图表生成失败: xxxxx
```

### 步骤4：分析日志结果

#### 情况A：没有调用HTML生成API

**日志特征**：
- 只看到"文字报告生成成功"
- 没有"调用阿里百炼API生成HTML图表"

**原因**：
- 代码逻辑问题，没有进入HTML生成分支

**解决方法**：
检查 `backend/app/api/v1/operation.py` 中的 `generate_report` 方法

#### 情况B：API调用失败

**日志特征**：
```
[BailianService] API调用异常: ...
[运营数据分析] HTML图表生成失败: API调用失败
```

**原因**：
- API Key 无效
- 网络连接问题
- API 服务异常

**解决方法**：
1. 验证 API Key：
```bash
curl -X POST https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"qwen-plus","input":{"messages":[{"role":"user","content":"你好"}]}}'
```

2. 检查网络：
```bash
docker exec operation-analysis-v2-backend ping -c 3 dashscope.aliyuncs.com
```

#### 情况C：API返回了内容但提取失败

**日志特征**：
```
[BailianService] 流式响应完成，总长度: xxxx 字符
[BailianService] 提取HTML失败: ...
```

**原因**：
- 大模型返回的不是HTML格式
- HTML被markdown代码块包裹，但提取逻辑有问题
- 大模型返回了错误或说明文字

**解决方法**：
查看完整的API响应内容（需要临时添加日志）

#### 情况D：HTML生成成功但长度为0

**日志特征**：
```
[运营数据分析] 默认HTML图表生成成功 - 长度: 0
```

**原因**：
- 大模型返回了空内容
- Prompt 设计有问题，大模型不理解要求

**解决方法**：
优化 Prompt，添加更明确的示例

## 快速修复方案

### 方案1：添加详细日志

在 `backend/app/services/bailian_service.py` 的 `_extract_html_from_response` 方法中添加：

```python
logger.debug(f"[BailianService] API原始响应: {json.dumps(response, ensure_ascii=False)[:1000]}")
logger.debug(f"[BailianService] 提取的content: {content[:500]}")
```

### 方案2：测试API连接

创建测试脚本 `backend/test_bailian_html.py`：

```python
import asyncio
from app.services.bailian_service import BailianService

async def test():
    service = BailianService()
    result = await service.analyze_excel_and_generate_html(
        file_path="backend/test_data.xlsx",
        analysis_request="分析数据趋势",
        chart_customization=None
    )
    print(f"Success: {result['success']}")
    print(f"HTML Length: {len(result.get('html_content', ''))}")
    if not result['success']:
        print(f"Error: {result['error']}")

asyncio.run(test())
```

运行：
```bash
docker exec operation-analysis-v2-backend python test_bailian_html.py
```

### 方案3：使用固定HTML模板（临时方案）

如果大模型一直无法生成HTML，可以使用固定模板：

在 `backend/app/api/v1/operation.py` 中：

```python
# 如果HTML生成失败，使用默认模板
if not html_charts or len(html_charts) == 0:
    html_charts = generate_default_html_chart(df)  # 基于pandas数据生成简单图表
```

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. 完整的后端日志（最近200行）
2. `.env` 文件配置（隐藏API Key）
3. 使用的Excel文件样本
4. 前端控制台日志

将这些信息发送给技术支持团队。
