# 功能管理功能使用说明

## 一、功能概述

超级管理员功能扩展已完成，现在可以通过管理界面统一管理三个数据分析功能的API配置。

## 二、已实现的功能

### 1. 侧边栏导航
- **用户管理**：管理用户账号（已有功能）
- **功能管理**：管理三个数据分析功能的API配置（新增）

### 2. 功能管理页面
- 显示三个功能模块的列表
- 支持搜索和筛选
- 为每个功能配置AI工作流API
- 测试API连接
- 启用/禁用功能

### 3. 三个功能模块
1. **单文件数据分析** (`operation_data_analysis`)
2. **批量数据分析** (`operation_batch_analysis`)
3. **黄伟斌定制款数据分析工具** (`custom_operation_data_analysis`)

## 三、数据库初始化

### 方法一：使用数据库迁移（推荐）

在Docker容器内运行迁移：

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行迁移
alembic upgrade head
```

### 方法二：使用初始化脚本

如果迁移遇到问题，可以直接运行初始化脚本：

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行初始化脚本
python scripts/init_function_modules.py
```

### 方法三：手动SQL（如果上述方法都不可用）

连接到PostgreSQL数据库，执行以下SQL：

```sql
-- 创建表
CREATE TABLE function_modules (
    id SERIAL PRIMARY KEY,
    function_key VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    route_path VARCHAR(200),
    icon VARCHAR(50),
    category VARCHAR(50) DEFAULT 'operation',
    is_enabled BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_function_modules_function_key ON function_modules(function_key);
CREATE INDEX idx_function_modules_id ON function_modules(id);
CREATE INDEX idx_function_modules_is_enabled ON function_modules(is_enabled);

-- 插入初始数据
INSERT INTO function_modules (function_key, name, description, route_path, icon, category, is_enabled, sort_order, created_at, updated_at)
VALUES
('operation_data_analysis', '单文件数据分析', '上传单个Excel文件，快速生成数据分析报告', '/operation', 'Document', 'operation', true, 1, NOW(), NOW()),
('operation_batch_analysis', '批量数据分析', '上传包含多个Sheet的Excel文件，批量生成分析报告', '/operation/batch', 'Files', 'operation', true, 2, NOW(), NOW()),
('custom_operation_data_analysis', '黄伟斌定制款数据分析工具', '定制化批量分析，支持根据Sheet索引自动选择工作流', '/operation/custom-batch', 'Setting', 'operation', true, 3, NOW(), NOW());
```

## 四、使用步骤

### 1. 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 或使用开发模式
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

### 2. 登录系统

使用超级管理员账号登录：
- 用户名：`admin`
- 密码：`admin123456`

### 3. 访问功能管理

登录后，系统会自动跳转到管理员界面。点击左侧边栏的"功能管理"菜单。

### 4. 配置API

1. 在功能管理页面，找到需要配置的功能
2. 点击"配置API"按钮
3. 在弹出的对话框中：
   - 选择AI平台（Dify/Langchain/Ragflow）
   - 填写工作流名称和描述
   - 填写API配置信息（根据平台不同，配置项不同）
   - 点击"测试连接"验证配置（可选）
   - 点击"保存配置"

### 5. Dify平台配置示例

```
AI平台: Dify
工作流名称: 运营数据分析工作流
描述: 单文件数据分析工作流配置

API地址: http://118.89.16.95/v1
API Key: app-enMcZvGV69jXZ8D7SMJUjCqF
文件上传URL: http://118.89.16.95/v1/files/upload
工作流URL: http://118.89.16.95/v1/chat-messages
工作流类型: chatflow
文件参数名: excell
查询参数名: sys.query
```

## 五、API端点说明

### 后端API（需要超级管理员权限）

- `GET /api/v1/admin/functions` - 获取功能列表
- `GET /api/v1/admin/functions/{function_key}` - 获取单个功能配置
- `POST /api/v1/admin/functions/{function_key}/config` - 配置功能的API（全局配置）
- `PUT /api/v1/admin/functions/{function_key}/config` - 更新功能的API配置
- `POST /api/v1/admin/functions/{function_key}/test-config` - 测试API配置
- `DELETE /api/v1/admin/functions/{function_key}/config` - 删除功能的API配置
- `PATCH /api/v1/admin/functions/{function_key}/toggle` - 启用/禁用功能

### 前端路由

- `/admin` - 管理员布局（包含侧边栏）
- `/admin/users` - 用户管理页面
- `/admin/functions` - 功能管理页面

## 六、配置逻辑说明

### 全局配置 vs 用户配置

- **全局配置**：管理员在功能管理页面配置，`user_id = NULL`，所有用户默认使用
- **用户配置**：用户在功能页面自行配置，`user_id != NULL`，仅该用户使用
- **优先级**：用户配置 > 全局配置

### 配置保存流程

1. 管理员在功能管理页面点击"配置API"
2. 填写API配置信息
3. 点击"测试连接"验证配置（可选）
4. 点击"保存配置"
5. 后端创建或更新工作流（`Workflow`）
6. 创建或更新工作流绑定（`WorkflowBinding`，`user_id = NULL`）
7. 所有用户默认使用此全局配置

## 七、注意事项

1. **权限控制**：只有超级管理员（`is_admin = true`）可以访问功能管理页面
2. **功能键唯一性**：三个功能的 `function_key` 必须唯一，不能修改
3. **配置影响**：修改全局配置后，所有使用全局配置的用户将使用新配置
4. **向后兼容**：如果功能未配置API，系统会使用默认配置或提示用户配置

## 八、故障排查

### 问题1：无法访问功能管理页面

**解决方案**：
- 确认当前用户是超级管理员（`is_admin = true`）
- 检查路由配置是否正确
- 查看浏览器控制台是否有错误

### 问题2：功能列表为空

**解决方案**：
- 确认数据库表 `function_modules` 已创建
- 确认初始数据已插入
- 检查后端日志是否有错误

### 问题3：API配置保存失败

**解决方案**：
- 检查API配置信息是否完整
- 确认工作流表 `workflows` 和绑定表 `workflow_bindings` 存在
- 查看后端日志获取详细错误信息

### 问题4：测试连接失败

**解决方案**：
- 检查API地址和API Key是否正确
- 确认网络连接正常
- 检查目标API服务是否可访问

## 九、文件清单

### 后端文件
- `backend/app/models/function_module.py` - 功能模块模型
- `backend/app/schemas/function_module.py` - Schema定义
- `backend/app/api/v1/admin.py` - 管理员API路由
- `backend/scripts/init_function_modules.py` - 初始化脚本
- `backend/migrations/versions/e2f3g4h5i6j7_add_function_modules_table.py` - 数据库迁移

### 前端文件
- `frontend/src/views/Admin/AdminLayout.vue` - 管理员布局组件
- `frontend/src/views/Admin/FunctionManagement.vue` - 功能管理页面
- `frontend/src/views/Admin/components/FunctionConfigDialog.vue` - API配置对话框
- `frontend/src/api/admin.ts` - 前端API接口

## 十、后续优化建议

1. **API连接测试**：实现真正的API连接测试，发送测试请求验证配置
2. **配置历史**：记录配置变更历史，支持回滚
3. **批量配置**：支持批量导入/导出配置
4. **配置验证**：增强配置验证，检查必填项和格式
5. **使用统计**：统计每个功能的使用情况

---

**完成时间**：2025-01-27
**版本**：v1.0.0

