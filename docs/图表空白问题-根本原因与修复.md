# 图表空白问题 - 根本原因与修复

## 问题描述

用户报告图表显示空白，虽然图表按钮可以点击，抽屉也能打开，但是里面没有任何图表内容。

## 问题诊断

通过检查数据库中的HTML内容，发现了根本原因：

### 数据库中的HTML内容分析

```
✓ 找到 html_charts
长度: 6107 字符

=== 内容分析 ===
✓ 包含 ECharts 代码（引入了 echarts.min.js）
✗ 不包含 option 配置
✗ 不包含 series 数据
✗ 不包含 setOption 调用
```

### HTML代码结构

大模型返回的HTML代码包含：
1. ✓ 完整的HTML结构（`<!DOCTYPE html>`, `<head>`, `<body>`）
2. ✓ ECharts 库引入（`<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>`）
3. ✓ 样式定义（CSS）
4. ✓ 图表容器（`<div id="chart" class="chart-container"></div>`）
5. ✓ 数据数组（`var dataRows = [...]`）
6. ✗ **缺少 ECharts option 配置**
7. ✗ **缺少 chart.setOption() 调用**

### 代码截断位置

HTML代码在数据数组的中间被截断：

```javascript
var dataRows = [
    ["2025-07-02 00:00:00", 13.3, 24.1, 29.5, ...],
    ["2025-07-03 00:00:00", 2.9, 4.3, 5.1, ...],
    ...
    ["2025-07-26 00:00:00", 3.7, 5.6, 5.9, 7.8, 8.3, 9.6, 9.7, 9.8, 2.3, 3.7, 4.0, 4.6, 5.2, 6.7, 6.8, 6.9, 14, 19.6, 19.8, 31.1,
    // 这里被截断了！
```

**缺少的代码**：
```javascript
        ];
        
        // 配置 ECharts option
        var option = {
            title: { text: '用户LTV趋势分析' },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: ... },
            yAxis: { type: 'value' },
            series: [...]
        };
        
        // 渲染图表
        chart.setOption(option);
    </script>
</body>
</html>
```

## 根本原因

**大模型的输出长度限制**：`max_tokens: 4000`

在 `backend/app/services/bailian_service.py` 的 `_call_dashscope_api` 方法中，设置了：

```python
"max_tokens": 4000  # ❌ 太小了！
```

由于数据量较大，生成的HTML代码超过了4000个token，导致：
1. 大模型生成到一半就被强制停止
2. HTML代码不完整，缺少关键的图表配置代码
3. 浏览器加载HTML后，只有容器和数据，没有图表渲染

## 修复方案

### 修复1：增加 max_tokens 限制

**文件**：`backend/app/services/bailian_service.py`

**修改位置1**（OpenAI兼容接口）：
```python
# 修复前
"max_tokens": 4000  # ❌

# 修复后
"max_tokens": 8000  # ✅ 增加到8000，支持更长的HTML代码
```

**修改位置2**（DashScope原生API）：
```python
# 修复前
"parameters": {
    "temperature": 0.1,
    "max_tokens": 4000,  # ❌
    ...
}

# 修复后
"parameters": {
    "temperature": 0.1,
    "max_tokens": 8000,  # ✅ 增加到8000，支持更长的HTML代码
    ...
}
```

### 为什么选择 8000？

1. **4000 太小**：无法生成完整的HTML代码（包含数据、配置、样式）
2. **8000 合适**：
   - 足够生成完整的HTML代码
   - 不会超过大模型的上下文限制
   - 平衡了性能和功能
3. **可以更大**：如果数据量特别大，可以考虑增加到 16000

## 验证步骤

### 1. 重启后端服务

```bash
docker-compose restart backend
```

### 2. 重新生成报告

1. 上传 Excel 文件
2. 输入分析需求
3. **重要**：在"图表定制 Prompt"中输入需求（例如："请生成折线图，展示用户LTV趋势"）
4. 点击"提交生成报告"

### 3. 检查生成的HTML

打开浏览器控制台，运行以下代码：

```javascript
// 检查 localStorage 中的 HTML
const sessionId = 24  // 替换为你的会话ID
const htmlCharts = localStorage.getItem(`html_charts_${sessionId}`)
console.log('HTML长度:', htmlCharts?.length)
console.log('包含 option:', htmlCharts?.includes('option'))
console.log('包含 setOption:', htmlCharts?.includes('setOption'))
console.log('包含 series:', htmlCharts?.includes('series'))
```

**预期结果**：
```
HTML长度: > 8000
包含 option: true
包含 setOption: true
包含 series: true
```

### 4. 检查图表显示

1. 点击"查看图表详情"按钮
2. 抽屉打开
3. **预期结果**：图表正常显示，包含数据和交互

## 后续优化建议

### 1. 动态调整 max_tokens

根据数据量动态调整：

```python
# 根据数据行数估算需要的 tokens
data_rows = len(df)
if data_rows < 50:
    max_tokens = 4000
elif data_rows < 100:
    max_tokens = 8000
else:
    max_tokens = 16000
```

### 2. 数据采样优化

如果数据量太大，可以采样：

```python
# 当前：取前100行
data_sample = df.head(100).to_string()

# 优化：智能采样
if len(df) > 100:
    # 取前50行 + 后50行
    data_sample = pd.concat([df.head(50), df.tail(50)]).to_string()
else:
    data_sample = df.to_string()
```

### 3. 分段生成

对于特别大的数据：
1. 先生成HTML结构和样式
2. 再生成数据数组
3. 最后生成图表配置
4. 在后端拼接成完整的HTML

### 4. 压缩数据

在传递给大模型之前，压缩数据：
- 移除不必要的列
- 四舍五入数值（保留2位小数）
- 使用更紧凑的格式

### 5. 添加验证

在保存HTML之前，验证完整性：

```python
def validate_html(html: str) -> bool:
    """验证HTML是否完整"""
    required_elements = [
        '<!DOCTYPE html>',
        '<html>',
        '</html>',
        'echarts',
        'option',
        'setOption'
    ]
    return all(elem in html for elem in required_elements)

# 使用
if not validate_html(html_charts):
    logger.error("[BailianService] HTML代码不完整，可能被截断")
    # 重试或报错
```

## 总结

✅ **问题已修复**

- **根本原因**：`max_tokens: 4000` 太小，导致HTML代码被截断
- **修复方案**：增加到 `max_tokens: 8000`
- **影响范围**：所有新生成的报告
- **历史报告**：需要重新生成

## 测试清单

- [ ] 重启后端服务
- [ ] 上传Excel文件
- [ ] 输入分析需求和图表定制prompt
- [ ] 生成报告
- [ ] 检查HTML长度（应该 > 8000字符）
- [ ] 检查HTML包含 option、setOption、series
- [ ] 点击"查看图表详情"
- [ ] 确认图表正常显示
- [ ] 测试图表交互（鼠标悬停、缩放等）

## 注意事项

1. **旧报告无法自动修复**：需要重新生成
2. **数据量限制**：如果数据特别大（>200行），可能还需要进一步优化
3. **大模型限制**：不同的大模型有不同的token限制，需要根据实际情况调整
4. **成本考虑**：增加 max_tokens 会增加API调用成本
