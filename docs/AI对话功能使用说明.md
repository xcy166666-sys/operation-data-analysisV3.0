# AI对话功能使用说明

## 功能概述

AI对话功能允许用户通过自然语言与系统进行交互，实时调整图表样式、修改数据范围等。

## 使用步骤

### 1. 生成报告

首先需要上传Excel文件并生成初始报告：

1. 在数据分析页面上传Excel文件
2. 输入分析需求
3. 点击"提交生成报告"按钮
4. 等待报告生成完成

### 2. 打开AI对话面板

报告生成后，点击页面右上角的"AI对话"按钮，打开对话面板。

### 3. 与AI对话

在对话面板的输入框中输入您的需求，例如：

- **修改图表类型**：
  - "将第一个图表改为柱状图"
  - "把折线图改成饼图"

- **修改图表颜色**：
  - "修改图表颜色为蓝色"
  - "使用红色主题"

- **数据分析**：
  - "分析数据趋势"
  - "找出异常数据点"

- **数据筛选**：
  - "只显示前10条数据"
  - "筛选出大于100的数据"

### 4. 查看修改结果

AI处理完您的请求后，会：

1. 在对话面板中显示回复
2. 如果修改了图表，会显示"已修改 X 个图表"
3. 主页面的图表会自动更新

### 5. 清除对话历史

如果需要重新开始对话，可以点击对话面板右上角的"删除"图标清除历史记录。

## 支持的修改类型

### 1. 图表类型修改 (change_type)

修改图表的类型，支持：
- line（折线图）
- bar（柱状图）
- pie（饼图）
- scatter（散点图）

**示例**：
```
用户："将第一个图表改为柱状图"
AI："已将第一个图表改为柱状图"
```

### 2. 颜色修改 (change_color)

修改图表的颜色主题。

**示例**：
```
用户："修改图表颜色为蓝色"
AI："已将图表颜色修改为蓝色"
```

### 3. 数据筛选 (add_filter)

添加数据筛选条件，限制显示的数据范围。

**示例**：
```
用户："只显示前50%的数据"
AI："已添加数据筛选，显示前50%的数据"
```

### 4. 样式修改 (modify_style)

修改图表的样式配置，如标题、图例、坐标轴等。

**示例**：
```
用户："添加数据标签"
AI："已添加数据标签到图表"
```

### 5. 数据范围更新 (update_data_range)

更新图表显示的数据范围。

**示例**：
```
用户："只显示第1到第10行数据"
AI："已更新数据范围，显示第1到第10行"
```

## 技术实现

### 后端API

#### 1. 发送对话消息

```http
POST /api/v1/operation/dialog
Content-Type: application/json

{
  "session_id": 123,
  "message": "将第一个图表改为柱状图",
  "conversation_id": "uuid-xxx"  // 可选，首次为null
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "response": "已将第一个图表改为柱状图",
    "modified_charts": [...],
    "conversation_id": "uuid-xxx",
    "action_type": "modify_chart"
  }
}
```

#### 2. 获取对话历史

```http
GET /api/v1/operation/dialog/history?session_id=123&limit=20
```

**响应**：
```json
{
  "success": true,
  "data": {
    "messages": [
      {
        "id": "msg-1",
        "role": "user",
        "content": "将第一个图表改为柱状图",
        "timestamp": "2025-12-19T10:00:00Z"
      },
      {
        "id": "msg-2",
        "role": "assistant",
        "content": "已将第一个图表改为柱状图",
        "timestamp": "2025-12-19T10:00:05Z",
        "modified_charts": [...]
      }
    ]
  }
}
```

#### 3. 清除对话历史

```http
DELETE /api/v1/operation/dialog/history?session_id=123
```

### 前端组件

#### DialogPanel.vue

对话面板组件，负责：
- 显示对话历史
- 发送用户消息
- 接收AI回复
- 更新图表

**主要方法**：
- `sendMessage()` - 发送消息
- `loadHistory()` - 加载历史
- `handleClearHistory()` - 清除历史

## 注意事项

1. **会话关联**：对话功能与当前会话关联，切换会话后对话历史会重新加载
2. **图表索引**：图表索引从0开始，"第一个图表"对应索引0
3. **修改限制**：目前仅支持JSON格式的图表修改，HTML图表暂不支持实时修改
4. **对话上下文**：系统会维护对话上下文（conversation_id），支持多轮对话

## 常见问题

### Q1: 为什么对话面板显示"离线"？

A: 检查后端服务是否正常运行，确保API端点可访问。

### Q2: 修改图表后没有生效？

A: 确保：
1. 当前会话有已生成的报告
2. 图表索引正确（从0开始）
3. 修改指令格式正确

### Q3: 如何查看对话历史？

A: 对话历史会自动加载，也可以点击刷新按钮重新加载。

### Q4: 对话历史保存在哪里？

A: 对话历史暂时保存在内存中（DialogManager），后续会迁移到Redis或数据库以实现持久化。

## 后续优化计划

- [ ] 支持流式输出（SSE）
- [ ] 支持HTML图表的实时修改
- [ ] 支持语音输入
- [ ] 支持图表导出
- [ ] 支持对话分享
- [ ] 对话历史持久化（Redis/数据库）
- [ ] 多语言支持

## 反馈与建议

如有问题或建议，请联系开发团队。
