# AI对话历史持久化与版本标记功能 - 测试指南

## 测试前准备

### 1. 执行数据库迁移
```bash
cd backend
alembic upgrade head
```

### 2. （可选）迁移历史数据
如果有旧的对话数据需要迁移：
```bash
cd backend
python scripts/migrate_dialog_history.py
```

### 3. 重启服务
```bash
# 后端
cd backend
.\start_local.bat

# 前端
cd frontend
npm run dev
```

## 测试场景

### 场景1：对话历史持久化测试

**步骤：**
1. 登录系统（admin / admin123!）
2. 创建新的分析会话
3. 上传Excel文件并生成报告
4. 点击"AI对话"按钮，进入对话模式
5. 发送几条消息与AI对话
6. 刷新浏览器页面
7. 再次进入该会话的对话模式

**预期结果：**
- ✅ 刷新后对话历史仍然存在
- ✅ 消息顺序正确（从旧到新）
- ✅ 消息内容完整（包括用户消息和AI回复）
- ✅ 时间戳正确显示

### 场景2：版本保存点标记测试

**步骤：**
1. 在已有对话的会话中
2. 点击"保存版本"按钮
3. 输入版本说明（如"初始分析报告"）
4. 保存成功后，查看对话历史

**预期结果：**
- ✅ 对话历史中出现版本保存点标记
- ✅ 标记显示为紫色渐变徽章
- ✅ 标记内容：📌 保存版本 V1: 初始分析报告
- ✅ 标记有脉冲动画效果
- ✅ 标记上下有分隔线

### 场景3：多版本标记测试

**步骤：**
1. 继续在会话中与AI对话
2. 修改报告内容（如修改图表样式）
3. 再次保存版本（版本说明："修改图表样式"）
4. 继续对话并保存第三个版本

**预期结果：**
- ✅ 对话历史中出现多个版本标记
- ✅ 版本号递增（V1, V2, V3）
- ✅ 每个标记之间的对话内容正确分组
- ✅ 时间轴效果清晰，易于理解报告演进过程

### 场景4：会话切换测试

**步骤：**
1. 在会话A中进行对话
2. 切换到会话B
3. 在会话B中进行对话
4. 切换回会话A

**预期结果：**
- ✅ 每个会话的对话历史独立
- ✅ 切换会话时正确加载对应的历史
- ✅ 不会出现消息混乱

### 场景5：清除历史测试

**步骤：**
1. 在有对话历史的会话中
2. 点击"清除历史"按钮
3. 确认清除操作

**预期结果：**
- ✅ 对话历史被清空
- ✅ 版本标记也被清除
- ✅ 可以重新开始对话

### 场景6：选中文字修改测试

**步骤：**
1. 在报告中选中一段文字
2. 在对话面板中输入修改指令（如"润色这段话"）
3. 发送消息
4. 查看对话历史

**预期结果：**
- ✅ 用户消息中显示引用的文字
- ✅ 引用文字有特殊样式（蓝色背景框）
- ✅ AI回复包含修改后的内容

## 数据验证

### 检查数据库
```sql
-- 查看对话历史表
SELECT * FROM dialog_histories 
WHERE session_id = <your_session_id> 
ORDER BY created_at;

-- 查看版本标记
SELECT * FROM dialog_histories 
WHERE role = 'system' AND extra_data->>'type' = 'version_marker';

-- 查看版本关联
SELECT 
    dh.id,
    dh.role,
    dh.content,
    dh.version_id,
    asv.version_no,
    asv.summary
FROM dialog_histories dh
LEFT JOIN analysis_session_versions asv ON dh.version_id = asv.id
WHERE dh.session_id = <your_session_id>
ORDER BY dh.created_at;
```

## 常见问题排查

### 问题1：对话历史不显示
**可能原因：**
- 数据库迁移未执行
- 后端服务未重启
- API请求失败

**排查步骤：**
1. 检查浏览器控制台是否有错误
2. 检查后端日志：`backend_logs.txt`
3. 验证数据库表是否存在：`SELECT * FROM dialog_histories LIMIT 1;`

### 问题2：版本标记不显示
**可能原因：**
- 版本创建时未添加标记
- 前端组件未正确识别system消息

**排查步骤：**
1. 检查数据库是否有system角色的消息
2. 检查extra_data字段是否包含type='version_marker'
3. 检查前端控制台是否有渲染错误

### 问题3：历史数据迁移失败
**可能原因：**
- 数据格式不兼容
- 时间戳解析失败

**排查步骤：**
1. 查看迁移脚本日志
2. 检查AnalysisSession.messages字段的数据格式
3. 手动修复问题数据后重新运行迁移

## 性能测试

### 大量消息测试
1. 创建一个会话
2. 通过脚本或手动发送100+条消息
3. 观察加载速度和滚动性能

**预期结果：**
- ✅ 加载时间 < 2秒
- ✅ 滚动流畅，无卡顿
- ✅ 内存占用合理

### 多会话测试
1. 创建10个会话
2. 每个会话有20+条对话
3. 快速切换会话

**预期结果：**
- ✅ 切换响应快速
- ✅ 历史加载正确
- ✅ 无内存泄漏

## 测试完成检查清单

- [ ] 对话历史持久化正常工作
- [ ] 版本保存点标记正确显示
- [ ] 多版本标记效果良好
- [ ] 会话切换功能正常
- [ ] 清除历史功能正常
- [ ] 选中文字修改功能正常
- [ ] 数据库数据正确
- [ ] 性能表现良好
- [ ] 无明显bug或错误

## 反馈与改进

如果发现问题，请记录：
1. 问题描述
2. 复现步骤
3. 预期行为 vs 实际行为
4. 浏览器控制台错误（如有）
5. 后端日志错误（如有）
