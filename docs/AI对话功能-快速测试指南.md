# AI对话功能 - 快速测试指南

## 🔧 最新修复（2025-12-19 15:52）

### 问题诊断与修复

**问题1：API路径重复**
- 症状：请求路径为 `/api/v1/api/v1/operation/dialog`（路径重复）
- 原因：`request.ts` 的 baseURL 已设置为 `/api/v1`，但 `dialog.ts` 中又加了一次
- 修复：将 `dialog.ts` 中的路径从 `/api/v1/operation/dialog` 改为 `/operation/dialog`

**问题2：参数格式错误**
- 症状：后端返回400错误，提示 `Field required: session_id, user_message`
- 原因：后端期望 FormData 格式（使用 `Form(...)` 参数），前端发送的是 JSON
- 修复：前端改为发送 FormData 格式，字段名改为 `user_message`

**问题3：路由冲突**
- 症状：创建了重复的对话API文件
- 原因：`operation.py` 中已有完整的对话API实现
- 修复：删除 `operation_dialog.py`，使用 `operation.py` 中的现有实现

### 修复后的代码

**前端 `dialog.ts`**：
```typescript
export function sendDialogMessage(data: DialogRequest) {
  const formData = new FormData()
  formData.append('session_id', data.session_id.toString())
  formData.append('user_message', data.message)  // 注意：字段名是 user_message
  if (data.conversation_id) {
    formData.append('conversation_id', data.conversation_id)
  }
  formData.append('current_charts', JSON.stringify([]))
  
  return request.post<DialogResponse>(
    '/operation/dialog',  // 注意：路径不包含 /api/v1
    formData,
    {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    }
  )
}
```

**后端路由**：
- 使用 `backend/app/api/v1/operation.py` 中的实现
- 路由：`POST /api/v1/operation/dialog`
- 参数格式：FormData（`session_id`, `user_message`, `current_charts`, `conversation_id`）

### 服务状态
✅ 后端已重启，服务正常运行
✅ 前端代码已更新
✅ 可以开始测试

## 测试环境

- **前端**：http://localhost:5173
- **后端**：http://localhost:21810
- **数据库**：PostgreSQL (端口22810)

## 测试步骤

### 1. 启动服务

确保所有服务正常运行：

```bash
# 检查Docker容器状态
docker ps

# 应该看到以下容器运行中：
# - operation-analysis-v2-backend
# - operation-analysis-v2-postgres
# - operation-analysis-v2-redis
```

前端服务：
```bash
cd frontend
npm run dev
```

### 2. 登录系统

访问 http://localhost:5173

使用测试账号：
- 用户名：`test`
- 密码：`test123`

### 3. 生成报告

1. 点击"运营数据分析"进入分析页面
2. 点击"新建会话"创建新会话
3. 上传Excel文件（测试文件：`backend/test_data.xlsx`）
4. 输入分析需求，例如：
   ```
   生成一份关注新手留存的周度报告
   ```
5. 点击"提交生成报告"
6. 等待报告生成完成（约10-30秒）

### 4. 开启AI对话模式

报告生成后：

1. 点击右上角的 **"AI对话"** 按钮
2. 页面应该切换为全屏对话模式：
   - 左侧：AI对话面板（450px宽）
   - 右侧：报告展示区域（自适应宽度）

### 5. 测试对话功能

#### 测试1：基础对话

在左侧对话面板输入：
```
你好
```

预期结果：
- AI回复欢迎消息
- 消息显示在对话历史中

#### 测试2：修改图表类型

输入：
```
将第一个图表改为柱状图
```

预期结果：
- AI回复确认消息
- 右侧图表自动更新
- 显示"已修改 1 个图表"提示

#### 测试3：修改图表颜色

输入：
```
修改图表颜色为蓝色
```

预期结果：
- AI回复确认消息
- 图表颜色更新

#### 测试4：数据分析

输入：
```
分析一下数据趋势
```

预期结果：
- AI提供数据分析结果
- 显示在对话历史中

### 6. 测试对话历史

1. 点击对话面板右上角的 **刷新图标**
   - 预期：重新加载对话历史

2. 点击对话面板右上角的 **删除图标**
   - 预期：弹出确认对话框
   - 确认后清除所有对话历史

### 7. 测试布局响应

1. **调整浏览器窗口大小**
   - 预期：左右面板自适应调整

2. **滚动右侧报告区域**
   - 预期：独立滚动，不影响左侧对话面板

3. **滚动左侧对话历史**
   - 预期：独立滚动，不影响右侧报告

### 8. 关闭对话模式

点击右上角的 **"隐藏对话"** 按钮

预期结果：
- 返回普通报告查看模式
- 显示完整的报告内容

## 测试检查清单

### 功能测试

- [ ] 能够开启AI对话模式
- [ ] 能够发送消息
- [ ] 能够接收AI回复
- [ ] 能够修改图表
- [ ] 能够查看对话历史
- [ ] 能够清除对话历史
- [ ] 能够关闭对话模式

### 布局测试

- [ ] 对话模式占满整个主内容区
- [ ] 左侧对话面板宽度正确（450px）
- [ ] 右侧报告区域自适应宽度
- [ ] 左右面板独立滚动
- [ ] 历史会话栏保持在最左侧

### UI测试

- [ ] 消息气泡样式正确
- [ ] 用户消息（蓝色）和AI消息（灰色）区分明显
- [ ] 时间显示格式正确
- [ ] 加载动画显示正常
- [ ] 图表修改提示显示正常

### 交互测试

- [ ] 按Enter发送消息
- [ ] Shift+Enter换行
- [ ] 发送按钮状态正确
- [ ] 输入框字数限制正常
- [ ] 刷新按钮功能正常
- [ ] 清除按钮功能正常

## 常见问题排查

### 问题1：对话模式无法开启

**症状**：点击"AI对话"按钮没有反应

**排查**：
1. 检查是否已生成报告
2. 打开浏览器控制台查看错误信息
3. 检查 `reportContent` 是否有值

**解决**：
- 确保先生成报告再开启对话模式
- 检查后端API是否正常运行

### 问题2：消息发送失败

**症状**：点击发送后没有AI回复

**排查**：
1. 打开浏览器控制台查看网络请求
2. 检查后端日志：`docker logs operation-analysis-v2-backend`
3. 检查API端点：`POST /api/v1/operation/dialog`

**解决**：
- 检查后端服务是否正常
- 检查阿里百炼API配置
- 检查网络连接

### 问题3：布局显示异常

**症状**：左右面板宽度不正确

**排查**：
1. 检查浏览器窗口大小
2. 打开浏览器开发者工具查看CSS
3. 检查 `.dialog-mode-layout` 样式

**解决**：
- 刷新页面
- 清除浏览器缓存
- 检查CSS是否正确加载

### 问题4：图表不更新

**症状**：对话后图表没有变化

**排查**：
1. 检查AI回复中是否包含修改指令
2. 检查 `modified_charts` 是否有值
3. 检查 `handleDialogResponse` 方法

**解决**：
- 检查图表修改器逻辑
- 检查AI回复格式
- 查看后端日志

## 性能测试

### 测试场景1：大量消息

1. 连续发送20条消息
2. 观察页面性能
3. 检查内存使用

**预期**：
- 页面流畅，无卡顿
- 内存使用稳定

### 测试场景2：大型报告

1. 上传包含大量数据的Excel文件
2. 生成报告
3. 开启对话模式

**预期**：
- 报告加载正常
- 滚动流畅

### 测试场景3：长时间使用

1. 保持对话模式开启30分钟
2. 进行多次对话
3. 观察系统稳定性

**预期**：
- 系统稳定运行
- 无内存泄漏

## 测试报告模板

```markdown
## AI对话功能测试报告

**测试时间**：2025-12-19

**测试人员**：[姓名]

**测试环境**：
- 浏览器：Chrome 120
- 操作系统：Windows 11
- 前端版本：v3.0.0
- 后端版本：v3.0.0

**测试结果**：

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 开启对话模式 | ✅ | 正常 |
| 发送消息 | ✅ | 正常 |
| 接收回复 | ✅ | 正常 |
| 修改图表 | ✅ | 正常 |
| 查看历史 | ✅ | 正常 |
| 清除历史 | ✅ | 正常 |
| 布局响应 | ✅ | 正常 |

**发现的问题**：
1. [问题描述]
2. [问题描述]

**改进建议**：
1. [建议内容]
2. [建议内容]
```

## 下一步

测试通过后，可以进行以下工作：

1. **功能优化**
   - 添加流式输出（SSE）
   - 支持语音输入
   - 支持图表导出

2. **性能优化**
   - 对话历史持久化
   - 图表渲染优化
   - 内存管理优化

3. **用户体验优化**
   - 添加快捷键
   - 优化加载动画
   - 添加提示信息

4. **文档完善**
   - 用户手册
   - API文档
   - 故障排查指南
