# 本地开发环境解决方案

## 问题背景

在使用 Docker 运行后端服务时，遇到了 500 错误，原因是 httpx 库在 Docker 容器中无法正常解析 DNS 和连接到阿里云 DashScope API。

错误信息：
```
httpx.ConnectError: [Errno -3] Temporary failure in name resolution
```

## 根本原因

1. **Docker 网络问题**: Docker 容器使用内部 DNS 服务器 (127.0.0.11)，httpx 的 anyio 后端无法正确使用它
2. **代理配置问题**: 即使移除了代理环境变量，httpx 仍然无法连接
3. **TLS 握手失败**: 在某些情况下，即使 DNS 解析成功，TLS 连接也会失败

## 解决方案：本地开发环境

**核心思路**: 在开发环境中不使用 Docker 运行后端，直接在本地运行，避免 Docker 网络问题。

### 优势

1. ✅ **无网络问题**: 直接使用本地网络，避免 Docker DNS 和代理问题
2. ✅ **更快的开发体验**: 代码修改后立即生效，无需重建容器
3. ✅ **更容易调试**: 可以直接使用 IDE 的调试功能
4. ✅ **更低的资源占用**: 不需要运行完整的后端容器

### 架构

```
开发环境:
- 前端: 本地运行 (npm run dev) - 端口 5173
- 后端: 本地运行 (uvicorn) - 端口 8000
- PostgreSQL: Docker 容器 - 端口 22810
- Redis: Docker 容器 - 端口 22811

生产环境:
- 全部使用 Docker Compose 运行
```

## 实施步骤

### 1. 创建本地环境配置文件

文件: `backend/.env.local`

```env
# 本地开发环境配置
APP_NAME=运营数据分析系统
APP_VERSION=3.0.0
DEBUG=true

# 数据库配置（连接到 Docker 中的 PostgreSQL）
POSTGRES_USER=postgres
POSTGRES_PASSWORD=secure_password_123!
POSTGRES_DB=operation_analysis_v2
POSTGRES_HOST=localhost
POSTGRES_PORT=22810

# Redis配置（连接到 Docker 中的 Redis）
REDIS_URL=redis://localhost:22811/0

# 阿里百炼DashScope配置
DASHSCOPE_API_KEY=sk-f72852ce679f42019f669589a51e2639
DASHSCOPE_MODEL=qwen3-32b

# CORS配置
CORS_ORIGINS=http://localhost:5173,http://localhost:80,http://localhost:3000

# 文件上传配置
UPLOAD_DIR=uploads/operation/project_1
MAX_UPLOAD_SIZE=20971520

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
```

### 2. 修改配置加载逻辑

文件: `backend/app/core/config.py`

添加支持 `.env.local` 文件的逻辑：

```python
# 创建全局配置实例
# 支持通过 ENV_FILE 环境变量指定配置文件
import os
env_file = os.environ.get("ENV_FILE", ".env")
if env_file != ".env" and os.path.exists(env_file):
    # 如果指定了自定义环境文件且存在，使用它
    settings = Settings(_env_file=env_file)
elif os.path.exists(".env.local"):
    # 如果存在 .env.local，优先使用它（开发环境）
    settings = Settings(_env_file=".env.local")
else:
    # 否则使用默认的 .env
    settings = Settings()
```

### 3. 创建启动脚本

文件: `backend/start_local.bat`

```batch
@echo off
chcp 65001 >nul
echo ========================================
echo 启动本地开发环境后端服务
echo ========================================

set ENV_FILE=.env.local
echo [信息] 使用环境变量文件: %ENV_FILE%

REM 检查并启动数据库和 Redis
docker ps | findstr "postgres" >nul 2>&1
if errorlevel 1 (
    echo [警告] PostgreSQL 容器未运行，正在启动...
    docker-compose up -d postgres
)

docker ps | findstr "redis" >nul 2>&1
if errorlevel 1 (
    echo [警告] Redis 容器未运行，正在启动...
    docker-compose up -d redis
)

echo [信息] 启动后端服务...
echo [信息] 访问地址: http://localhost:8000
echo [信息] API 文档: http://localhost:8000/docs

python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 4. 修改 bailian_service.py

文件: `backend/app/services/bailian_service.py`

移除代理配置，显式禁用环境代理：

```python
# 显式禁用代理，避免DNS解析问题
async with httpx.AsyncClient(timeout=300.0, trust_env=False) as client:
    # ... API 调用代码
```

## 使用方法

### 启动开发环境

1. **启动数据库和 Redis**（如果还没运行）:
   ```powershell
   docker-compose up -d postgres redis
   ```

2. **启动后端服务**:
   ```powershell
   cd backend
   .\start_local.bat
   ```

3. **启动前端服务**（另一个终端）:
   ```powershell
   cd frontend
   npm run dev
   ```

### 访问地址

- 前端: http://localhost:5173
- 后端 API: http://localhost:8000
- API 文档: http://localhost:8000/docs

### 切换回 Docker 模式

如果需要测试完整的 Docker 环境：

```powershell
# 停止本地后端服务（Ctrl+C）
# 启动 Docker 后端
docker-compose up -d backend
```

## 测试结果

✅ 配置加载成功  
✅ 数据库连接成功  
✅ Redis 连接成功  
✅ 后端服务启动成功  
✅ 前端可以正常访问后端 API  

## 注意事项

1. **端口冲突**: 确保 8000 端口没有被占用
2. **数据库密码**: 确保 `.env.local` 中的数据库密码与 Docker 容器中的一致
3. **Python 版本**: 需要 Python 3.11 或更高版本
4. **依赖安装**: 首次运行需要安装依赖 `pip install -r requirements.txt`

## 生产部署

生产环境仍然使用 Docker Compose：

```powershell
docker-compose up -d
```

所有服务（包括后端）都在 Docker 中运行，使用 `.env` 文件配置。

## 总结

通过将后端服务从 Docker 迁移到本地运行，我们成功解决了 Docker 网络导致的 API 调用问题。这种方案在开发环境中更加灵活和高效，同时保持了生产环境使用 Docker 的部署方式。
