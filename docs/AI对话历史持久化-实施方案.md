# AIå¯¹è¯å†å²æŒä¹…åŒ–ä¸ç‰ˆæœ¬æ ‡è®°åŠŸèƒ½ - å®æ–½æ–¹æ¡ˆ

## åŠŸèƒ½æ¦‚è¿°

å®ç°AIå¯¹è¯å†å²çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå¹¶åœ¨å¯¹è¯æ—¶é—´è½´ä¸­æ ‡è®°ç‰ˆæœ¬ä¿å­˜ç‚¹ï¼Œè®©ç”¨æˆ·å¯ä»¥ï¼š
1. ç‚¹å‡»ä¼šè¯æ—¶æŸ¥çœ‹æ‰€æœ‰å†å²å¯¹è¯è®°å½•
2. åœ¨å¯¹è¯å†å²ä¸­çœ‹åˆ°æ¯æ¬¡ä¿å­˜ç‰ˆæœ¬çš„æ—¶é—´ç‚¹æ ‡è®°

## æŠ€æœ¯æ–¹æ¡ˆ

### 1. æ•°æ®æ¨¡å‹å˜æ›´

#### DialogHistory è¡¨å¢å¼º
- æ·»åŠ  `version_id` å­—æ®µï¼šå…³è”åˆ° `analysis_session_versions.id`
- ç”¨äºæ ‡è®°æŸæ¡æ¶ˆæ¯æ˜¯åœ¨å“ªä¸ªç‰ˆæœ¬ä¿å­˜æ—¶äº§ç”Ÿçš„
- æ”¯æŒ `system` è§’è‰²æ¶ˆæ¯ï¼Œç”¨äºæ˜¾ç¤ºç‰ˆæœ¬ä¿å­˜ç‚¹æ ‡è®°

```python
class DialogHistory(Base):
    id = Column(Integer, primary_key=True)
    session_id = Column(Integer, ForeignKey('analysis_sessions.id'))
    role = Column(String(20))  # 'user' | 'assistant' | 'system'
    content = Column(Text)
    version_id = Column(Integer, ForeignKey('analysis_session_versions.id'))  # æ–°å¢
    extra_data = Column(JSONB)
    created_at = Column(DateTime)
```

### 2. åç«¯å®ç°

#### 2.1 å¯¹è¯å†å²å­˜å‚¨
- ä½¿ç”¨ `DialogHistory` è¡¨æ›¿ä»£ `AnalysisSession.messages` JSONB å­—æ®µ
- é€šè¿‡ `DialogManager` æœåŠ¡ç»Ÿä¸€ç®¡ç†å¯¹è¯å†å²
- æ”¯æŒç‰ˆæœ¬æ ‡è®°åŠŸèƒ½

#### 2.2 ç‰ˆæœ¬ä¿å­˜ç‚¹æ ‡è®°
å½“åˆ›å»ºæ–°ç‰ˆæœ¬æ—¶ï¼š
1. ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ° `analysis_session_versions` è¡¨
2. åœ¨ `dialog_histories` è¡¨ä¸­æ’å…¥ä¸€æ¡ `system` è§’è‰²çš„æ¶ˆæ¯
3. æ¶ˆæ¯å†…å®¹ï¼š`ğŸ“Œ ä¿å­˜ç‰ˆæœ¬ V{version_no}: {summary}`
4. è®¾ç½® `version_id` å…³è”åˆ°æ–°åˆ›å»ºçš„ç‰ˆæœ¬
5. `extra_data` åŒ…å«ç‰ˆæœ¬è¯¦ç»†ä¿¡æ¯

```python
dialog_manager.save_message_to_db(
    db=db,
    session_id=session_id,
    role="system",
    content=f"ğŸ“Œ ä¿å­˜ç‰ˆæœ¬ V{version_no}: {summary}",
    extra_data={
        "type": "version_marker",
        "version_id": version.id,
        "version_no": version_no,
        "summary": summary
    },
    version_id=version.id
)
```

#### 2.3 API æ›´æ–°

**GET /api/v1/operation/dialog/history**
- ä» `DialogHistory` è¡¨è¯»å–å¯¹è¯å†å²
- æŒ‰æ—¶é—´æ­£åºè¿”å›
- åŒ…å«ç‰ˆæœ¬æ ‡è®°ä¿¡æ¯

**DELETE /api/v1/operation/dialog/history**
- åˆ é™¤ `DialogHistory` è¡¨ä¸­çš„è®°å½•
- åŒæ—¶æ¸…ç©º `AnalysisSession.messages`ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰

**POST /api/v1/operation/sessions/{id}/versions**
- åˆ›å»ºç‰ˆæœ¬åè‡ªåŠ¨æ·»åŠ ç‰ˆæœ¬ä¿å­˜ç‚¹æ ‡è®°

### 3. å‰ç«¯å®ç°

#### 3.1 DialogPanel ç»„ä»¶å¢å¼º

**ç‰ˆæœ¬æ ‡è®°æ˜¾ç¤º**
```vue
<div v-if="message.role === 'system' && message.extra_data?.type === 'version_marker'" 
     class="version-marker">
  <div class="marker-line"></div>
  <div class="marker-badge">
    <el-icon><Flag /></el-icon>
    <span class="marker-text">{{ message.content }}</span>
  </div>
  <div class="marker-time">{{ formatTime(message.timestamp) }}</div>
</div>
```

**æ ·å¼è®¾è®¡**
- æ¸å˜è‰²å¾½ç« ï¼šç´«è‰²æ¸å˜èƒŒæ™¯
- è„‰å†²åŠ¨ç”»ï¼šå¸å¼•æ³¨æ„åŠ›
- åˆ†éš”çº¿ï¼šè§†è§‰ä¸Šåˆ†éš”ä¸åŒç‰ˆæœ¬çš„å¯¹è¯
- æ—¶é—´æˆ³ï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿å­˜æ—¶é—´

#### 3.2 æ¶ˆæ¯ç±»å‹æ‰©å±•
```typescript
interface ExtendedDialogMessage extends DialogMessage {
  quoted_text?: string
  extra_data?: {
    type?: string  // 'version_marker'
    version_id?: number
    version_no?: number
    summary?: string
  }
}
```

### 4. æ•°æ®è¿ç§»

#### 4.1 æ•°æ®åº“è¿ç§»
æ–‡ä»¶ï¼š`backend/migrations/versions/20251224_145706_add_version_id_to_dialog_history.py`

```bash
# æ‰§è¡Œè¿ç§»
cd backend
alembic upgrade head
```

#### 4.2 å†å²æ•°æ®è¿ç§»
æ–‡ä»¶ï¼š`backend/scripts/migrate_dialog_history.py`

åŠŸèƒ½ï¼š
- å°† `AnalysisSession.messages` ä¸­çš„å¯¹è¯è¿ç§»åˆ° `DialogHistory` è¡¨
- ä¿ç•™æ—¶é—´æˆ³å’Œé¢å¤–æ•°æ®
- è‡ªåŠ¨è·³è¿‡å·²è¿ç§»çš„ä¼šè¯

```bash
# æ‰§è¡Œæ•°æ®è¿ç§»
cd backend
python scripts/migrate_dialog_history.py
```

## ä½¿ç”¨æ•ˆæœ

### 1. å¯¹è¯å†å²æŒä¹…åŒ–
- ç‚¹å‡»ä»»æ„ä¼šè¯ï¼Œç«‹å³åŠ è½½æ‰€æœ‰å†å²å¯¹è¯
- å¯¹è¯è®°å½•æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­
- æ”¯æŒå¤§é‡å†å²æ¶ˆæ¯çš„é«˜æ•ˆæŸ¥è¯¢

### 2. ç‰ˆæœ¬ä¿å­˜ç‚¹æ ‡è®°
- åœ¨å¯¹è¯æ—¶é—´è½´ä¸­æ¸…æ™°æ˜¾ç¤ºç‰ˆæœ¬ä¿å­˜ç‚¹
- ç´«è‰²æ¸å˜å¾½ç«  + è„‰å†²åŠ¨ç”»
- æ˜¾ç¤ºç‰ˆæœ¬å·å’Œç‰ˆæœ¬è¯´æ˜
- å¸®åŠ©ç”¨æˆ·ç†è§£æŠ¥å‘Šæ¼”è¿›è¿‡ç¨‹

### 3. æ—¶é—´è½´æ•ˆæœ
```
ç”¨æˆ·: è¯·åˆ†æè¿™ä»½æ•°æ®
AI: å¥½çš„ï¼Œæˆ‘æ¥åˆ†æ...

ç”¨æˆ·: ä¿®æ”¹ç¬¬ä¸€ä¸ªå›¾è¡¨ä¸ºæŸ±çŠ¶å›¾
AI: å·²ä¿®æ”¹å›¾è¡¨æ ·å¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ä¿å­˜ç‰ˆæœ¬ V1: åˆå§‹åˆ†ææŠ¥å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç”¨æˆ·: æ·»åŠ è¶‹åŠ¿åˆ†æ
AI: å·²æ·»åŠ è¶‹åŠ¿åˆ†æå†…å®¹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ä¿å­˜ç‰ˆæœ¬ V2: æ·»åŠ è¶‹åŠ¿åˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## éƒ¨ç½²æ­¥éª¤

### 1. åœæ­¢æœåŠ¡
```bash
# åœæ­¢åç«¯æœåŠ¡
```

### 2. æ›´æ–°ä»£ç 
```bash
git pull
```

### 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
cd backend
alembic upgrade head
```

### 4. è¿ç§»å†å²æ•°æ®ï¼ˆå¯é€‰ï¼‰
```bash
cd backend
python scripts/migrate_dialog_history.py
```

### 5. é‡å¯æœåŠ¡
```bash
# å¯åŠ¨åç«¯
cd backend
.\start_local.bat

# å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

## æµ‹è¯•éªŒè¯

### 1. å¯¹è¯å†å²æµ‹è¯•
- [ ] åˆ›å»ºæ–°ä¼šè¯å¹¶å‘é€æ¶ˆæ¯
- [ ] åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯æ¶ˆæ¯æ˜¯å¦ä¿ç•™
- [ ] åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯å†åˆ‡æ¢å›æ¥ï¼ŒéªŒè¯å†å²åŠ è½½

### 2. ç‰ˆæœ¬æ ‡è®°æµ‹è¯•
- [ ] ç”ŸæˆæŠ¥å‘Šåä¿å­˜ç‰ˆæœ¬
- [ ] éªŒè¯å¯¹è¯å†å²ä¸­å‡ºç°ç‰ˆæœ¬æ ‡è®°
- [ ] éªŒè¯æ ‡è®°æ ·å¼å’ŒåŠ¨ç”»æ•ˆæœ
- [ ] ç»§ç»­å¯¹è¯åå†ä¿å­˜ç‰ˆæœ¬ï¼ŒéªŒè¯å¤šä¸ªæ ‡è®°

### 3. æ•°æ®è¿ç§»æµ‹è¯•
- [ ] è¿è¡Œè¿ç§»è„šæœ¬
- [ ] éªŒè¯æ—§ä¼šè¯çš„å¯¹è¯å†å²æ˜¯å¦æ­£ç¡®è¿ç§»
- [ ] éªŒè¯æ—¶é—´æˆ³æ˜¯å¦ä¿ç•™
- [ ] éªŒè¯é¢å¤–æ•°æ®ï¼ˆå›¾è¡¨ã€å¼•ç”¨æ–‡å­—ç­‰ï¼‰æ˜¯å¦ä¿ç•™

## æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šä¿ç•™äº† `AnalysisSession.messages` å­—æ®µï¼Œç¡®ä¿æ—§ä»£ç ä»èƒ½å·¥ä½œ
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨æ•°æ®åº“ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼ˆ`session_id` + `created_at`ï¼‰
3. **æ•°æ®å®Œæ•´æ€§**ï¼šä½¿ç”¨å¤–é”®çº¦æŸç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **é”™è¯¯å¤„ç†**ï¼šè¿ç§»è„šæœ¬åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## åç»­ä¼˜åŒ–

1. **åˆ†é¡µåŠ è½½**ï¼šå½“å¯¹è¯å†å²å¾ˆé•¿æ—¶ï¼Œæ”¯æŒåˆ†é¡µæˆ–è™šæ‹Ÿæ»šåŠ¨
2. **æœç´¢åŠŸèƒ½**ï¼šåœ¨å¯¹è¯å†å²ä¸­æœç´¢å…³é”®è¯
3. **å¯¼å‡ºåŠŸèƒ½**ï¼šå¯¼å‡ºå¯¹è¯å†å²ä¸ºæ–‡æœ¬æˆ–PDF
4. **ç‰ˆæœ¬å¯¹æ¯”**ï¼šç‚¹å‡»ç‰ˆæœ¬æ ‡è®°å¯ä»¥æŸ¥çœ‹è¯¥ç‰ˆæœ¬çš„æŠ¥å‘Šå†…å®¹
5. **ç‰ˆæœ¬å›æ»š**ï¼šæ”¯æŒæ¢å¤åˆ°æŸä¸ªå†å²ç‰ˆæœ¬
