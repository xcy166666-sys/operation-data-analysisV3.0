# 保存版本功能 - 快速测试指南

## ✅ 已完成的修改

### 1. 前端修改（DataAnalysis.vue）

**按钮显示条件优化**：
- ❌ 之前：只有通过AI对话修改报告后才显示"保存版本"按钮
- ✅ 现在：只要有报告内容就显示"保存版本"按钮

**API调用修复**：
- ❌ 之前：使用错误的 `/api/v1/operation/save-version` 接口
- ✅ 现在：使用正确的 `createSessionVersion` API函数

**功能增强**：
- ✅ 点击按钮弹出输入框，可输入版本说明
- ✅ 自动生成版本号（V1, V2, V3...）
- ✅ 保存成功后显示版本号提示
- ✅ 保存报告文本、HTML图表、JSON图表配置

### 2. 后端状态

✅ 数据库表 `analysis_session_versions` 已存在
✅ API接口已实现：
- `POST /api/v1/operation/sessions/{id}/versions` - 创建版本
- `GET /api/v1/operation/sessions/{id}/versions` - 获取版本列表
- `GET /api/v1/operation/sessions/{id}/versions/{version_id}` - 获取版本详情

## 🚀 快速测试步骤

### 步骤1：启动前端（如果未运行）

```bash
cd frontend
npm run dev
```

访问：http://localhost:5173

### 步骤2：生成一个报告

1. 登录系统
2. 上传Excel文件
3. 输入分析需求
4. 点击"提交生成报告"
5. 等待报告生成完成

### 步骤3：测试保存版本

1. **查看按钮**：报告生成后，右上角应该显示"保存版本"按钮（黄色warning样式）

2. **点击保存**：
   - 点击"保存版本"按钮
   - 弹出输入框
   - 输入版本说明，例如："初始版本"
   - 点击"保存"

3. **验证结果**：
   - 应该显示成功提示："版本 V1 已保存"
   - 按钮仍然可用，可以继续保存更多版本

### 步骤4：修改报告后再次保存

1. **开启AI对话**：点击"AI对话"按钮
2. **修改报告**：通过对话修改报告内容
3. **保存新版本**：
   - 再次点击"保存版本"
   - 输入说明，例如："添加了新的分析章节"
   - 保存后应显示："版本 V2 已保存"

### 步骤5：查看版本历史

1. 在左侧历史会话列表中找到该会话
2. 点击会话右侧的 📄 图标
3. 应该看到版本列表展开，显示：
   - V2 - 添加了新的分析章节
   - V1 - 初始版本

4. 点击任意版本，应该加载该版本的报告内容

## 🔍 验证数据库

### 查看保存的版本

```bash
docker-compose exec postgres psql -U postgres -d operation_analysis_v2 -c "SELECT id, session_id, version_no, summary, created_at FROM analysis_session_versions ORDER BY created_at DESC LIMIT 10;"
```

**预期输出**：
```
 id | session_id | version_no |        summary         |       created_at
----+------------+------------+------------------------+------------------------
  2 |         13 |          2 | 添加了新的分析章节      | 2025-12-24 12:10:00
  1 |         13 |          1 | 初始版本               | 2025-12-24 12:05:00
```

### 查看版本详情

```bash
docker-compose exec postgres psql -U postgres -d operation_analysis_v2 -c "SELECT id, version_no, length(report_text) as text_length, length(report_html_charts) as html_length FROM analysis_session_versions WHERE session_id = 13;"
```

## 🎯 功能特点

### 1. 随时保存
- ✅ 不需要等到修改后才能保存
- ✅ 生成报告后立即可以保存第一个版本
- ✅ 每次修改后都可以保存新版本

### 2. 版本说明
- ✅ 可以输入自定义版本说明
- ✅ 如果不输入，自动使用时间戳
- ✅ 支持多行文本输入

### 3. 完整保存
- ✅ 保存报告文本内容
- ✅ 保存HTML图表
- ✅ 保存JSON图表配置
- ✅ 记录创建时间和创建人

### 4. 版本管理
- ✅ 自动递增版本号（V1, V2, V3...）
- ✅ 可以查看版本列表
- ✅ 可以切换到任意历史版本
- ✅ 显示当前版本标识

## 📝 按钮位置

"保存版本"按钮位于页面右上角，在以下按钮之间：
```
[返回首页] [批量分析] [定制化批量分析] [保存版本] [AI对话]
```

**样式**：
- 颜色：黄色（warning类型）
- 图标：📄 DocumentCopy
- 文字："保存版本"
- 加载状态：保存时显示loading动画

## ⚠️ 注意事项

### 1. 显示条件
按钮只在以下条件下显示：
- ✅ 有报告内容（`reportContent` 不为空）
- ✅ 有当前会话ID（`currentSessionId` 不为空）

### 2. 保存内容
每次保存包含：
- 当前的报告文本
- 当前的HTML图表
- 当前的JSON图表配置
- 版本说明（用户输入或自动生成）

### 3. 版本号规则
- 从1开始递增
- 每个会话独立计数
- 不会重复或跳号

## 🐛 常见问题

### Q1: 按钮不显示？
**检查**：
1. 是否已经生成了报告？
2. 浏览器控制台是否有错误？
3. 刷新页面并清除缓存（Ctrl+Shift+R）

### Q2: 保存失败？
**检查**：
1. 后端服务是否正常运行？
2. 数据库表是否已创建？
3. 查看浏览器控制台的错误信息
4. 查看后端日志：`docker-compose logs backend --tail=50`

### Q3: 版本列表不显示？
**检查**：
1. 是否点击了会话右侧的 📄 图标？
2. 该会话是否有保存过版本？
3. 刷新页面重试

## 🎉 测试成功标志

如果以下操作都成功，说明功能正常：

- ✅ 生成报告后看到"保存版本"按钮
- ✅ 点击按钮弹出输入框
- ✅ 输入说明后保存成功
- ✅ 显示"版本 V1 已保存"提示
- ✅ 可以继续保存更多版本
- ✅ 版本号自动递增（V2, V3...）
- ✅ 在版本列表中可以看到保存的版本
- ✅ 点击版本可以加载历史内容

## 📞 获取帮助

如果遇到问题：
1. 查看浏览器控制台（F12）
2. 查看后端日志：`docker-compose logs backend`
3. 查看数据库数据（使用上面的SQL命令）
4. 参考其他文档：
   - `报告版本历史功能-快速开始.md`
   - `报告版本历史功能-问题诊断与修复.md`

---

**祝测试顺利！** 🎉
