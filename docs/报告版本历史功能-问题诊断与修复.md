# æŠ¥å‘Šç‰ˆæœ¬å†å²åŠŸèƒ½ - é—®é¢˜è¯Šæ–­ä¸ä¿®å¤

## å®æ–½æ—¶é—´
2025-12-22

---

## åŠŸèƒ½æ¦‚è¿°

å®ç°ä¼šè¯ç‰ˆæœ¬å†å²ç®¡ç†åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·ï¼š
1. ç‚¹å‡»å†å²ä¼šè¯ï¼Œå±•å¼€æŸ¥çœ‹è¯¥ä¼šè¯çš„æ‰€æœ‰ç‰ˆæœ¬
2. ç‚¹å‡»æŸä¸ªç‰ˆæœ¬ï¼ŒåŠ è½½å¹¶æ˜¾ç¤ºè¯¥ç‰ˆæœ¬çš„æŠ¥å‘Šå†…å®¹
3. æ”¯æŒç‰ˆæœ¬ä¿å­˜å’Œå›æ»š

---

## å·²å®Œæˆçš„å·¥ä½œ âœ…

### 1. åç«¯å®ç°

#### 1.1 æ•°æ®åº“è¡¨ âœ…
**æ–‡ä»¶**: `backend/app/models/session_version.py`

å·²åˆ›å»º `AnalysisSessionVersion` æ¨¡å‹ï¼š
- `id` - ä¸»é”®
- `session_id` - ä¼šè¯IDï¼ˆå¤–é”®ï¼‰
- `version_no` - ç‰ˆæœ¬å·
- `summary` - ç‰ˆæœ¬æ‘˜è¦
- `report_text` - æŠ¥å‘Šæ–‡å­—
- `report_html_charts` - HTMLå›¾è¡¨
- `report_charts_json` - JSONå›¾è¡¨é…ç½®
- `created_at` - åˆ›å»ºæ—¶é—´
- `created_by` - åˆ›å»ºè€…

#### 1.2 æ•°æ®åº“è¿ç§» âœ…
**æ–‡ä»¶**: `backend/migrations/versions/20251222_add_session_versions_table.py`

å·²åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- åˆ›å»º `analysis_session_versions` è¡¨
- åˆ›å»ºç´¢å¼• `idx_session_versions_session_id_version_no`

#### 1.3 APIæ¥å£ âœ…
**æ–‡ä»¶**: `backend/app/api/v1/operation.py`

å·²å®ç°3ä¸ªAPIæ¥å£ï¼š
1. `GET /operation/sessions/{session_id}/versions` - è·å–ç‰ˆæœ¬åˆ—è¡¨
2. `GET /operation/sessions/{session_id}/versions/{version_id}` - è·å–ç‰ˆæœ¬è¯¦æƒ…
3. `POST /operation/sessions/{session_id}/versions` - ä¿å­˜æ–°ç‰ˆæœ¬

### 2. å‰ç«¯å®ç°

#### 2.1 APIå°è£… âœ…
**æ–‡ä»¶**: `frontend/src/api/operation.ts`

å·²å®ç°3ä¸ªAPIè°ƒç”¨å‡½æ•°ï¼š
- `getSessionVersions(sessionId)` - è·å–ç‰ˆæœ¬åˆ—è¡¨
- `getSessionVersionDetail(sessionId, versionId)` - è·å–ç‰ˆæœ¬è¯¦æƒ…
- `createSessionVersion(sessionId, payload)` - åˆ›å»ºæ–°ç‰ˆæœ¬

#### 2.2 HistorySidebarç»„ä»¶ âœ…
**æ–‡ä»¶**: `frontend/src/views/Operation/components/HistorySidebar.vue`

å·²å®ç°ç‰ˆæœ¬å±•å¼€åŠŸèƒ½ï¼š
- `toggleVersions()` - å±•å¼€/æŠ˜å ç‰ˆæœ¬åˆ—è¡¨
- `loadVersions()` - åŠ è½½ç‰ˆæœ¬åˆ—è¡¨
- `handleSelectVersion()` - é€‰æ‹©ç‰ˆæœ¬
- ç‰ˆæœ¬åˆ—è¡¨UIï¼ˆç‰ˆæœ¬å·ã€æ—¶é—´ã€æ‘˜è¦ã€å½“å‰æ ‡è®°ï¼‰

#### 2.3 DataAnalysisä¸»é¡µé¢ âœ…
**æ–‡ä»¶**: `frontend/src/views/Operation/DataAnalysis.vue`

å·²å®ç°ç‰ˆæœ¬åˆ‡æ¢å¤„ç†ï¼š
- `handleVersionSelected()` - å¤„ç†ç‰ˆæœ¬é€‰æ‹©äº‹ä»¶
- æ›´æ–°æŠ¥å‘Šå†…å®¹
- æ›´æ–°å›¾è¡¨æ˜¾ç¤º
- æ¸…ç©ºå¯¹è¯ä¸Šä¸‹æ–‡

---

## å‘ç°çš„é—®é¢˜ âŒ

### é—®é¢˜1ï¼šç‰ˆæœ¬é¢æ¿HTMLç»“æ„é”™è¯¯ ğŸ”´

**ä½ç½®**: `frontend/src/views/Operation/components/HistorySidebar.vue` (ç¬¬67-103è¡Œ)

**é—®é¢˜æè¿°**:
ç‰ˆæœ¬é¢æ¿ (`version-panel`) è¢«æ”¾åœ¨äº† `v-for` å¾ªç¯å¤–é¢ï¼Œå¯¼è‡´ï¼š
1. ç‰ˆæœ¬é¢æ¿æ— æ³•æ­£ç¡®å…³è”åˆ°å¯¹åº”çš„ä¼šè¯
2. åªä¼šæ˜¾ç¤ºæœ€åä¸€ä¸ªä¼šè¯çš„ç‰ˆæœ¬
3. ç‚¹å‡»å±•å¼€æŒ‰é’®åï¼Œç‰ˆæœ¬é¢æ¿ä½ç½®ä¸æ­£ç¡®

**å½“å‰é”™è¯¯ä»£ç **:
```vue
<div 
  v-for="session in filteredSessions" 
  :key="session.id"
  class="session-item"
  <!-- ... -->
>
  <!-- ä¼šè¯é¡¹å†…å®¹ -->
</div>
<!-- âŒ ç‰ˆæœ¬é¢æ¿åœ¨å¾ªç¯å¤–é¢ -->
<div 
  v-if="expandedSessionId === session.id" 
  class="version-panel"
>
  <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
</div>
```

**æ­£ç¡®çš„ç»“æ„åº”è¯¥æ˜¯**:
```vue
<template v-for="session in filteredSessions" :key="session.id">
  <div class="session-item">
    <!-- ä¼šè¯é¡¹å†…å®¹ -->
  </div>
  <!-- âœ… ç‰ˆæœ¬é¢æ¿åœ¨å¾ªç¯å†…éƒ¨ -->
  <div 
    v-if="expandedSessionId === session.id" 
    class="version-panel"
  >
    <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
  </div>
</template>
```

### é—®é¢˜2ï¼šç¼ºå°‘ç±»å‹å®šä¹‰ âš ï¸

**ä½ç½®**: `frontend/src/api/operation.ts`

**é—®é¢˜æè¿°**:
ç¼ºå°‘ `SessionVersionMeta` å’Œ `SessionVersionDetail` çš„TypeScriptç±»å‹å®šä¹‰

**éœ€è¦æ·»åŠ **:
```typescript
export interface SessionVersionMeta {
  id: number
  version_no: number
  summary?: string
  created_at: string
  is_current: boolean
}

export interface SessionVersionDetail {
  id: number
  version_no: number
  summary?: string
  report_text?: string
  report_html_charts?: string
  report_charts_json?: any
  created_at: string
}
```

### é—®é¢˜3ï¼šç¼ºå°‘åç«¯Pydanticæ¨¡å‹ âš ï¸

**ä½ç½®**: `backend/app/api/v1/operation.py`

**é—®é¢˜æè¿°**:
APIæ¥å£ä¸­ä½¿ç”¨äº† `SessionVersionMeta`ã€`SessionVersionDetail`ã€`CreateVersionRequest` ç­‰Pydanticæ¨¡å‹ï¼Œä½†è¿™äº›æ¨¡å‹å¯èƒ½æœªå®šä¹‰

**éœ€è¦æ£€æŸ¥**: `backend/app/schemas/` ç›®å½•ä¸‹æ˜¯å¦æœ‰å¯¹åº”çš„schemaå®šä¹‰

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šä¿®æ­£HistorySidebarçš„HTMLç»“æ„

**æ–‡ä»¶**: `frontend/src/views/Operation/components/HistorySidebar.vue`

**ä¿®æ”¹å†…å®¹**:
å°†ç‰ˆæœ¬é¢æ¿ç§»åˆ° `v-for` å¾ªç¯å†…éƒ¨ï¼Œä½¿ç”¨ `<template>` åŒ…è£¹

### ä¿®å¤2ï¼šæ·»åŠ TypeScriptç±»å‹å®šä¹‰

**æ–‡ä»¶**: `frontend/src/api/operation.ts`

**ä¿®æ”¹å†…å®¹**:
åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ç‰ˆæœ¬ç›¸å…³çš„æ¥å£å®šä¹‰

### ä¿®å¤3ï¼šæ£€æŸ¥å¹¶æ·»åŠ Pydanticæ¨¡å‹

**æ–‡ä»¶**: `backend/app/schemas/operation.py` æˆ–æ–°å»º `backend/app/schemas/session_version.py`

**ä¿®æ”¹å†…å®¹**:
æ·»åŠ ç‰ˆæœ¬ç›¸å…³çš„Pydanticæ¨¡å‹å®šä¹‰

### ä¿®å¤4ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

**å‘½ä»¤**:
```bash
# è¿›å…¥åç«¯å®¹å™¨
docker-compose exec backend bash

# è¿è¡Œè¿ç§»
alembic upgrade head
```

---

## å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®å¤å‰ç«¯HTMLç»“æ„ ğŸ”§

ä¿®æ”¹ `HistorySidebar.vue` çš„ä¼šè¯åˆ—è¡¨éƒ¨åˆ†

### æ­¥éª¤2ï¼šæ·»åŠ TypeScriptç±»å‹ ğŸ”§

åœ¨ `operation.ts` ä¸­æ·»åŠ ç±»å‹å®šä¹‰

### æ­¥éª¤3ï¼šæ£€æŸ¥åç«¯Schema ğŸ”

æ£€æŸ¥å¹¶æ·»åŠ å¿…è¦çš„Pydanticæ¨¡å‹

### æ­¥éª¤4ï¼šè¿è¡Œæ•°æ®åº“è¿ç§» ğŸ—„ï¸

æ‰§è¡Œ `alembic upgrade head`

### æ­¥éª¤5ï¼šæµ‹è¯•åŠŸèƒ½ âœ…

1. åˆ›å»ºæ–°ä¼šè¯å¹¶ç”ŸæˆæŠ¥å‘Š
2. ç‚¹å‡»ä¼šè¯æ—çš„å±•å¼€æŒ‰é’®
3. æŸ¥çœ‹ç‰ˆæœ¬åˆ—è¡¨æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
4. ç‚¹å‡»æŸä¸ªç‰ˆæœ¬ï¼ŒæŸ¥çœ‹æŠ¥å‘Šæ˜¯å¦æ­£ç¡®åŠ è½½

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šå±•å¼€ç‰ˆæœ¬åˆ—è¡¨
- [ ] ç‚¹å‡»ä¼šè¯çš„å±•å¼€æŒ‰é’®
- [ ] ç‰ˆæœ¬åˆ—è¡¨æ­£ç¡®æ˜¾ç¤ºåœ¨è¯¥ä¼šè¯ä¸‹æ–¹
- [ ] æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
- [ ] ç‰ˆæœ¬åˆ—è¡¨æŒ‰ç‰ˆæœ¬å·é™åºæ’åˆ—

### æµ‹è¯•2ï¼šç‰ˆæœ¬åˆ—è¡¨å†…å®¹
- [ ] æ˜¾ç¤ºç‰ˆæœ¬å·ï¼ˆV1, V2, V3...ï¼‰
- [ ] æ˜¾ç¤ºåˆ›å»ºæ—¶é—´
- [ ] æ˜¾ç¤ºç‰ˆæœ¬æ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] å½“å‰ç‰ˆæœ¬æœ‰"å½“å‰"æ ‡è®°

### æµ‹è¯•3ï¼šåˆ‡æ¢ç‰ˆæœ¬
- [ ] ç‚¹å‡»æŸä¸ªç‰ˆæœ¬
- [ ] æŠ¥å‘Šæ–‡å­—æ­£ç¡®æ›´æ–°
- [ ] å›¾è¡¨æ­£ç¡®æ›´æ–°
- [ ] æ˜¾ç¤ºæˆåŠŸæç¤º

### æµ‹è¯•4ï¼šæŠ˜å ç‰ˆæœ¬åˆ—è¡¨
- [ ] å†æ¬¡ç‚¹å‡»å±•å¼€æŒ‰é’®
- [ ] ç‰ˆæœ¬åˆ—è¡¨æ­£ç¡®æŠ˜å 
- [ ] ä¸é‡å¤è¯·æ±‚API

### æµ‹è¯•5ï¼šå¤šä¸ªä¼šè¯
- [ ] å±•å¼€ä¼šè¯Açš„ç‰ˆæœ¬
- [ ] å±•å¼€ä¼šè¯Bçš„ç‰ˆæœ¬
- [ ] ä¼šè¯Açš„ç‰ˆæœ¬è‡ªåŠ¨æŠ˜å 
- [ ] ç‰ˆæœ¬åˆ—è¡¨ä¸ä¼šæ··æ·†

---

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

1. **è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬** - åœ¨æŠ¥å‘Šç”Ÿæˆå®Œæˆæ—¶è‡ªåŠ¨ä¿å­˜ç¬¬ä¸€ä¸ªç‰ˆæœ¬
2. **ç‰ˆæœ¬å¯¹æ¯”** - æ”¯æŒå¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„å·®å¼‚
3. **ç‰ˆæœ¬å›æ»š** - æ·»åŠ "å›æ»šåˆ°æ­¤ç‰ˆæœ¬"åŠŸèƒ½
4. **ç‰ˆæœ¬åˆ é™¤** - æ”¯æŒåˆ é™¤æ—§ç‰ˆæœ¬

### ä¸­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼‰

1. **ç‰ˆæœ¬å‘½å** - å…è®¸ç”¨æˆ·ä¸ºç‰ˆæœ¬æ·»åŠ è‡ªå®šä¹‰åç§°
2. **ç‰ˆæœ¬æ ‡ç­¾** - æ”¯æŒä¸ºç‰ˆæœ¬æ·»åŠ æ ‡ç­¾ï¼ˆå¦‚"åˆç¨¿"ã€"ç»ˆç¨¿"ï¼‰
3. **ç‰ˆæœ¬å¯¼å‡º** - æ”¯æŒå¯¼å‡ºç‰¹å®šç‰ˆæœ¬çš„æŠ¥å‘Š
4. **ç‰ˆæœ¬æœç´¢** - æ”¯æŒæŒ‰æ—¶é—´ã€æ‘˜è¦æœç´¢ç‰ˆæœ¬

### é•¿æœŸï¼ˆ3ä¸ªæœˆå†…ï¼‰

1. **ç‰ˆæœ¬åˆ†æ”¯** - æ”¯æŒä»æŸä¸ªç‰ˆæœ¬åˆ›å»ºåˆ†æ”¯
2. **ç‰ˆæœ¬åˆå¹¶** - æ”¯æŒåˆå¹¶ä¸åŒåˆ†æ”¯çš„ç‰ˆæœ¬
3. **åä½œç‰ˆæœ¬** - æ”¯æŒå¤šäººåä½œç¼–è¾‘å’Œç‰ˆæœ¬ç®¡ç†
4. **ç‰ˆæœ¬æƒé™** - æ”¯æŒç‰ˆæœ¬çº§åˆ«çš„æƒé™æ§åˆ¶

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ¨¡å‹](../backend/app/models/session_version.py)
- [APIæ¥å£](../backend/app/api/v1/operation.py)
- [å‰ç«¯ç»„ä»¶](../frontend/src/views/Operation/components/HistorySidebar.vue)

---

## æ€»ç»“

ç‰ˆæœ¬å†å²åŠŸèƒ½çš„æ ¸å¿ƒæ¶æ„å·²ç»å®Œæˆï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ•°æ®åº“è¡¨å’Œæ¨¡å‹
- âœ… åç«¯APIæ¥å£
- âœ… å‰ç«¯APIå°è£…
- âœ… åŸºç¡€UIç»„ä»¶

**ä¸»è¦é—®é¢˜**ï¼š
- ğŸ”´ HTMLç»“æ„é”™è¯¯å¯¼è‡´ç‰ˆæœ¬é¢æ¿æ— æ³•æ­£ç¡®æ˜¾ç¤º
- âš ï¸ ç¼ºå°‘éƒ¨åˆ†ç±»å‹å®šä¹‰

**ä¸‹ä¸€æ­¥**ï¼š
1. ä¿®å¤HTMLç»“æ„é—®é¢˜
2. æ·»åŠ ç±»å‹å®šä¹‰
3. è¿è¡Œæ•°æ®åº“è¿ç§»
4. å…¨é¢æµ‹è¯•åŠŸèƒ½

ä¿®å¤è¿™äº›é—®é¢˜åï¼Œç‰ˆæœ¬å†å²åŠŸèƒ½å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼
