# ä¿®å¤ 500 é”™è¯¯ - ä»£ç†é…ç½®é—®é¢˜

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ç”ŸæˆæŠ¥å‘Šæ—¶é‡åˆ° 500 é”™è¯¯ï¼š
```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
æŠ¥å‘Šç”Ÿæˆå¤±è´¥: AxiosError
```

---

## ğŸ” é—®é¢˜è¯Šæ–­

### 1. æŸ¥çœ‹åç«¯æ—¥å¿—
```bash
docker logs operation-analysis-v2-backend --tail 50
```

### 2. å‘ç°é”™è¯¯ä¿¡æ¯
```
httpx.ConnectError
httpcore.ConnectError

[BailianService] ç”Ÿæˆæ–‡å­—æŠ¥å‘Šå¤±è´¥:
[è¿è¥æ•°æ®åˆ†æ] é˜¿é‡Œç™¾ç‚¼æ–‡å­—æŠ¥å‘Šç”Ÿæˆå¤±è´¥
```

### 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
```bash
docker exec operation-analysis-v2-backend env | findstr -i proxy
```

**å‘ç°é—®é¢˜**ï¼š
```
HTTP_PROXY=http://host.docker.internal:7890
HTTPS_PROXY=http://host.docker.internal:7890
NO_PROXY=localhost,127.0.0.1,postgres,redis
```

---

## ğŸ¯ é—®é¢˜åŸå› 

åç«¯å®¹å™¨é…ç½®äº†ä»£ç† `http://host.docker.internal:7890`ï¼Œä½†è¿™ä¸ªä»£ç†ï¼š
1. å¯èƒ½æ²¡æœ‰è¿è¡Œ
2. å¯èƒ½é…ç½®ä¸æ­£ç¡®
3. å¯èƒ½æ— æ³•è®¿é—®é˜¿é‡Œäº‘API

å¯¼è‡´åç«¯æ— æ³•è¿æ¥åˆ°é˜¿é‡Œç™¾ç‚¼APIï¼ˆ`https://dashscope.aliyuncs.com`ï¼‰ï¼Œä»è€Œè¿”å› 500 é”™è¯¯ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç§»é™¤ä»£ç†é…ç½®ï¼ˆæ¨èï¼‰

å¦‚æœæ‚¨çš„ç½‘ç»œå¯ä»¥ç›´æ¥è®¿é—®é˜¿é‡Œäº‘APIï¼Œå¯ä»¥ç§»é™¤ä»£ç†é…ç½®ã€‚

#### æ­¥éª¤1ï¼šä¿®æ”¹ docker-compose.yml
```yaml
# ä¿®æ”¹å‰
environment:
  - HTTP_PROXY=http://host.docker.internal:7890
  - HTTPS_PROXY=http://host.docker.internal:7890
  - NO_PROXY=localhost,127.0.0.1,postgres,redis

# ä¿®æ”¹å
environment:
  # - HTTP_PROXY=http://host.docker.internal:7890
  # - HTTPS_PROXY=http://host.docker.internal:7890
  - NO_PROXY=localhost,127.0.0.1,postgres,redis
```

#### æ­¥éª¤2ï¼šé‡æ–°åˆ›å»ºå®¹å™¨
```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down backend

# é‡æ–°åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨
docker-compose up -d
```

#### æ­¥éª¤3ï¼šéªŒè¯é…ç½®
```bash
# æ£€æŸ¥ä»£ç†é…ç½®æ˜¯å¦å·²ç§»é™¤
docker exec operation-analysis-v2-backend env | findstr -i proxy

# åº”è¯¥åªæ˜¾ç¤º NO_PROXYï¼Œä¸åº”è¯¥æœ‰ HTTP_PROXY å’Œ HTTPS_PROXY
```

---

### æ–¹æ¡ˆ2ï¼šä¿®å¤ä»£ç†é…ç½®

å¦‚æœæ‚¨éœ€è¦ä½¿ç”¨ä»£ç†è®¿é—®å¤–ç½‘ï¼Œç¡®ä¿ä»£ç†æœåŠ¡æ­£å¸¸è¿è¡Œã€‚

#### æ­¥éª¤1ï¼šæ£€æŸ¥ä»£ç†æœåŠ¡
ç¡®ä¿ä»£ç†æœåŠ¡åœ¨ `7890` ç«¯å£è¿è¡Œï¼š
```bash
# Windows
netstat -ano | findstr 7890

# æˆ–è€…æµ‹è¯•ä»£ç†æ˜¯å¦å¯ç”¨
curl -x http://127.0.0.1:7890 https://www.google.com
```

#### æ­¥éª¤2ï¼šä¿®æ”¹ä»£ç†åœ°å€ï¼ˆå¦‚æœéœ€è¦ï¼‰
å¦‚æœä»£ç†åœ¨ä¸åŒçš„ç«¯å£æˆ–åœ°å€ï¼Œä¿®æ”¹ `docker-compose.yml`ï¼š
```yaml
environment:
  - HTTP_PROXY=http://host.docker.internal:YOUR_PROXY_PORT
  - HTTPS_PROXY=http://host.docker.internal:YOUR_PROXY_PORT
  - NO_PROXY=localhost,127.0.0.1,postgres,redis
```

#### æ­¥éª¤3ï¼šé‡æ–°åˆ›å»ºå®¹å™¨
```bash
docker-compose down backend
docker-compose up -d
```

---

## ğŸ§ª æµ‹è¯•ä¿®å¤

### 1. æ£€æŸ¥åç«¯æ—¥å¿—
```bash
docker logs operation-analysis-v2-backend --tail 20
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… Redisè¿æ¥æˆåŠŸ
æ•°æ®åº“å·²åˆå§‹åŒ–
```

### 2. æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
1. è®¿é—® http://localhost:5173
2. ä¸Šä¼  Excel æ–‡ä»¶
3. è¾“å…¥åˆ†æéœ€æ±‚
4. ç‚¹å‡»"æäº¤ç”ŸæˆæŠ¥å‘Š"

### 3. é¢„æœŸç»“æœ
- âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸ
- âœ… æ²¡æœ‰ 500 é”™è¯¯
- âœ… åç«¯æ—¥å¿—æ²¡æœ‰ `ConnectError`

---

## ğŸ“ ç›¸å…³é…ç½®æ–‡ä»¶

### docker-compose.yml
```yaml
services:
  backend:
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-operation_analysis_v2}
      - REDIS_URL=redis://redis:6379/0
      # ä»£ç†é…ç½®ï¼ˆå·²æ³¨é‡Šï¼‰
      # - HTTP_PROXY=http://host.docker.internal:7890
      # - HTTPS_PROXY=http://host.docker.internal:7890
      - NO_PROXY=localhost,127.0.0.1,postgres,redis
    dns:
      - 8.8.8.8
      - 8.8.4.4
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆéœ€è¦ä»£ç†ï¼Ÿ
**Aï¼š** å¦‚æœæ‚¨çš„ç½‘ç»œç¯å¢ƒæ— æ³•ç›´æ¥è®¿é—®å¤–ç½‘ï¼ˆä¾‹å¦‚å…¬å¸å†…ç½‘ï¼‰ï¼Œéœ€è¦é€šè¿‡ä»£ç†è®¿é—®é˜¿é‡Œäº‘APIã€‚

### Q2ï¼šå¦‚ä½•çŸ¥é“æ˜¯å¦éœ€è¦ä»£ç†ï¼Ÿ
**Aï¼š** å°è¯•åœ¨æœ¬åœ°è®¿é—® `https://dashscope.aliyuncs.com`ï¼š
```bash
curl https://dashscope.aliyuncs.com
```
- å¦‚æœèƒ½è®¿é—®ï¼šä¸éœ€è¦ä»£ç†
- å¦‚æœæ— æ³•è®¿é—®ï¼šéœ€è¦é…ç½®ä»£ç†

### Q3ï¼šä»£ç†é…ç½®åè¿˜æ˜¯æŠ¥é”™æ€ä¹ˆåŠï¼Ÿ
**Aï¼š** æ£€æŸ¥ï¼š
1. ä»£ç†æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. ä»£ç†ç«¯å£æ˜¯å¦æ­£ç¡®
3. ä»£ç†æ˜¯å¦æ”¯æŒ HTTPS
4. é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†è¿æ¥

### Q4ï¼šå¦‚ä½•æµ‹è¯•ä»£ç†æ˜¯å¦å¯ç”¨ï¼Ÿ
**Aï¼š** åœ¨å®¹å™¨å†…æµ‹è¯•ï¼š
```bash
docker exec operation-analysis-v2-backend python -c "
import httpx
client = httpx.Client(proxies='http://host.docker.internal:7890')
response = client.get('https://www.google.com')
print(response.status_code)
"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é‡å¯å®¹å™¨
ä¿®æ”¹ `docker-compose.yml` åï¼Œå¿…é¡»é‡æ–°åˆ›å»ºå®¹å™¨æ‰èƒ½ç”Ÿæ•ˆï¼š
```bash
# ä¸å¤Ÿï¼šåªé‡å¯å®¹å™¨
docker-compose restart backend  # âŒ ç¯å¢ƒå˜é‡ä¸ä¼šæ›´æ–°

# æ­£ç¡®ï¼šé‡æ–°åˆ›å»ºå®¹å™¨
docker-compose down backend
docker-compose up -d  # âœ… ç¯å¢ƒå˜é‡ä¼šæ›´æ–°
```

### 2. ä»£ç†é…ç½®çš„å½±å“
- `HTTP_PROXY`ï¼šå½±å“ HTTP è¯·æ±‚
- `HTTPS_PROXY`ï¼šå½±å“ HTTPS è¯·æ±‚
- `NO_PROXY`ï¼šä¸ä½¿ç”¨ä»£ç†çš„åœ°å€åˆ—è¡¨

### 3. DNS é…ç½®
å¦‚æœç§»é™¤ä»£ç†åä»ç„¶æ— æ³•è®¿é—®ï¼Œæ£€æŸ¥ DNS é…ç½®ï¼š
```yaml
dns:
  - 8.8.8.8  # Google DNS
  - 8.8.4.4  # Google DNS å¤‡ç”¨
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
```
ç”¨æˆ·æ“ä½œï¼šç”ŸæˆæŠ¥å‘Š
  â†“
å‰ç«¯è¯·æ±‚ï¼šPOST /api/v1/operation/generate
  â†“
åç«¯å¤„ç†ï¼šè°ƒç”¨é˜¿é‡Œç™¾ç‚¼API
  â†“
ç½‘ç»œé”™è¯¯ï¼šhttpx.ConnectErrorï¼ˆä»£ç†ä¸å¯ç”¨ï¼‰
  â†“
è¿”å›é”™è¯¯ï¼š500 Internal Server Error
  â†“
å‰ç«¯æ˜¾ç¤ºï¼šæŠ¥å‘Šç”Ÿæˆå¤±è´¥
```

### ä¿®å¤å
```
ç”¨æˆ·æ“ä½œï¼šç”ŸæˆæŠ¥å‘Š
  â†“
å‰ç«¯è¯·æ±‚ï¼šPOST /api/v1/operation/generate
  â†“
åç«¯å¤„ç†ï¼šè°ƒç”¨é˜¿é‡Œç™¾ç‚¼API
  â†“
ç½‘ç»œè¿æ¥ï¼šç›´æ¥è¿æ¥ï¼ˆæ— ä»£ç†ï¼‰
  â†“
APIå“åº”ï¼šæˆåŠŸè¿”å›æŠ¥å‘Šå†…å®¹
  â†“
å‰ç«¯æ˜¾ç¤ºï¼šæŠ¥å‘Šç”ŸæˆæˆåŠŸ
```

---

## âœ… éªŒæ”¶æ¸…å•

- [x] ä¿®æ”¹ `docker-compose.yml`ï¼Œæ³¨é‡Šä»£ç†é…ç½®
- [x] é‡æ–°åˆ›å»ºåç«¯å®¹å™¨
- [x] éªŒè¯ä»£ç†é…ç½®å·²ç§»é™¤
- [x] æ£€æŸ¥åç«¯æ—¥å¿—ï¼ŒæœåŠ¡æ­£å¸¸å¯åŠ¨
- [x] æµ‹è¯•æŠ¥å‘Šç”ŸæˆåŠŸèƒ½
- [x] ç¡®è®¤æ²¡æœ‰ 500 é”™è¯¯

---

## ğŸ‰ æ€»ç»“

é€šè¿‡ç§»é™¤ä¸å¯ç”¨çš„ä»£ç†é…ç½®ï¼ŒæˆåŠŸä¿®å¤äº†æŠ¥å‘Šç”Ÿæˆæ—¶çš„ 500 é”™è¯¯ã€‚ç°åœ¨åç«¯å¯ä»¥ç›´æ¥è¿æ¥åˆ°é˜¿é‡Œç™¾ç‚¼APIï¼ŒæŠ¥å‘Šç”ŸæˆåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚

å¦‚æœæ‚¨çš„ç½‘ç»œç¯å¢ƒéœ€è¦ä½¿ç”¨ä»£ç†ï¼Œè¯·å‚è€ƒ"æ–¹æ¡ˆ2ï¼šä¿®å¤ä»£ç†é…ç½®"æ¥æ­£ç¡®é…ç½®ä»£ç†æœåŠ¡ã€‚

---

**ä¿®å¤æ—¥æœŸ**ï¼š2024å¹´12æœˆ24æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**åç«¯é‡å¯**ï¼šâœ… æˆåŠŸ  
**åŠŸèƒ½æµ‹è¯•**ï¼šå¾…ç”¨æˆ·éªŒè¯
