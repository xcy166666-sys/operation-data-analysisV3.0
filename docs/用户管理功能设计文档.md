# 管理员用户管理功能设计文档

## 1. 功能概述

为运营数据分析平台添加管理员用户管理功能，允许管理员对使用该系统的用户进行基本的增删改查操作。

## 2. 功能需求

### 2.1 核心功能（简化版）
- ✅ 用户列表查看（分页、搜索）
- ✅ 创建新用户
- ✅ 编辑用户信息
- ✅ 删除用户

### 2.2 权限控制
- 仅管理员（`is_admin = True`）可以访问用户管理功能
- 管理员不能删除自己

### 2.3 登录界面设计
- 在普通用户登录界面添加"管理员登录"按钮
- 点击按钮切换到管理员登录界面
- 管理员使用自己的账号（`is_admin = True`）登录
- 登录成功后根据用户权限自动跳转到相应页面

## 3. 技术架构

### 3.1 后端设计

#### 3.1.1 API 路由设计

**文件位置**: `backend/app/api/v1/users.py`

**路由前缀**: `/api/v1/users`

| 方法 | 路径 | 功能 | 权限要求 |
|------|------|------|----------|
| GET | `/users` | 获取用户列表（分页、搜索） | 管理员 |
| POST | `/users` | 创建新用户 | 管理员 |
| PUT | `/users/{user_id}` | 更新用户信息 | 管理员 |
| DELETE | `/users/{user_id}` | 删除用户 | 管理员 |

#### 3.1.2 数据模型（已存在）

**文件位置**: `backend/app/models/user.py`

```python
class User(Base):
    id: int
    username: str (唯一, 最小长度3)
    password_hash: str
    email: str (可选)
    full_name: str (可选)
    is_active: bool (默认True)
    is_admin: bool (默认False)
    created_at: datetime
    updated_at: datetime
    last_login_at: datetime (可选)
```

#### 3.1.3 Schema 设计

**文件位置**: `backend/app/schemas/user.py` (新建)

```python
# 请求Schema
class UserCreate(BaseModel):
    username: str (必填, 最小长度3, 最大长度50)
    password: str (必填, 最小长度6)
    email: Optional[str] (可选, 邮箱格式验证)
    full_name: Optional[str] (可选, 最大长度100)

class UserUpdate(BaseModel):
    email: Optional[str]
    full_name: Optional[str]

class UserListQuery(BaseModel):
    page: int = 1 (最小1)
    page_size: int = 20 (最小1, 最大100)
    search: Optional[str] (搜索用户名、邮箱、全名)

# 响应Schema
class UserResponse(BaseModel):
    id: int
    username: str
    email: Optional[str]
    full_name: Optional[str]
    is_active: bool
    is_admin: bool
    created_at: datetime
    updated_at: datetime
    last_login_at: Optional[datetime]
```

#### 3.1.4 权限依赖

**文件位置**: `backend/app/auth/dependencies.py` (已存在)

使用现有的 `get_current_superadmin` 依赖函数。

### 3.2 前端设计

#### 3.2.1 页面结构

**文件位置**: `frontend/src/views/Admin/UserManagement.vue` (新建)

**页面布局**:
```
┌─────────────────────────────────────────┐
│  用户管理 (标题)              [返回首页] │
├─────────────────────────────────────────┤
│  搜索和操作栏                            │
│  [搜索框]                    [创建用户]  │
├─────────────────────────────────────────┤
│  用户列表表格                            │
│  ID | 用户名 | 邮箱 | 全名 | 创建时间   │
│  ─────────────────────────────────────  │
│  1  | admin  | ...  | ...  | 2024-01-01 │
│  2  | user1  | ...  | ...  | 2024-01-02 │
│  ...                                    │
│  [分页控件]                              │
└─────────────────────────────────────────┘
```

#### 3.2.2 路由配置

**文件位置**: `frontend/src/router/index.ts`

```typescript
{
  path: '/admin/users',
  name: 'admin-users',
  component: () => import('@/views/Admin/UserManagement.vue'),
  meta: { 
    requiresAuth: true, 
    requiresAdmin: true,  // 新增：需要管理员权限
    title: '用户管理' 
  }
}
```

#### 3.2.3 API 服务

**文件位置**: `frontend/src/api/user.ts` (新建)

```typescript
// 用户管理相关API
export function getUserList(params: UserListQuery): Promise<ApiResponse>
export function createUser(data: UserCreate): Promise<ApiResponse>
export function updateUser(userId: number, data: UserUpdate): Promise<ApiResponse>
export function deleteUser(userId: number): Promise<ApiResponse>
```

#### 3.2.4 类型定义

**文件位置**: `frontend/src/types/index.ts` (扩展)

```typescript
export interface UserListQuery {
  page?: number
  page_size?: number
  search?: string
}

export interface UserCreate {
  username: string
  password: string
  email?: string
  full_name?: string
}

export interface UserUpdate {
  email?: string
  full_name?: string
}
```

#### 3.2.5 登录界面设计

**文件位置**: `frontend/src/views/Login.vue` (更新)

**普通用户登录界面布局**:
```
┌─────────────────────────────────────────┐
│  运营数据分析系统                       │
│  登录您的账户                           │
├─────────────────────────────────────────┤
│  [用户名输入框]                         │
│  [密码输入框]                           │
│  [登录按钮]                             │
├─────────────────────────────────────────┤
│  [切换到管理员登录] 按钮                 │
└─────────────────────────────────────────┘
```

**管理员登录界面布局**:
```
┌─────────────────────────────────────────┐
│  运营数据分析系统 - 管理员登录           │
│  使用管理员账号登录                     │
├─────────────────────────────────────────┤
│  [用户名输入框]                         │
│  [密码输入框]                           │
│  [登录按钮]                             │
├─────────────────────────────────────────┤
│  [返回普通登录] 按钮                    │
└─────────────────────────────────────────┘
```

**功能说明**:
- 普通登录界面：显示"切换到管理员登录"按钮（文字按钮，位于登录按钮下方）
- 管理员登录界面：显示"返回普通登录"按钮（文字按钮，位于登录按钮下方）
- 两个界面共享同一个登录API，登录后根据用户`is_admin`字段判断权限
- 管理员登录成功后，如果用户是管理员，跳转到首页（显示用户管理入口）
- 普通用户登录成功后，跳转到首页（不显示用户管理入口）

#### 3.2.6 导航菜单

在首页添加管理员入口（仅管理员可见）：

**文件位置**: `frontend/src/views/Home.vue`

```vue
<el-button 
  v-if="authStore.isSuperadmin"
  type="primary"
  :icon="User"
  @click="goToUserManagement"
>
  用户管理
</el-button>
```

## 4. 功能详细设计

### 4.0 登录界面设计

#### 4.0.1 普通用户登录界面

**界面元素**:
- 标题："运营数据分析系统"
- 副标题："登录您的账户"
- 用户名输入框（必填）
- 密码输入框（必填，显示/隐藏切换）
- 登录按钮（主色调，全宽）
- "切换到管理员登录"按钮（文字按钮，位于登录按钮下方，居中显示）

**交互流程**:
1. 用户输入用户名和密码
2. 点击"登录"按钮或按Enter键
3. 调用登录API
4. 登录成功后，根据用户权限跳转：
   - 管理员：跳转到首页（显示用户管理入口）
   - 普通用户：跳转到首页（不显示用户管理入口）

#### 4.0.2 管理员登录界面

**界面元素**:
- 标题："运营数据分析系统 - 管理员登录"
- 副标题："使用管理员账号登录"
- 用户名输入框（必填）
- 密码输入框（必填，显示/隐藏切换）
- 登录按钮（主色调，全宽）
- "返回普通登录"按钮（文字按钮，位于登录按钮下方，居中显示）

**交互流程**:
1. 管理员输入用户名和密码
2. 点击"登录"按钮或按Enter键
3. 调用登录API
4. 验证用户是否为管理员（`is_admin = True`）
5. 如果不是管理员，显示错误提示："该账号不是管理员账号"
6. 如果是管理员，登录成功后跳转到首页（显示用户管理入口）

#### 4.0.3 界面切换

**切换方式**:
- 使用路由参数或组件状态来区分普通登录和管理员登录
- 推荐使用路由参数：`/login`（普通登录）和`/login?admin=true`（管理员登录）
- 或使用组件内部状态切换显示内容

**按钮样式**:
- "切换到管理员登录"按钮：
  - 类型：文字按钮（text）
  - 颜色：主色调
  - 位置：登录按钮下方，居中
  - 图标：可选（User图标）
  
- "返回普通登录"按钮：
  - 类型：文字按钮（text）
  - 颜色：次要色调
  - 位置：登录按钮下方，居中
  - 图标：可选（ArrowLeft图标）

### 4.1 用户列表页面

#### 4.1.1 页面头部
- 标题："用户管理"（左侧）
- 返回首页按钮（右上角，使用 ArrowLeft 图标）

#### 4.1.2 搜索和操作栏
- **搜索框**（左侧）：
  - 支持搜索用户名、邮箱、全名
  - 实时搜索（输入后自动触发搜索）
  - 占位符："搜索用户名、邮箱或全名"
  
- **创建用户按钮**（右侧）：
  - 主色调按钮
  - 图标：Plus
  - 文字："创建用户"

#### 4.1.3 用户表格
**表格列**：
- **ID**：用户ID（宽度80px）
- **用户名**：用户名（宽度150px）
- **邮箱**：邮箱地址（宽度200px，为空显示"-"）
- **全名**：用户全名（宽度150px，为空显示"-"）
- **创建时间**：格式化显示，如"2024-01-01 12:00:00"（宽度180px）
- **操作**：操作按钮（宽度150px）
  - 编辑按钮（文字按钮，primary类型）
  - 删除按钮（文字按钮，danger类型）

**表格特性**：
- 分页显示（每页20条，底部显示分页控件）
- 空状态提示："暂无用户数据"
- 加载状态：显示加载动画
- 表格样式：使用 Element Plus 的 el-table 组件

### 4.2 创建/编辑用户对话框

#### 4.2.1 对话框布局
- 宽度：500px
- 标题：创建用户时为"创建用户"，编辑时为"编辑用户"
- 关闭按钮：右上角X按钮

#### 4.2.2 表单字段
**创建用户表单**：
```
┌─────────────────────────────┐
│ 用户名 *                    │
│ [输入框]                    │
│                             │
│ 密码 *                      │
│ [密码输入框]                │
│                             │
│ 邮箱                        │
│ [输入框]                    │
│                             │
│ 全名                        │
│ [输入框]                    │
│                             │
│        [取消]  [确定]       │
└─────────────────────────────┘
```

**编辑用户表单**：
```
┌─────────────────────────────┐
│ 用户名                      │
│ [只读输入框，显示用户名]     │
│                             │
│ 邮箱                        │
│ [输入框]                    │
│                             │
│ 全名                        │
│ [输入框]                    │
│                             │
│        [取消]  [确定]       │
└─────────────────────────────┘
```

#### 4.2.3 验证规则
- **用户名**（创建时）：
  - 必填
  - 3-50字符
  - 只能包含字母、数字、下划线
  - 实时验证唯一性
  
- **密码**（创建时）：
  - 必填
  - 最小6位
  - 显示密码强度提示
  
- **邮箱**（可选）：
  - 如果填写，必须是有效的邮箱格式
  - 使用正则表达式验证

- **全名**（可选）：
  - 最大长度100字符

#### 4.2.4 表单验证提示
- 实时验证，显示错误信息
- 提交前验证所有必填项
- 用户名重复时显示错误提示

### 4.3 操作功能

#### 4.3.1 删除用户
- 点击删除按钮弹出确认对话框
- 对话框内容：
  - 标题："确认删除"
  - 内容："确定要删除用户 '{username}' 吗？此操作不可恢复，将同时删除该用户的所有数据。"
  - 按钮：取消、确定（danger类型）
- 确认后删除用户
- 级联删除用户相关的所有数据（分析会话、批量分析会话等）
- 不能删除自己：
  - 如果当前用户是自己，删除按钮禁用
  - 或显示提示："不能删除自己"

#### 4.3.2 编辑用户
- 点击编辑按钮打开编辑对话框
- 预填充当前用户信息
- 只能修改邮箱和全名
- 用户名显示为只读（不可修改）

#### 4.3.3 创建用户
- 点击"创建用户"按钮打开创建对话框
- 表单为空，等待用户输入
- 提交后刷新用户列表

### 4.4 页面交互流程

#### 4.4.1 页面加载
1. 检查管理员权限
2. 加载用户列表（第一页）
3. 显示加载状态
4. 数据加载完成后显示表格

#### 4.4.2 搜索流程
1. 用户在搜索框输入
2. 防抖处理（500ms延迟）
3. 调用API搜索
4. 更新表格数据
5. 重置到第一页

#### 4.4.3 创建用户流程
1. 点击"创建用户"按钮
2. 打开创建对话框
3. 填写表单信息
4. 点击"确定"提交
5. 验证表单
6. 调用创建API
7. 成功后关闭对话框
8. 刷新用户列表
9. 显示成功提示

#### 4.4.4 编辑用户流程
1. 点击表格中的"编辑"按钮
2. 打开编辑对话框
3. 预填充用户信息
4. 修改邮箱或全名
5. 点击"确定"提交
6. 验证表单
7. 调用更新API
8. 成功后关闭对话框
9. 刷新用户列表
10. 显示成功提示

#### 4.4.5 删除用户流程
1. 点击表格中的"删除"按钮
2. 弹出确认对话框
3. 用户确认删除
4. 调用删除API
5. 成功后刷新用户列表
6. 显示成功提示

## 5. 安全考虑

### 5.1 权限验证
- 所有API端点都需要管理员权限
- 前端路由守卫检查管理员权限
- 后端依赖注入验证管理员权限
- 管理员登录时验证用户`is_admin`字段，非管理员账号不能通过管理员登录界面登录

### 5.2 数据保护
- 密码使用哈希存储，不返回明文
- 删除操作需要二次确认
- 防止管理员误操作（不能删除自己）

### 5.3 输入验证
- 所有用户输入进行验证和清理
- 防止SQL注入和XSS攻击
- 用户名唯一性检查

## 6. 实现步骤

### 阶段1：后端API开发
1. 创建 `backend/app/schemas/user.py`
2. 创建 `backend/app/api/v1/users.py`
3. 实现4个API端点（列表、创建、更新、删除）
4. 添加权限验证
5. 添加输入验证

### 阶段2：前端页面开发
1. 更新 `frontend/src/views/Login.vue`（添加管理员登录界面切换）
2. 创建 `frontend/src/api/user.ts`
3. 创建 `frontend/src/views/Admin/UserManagement.vue`
4. 实现用户列表表格
5. 实现创建/编辑用户对话框
6. 添加路由配置
7. 添加路由守卫（管理员权限检查）
8. 在首页添加管理员入口

### 阶段3：集成测试
1. 测试所有功能
2. 测试权限控制
3. 测试边界情况
4. 性能优化

## 7. 数据库变更

无需数据库迁移，使用现有的 `users` 表。

## 8. 文件清单

### 后端文件
- `backend/app/schemas/user.py` (新建)
- `backend/app/api/v1/users.py` (新建)
- `backend/app/api/v1/__init__.py` (更新，注册新路由)

### 前端文件
- `frontend/src/api/user.ts` (新建)
- `frontend/src/views/Admin/UserManagement.vue` (新建，包含列表和对话框)
- `frontend/src/views/Login.vue` (更新，添加管理员登录界面切换)
- `frontend/src/types/index.ts` (更新，添加类型定义)
- `frontend/src/router/index.ts` (更新，添加路由和守卫)
- `frontend/src/views/Home.vue` (更新，添加管理员入口)

## 9. 后续扩展

- 用户角色系统（多角色）
- 用户权限细粒度控制
- 用户操作日志
- 批量操作（批量删除、批量启用/禁用）
- 用户导入/导出功能


