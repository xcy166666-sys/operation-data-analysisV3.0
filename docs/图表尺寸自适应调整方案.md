# å›¾è¡¨å°ºå¯¸è‡ªé€‚åº”è°ƒæ•´æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

å½“å‰HTMLå›¾è¡¨åœ¨iframeä¸­æ˜¾ç¤ºæ—¶ï¼Œå¯èƒ½å‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š
1. **æ¯”ä¾‹ä¸åè°ƒ**ï¼šå›¾è¡¨è¿‡äºæ‰å¹³æˆ–è¿‡é«˜
2. **å°ºå¯¸ä¸åˆé€‚**ï¼šå›¾è¡¨å¤ªå°çœ‹ä¸æ¸…æˆ–å¤ªå¤§å ç”¨è¿‡å¤šç©ºé—´
3. **æ•°æ®ç‚¹è¿‡å¤š**ï¼šæ¨ªå‘æ•°æ®ç‚¹è¿‡å¤šå¯¼è‡´å›¾è¡¨è¢«å‹ç¼©
4. **å“åº”å¼é—®é¢˜**ï¼šä¸åŒå±å¹•å°ºå¯¸ä¸‹æ˜¾ç¤ºæ•ˆæœä¸ä½³

## ğŸ¯ è§£å†³æ–¹æ¡ˆï¼šå‰ç«¯æ™ºèƒ½è‡ªé€‚åº”è°ƒæ•´

### æ ¸å¿ƒæ€è·¯

**ä¸ä¾èµ–ç”¨æˆ·promptï¼Œå®Œå…¨ç”±å‰ç«¯è‡ªåŠ¨æ£€æµ‹å’Œè°ƒæ•´**ï¼š
- å‰ç«¯æ£€æµ‹iframeå†…å®¹çš„å®é™…å°ºå¯¸
- æ ¹æ®å†…å®¹ç±»å‹ï¼ˆå›¾è¡¨ã€è¡¨æ ¼ç­‰ï¼‰æ™ºèƒ½è°ƒæ•´
- ä¿æŒåˆç†çš„å®½é«˜æ¯”
- å¤„ç†æ¨ªå‘æ»šåŠ¨æƒ…å†µ
- å“åº”å¼é€‚é…ä¸åŒå±å¹•

## ğŸ—ï¸ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. å°ºå¯¸æ£€æµ‹ç­–ç•¥

#### 1.1 å†…å®¹å°ºå¯¸æ£€æµ‹
```typescript
// æ£€æµ‹iframeå†…å®¹çš„å®é™…å°ºå¯¸
const detectContentSize = (iframe: HTMLIFrameElement) => {
  try {
    const doc = iframe.contentDocument || iframe.contentWindow?.document
    if (!doc) return null
    
    // è·å–å®é™…å†…å®¹å°ºå¯¸
    const body = doc.body
    const html = doc.documentElement
    
    return {
      scrollWidth: Math.max(body.scrollWidth, html.scrollWidth),
      scrollHeight: Math.max(body.scrollHeight, html.scrollHeight),
      clientWidth: Math.max(body.clientWidth, html.clientWidth),
      clientHeight: Math.max(body.clientHeight, html.clientHeight),
      offsetWidth: body.offsetWidth,
      offsetHeight: body.offsetHeight
    }
  } catch (e) {
    return null // è·¨åŸŸé™åˆ¶
  }
}
```

#### 1.2 å›¾è¡¨å®¹å™¨æ£€æµ‹
```typescript
// æ£€æµ‹å›¾è¡¨å®¹å™¨çš„å°ºå¯¸ï¼ˆEChartsã€Chart.jsç­‰ï¼‰
const detectChartSize = (doc: Document) => {
  // æ£€æµ‹å¸¸è§çš„å›¾è¡¨å®¹å™¨
  const chartSelectors = [
    'canvas',           // ECharts, Chart.js
    '#chart',           // é€šç”¨å›¾è¡¨ID
    '.chart',           // é€šç”¨å›¾è¡¨ç±»
    '[id*="chart"]',   // åŒ…å«chartçš„ID
    '[class*="chart"]'  // åŒ…å«chartçš„ç±»
  ]
  
  for (const selector of chartSelectors) {
    const element = doc.querySelector(selector)
    if (element) {
      return {
        width: element.offsetWidth || element.clientWidth,
        height: element.offsetHeight || element.clientHeight,
        aspectRatio: (element.offsetWidth || 1) / (element.offsetHeight || 1)
      }
    }
  }
  
  return null
}
```

### 2. æ™ºèƒ½è°ƒæ•´ç®—æ³•

#### 2.1 é«˜åº¦è°ƒæ•´ç­–ç•¥

```typescript
const calculateOptimalHeight = (
  contentSize: ContentSize,
  containerWidth: number,
  minHeight: number = 600,
  maxHeight: number = 1200
): number => {
  // 1. ä½¿ç”¨å†…å®¹å®é™…é«˜åº¦
  let height = contentSize.scrollHeight
  
  // 2. å¦‚æœæ£€æµ‹åˆ°å›¾è¡¨å®¹å™¨ï¼Œä½¿ç”¨å›¾è¡¨é«˜åº¦
  if (contentSize.chartSize) {
    const chartHeight = contentSize.chartSize.height
    // å›¾è¡¨é«˜åº¦ + å…¶ä»–å†…å®¹ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ç­‰ï¼‰çš„é¢„ä¼°é«˜åº¦
    height = chartHeight + 100 // é¢„ç•™100pxç»™å…¶ä»–å†…å®¹
  }
  
  // 3. æ ¹æ®å®½é«˜æ¯”è°ƒæ•´ï¼ˆå¦‚æœå†…å®¹å®½åº¦è¶…è¿‡å®¹å™¨ï¼Œå¯èƒ½éœ€è¦æ›´å¤šé«˜åº¦ï¼‰
  if (contentSize.scrollWidth > containerWidth) {
    // å†…å®¹è¾ƒå®½ï¼Œå¯èƒ½éœ€è¦æ›´å¤šé«˜åº¦æ¥é¿å…è¿‡åº¦å‹ç¼©
    const aspectRatio = contentSize.scrollWidth / containerWidth
    if (aspectRatio > 1.5) {
      // å†…å®¹å®½åº¦æ˜¯å®¹å™¨çš„1.5å€ä»¥ä¸Šï¼Œå¢åŠ é«˜åº¦
      height = Math.max(height, containerWidth * 0.7) // ä¿æŒ0.7çš„å®½é«˜æ¯”
    }
  }
  
  // 4. åº”ç”¨æœ€å°å’Œæœ€å¤§é«˜åº¦é™åˆ¶
  height = Math.max(minHeight, Math.min(maxHeight, height))
  
  return Math.ceil(height)
}
```

#### 2.2 å®½åº¦å¤„ç†ç­–ç•¥

```typescript
const handleWidth = (
  iframe: HTMLIFrameElement,
  contentSize: ContentSize,
  containerWidth: number
) => {
  // iframeå®½åº¦å§‹ç»ˆ100%ï¼Œç”±CSSæ§åˆ¶
  // å¦‚æœå†…å®¹å®½åº¦è¶…è¿‡å®¹å™¨ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼š
  
  if (contentSize.scrollWidth > containerWidth) {
    const overflowRatio = contentSize.scrollWidth / containerWidth
    
    if (overflowRatio > 2.0) {
      // å†…å®¹å®½åº¦è¶…è¿‡å®¹å™¨2å€ä»¥ä¸Šï¼Œå»ºè®®ä½¿ç”¨æ¨ªå‘æ»šåŠ¨
      // ä¸è°ƒæ•´iframeå®½åº¦ï¼Œè®©CSSçš„overflowå¤„ç†
      console.log('[å›¾è¡¨å°ºå¯¸] å†…å®¹è¾ƒå®½ï¼Œå¯ç”¨æ¨ªå‘æ»šåŠ¨')
    } else if (overflowRatio > 1.2) {
      // å†…å®¹å®½åº¦è¶…è¿‡å®¹å™¨20%ä»¥ä¸Šï¼Œå¯ä»¥ç¨å¾®å¢åŠ é«˜åº¦æ¥æ”¹å–„æ˜¾ç¤º
      // å·²ç»åœ¨é«˜åº¦è®¡ç®—ä¸­å¤„ç†
    }
  }
}
```

### 3. å“åº”å¼é€‚é…

#### 3.1 å±å¹•å°ºå¯¸æ£€æµ‹
```typescript
const getScreenSize = () => {
  return {
    width: window.innerWidth,
    height: window.innerHeight,
    isMobile: window.innerWidth < 768,
    isTablet: window.innerWidth >= 768 && window.innerWidth < 1024,
    isDesktop: window.innerWidth >= 1024
  }
}
```

#### 3.2 æ ¹æ®å±å¹•è°ƒæ•´å‚æ•°
```typescript
const getSizeParams = (screenSize: ScreenSize) => {
  if (screenSize.isMobile) {
    return {
      minHeight: 400,
      maxHeight: 800,
      defaultHeight: 500
    }
  } else if (screenSize.isTablet) {
    return {
      minHeight: 500,
      maxHeight: 1000,
      defaultHeight: 600
    }
  } else {
    return {
      minHeight: 600,
      maxHeight: 1200,
      defaultHeight: 700
    }
  }
}
```

### 4. åŠ¨æ€ç›‘å¬å’Œè°ƒæ•´

#### 4.1 å†…å®¹å˜åŒ–ç›‘å¬
```typescript
// ç›‘å¬iframeå†…å®¹çš„å˜åŒ–ï¼ˆå¦‚å›¾è¡¨åŠ¨ç”»ã€æ•°æ®æ›´æ–°ç­‰ï¼‰
const observeContentChanges = (iframe: HTMLIFrameElement, callback: () => void) => {
  try {
    const doc = iframe.contentDocument || iframe.contentWindow?.document
    if (!doc) return null
    
    // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
    const observer = new MutationObserver(() => {
      // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è°ƒæ•´
      clearTimeout(adjustTimeout)
      adjustTimeout = setTimeout(callback, 300)
    })
    
    observer.observe(doc.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['style', 'class']
    })
    
    return observer
  } catch (e) {
    return null
  }
}
```

#### 4.2 çª—å£å¤§å°å˜åŒ–ç›‘å¬
```typescript
// ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´iframe
const handleResize = debounce(() => {
  const iframes = document.querySelectorAll('.html-charts-iframe')
  iframes.forEach(iframe => {
    if (iframe instanceof HTMLIFrameElement) {
      adjustIframeSize(iframe)
    }
  })
}, 300)

window.addEventListener('resize', handleResize)
```

## ğŸ“ å®Œæ•´å®ç°ä»£ç 

### å‰ç«¯å®ç°ï¼ˆVue 3ï¼‰

```typescript
// å›¾è¡¨å°ºå¯¸è‡ªé€‚åº”è°ƒæ•´å·¥å…·å‡½æ•°
interface ContentSize {
  scrollWidth: number
  scrollHeight: number
  clientWidth: number
  clientHeight: number
  chartSize?: {
    width: number
    height: number
    aspectRatio: number
  }
}

interface ScreenSize {
  width: number
  height: number
  isMobile: boolean
  isTablet: boolean
  isDesktop: boolean
}

// æ£€æµ‹å†…å®¹å°ºå¯¸
const detectContentSize = (iframe: HTMLIFrameElement): ContentSize | null => {
  try {
    const doc = iframe.contentDocument || iframe.contentWindow?.document
    if (!doc) return null
    
    const body = doc.body
    const html = doc.documentElement
    
    // æ£€æµ‹å›¾è¡¨å®¹å™¨
    const chartSelectors = [
      'canvas',
      '#chart',
      '.chart',
      '[id*="chart"]',
      '[class*="chart"]'
    ]
    
    let chartSize = null
    for (const selector of chartSelectors) {
      const element = doc.querySelector(selector)
      if (element) {
        chartSize = {
          width: element.offsetWidth || element.clientWidth,
          height: element.offsetHeight || element.clientHeight,
          aspectRatio: (element.offsetWidth || 1) / (element.offsetHeight || 1)
        }
        break
      }
    }
    
    return {
      scrollWidth: Math.max(body.scrollWidth, html.scrollWidth),
      scrollHeight: Math.max(body.scrollHeight, html.scrollHeight),
      clientWidth: Math.max(body.clientWidth, html.clientWidth),
      clientHeight: Math.max(body.clientHeight, html.clientHeight),
      chartSize: chartSize || undefined
    }
  } catch (e) {
    return null
  }
}

// è·å–å±å¹•å°ºå¯¸
const getScreenSize = (): ScreenSize => {
  const width = window.innerWidth
  return {
    width,
    height: window.innerHeight,
    isMobile: width < 768,
    isTablet: width >= 768 && width < 1024,
    isDesktop: width >= 1024
  }
}

// è·å–å°ºå¯¸å‚æ•°
const getSizeParams = (screenSize: ScreenSize) => {
  if (screenSize.isMobile) {
    return { minHeight: 400, maxHeight: 800, defaultHeight: 500 }
  } else if (screenSize.isTablet) {
    return { minHeight: 500, maxHeight: 1000, defaultHeight: 600 }
  } else {
    return { minHeight: 600, maxHeight: 1200, defaultHeight: 700 }
  }
}

// è®¡ç®—æœ€ä¼˜é«˜åº¦
const calculateOptimalHeight = (
  contentSize: ContentSize,
  containerWidth: number,
  sizeParams: ReturnType<typeof getSizeParams>
): number => {
  let height = contentSize.scrollHeight
  
  // å¦‚æœæ£€æµ‹åˆ°å›¾è¡¨å®¹å™¨ï¼Œä¼˜å…ˆä½¿ç”¨å›¾è¡¨é«˜åº¦
  if (contentSize.chartSize) {
    const chartHeight = contentSize.chartSize.height
    // å›¾è¡¨é«˜åº¦ + å…¶ä»–å†…å®¹ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ç­‰ï¼‰çš„é¢„ä¼°é«˜åº¦
    height = chartHeight + 100
  }
  
  // æ ¹æ®å®½é«˜æ¯”è°ƒæ•´
  if (contentSize.scrollWidth > containerWidth) {
    const aspectRatio = contentSize.scrollWidth / containerWidth
    if (aspectRatio > 1.5) {
      // å†…å®¹è¾ƒå®½ï¼Œå¢åŠ é«˜åº¦é¿å…è¿‡åº¦å‹ç¼©
      height = Math.max(height, containerWidth * 0.7)
    }
  }
  
  // åº”ç”¨æœ€å°å’Œæœ€å¤§é«˜åº¦é™åˆ¶
  height = Math.max(sizeParams.minHeight, Math.min(sizeParams.maxHeight, height))
  
  return Math.ceil(height)
}

// é˜²æŠ–å‡½æ•°
const debounce = <T extends (...args: any[]) => void>(
  func: T,
  wait: number
): ((...args: Parameters<T>) => void) => {
  let timeout: NodeJS.Timeout | null = null
  return (...args: Parameters<T>) => {
    if (timeout) clearTimeout(timeout)
    timeout = setTimeout(() => func(...args), wait)
  }
}

// è°ƒæ•´iframeå°ºå¯¸
const adjustIframeSize = (iframe: HTMLIFrameElement) => {
  const contentSize = detectContentSize(iframe)
  if (!contentSize) {
    // è·¨åŸŸé™åˆ¶ï¼Œä½¿ç”¨é»˜è®¤é«˜åº¦
    const screenSize = getScreenSize()
    const sizeParams = getSizeParams(screenSize)
    iframe.style.height = `${sizeParams.defaultHeight}px`
    return
  }
  
  const containerWidth = iframe.offsetWidth || iframe.parentElement?.offsetWidth || 800
  const screenSize = getScreenSize()
  const sizeParams = getSizeParams(screenSize)
  
  const optimalHeight = calculateOptimalHeight(contentSize, containerWidth, sizeParams)
  iframe.style.height = `${optimalHeight}px`
  
  console.log('[å›¾è¡¨å°ºå¯¸] å·²è°ƒæ•´:', {
    contentSize: {
      width: contentSize.scrollWidth,
      height: contentSize.scrollHeight
    },
    chartSize: contentSize.chartSize,
    optimalHeight,
    containerWidth
  })
}

// iframeåŠ è½½å®Œæˆå¤„ç†
const handleHtmlChartLoad = (event: Event) => {
  const iframe = event.target as HTMLIFrameElement
  console.log('[HTMLå›¾è¡¨] iframeåŠ è½½å®Œæˆ')
  
  // é¦–æ¬¡è°ƒæ•´ï¼ˆç­‰å¾…å†…å®¹æ¸²æŸ“ï¼‰
  setTimeout(() => {
    adjustIframeSize(iframe)
  }, 300) // å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿å›¾è¡¨å®Œå…¨æ¸²æŸ“
  
  // ç›‘å¬å†…å®¹å˜åŒ–
  try {
    const doc = iframe.contentDocument || iframe.contentWindow?.document
    if (doc) {
      // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
      const observer = new MutationObserver(() => {
        clearTimeout(adjustTimeout)
        adjustTimeout = setTimeout(() => adjustIframeSize(iframe), 300)
      })
      
      observer.observe(doc.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
      })
      
      // ä¿å­˜observerä»¥ä¾¿åç»­æ¸…ç†
      iframe.dataset.observer = 'true'
    }
  } catch (e) {
    console.warn('[HTMLå›¾è¡¨] æ— æ³•ç›‘å¬å†…å®¹å˜åŒ–:', e)
  }
}

let adjustTimeout: NodeJS.Timeout | null = null

// çª—å£å¤§å°å˜åŒ–ç›‘å¬
const handleResize = debounce(() => {
  const iframes = document.querySelectorAll('.html-charts-iframe')
  iframes.forEach(iframe => {
    if (iframe instanceof HTMLIFrameElement) {
      adjustIframeSize(iframe)
    }
  })
}, 300)

window.addEventListener('resize', handleResize)
```

## ğŸ¨ CSSæ ·å¼ä¼˜åŒ–

```css
.html-charts-container {
  margin-top: 20px;
  margin-bottom: 20px;
  border: 1px solid var(--apple-border-light);
  border-radius: var(--apple-radius-lg);
  overflow: hidden;
  background: var(--apple-bg-primary);
  box-shadow: var(--apple-shadow-sm);
  /* ç¡®ä¿å®¹å™¨å®½åº¦100% */
  width: 100%;
}

.html-charts-iframe {
  width: 100%;
  min-height: 600px;
  max-height: 1200px;
  border: none;
  display: block;
  background: white;
  /* å…è®¸å†…å®¹è¶…å‡ºæ—¶æ»šåŠ¨ */
  overflow: auto;
  /* å¹³æ»‘è¿‡æ¸¡ */
  transition: height 0.3s ease;
}

/* å“åº”å¼é€‚é… */
@media (max-width: 768px) {
  .html-charts-iframe {
    min-height: 400px;
    max-height: 800px;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  .html-charts-iframe {
    min-height: 500px;
    max-height: 1000px;
  }
}
```

## âœ… ä¼˜åŠ¿æ€»ç»“

1. **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šä¸éœ€è¦ç”¨æˆ·åœ¨ä»»ä½•åœ°æ–¹æŒ‡å®šå°ºå¯¸
2. **æ™ºèƒ½é€‚é…**ï¼šæ ¹æ®å®é™…å†…å®¹è‡ªåŠ¨è°ƒæ•´
3. **å“åº”å¼**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
4. **åŠ¨æ€ç›‘å¬**ï¼šå†…å®¹å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°è°ƒæ•´
5. **è·¨åŸŸå…¼å®¹**ï¼šå³ä½¿è·¨åŸŸä¹Ÿèƒ½ä½¿ç”¨é»˜è®¤å°ºå¯¸

## ğŸ”„ å·¥ä½œæµç¨‹

```
HTMLå›¾è¡¨åŠ è½½
    â†“
iframeåŠ è½½å®Œæˆ
    â†“
ç­‰å¾…300msï¼ˆç¡®ä¿å›¾è¡¨æ¸²æŸ“ï¼‰
    â†“
æ£€æµ‹å†…å®¹å°ºå¯¸
    â”œâ”€ æ£€æµ‹æ•´ä½“å†…å®¹å°ºå¯¸
    â”œâ”€ æ£€æµ‹å›¾è¡¨å®¹å™¨å°ºå¯¸
    â””â”€ æ£€æµ‹å±å¹•å°ºå¯¸
    â†“
è®¡ç®—æœ€ä¼˜é«˜åº¦
    â”œâ”€ ä½¿ç”¨å›¾è¡¨é«˜åº¦ï¼ˆå¦‚æœæ£€æµ‹åˆ°ï¼‰
    â”œâ”€ è€ƒè™‘å®½é«˜æ¯”
    â””â”€ åº”ç”¨æœ€å°/æœ€å¤§é™åˆ¶
    â†“
è°ƒæ•´iframeé«˜åº¦
    â†“
ç›‘å¬å†…å®¹å˜åŒ–
    â”œâ”€ MutationObserverç›‘å¬DOM
    â””â”€ çª—å£resizeç›‘å¬
    â†“
å†…å®¹å˜åŒ–æ—¶é‡æ–°è°ƒæ•´
```

## ğŸ“Š æµ‹è¯•åœºæ™¯

1. **å°å›¾è¡¨**ï¼šæ•°æ®ç‚¹å°‘ï¼Œå›¾è¡¨è¾ƒå° â†’ ä½¿ç”¨æœ€å°é«˜åº¦
2. **å¤§å›¾è¡¨**ï¼šæ•°æ®ç‚¹å¤šï¼Œå›¾è¡¨è¾ƒå¤§ â†’ ä½¿ç”¨å®é™…é«˜åº¦ï¼Œä½†ä¸è¶…è¿‡æœ€å¤§é«˜åº¦
3. **å®½å›¾è¡¨**ï¼šæ¨ªå‘æ•°æ®ç‚¹å¤š â†’ å¢åŠ é«˜åº¦é¿å…å‹ç¼©ï¼Œæˆ–å¯ç”¨æ¨ªå‘æ»šåŠ¨
4. **é«˜å›¾è¡¨**ï¼šçºµå‘æ•°æ®ç‚¹å¤š â†’ ä½¿ç”¨å®é™…é«˜åº¦
5. **å“åº”å¼**ï¼šä¸åŒå±å¹•å°ºå¯¸ â†’ ä½¿ç”¨ä¸åŒçš„æœ€å°/æœ€å¤§é«˜åº¦

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-12-05  
**çŠ¶æ€**ï¼šå¾…å®ç°

