# RAG 增强功能 - Project 模式产品设计文档

> 基于 RAG 技术实现智能历史分析与知识积累

**文档版本**: V1.0
**创建日期**: 2024-12-26
**基于讨论**: 产品需求讨论记录

---

## 目录

1. [概述](#1-概述)
2. [核心概念：Project 模式](#2-核心概念project-模式)
3. [功能需求详细设计](#3-功能需求详细设计)
4. [技术架构设计](#4-技术架构设计)
5. [数据模型设计](#5-数据模型设计)
6. [界面设计](#6-界面设计)
7. [RAG 技术实现方案](#7-rag-技术实现方案)
8. [实施路线图](#8-实施路线图)
9. [风险评估与应对](#9-风险评估与应对)

---

# 1. 概述

## 1.1 背景与问题

当前系统存在的核心问题：

| 问题 | 描述 | 用户痛点 |
|------|------|----------|
| **分析孤立** | 每次分析独立进行，无法积累经验 | "每次都要重新告诉AI分析重点" |
| **历史断层** | 无法自动对比历史数据 | "手动对比上周数据太麻烦" |
| **洞察丢失** | 有价值的发现没有保存和复用 | "上次发现的规律，这次还要重新分析" |
| **知识孤岛** | 用户的分析经验无法沉淀 | "新人来了要从头摸索" |

## 1.2 解决方案：RAG + Project 模式

引入 **RAG（Retrieval-Augmented Generation）** 技术，结合 **Project 模式**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   传统模式：每次分析 → 独立报告 → 结果丢弃                              │
│                                                                         │
│   Project模式：                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                                                                 │  │
│   │   创建 Project → 上传数据 → 分析 → 提取洞察 → 存入RAG知识库     │  │
│   │        ↑                                            │           │  │
│   │        └────────────── 下次分析时检索参考 ←─────────┘           │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   核心价值：Project 越用越"聪明"，分析越来越精准                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 1.3 核心价值

| 价值 | 描述 | 量化目标 |
|------|------|----------|
| **分析效率提升** | 自动参考历史，减少重复工作 | 分析时间减少 50% |
| **报告质量提升** | 基于历史洞察，分析更深入 | 用户满意度提升至 4.5/5 |
| **知识沉淀** | 团队经验可积累、可传承 | 洞察复用率 > 60% |
| **智能对比** | 自动生成环比、趋势分析 | 对比准确率 > 95% |

---

# 2. 核心概念：Project 模式

## 2.1 什么是 Project

**Project** 是一个长期的分析主题空间，类似于 ChatGPT 的 Project 功能：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Project 定义                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Project = 分析主题 + 数据池 + 洞察库 + 历史报告                         │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 示例：Project "留存周报分析"                                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │                                                                 │   │
│  │ 📁 数据池：                                                      │   │
│  │    ├── 12月第4周_留存.xlsx                                      │   │
│  │    ├── 12月第3周_留存.xlsx                                      │   │
│  │    ├── 12月第2周_留存.xlsx                                      │   │
│  │    └── ...（持续积累）                                          │   │
│  │                                                                 │   │
│  │ 💡 洞察库（RAG）：                                               │   │
│  │    ├── "新手引导完成率与留存强相关"（出现8次）                  │   │
│  │    ├── "第3天是流失高峰期"（出现6次）                           │   │
│  │    └── ...（持续积累）                                          │   │
│  │                                                                 │   │
│  │ 📋 历史报告：                                                    │   │
│  │    ├── 12-25 分析报告（第4周 vs 第3周）                         │   │
│  │    ├── 12-18 分析报告（第3周 vs 第2周）                         │   │
│  │    └── ...                                                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2.2 Project vs 传统模式对比

| 维度 | 传统模式（快速分析） | Project 模式 |
|------|---------------------|--------------|
| **使用场景** | 一次性分析，临时需求 | 长期跟踪的分析主题 |
| **数据管理** | 用完即弃 | 持续积累到数据池 |
| **历史对比** | 手动对比 | 自动检索对比 |
| **洞察积累** | 无 | 自动提取并存入RAG |
| **分析深度** | 基础分析 | 基于历史经验的深度分析 |
| **适合人群** | 临时需求用户 | 定期分析用户 |

## 2.3 用户使用流程

### 2.3.1 创建 Project

```
用户操作：点击"新建 Project"
    ↓
输入基本信息：
    ├── 名称：留存周报分析
    ├── 描述：每周的用户留存数据分析
    └── 可选：设置默认分析模板
    ↓
Project 创建成功，数据池为空
```

### 2.3.2 首次分析

```
用户进入 Project
    ↓
上传数据："12月第1周_留存.xlsx"
    ↓
数据自动存入 Project 数据池
    ↓
输入分析需求（或使用默认）
    ↓
系统生成分析报告
    ↓
AI 提取关键洞察，展示给用户
    ↓
用户确认/修改洞察内容
    ↓
洞察存入 RAG 知识库
```

### 2.3.3 后续分析（核心价值体现）

```
用户进入 Project
    ↓
上传新数据："12月第2周_留存.xlsx"
    ↓
数据自动存入数据池
    ↓
用户在数据池中勾选要分析的数据：
    ☑️ 12月第2周（新数据）
    ☑️ 12月第1周（历史数据）
    ↓
系统自动：
    ├── 从 RAG 检索相关洞察
    ├── 对比两周数据变化
    └── 参考历史经验生成更深入的报告
    ↓
报告自动包含：
    ├── 与上周的数据对比
    ├── 基于历史洞察的分析（"验证了xxx规律"）
    └── 趋势判断
    ↓
新发现的洞察 → 用户确认 → 追加到 RAG
```

---

# 3. 功能需求详细设计

## 3.1 需求总览

| 需求ID | 需求名称 | 优先级 | 阶段 |
|--------|----------|--------|------|
| R1 | 自动记忆历史分析 | P0 | 阶段一 |
| R2 | 智能历史对比 | P0 | 阶段一 |
| R3 | 智能分析建议 | P1 | 阶段二 |
| R4 | 用户反馈学习 | P1 | 阶段二 |
| R5 | AI 对话增强 | P1 | 阶段二 |
| R6 | 知识库管理界面 | P2 | 阶段三 |
| R7 | 团队协作共享 | P2 | 阶段三 |

## 3.2 R1：自动记忆历史分析

### 3.2.1 功能描述

用户完成分析后，系统自动提取关键洞察并存入 Project 的 RAG 知识库。

### 3.2.2 提取内容分层

| 层级 | 内容类型 | 示例 | 用途 |
|------|----------|------|------|
| **元数据层** | 数据特征 | "留存数据、7日/30日、10万样本" | 快速匹配相似场景 |
| **洞察层** | 关键发现 | "7日留存与新手引导完成率相关系数0.85" | 生成报告时参考 |
| **建议层** | 行动措施 | "建议优化第3天的推送策略" | 给用户直接建议 |

### 3.2.3 提取流程（半自动）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        洞察提取流程（半自动）                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 分析完成                                                            │
│     ↓                                                                   │
│  2. AI 自动提取关键信息                                                 │
│     ↓                                                                   │
│  3. 展示给用户确认                                                      │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │ 💾 保存到 Project 知识库                                    │    │
│     │                                                             │    │
│     │ AI 已自动提取以下关键信息，请确认或修改：                   │    │
│     │                                                             │    │
│     │ 关键发现（可编辑）:                                         │    │
│     │ ┌─────────────────────────────────────────────────────┐    │    │
│     │ │ • 7日留存率45%，较历史平均下降5%                    │    │    │
│     │ │ • 新手引导完成率与留存强相关（相关系数0.85）        │    │    │
│     │ │ • 第3天是流失高峰期                                 │    │    │
│     │ └─────────────────────────────────────────────────────┘    │    │
│     │                                            [+ 添加发现]    │    │
│     │                                                             │    │
│     │ 分析建议（可编辑）:                                         │    │
│     │ ┌─────────────────────────────────────────────────────┐    │    │
│     │ │ • 优化新手引导流程，提升完成率                      │    │    │
│     │ │ • 在第2天增加推送，预防第3天流失                    │    │    │
│     │ └─────────────────────────────────────────────────────┘    │    │
│     │                                            [+ 添加建议]    │    │
│     │                                                             │    │
│     │ 标签: [新手] [留存] [周报] [+ 添加]                        │    │
│     │                                                             │    │
│     │                          [取消]  [确认保存到知识库]         │    │
│     └─────────────────────────────────────────────────────────────┘    │
│     ↓                                                                   │
│  4. 用户确认后                                                          │
│     ↓                                                                   │
│  5. 向量化 → 存入 Milvus                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2.4 为什么选择半自动

| 方式 | 优点 | 缺点 |
|------|------|------|
| 全自动 | 用户无负担 | 提取可能不准确 |
| **半自动（推荐）** | 准确性高，用户知道存了什么 | 需要用户操作一步 |
| 全手动 | 最准确 | 用户负担重 |

## 3.3 R2：智能历史对比

### 3.3.1 功能描述

用户在 Project 中选择多个数据进行分析时，系统自动生成对比分析。

### 3.3.2 对比维度

| 对比类型 | 触发条件 | 对比内容 |
|----------|----------|----------|
| **周环比** | 选择连续两周数据 | 本周 vs 上周 |
| **多周趋势** | 选择3周以上数据 | 趋势线 + 平均线 |
| **历史平均** | 有4周以上历史 | 当前 vs 历史平均 |
| **异常检测** | 任何分析 | 偏离历史标准差的指标 |

### 3.3.3 异常判定规则

```python
# 动态阈值计算
历史标准差 = std(历史数据)
异常阈值 = 2 * 历史标准差

# 判定逻辑
if abs(当前值 - 历史平均) > 异常阈值:
    标记为异常

# 示例：
# 历史留存率：45%, 46%, 44%, 47%（平均45.5%，标准差1.3%）
# 异常阈值：2 * 1.3% = 2.6%
# 本周留存率：42% → 偏离3.5% > 2.6% → 标记为异常
```

### 3.3.4 对比结果呈现

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📊 智能对比摘要                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 文字描述:                                                               │
│ ┌─────────────────────────────────────────────────────────────────┐    │
│ │ • 本周7日留存45%，较上周下降5%（⚠️ 异常，历史波动仅±2%）        │    │
│ │ • 新手引导完成率60%，为近8周最低                                │    │
│ │ • DAU 12万，处于历史正常范围                                    │    │
│ └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│ 对比图表:                                                               │
│ ┌─────────────────────────────────────────────────────────────────┐    │
│ │  50% ─┬─────●─────●─────●─────●─────○─────                      │    │
│ │       │                           ↓                              │    │
│ │  45% ─┼───────────────────────────●───── 本周（⚠️异常）         │    │
│ │       │     ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ 历史平均线             │    │
│ │  40% ─┴─────┬─────┬─────┬─────┬─────┬─────                      │    │
│ │            W1    W2    W3    W4    W5                            │    │
│ └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│ 指标卡片:                                                               │
│ ┌───────────┐ ┌───────────┐ ┌───────────┐                             │
│ │ 7日留存   │ │ 环比变化  │ │ 历史排名  │                             │
│ │   45%     │ │   ↓5%     │ │  8周第7   │                             │
│ │   ⚠️      │ │   🔴      │ │   🔴      │                             │
│ └───────────┘ └───────────┘ └───────────┘                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3.4 R3：智能分析建议

### 3.4.1 功能描述

用户上传数据后，系统基于 RAG 检索，主动推荐分析方向。

### 3.4.2 建议来源（优先级排序）

| 优先级 | 来源 | 示例 |
|--------|------|------|
| 1 | 本 Project 历史洞察 | "历史分析显示新手引导是关键因素" |
| 2 | 用户其他 Project | "你的付费分析Project发现VIP3流失异常" |
| 3 | 系统预置知识（未来） | "行业经验表明首付时间与LTV强相关" |

### 3.4.3 建议展示

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 💡 智能分析建议                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 基于您的 Project 历史，建议关注以下方向：                               │
│                                                                         │
│ 1. 重点关注新手引导完成率                                               │
│    相关度: 95%  来源: 本Project历史（出现8次）                          │
│    原因: 历史数据显示引导完成率每提升10%，留存提升约3%                  │
│    [应用此建议]  [忽略]                                                 │
│                                                                         │
│ 2. 检查第3天流失情况                                                    │
│    相关度: 88%  来源: 本Project历史（出现6次）                          │
│    原因: 历史数据显示35%的流失发生在第3天                               │
│    [应用此建议]  [忽略]                                                 │
│                                                                         │
│ 3. 对比周末vs工作日注册用户                                             │
│    相关度: 72%  来源: 本Project历史（出现4次）                          │
│    原因: 周末注册用户留存率通常偏低5-8%                                 │
│    [应用此建议]  [忽略]                                                 │
│                                                                         │
│                                           [查看更多建议...]             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4.4 "应用建议"的实现

点击"应用此建议"后：
1. 将建议内容追加到分析 Prompt 中
2. 在报告中专门展示该维度的分析结果

## 3.5 R4：用户反馈学习

### 3.5.1 功能描述

用户对分析报告评分，系统根据反馈优化推荐。

### 3.5.2 反馈界面

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📝 给这份报告打个分                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 整体评分: ⭐⭐⭐⭐☆ (4/5)                                               │
│                                                                         │
│ [可选] 哪些方面做得好？                                                 │
│ ☑️ 数据分析准确  ☐ 图表清晰  ☑️ 建议实用                              │
│                                                                         │
│ [可选] 哪些方面需要改进？                                               │
│ ☐ 分析不够深入  ☑️ 缺少对比  ☐ 建议不具体                             │
│                                                                         │
│ [可选] 补充说明: [___________________________]                         │
│                                                                         │
│                                              [提交反馈]                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.5.3 反馈处理规则

| 反馈类型 | 处理方式 |
|----------|----------|
| 单次低分（1-2星） | 记录，不立即调整 |
| 累积3次低分 | 降低该洞察的推荐权重 |
| 累积5次低分 | 标记为"需审核" |
| 用户明确标记"错误" | 立即从推荐池移除 |

### 3.5.4 推荐分数计算

```python
推荐分数 = (
    语义相关度 × 0.4 +
    历史评分 × 0.3 +
    出现次数 × 0.2 +
    时效性 × 0.1
)

# 示例：
# A洞察：相关度0.9，评分4.5，出现10次，1周前
# B洞察：相关度0.95，评分3.0，出现2次，3月前
# A的推荐分数更高，优先推荐
```

## 3.6 R5：AI 对话增强

### 3.6.1 功能描述

对话时自动检索 Project 历史，提供更准确的回答。

### 3.6.2 检索范围（分层）

| 优先级 | 范围 | 触发条件 |
|--------|------|----------|
| 1 | 当前会话 | 默认 |
| 2 | 当前 Project 历史洞察 | 任何问题 |
| 3 | 当前 Project 历史报告 | 用户问"之前那个..." |
| 4 | 用户其他 Project（未来） | 用户明确要求 |

### 3.6.3 对话示例

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 💬 AI 对话                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 用户: 为什么本周留存率下降？                                            │
│                                                                         │
│ AI: 根据当前数据和 Project 历史分析，可能有以下原因：                   │
│                                                                         │
│ 1. 新手引导完成率下降                                                   │
│    本周60%，上周68%，历史分析显示这是留存的关键因素                     │
│    📎 参考: 11月第3周的留存分析 [点击查看]                              │
│                                                                         │
│ 2. 第3天流失率上升                                                      │
│    本周第3天流失率38%，高于历史平均35%                                  │
│    📎 参考: Project洞察 "第3天是流失高峰期" [查看详情]                  │
│                                                                         │
│ 建议优先排查新手引导流程是否有变化。需要我详细分析哪个方向？            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3.7 R6：知识库管理界面

### 3.7.1 功能描述

管理员可以查看、编辑、删除 Project 中的洞察条目。

### 3.7.2 管理界面

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📚 Project知识库管理 - 留存周报分析                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 统计: 共 24 条洞察  |  本周新增 3 条  |  被引用 156 次                  │
│                                                                         │
│ 筛选: [全部类型 ▼] [全部来源 ▼] [按引用次数排序 ▼]      🔍 [搜索...]  │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ │ ID │ 洞察内容                           │ 出现 │ 引用 │ 评分 │ 操作 │ │
│ ├────┼────────────────────────────────────┼──────┼──────┼──────┼──────┤ │
│ │ 1  │ 新手引导完成率与留存强相关         │ 8次  │ 45次 │ 4.8  │[编辑]│ │
│ │    │ (相关系数0.85)                     │      │      │      │[删除]│ │
│ ├────┼────────────────────────────────────┼──────┼──────┼──────┼──────┤ │
│ │ 2  │ 第3天是流失高峰期                  │ 6次  │ 38次 │ 4.5  │[编辑]│ │
│ │    │ (约35%流失发生在第3天)             │      │      │      │[删除]│ │
│ ├────┼────────────────────────────────────┼──────┼──────┼──────┼──────┤ │
│ │ 3  │ 周末注册用户留存偏低               │ 4次  │ 21次 │ 4.2  │[编辑]│ │
│ │    │ (低于工作日5-8%)                   │      │      │      │[删除]│ │
│ ├────┼────────────────────────────────────┼──────┼──────┼──────┼──────┤ │
│ │ ⚠️ │ 安卓用户留存高于iOS                │ 1次  │ 2次  │ 2.5  │[编辑]│ │
│ │ 4  │ (需审核：评分较低)                 │      │      │      │[删除]│ │
│                                                                         │
│                              [+ 手动添加洞察]  [批量删除]  [导出]       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3.8 R7：团队协作共享（未来）

### 3.8.1 功能描述

用户可以将优秀的 Project 或洞察共享给团队成员。

### 3.8.2 共享层级

| 级别 | 可见范围 | 共享内容 |
|------|----------|----------|
| 私有 | 仅自己 | 完整 Project |
| 团队 | 本团队成员 | 完整 Project + 讨论 |
| 公开（未来） | 所有用户 | 脱敏后的洞察 |

---

# 4. 技术架构设计

## 4.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           系统架构图                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                          前端层                                    │ │
│  │  Vue 3 + Arco Design + TypeScript                                 │ │
│  │                                                                   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│ │
│  │  │ 快速分析    │ │ Project管理 │ │ 知识库管理  │ │ 对话面板   ││ │
│  │  │ (传统模式)  │ │ (新增)      │ │ (新增)      │ │ (增强)     ││ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    │ HTTP/REST                          │
│                                    ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                          后端层                                    │ │
│  │  FastAPI + SQLAlchemy + Pydantic                                  │ │
│  │                                                                   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│ │
│  │  │ 分析服务    │ │ Project服务 │ │ RAG服务     │ │ 对话服务   ││ │
│  │  │ (现有)      │ │ (新增)      │ │ (新增)      │ │ (增强)     ││ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│ │
│  └───────────────────────────────────────────────────────────────────┘ │
│           │                │                │                │          │
│           ▼                ▼                ▼                ▼          │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │
│  │  PostgreSQL  │ │    Milvus    │ │   阿里百炼   │ │    Redis     │  │
│  │  元数据存储  │ │  向量数据库  │ │   AI服务     │ │    缓存      │  │
│  │  (现有)      │ │  (新增)      │ │  (现有)      │ │   (现有)     │  │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 4.2 RAG 流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           RAG 数据流                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【入库流程】                                                           │
│                                                                         │
│  分析完成 → AI提取洞察 → 用户确认 → 向量化 → 存入Milvus                │
│                              │                    │                     │
│                              ▼                    ▼                     │
│                      PostgreSQL            Milvus                       │
│                      (元数据)              (向量)                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  洞察文本: "新手引导完成率与留存强相关"                         │   │
│  │       ↓                                                         │   │
│  │  阿里百炼 text-embedding-v3                                     │   │
│  │       ↓                                                         │   │
│  │  向量: [0.12, -0.34, 0.56, ...]  (1024维)                      │   │
│  │       ↓                                                         │   │
│  │  存入 Milvus (partition: project_{id})                         │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【检索流程】                                                           │
│                                                                         │
│  用户上传数据/提问 → 向量化 → Milvus检索 → 相关洞察 → 增强AI生成       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  用户问题: "为什么留存率下降"                                   │   │
│  │       ↓                                                         │   │
│  │  向量化: [0.08, -0.29, 0.61, ...]                              │   │
│  │       ↓                                                         │   │
│  │  Milvus 检索 (partition: project_{id}, top_k=5)                │   │
│  │       ↓                                                         │   │
│  │  返回相关洞察:                                                  │   │
│  │  1. "新手引导完成率与留存强相关" (相似度: 0.92)                 │   │
│  │  2. "第3天是流失高峰期" (相似度: 0.85)                         │   │
│  │       ↓                                                         │   │
│  │  构建增强 Prompt:                                               │   │
│  │  "基于以下历史洞察回答用户问题:                                 │   │
│  │   - 新手引导完成率与留存强相关                                  │   │
│  │   - 第3天是流失高峰期                                           │   │
│  │   用户问题: 为什么留存率下降"                                   │   │
│  │       ↓                                                         │   │
│  │  发送给阿里百炼生成回答                                         │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 4.3 数据隔离方案

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据隔离架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        Milvus 向量数据库                           │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  Collection: project_insights                                     │ │
│  │  ├── partition: project_1     ← Project 1 的洞察                  │ │
│  │  ├── partition: project_2     ← Project 2 的洞察                  │ │
│  │  ├── partition: project_3     ← Project 3 的洞察                  │ │
│  │  └── ...                                                          │ │
│  │                                                                   │ │
│  │  每个 Project 的数据完全隔离                                      │ │
│  │  检索时指定 partition，保证只检索当前 Project                     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  检索代码示例:                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ results = collection.search(                                      │ │
│  │     data=[query_embedding],                                       │ │
│  │     partition_names=[f"project_{project_id}"],  # 隔离关键        │ │
│  │     limit=5                                                       │ │
│  │ )                                                                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  未来团队共享时:                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Collection: team_insights                                        │ │
│  │  ├── partition: team_A        ← 团队A的共享洞察                   │ │
│  │  ├── partition: team_B        ← 团队B的共享洞察                   │ │
│  │  └── ...                                                          │ │
│  │                                                                   │ │
│  │  检索范围:                                                        │ │
│  │  私有: project_{id}                                               │ │
│  │  团队: project_{id} + team_{team_id}                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 4.4 新增服务模块

### 4.4.1 后端服务划分

```
backend/app/services/
├── existing/                     # 现有服务
│   ├── bailian_service.py       # AI文本生成
│   ├── chart_generator.py       # 图表生成
│   └── excel_service.py         # Excel处理
│
└── new/                          # 新增服务
    ├── project_service.py        # Project CRUD
    ├── rag_service.py            # RAG核心服务
    │   ├── embedding()           # 向量化
    │   ├── store_insight()       # 存储洞察
    │   ├── search_insights()     # 检索洞察
    │   └── build_context()       # 构建增强上下文
    ├── insight_extractor.py      # 洞察提取
    │   └── extract_from_report() # 从报告提取洞察
    └── comparison_service.py     # 对比分析
        ├── compare_data()        # 数据对比
        └── detect_anomaly()      # 异常检测
```

### 4.4.2 API 端点设计

```yaml
# Project 相关
POST   /api/v1/projects                    # 创建 Project
GET    /api/v1/projects                    # 获取 Project 列表
GET    /api/v1/projects/{id}               # 获取 Project 详情
PUT    /api/v1/projects/{id}               # 更新 Project
DELETE /api/v1/projects/{id}               # 删除 Project

# Project 数据池
POST   /api/v1/projects/{id}/data          # 上传数据到数据池
GET    /api/v1/projects/{id}/data          # 获取数据池列表
DELETE /api/v1/projects/{id}/data/{did}    # 删除数据池中的数据

# Project 分析
POST   /api/v1/projects/{id}/analyze       # 在 Project 中执行分析
GET    /api/v1/projects/{id}/analyses      # 获取历史分析列表
GET    /api/v1/projects/{id}/analyses/{aid} # 获取分析详情

# Project 洞察
GET    /api/v1/projects/{id}/insights      # 获取洞察列表
POST   /api/v1/projects/{id}/insights      # 添加洞察
PUT    /api/v1/projects/{id}/insights/{iid} # 更新洞察
DELETE /api/v1/projects/{id}/insights/{iid} # 删除洞察

# RAG 检索
POST   /api/v1/projects/{id}/search        # 检索相关洞察

# 反馈
POST   /api/v1/analyses/{id}/feedback      # 提交分析反馈
```

---

# 5. 数据模型设计

## 5.1 PostgreSQL 表结构

### 5.1.1 Project 表

```sql
-- Project 主表
CREATE TABLE projects (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),

    -- 基本信息
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(50),                       -- 图标标识

    -- 统计信息（定期更新）
    data_count INTEGER DEFAULT 0,           -- 数据池文件数
    analysis_count INTEGER DEFAULT 0,       -- 分析次数
    insight_count INTEGER DEFAULT 0,        -- 洞察条数

    -- 配置
    default_prompt TEXT,                    -- 默认分析Prompt
    settings JSONB DEFAULT '{}',            -- 其他设置

    -- 时间
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_analysis_at TIMESTAMP,             -- 最近分析时间

    -- 索引
    CONSTRAINT uk_project_user_name UNIQUE (user_id, name)
);

CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_updated_at ON projects(updated_at DESC);
```

### 5.1.2 数据池表

```sql
-- Project 数据池
CREATE TABLE project_data_pool (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- 文件信息
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER,
    file_type VARCHAR(50),                  -- xlsx, csv

    -- 数据摘要（AI提取）
    data_summary JSONB,                     -- { "rows": 1000, "columns": [...], "key_metrics": {...} }
    time_period VARCHAR(100),               -- "12月第4周"（用户可编辑）

    -- 关键指标快照（用于快速对比）
    key_metrics JSONB,                      -- { "7日留存": 0.45, "DAU": 120000, ... }

    -- 状态
    status VARCHAR(20) DEFAULT 'active',    -- active / archived / deleted

    created_at TIMESTAMP DEFAULT NOW(),

    -- 索引
    CONSTRAINT uk_data_pool_file UNIQUE (project_id, file_name)
);

CREATE INDEX idx_data_pool_project_id ON project_data_pool(project_id);
CREATE INDEX idx_data_pool_created_at ON project_data_pool(created_at DESC);
```

### 5.1.3 洞察表

```sql
-- Project 洞察库（RAG元数据）
CREATE TABLE project_insights (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- 洞察内容
    content TEXT NOT NULL,                  -- 洞察文本
    insight_type VARCHAR(50),               -- finding / recommendation / pattern
    category VARCHAR(100),                  -- 分类标签

    -- 向量索引
    milvus_id VARCHAR(100),                 -- Milvus 中的向量 ID
    embedding_model VARCHAR(100),           -- 使用的embedding模型

    -- 来源追踪
    source_analysis_id INTEGER,             -- 来自哪次分析
    source_data_ids INTEGER[],              -- 基于哪些数据得出

    -- 质量信号
    occurrence_count INTEGER DEFAULT 1,     -- 出现次数
    reference_count INTEGER DEFAULT 0,      -- 被引用次数
    user_confirmed BOOLEAN DEFAULT FALSE,   -- 用户是否确认
    quality_score FLOAT DEFAULT 0,          -- 质量评分（基于反馈计算）

    -- 状态
    status VARCHAR(20) DEFAULT 'active',    -- active / archived / pending_review

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_insights_project_id ON project_insights(project_id);
CREATE INDEX idx_insights_quality ON project_insights(quality_score DESC);
CREATE INDEX idx_insights_occurrence ON project_insights(occurrence_count DESC);
```

### 5.1.4 分析记录表

```sql
-- Project 分析记录
CREATE TABLE project_analyses (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- 分析输入
    data_ids INTEGER[] NOT NULL,            -- 选中的数据池文件ID
    analysis_request TEXT,                  -- 用户输入的分析需求

    -- 分析配置
    config JSONB DEFAULT '{
        "enable_comparison": true,
        "enable_insight_reference": true,
        "enable_suggestions": true
    }',

    -- RAG检索结果
    retrieved_insights JSONB,               -- 检索到的相关洞察

    -- 分析结果
    report_content JSONB,                   -- 报告内容
    comparison_result JSONB,                -- 对比分析结果
    new_insights JSONB,                     -- 本次发现的新洞察（待确认）

    -- 用户反馈
    user_rating INTEGER,                    -- 1-5 评分
    user_feedback_tags VARCHAR[],           -- 反馈标签
    user_feedback_text TEXT,                -- 反馈详情

    -- 状态
    status VARCHAR(20) DEFAULT 'completed', -- pending / processing / completed / failed

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_analyses_project_id ON project_analyses(project_id);
CREATE INDEX idx_analyses_created_at ON project_analyses(created_at DESC);
```

## 5.2 Milvus Collection 设计

```python
from pymilvus import Collection, FieldSchema, CollectionSchema, DataType

# 定义字段
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
    FieldSchema(name="project_id", dtype=DataType.INT64),
    FieldSchema(name="insight_id", dtype=DataType.INT64),          # PostgreSQL 中的 ID
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=2000),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=1024),  # text-embedding-v3
    FieldSchema(name="created_at", dtype=DataType.INT64),          # Unix timestamp
]

# 创建 Collection
schema = CollectionSchema(fields, description="Project insights for RAG")
collection = Collection("project_insights", schema)

# 创建索引
index_params = {
    "metric_type": "COSINE",
    "index_type": "IVF_FLAT",
    "params": {"nlist": 1024}
}
collection.create_index("embedding", index_params)

# 为每个 Project 创建 partition
def create_project_partition(project_id: int):
    partition_name = f"project_{project_id}"
    if not collection.has_partition(partition_name):
        collection.create_partition(partition_name)
```

---

# 6. 界面设计

## 6.1 首页改版

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 🏠 运营数据分析平台                                              [头像] │
├───────────────┬─────────────────────────────────────────────────────────┤
│               │                                                         │
│  📂 导航      │   欢迎回来，张三                                        │
│               │                                                         │
│  ├ ⚡ 快速分析 │   ┌─────────────────────────────────────────────────┐  │
│  │            │   │                                                 │  │
│  ├ 📁 我的    │   │   ⚡ 快速分析                    📁 我的 Project   │  │
│  │   Project  │   │                                                 │  │
│  │   ├ 留存   │   │   无需创建 Project              管理长期分析项目  │  │
│  │   │  周报  │   │   上传即分析                    数据持续积累      │  │
│  │   ├ 付费   │   │   一次性使用                    智能对比历史      │  │
│  │   │  分析  │   │                                 RAG 知识积累      │  │
│  │   └ 新手   │   │                                                 │  │
│  │     漏斗   │   │   [开始快速分析]                [管理我的Project] │  │
│  │            │   │                                                 │  │
│  └ ⚙️ 设置    │   └─────────────────────────────────────────────────┘  │
│               │                                                         │
│               │   最近的 Project                          [+ 新建]     │
│               │                                                         │
│               │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │
│               │   │ 📊 留存周报  │ │ 💰 付费分析  │ │ 🎮 新手漏斗 │     │
│               │   │             │ │             │ │             │     │
│               │   │ 📁 8个数据  │ │ 📁 5个数据  │ │ 📁 3个数据  │     │
│               │   │ 💡 24条洞察 │ │ 💡 15条洞察 │ │ 💡 8条洞察  │     │
│               │   │ 最近: 昨天  │ │ 最近: 3天前 │ │ 最近: 1周前 │     │
│               │   │             │ │             │ │             │     │
│               │   │ [进入]      │ │ [进入]      │ │ [进入]      │     │
│               │   └─────────────┘ └─────────────┘ └─────────────┘     │
│               │                                                         │
│               │   最近分析                                              │
│               │   ─────────────────────────────────────────────────────│
│               │   • 留存周报 - 12月第4周 vs 第3周        昨天  ⭐4.5   │
│               │   • 付费分析 - 12月付费转化分析          3天前 ⭐4.0   │
│               │   • 快速分析 - 临时数据分析              5天前 ⭐3.5   │
│               │                                                         │
└───────────────┴─────────────────────────────────────────────────────────┘
```

## 6.2 Project 内部界面

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📊 留存周报分析                              [设置] [知识库] [删除]     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 📁 数据池 (8个文件)                                [上传新数据]   │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  勾选要分析的数据：                                              │  │
│  │                                                                  │  │
│  │  ☑️ 12月第4周_留存.xlsx                                          │  │
│  │     2024-12-25  |  7日留存: 46%  |  DAU: 15万                   │  │
│  │                                                                  │  │
│  │  ☑️ 12月第3周_留存.xlsx                                          │  │
│  │     2024-12-18  |  7日留存: 44%  |  DAU: 14万                   │  │
│  │                                                                  │  │
│  │  ☐ 12月第2周_留存.xlsx                                          │  │
│  │     2024-12-11  |  7日留存: 47%  |  DAU: 15万                   │  │
│  │                                                                  │  │
│  │  ☐ 12月第1周_留存.xlsx                                          │  │
│  │     2024-12-04  |  7日留存: 45%  |  DAU: 14万                   │  │
│  │                                                                  │  │
│  │  ... 显示更多 (4)                                                │  │
│  │                                                                  │  │
│  │  已选择 2 个文件              [全选近4周] [清空选择]             │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 💡 智能分析建议（基于 Project 知识库）                           │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  1. 重点关注新手引导完成率                          [应用] [忽略]│  │
│  │     历史数据显示：引导完成率每提升10%，留存提升约3%             │  │
│  │                                                                  │  │
│  │  2. 检查第3天流失情况                               [应用] [忽略]│  │
│  │     历史数据显示：35%的流失发生在第3天                          │  │
│  │                                                                  │  │
│  │                                              [查看更多建议...]   │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 分析设置                                                         │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  分析需求:                                                       │  │
│  │  ┌────────────────────────────────────────────────────────────┐ │  │
│  │  │ 分析本周留存数据，重点关注与上周的变化，以及新手引导的影响 │ │  │
│  │  └────────────────────────────────────────────────────────────┘ │  │
│  │                                                                  │  │
│  │  ☑️ 自动对比选中的历史数据                                       │  │
│  │  ☑️ 参考 Project 知识库中的历史洞察                              │  │
│  │  ☑️ 生成行动建议                                                 │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│                                         [开始分析选中的数据]           │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│  📋 历史分析报告                                                        │
│  ───────────────────────────────────────────────────────────────────── │
│  │ 时间       │ 分析数据                    │ 评分  │ 操作            │ │
│  ├────────────┼────────────────────────────┼───────┼─────────────────┤ │
│  │ 12-25      │ 第4周 vs 第3周             │ ⭐4.5 │ [查看] [删除]   │ │
│  │ 12-18      │ 第3周 vs 第2周             │ ⭐4.0 │ [查看] [删除]   │ │
│  │ 12-11      │ 第2周 vs 第1周             │ ⭐5.0 │ [查看] [删除]   │ │
│  │ 12-04      │ 第1周（首次分析）          │ ⭐4.0 │ [查看] [删除]   │ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 6.3 分析结果页

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📊 留存周报分析 > 分析报告                               [返回Project] │
│    12月第4周 vs 第3周                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 📋 分析摘要                                                      │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  本周7日留存率 46%，较上周提升 2个百分点 ↑                       │  │
│  │                                                                  │  │
│  │  ┌────────────────────────────────────────────────────────────┐ │  │
│  │  │ 💡 基于 Project 历史洞察的分析：                            │ │  │
│  │  │                                                            │ │  │
│  │  │ 本周新手引导完成率提升至72%（上周68%），与留存提升趋势      │ │  │
│  │  │ 一致。这验证了本 Project 的核心洞察：                       │ │  │
│  │  │ "新手引导完成率是留存的关键因素"                            │ │  │
│  │  │                                                            │ │  │
│  │  │ 📎 历史洞察来源: 共出现8次，置信度95%                       │ │  │
│  │  └────────────────────────────────────────────────────────────┘ │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 📈 对比分析                                                      │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │  │
│  │  │ 7日留存   ��� │ 环比变化  │ │ 历史排名  │ │ 异常检测  │       │  │
│  │  │   46%     │ │   ↑2%     │ │  8周第2   │ │   正常    │       │  │
│  │  │   🟢      │ │   🟢      │ │   🟢      │ │   🟢      │       │  │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │  │
│  │                                                                  │  │
│  │  趋势图:                                                         │  │
│  │  ┌────────────────────────────────────────────────────────────┐ │  │
│  │  │  50% ─┬─────────────────────────────────────────────       │ │  │
│  │  │       │                                    ●── 本周 46%    │ │  │
│  │  │  45% ─┼───────────────────────────●───────                 │ │  │
│  │  │       │         ●─────●───────────  上周 44%               │ │  │
│  │  │  40% ─┴─────┬─────┬─────┬─────┬─────┬─────                 │ │  │
│  │  │            W1    W2    W3    W4    本周                     │ │  │
│  │  │                                                            │ │  │
│  │  │  ─●─ 实际值    ─ ─ ─ 历史平均 (45.2%)                      │ │  │
│  │  └────────────────────────────────────────────────────────────┘ │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 📝 详细分析报告                                         [展开]   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 🔍 新发现（确认后将加入 Project 知识库）                         │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  AI 在本次分析中发现了以下新洞察：                               │  │
│  │                                                                  │  │
│  │  ☑️ 新手引导完成率提升4%带来留存提升2%（量化关系）               │  │
│  │     这是对现有洞察的补充，建议加入知识库                        │  │
│  │                                                                  │  │
│  │  ☑️ 本周第3天流失率从35%降至30%                                  │  │
│  │     第3天流失情况改善，可能与推送策略调整有关                   │  │
│  │                                                                  │  │
│  │  ☐ 安卓用户留存高于iOS 3个百分点                                │  │
│  │     可能是数据偶然，建议观察后续数据再确认                      │  │
│  │                                                                  │  │
│  │                                         [确认选中的洞察入库]     │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 📝 给这次分析打分                                                │  │
│  │                                                                  │  │
│  │  整体评分: ⭐⭐⭐⭐⭐                            [提交评分]        │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│           [导出PDF]  [继续对话深入分析]  [返回Project]                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 6.4 新建 Project 弹窗

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📁 新建 Project                                                 [关闭] │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Project 名称 *                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ 留存周报分析                                                    │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  描述                                                                   │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ 每周的用户留存数据分析，追踪7日和30日留存率变化                 │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  图标                                                                   │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐            │
│  │ 📊 │ │ 📈 │ │ 💰 │ │ 👥 │ │ 🎮 │ │ 📱 │ │ 🛒 │ │ 📋 │            │
│  └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘            │
│    ✓                                                                   │
│                                                                         │
│  默认分析 Prompt（可选，每次分析时可修改）                              │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ 请分析留存数据，重点关注：                                      │    │
│  │ 1. 7日留存率变化趋势                                            │    │
│  │ 2. 与历史数据的对比                                             │    │
│  │ 3. 影响留存的关键因素                                           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│                                              [取消]  [创建 Project]     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

# 7. RAG 技术实现方案

## 7.1 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| **向量数据库** | Milvus 2.3+ | 专业向量数据库，支持 partition，性能好 |
| **Embedding** | 阿里百炼 text-embedding-v3 | 中文效果好，与现有AI服务统一 |
| **检索策略** | 纯向量检索（初期） | 简单易上手，后续可扩展为混合检索 |

## 7.2 Milvus 部署

```yaml
# docker-compose.yml 新增
services:
  # ... 现有服务 ...

  milvus-etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - milvus_etcd:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd

  milvus-minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - milvus_minio:/minio_data
    command: minio server /minio_data

  milvus:
    image: milvusdb/milvus:v2.3.0
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: milvus-etcd:2379
      MINIO_ADDRESS: milvus-minio:9000
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus
    depends_on:
      - milvus-etcd
      - milvus-minio

volumes:
  milvus_etcd:
  milvus_minio:
  milvus_data:
```

## 7.3 核心代码实现

### 7.3.1 RAG Service

```python
# backend/app/services/rag_service.py

from pymilvus import Collection, connections, utility
from dashscope import TextEmbedding
from typing import List, Optional
import json

class RAGService:
    """RAG 核心服务"""

    def __init__(self):
        self.collection_name = "project_insights"
        self.embedding_model = "text-embedding-v3"
        self.embedding_dim = 1024
        self._connect()
        self._ensure_collection()

    def _connect(self):
        """连接 Milvus"""
        connections.connect(
            alias="default",
            host="localhost",
            port="19530"
        )

    def _ensure_collection(self):
        """确保 Collection 存在"""
        if not utility.has_collection(self.collection_name):
            self._create_collection()
        self.collection = Collection(self.collection_name)
        self.collection.load()

    def _create_collection(self):
        """创建 Collection"""
        from pymilvus import FieldSchema, CollectionSchema, DataType

        fields = [
            FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
            FieldSchema(name="project_id", dtype=DataType.INT64),
            FieldSchema(name="insight_id", dtype=DataType.INT64),
            FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=2000),
            FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=self.embedding_dim),
        ]

        schema = CollectionSchema(fields, description="Project insights for RAG")
        collection = Collection(self.collection_name, schema)

        # 创建索引
        index_params = {
            "metric_type": "COSINE",
            "index_type": "IVF_FLAT",
            "params": {"nlist": 1024}
        }
        collection.create_index("embedding", index_params)

    def ensure_partition(self, project_id: int):
        """确保 Project 的 partition 存在"""
        partition_name = f"project_{project_id}"
        if not self.collection.has_partition(partition_name):
            self.collection.create_partition(partition_name)
        return partition_name

    def get_embedding(self, text: str) -> List[float]:
        """获取文本的向量表示"""
        response = TextEmbedding.call(
            model=self.embedding_model,
            input=text
        )
        return response.output['embeddings'][0]['embedding']

    def store_insight(
        self,
        project_id: int,
        insight_id: int,
        content: str
    ) -> str:
        """存储洞察到 Milvus"""
        partition_name = self.ensure_partition(project_id)
        embedding = self.get_embedding(content)

        data = [
            [project_id],
            [insight_id],
            [content],
            [embedding]
        ]

        self.collection.insert(data, partition_name=partition_name)
        self.collection.flush()

        return partition_name

    def search_insights(
        self,
        project_id: int,
        query: str,
        top_k: int = 5,
        score_threshold: float = 0.7
    ) -> List[dict]:
        """检索相关洞察"""
        partition_name = f"project_{project_id}"

        # 检查 partition 是否存在
        if not self.collection.has_partition(partition_name):
            return []

        query_embedding = self.get_embedding(query)

        search_params = {
            "metric_type": "COSINE",
            "params": {"nprobe": 10}
        }

        results = self.collection.search(
            data=[query_embedding],
            anns_field="embedding",
            param=search_params,
            limit=top_k,
            partition_names=[partition_name],
            output_fields=["insight_id", "content"]
        )

        insights = []
        for hits in results:
            for hit in hits:
                if hit.score >= score_threshold:
                    insights.append({
                        "insight_id": hit.entity.get("insight_id"),
                        "content": hit.entity.get("content"),
                        "score": hit.score
                    })

        return insights

    def delete_insight(self, project_id: int, insight_id: int):
        """删除洞察"""
        partition_name = f"project_{project_id}"
        expr = f"insight_id == {insight_id}"
        self.collection.delete(expr, partition_name=partition_name)

    def delete_project_partition(self, project_id: int):
        """删除整个 Project 的 partition"""
        partition_name = f"project_{project_id}"
        if self.collection.has_partition(partition_name):
            self.collection.drop_partition(partition_name)

    def build_context(
        self,
        project_id: int,
        query: str,
        max_context_length: int = 2000
    ) -> str:
        """构建 RAG 增强的上下文"""
        insights = self.search_insights(project_id, query)

        if not insights:
            return ""

        context_parts = ["基于历史分析的相关洞察："]
        current_length = len(context_parts[0])

        for insight in insights:
            insight_text = f"- {insight['content']} (相关度: {insight['score']:.0%})"
            if current_length + len(insight_text) > max_context_length:
                break
            context_parts.append(insight_text)
            current_length += len(insight_text)

        return "\n".join(context_parts)


# 单例
rag_service = RAGService()
```

### 7.3.2 洞察提取服务

```python
# backend/app/services/insight_extractor.py

from app.services.bailian_service import BailianService
from typing import List, Dict
import json

class InsightExtractor:
    """从分析报告中提取洞察"""

    EXTRACTION_PROMPT = """
请从以下分析报告中提取关键洞察。

要求：
1. 提取3-5条最重要的发现
2. 每条洞察要简洁明确（不超过50字）
3. 包含具体数据时要保留数据
4. 区分"发现"和"建议"两种类型

输出格式（JSON）：
{
    "findings": [
        {"content": "洞察内容", "confidence": 0.9}
    ],
    "recommendations": [
        {"content": "建议内容", "priority": "high/medium/low"}
    ]
}

分析报告：
{report_content}
"""

    def __init__(self):
        self.bailian_service = BailianService()

    async def extract_insights(self, report_content: str) -> Dict:
        """从报告中提取洞察"""
        prompt = self.EXTRACTION_PROMPT.format(report_content=report_content)

        response = await self.bailian_service.generate_text(prompt)

        try:
            # 尝试解析 JSON
            insights = json.loads(response)
            return insights
        except json.JSONDecodeError:
            # 如果解析失败，返回空结果
            return {"findings": [], "recommendations": []}

    def format_for_display(self, insights: Dict) -> List[Dict]:
        """格式化洞察用于前端显示"""
        result = []

        for finding in insights.get("findings", []):
            result.append({
                "type": "finding",
                "content": finding["content"],
                "confidence": finding.get("confidence", 0.8),
                "selected": True  # 默认选中
            })

        for rec in insights.get("recommendations", []):
            result.append({
                "type": "recommendation",
                "content": rec["content"],
                "priority": rec.get("priority", "medium"),
                "selected": True
            })

        return result


insight_extractor = InsightExtractor()
```

### 7.3.3 Project Service

```python
# backend/app/services/project_service.py

from sqlalchemy.orm import Session
from app.models import Project, ProjectDataPool, ProjectInsight, ProjectAnalysis
from app.services.rag_service import rag_service
from app.services.insight_extractor import insight_extractor
from typing import List, Optional
import os

class ProjectService:
    """Project 业务逻辑服务"""

    def create_project(
        self,
        db: Session,
        user_id: int,
        name: str,
        description: str = None,
        icon: str = "📊",
        default_prompt: str = None
    ) -> Project:
        """创建 Project"""
        project = Project(
            user_id=user_id,
            name=name,
            description=description,
            icon=icon,
            default_prompt=default_prompt
        )
        db.add(project)
        db.commit()
        db.refresh(project)

        # 在 Milvus 中创建 partition
        rag_service.ensure_partition(project.id)

        return project

    def add_data_to_pool(
        self,
        db: Session,
        project_id: int,
        file_name: str,
        file_path: str,
        file_size: int,
        data_summary: dict = None,
        time_period: str = None,
        key_metrics: dict = None
    ) -> ProjectDataPool:
        """添加数据到数据池"""
        data = ProjectDataPool(
            project_id=project_id,
            file_name=file_name,
            file_path=file_path,
            file_size=file_size,
            data_summary=data_summary,
            time_period=time_period,
            key_metrics=key_metrics
        )
        db.add(data)

        # 更新 Project 统计
        project = db.query(Project).filter(Project.id == project_id).first()
        project.data_count += 1

        db.commit()
        db.refresh(data)
        return data

    async def analyze_with_rag(
        self,
        db: Session,
        project_id: int,
        data_ids: List[int],
        analysis_request: str,
        enable_comparison: bool = True,
        enable_insight_reference: bool = True
    ) -> ProjectAnalysis:
        """执行带 RAG 增强的分析"""

        # 1. 检索相关洞察
        retrieved_insights = []
        if enable_insight_reference:
            retrieved_insights = rag_service.search_insights(
                project_id=project_id,
                query=analysis_request,
                top_k=5
            )

        # 2. 构建增强 Prompt
        enhanced_prompt = self._build_enhanced_prompt(
            analysis_request=analysis_request,
            retrieved_insights=retrieved_insights,
            enable_comparison=enable_comparison
        )

        # 3. 执行分析（调用现有的分析服务）
        # ... 省略具体分析逻辑 ...

        # 4. 提取新洞察
        # new_insights = await insight_extractor.extract_insights(report_content)

        # 5. 保存分析记录
        analysis = ProjectAnalysis(
            project_id=project_id,
            data_ids=data_ids,
            analysis_request=analysis_request,
            retrieved_insights=retrieved_insights,
            # report_content=report_content,
            # new_insights=new_insights
        )
        db.add(analysis)
        db.commit()

        return analysis

    def _build_enhanced_prompt(
        self,
        analysis_request: str,
        retrieved_insights: List[dict],
        enable_comparison: bool
    ) -> str:
        """构建 RAG 增强的 Prompt"""
        parts = []

        # 添加历史洞察上下文
        if retrieved_insights:
            parts.append("【历史分析洞察（请参考）】")
            for insight in retrieved_insights:
                parts.append(f"- {insight['content']}")
            parts.append("")

        # 添加对比指令
        if enable_comparison:
            parts.append("【分析要求】")
            parts.append("请在分析中包含与历史数据的对比，标注变化趋势和异常情况。")
            parts.append("")

        # 添加用户请求
        parts.append("【用户分析需求】")
        parts.append(analysis_request)

        return "\n".join(parts)

    def confirm_insights(
        self,
        db: Session,
        project_id: int,
        analysis_id: int,
        confirmed_insights: List[dict]
    ):
        """确认并存储用户选中的洞察"""
        for insight_data in confirmed_insights:
            # 存入 PostgreSQL
            insight = ProjectInsight(
                project_id=project_id,
                content=insight_data["content"],
                insight_type=insight_data.get("type", "finding"),
                source_analysis_id=analysis_id,
                user_confirmed=True
            )
            db.add(insight)
            db.flush()  # 获取 ID

            # 存入 Milvus
            rag_service.store_insight(
                project_id=project_id,
                insight_id=insight.id,
                content=insight_data["content"]
            )

        # 更新 Project 统计
        project = db.query(Project).filter(Project.id == project_id).first()
        project.insight_count += len(confirmed_insights)

        db.commit()

    def delete_project(self, db: Session, project_id: int):
        """删除 Project（包括 Milvus 数据）"""
        # 删除 Milvus partition
        rag_service.delete_project_partition(project_id)

        # 删除数据库记录（级联删除）
        project = db.query(Project).filter(Project.id == project_id).first()
        db.delete(project)
        db.commit()


project_service = ProjectService()
```

---

# 8. 实施路线图

## 8.1 整体规划

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           实施路线图                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段一（4-6周）          阶段二（4-6周）          阶段三（4-6周）       │
│  基础 RAG 能力            智能增强                 管理与协作            │
│  ─────────────            ─────────               ─────────            │
│                                                                         │
│  • Project CRUD           • 智能分析建议          • 知识库管理界面      │
│  • 数据池管理             • 用户反馈学习          • 团队共享功能        │
│  • RAG 存储/检索          • AI 对话增强           • 权限控制            │
│  • 洞察提取（半自动）     • 异常检测优化          • 数据统计面板        │
│  • 基础历史对比           • 推荐算法优化                                │
│                                                                         │
│  里程碑: MVP 上线         里程碑: 智能化上线      里程碑: 协作版上线    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 8.2 阶段一详细计划

### Week 1-2: 基础设施

| 任务 | 说明 | 产出 |
|------|------|------|
| Milvus 部署 | Docker Compose 集成 | 运行中的 Milvus 服务 |
| RAG Service 开发 | 向量化、存储、检索 | rag_service.py |
| 数据模型创建 | PostgreSQL 表结构 | 数据库迁移脚本 |
| API 框架搭建 | Project 相关端点 | API 可调用 |

### Week 3-4: 核心功能

| 任务 | 说明 | 产出 |
|------|------|------|
| Project CRUD | 创建、查看、删除 | 完整的 Project 管理 |
| 数据池功能 | 上传、列表、选择 | 数据池可用 |
| 洞察提取 | AI 提取 + 用户确认 | 洞察入库流程 |
| 基础检索 | 分析时检索历史 | RAG 增强生效 |

### Week 5-6: 前端与联调

| 任务 | 说明 | 产出 |
|------|------|------|
| 首页改版 | 快速分析 + Project 入口 | 新首页 |
| Project 页面 | 数据池 + 分析 + 历史 | Project 完整界面 |
| 分析结果页 | 对比 + 新洞察确认 | 完整分析流程 |
| 测试修复 | 端到端测试 | 稳定可用 |

## 8.3 阶段一验收标准

| 功能点 | 验收标准 |
|--------|----------|
| 创建 Project | 用户可以创建 Project，设置名称和描述 |
| 数据池 | 用户可以上传数据，查看数据池列表 |
| 勾选分析 | 用户可以勾选多个数据进行分析 |
| RAG 检索 | 分析时自动检索历史洞察，体现在报告中 |
| 洞察入库 | 分析后用户可以确认洞察，存入知识库 |
| 历史对比 | 选择多个数据时，报告中有对比分析 |

## 8.4 风险与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| Milvus 性能问题 | 低 | 中 | 预留扩容方案，监控资源 |
| Embedding 成本过高 | 中 | 低 | 设置缓存，避免重复调用 |
| 洞察提取质量差 | 中 | 中 | 半自动模式，用户可修改 |
| 用户不理解 Project | 中 | 中 | 新手引导，清晰的 UI 提示 |

---

# 9. 风险评估与应对

## 9.1 技术风险

| 风险 | 描述 | 影响 | 应对策略 |
|------|------|------|----------|
| **Milvus 稳定性** | 新引入的组件，可能有坑 | 中 | 充分测试，保留降级方案 |
| **向量检索准确性** | 检索结果可能不相关 | 中 | 设置阈值过滤，用户可反馈 |
| **Embedding 延迟** | 调用外部 API 有延迟 | 低 | 异步处理，结果缓存 |
| **数据迁移** | 现有数据如何迁移 | 低 | 新老模式并存，渐进迁移 |

## 9.2 产品风险

| 风险 | 描述 | 影响 | 应对策略 |
|------|------|------|----------|
| **用户学习成本** | Project 概念需要学习 | 中 | 保留快速分析，渐进引导 |
| **洞察质量** | AI 提取的洞察可能不准 | 中 | 半自动模式，用户确认 |
| **冷启动** | 新 Project 没有历史 | 中 | 第一次分析时明确提示 |

## 9.3 降级方案

```
如果 RAG 服务不可用:
    ↓
自动降级为传统模式（不检索历史洞察）
    ↓
用户仍可正常使用分析功能
    ↓
后台告警，运维介入修复
```

---

# 附录

## A. 术语表

| 术语 | 定义 |
|------|------|
| **Project** | 长期分析主题空间，包含数据池和洞察库 |
| **数据池** | Project 中累积的历史数据文件 |
| **洞察库** | Project 中累积的分析洞察（RAG 知识） |
| **RAG** | Retrieval-Augmented Generation，检索增强生成 |
| **Embedding** | 将文本转换为向量的过程 |
| **Milvus** | 开源向量数据库 |

## B. 参考资料

- [Milvus 官方文档](https://milvus.io/docs)
- [阿里百炼 Embedding API](https://help.aliyun.com/document_detail/2712195.html)
- [RAG 最佳实践](https://www.pinecone.io/learn/retrieval-augmented-generation/)

## C. 修订历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024-12-26 | 初稿，基于产品讨论 | AI Assistant |

---

*本文档基于产品需求讨论整理，详细描述了 RAG 增强功能的 Project 模式设计方案。*
