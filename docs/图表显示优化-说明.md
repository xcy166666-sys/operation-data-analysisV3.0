# 图表显示优化 - 说明文档

## 问题描述

用户反馈生成的图表比例不对，图表区域几乎是空白的，只显示绿色边框。

## 问题原因

1. **AI 生成的 HTML 尺寸设置不当**：
   - 图表容器没有设置明确的高度
   - 使用了固定像素宽度，导致在 iframe 中显示异常
   - 没有正确初始化图表库（如 ECharts）

2. **iframe 最小高度不足**：
   - 前端 iframe 的 min-height 只有 600px
   - 对于复杂图表可能不够

## 解决方案

### 1. 优化后端 HTML 生成 Prompt

修改了 `backend/app/services/bailian_service.py` 中的 `_build_html_generation_prompt` 方法，添加了更详细和强制性的图表尺寸要求：

**关键要求**：
- body 必须设置：`margin: 0; padding: 20px; box-sizing: border-box;`
- 主容器必须设置：`width: 100%; max-width: 100%;`
- 图表容器必须设置：`width: 100%; height: 600px; min-height: 600px;`
- 提供了完整的示例代码结构

**ECharts 特定要求**：
```html
<div id="chart" style="width: 100%; height: 600px; min-height: 600px;"></div>
<script>
    var chart = echarts.init(document.getElementById('chart'));
    chart.setOption(option);
    window.addEventListener('resize', function() {
        chart.resize();
    });
</script>
```

### 2. 优化前端 iframe 样式

修改了 `frontend/src/views/Operation/components/ChartDrawer.vue`：

```scss
.chart-html-iframe {
  width: 100%;
  min-height: 800px;  // 从 600px 增加到 800px
  height: auto;
  border: none;
  display: block;
  background: white;
}
```

### 3. 自动高度调整

前端代码已经实现了自动高度调整逻辑：

```typescript
// 尝试调整iframe高度
const iframeDoc = iframe.contentDocument || iframeWindow?.document
if (iframeDoc && iframeDoc.body) {
  setTimeout(() => {
    const height = Math.max(
      iframeDoc.body.scrollHeight,
      iframeDoc.documentElement.scrollHeight,
      600
    )
    iframe.style.height = `${height}px`
  }, 300)
}
```

## 使用方法

### 重新生成图表

1. **删除旧报告**（如果需要）
2. **重新上传 Excel 文件**
3. **生成新报告**

新生成的图表将使用优化后的 prompt，应该能正确显示。

### 验证图表显示

1. 点击"查看图表详情"按钮
2. 检查图表是否正常显示
3. 如果图表仍然显示异常，可以：
   - 点击"下载图表" → "导出HTML文件"
   - 在浏览器中直接打开 HTML 文件查看
   - 检查 HTML 代码中的图表容器尺寸设置

## 常见问题

### Q1: 旧的报告图表还是显示不正常？

A: 旧的报告使用的是旧的 prompt 生成的 HTML，需要重新生成报告才能应用新的优化。

### Q2: 如何手动修复图表显示？

A: 如果 AI 生成的 HTML 仍然有问题，可以：

1. 导出 HTML 文件
2. 手动编辑 HTML，添加正确的样式：
   ```html
   <style>
       body {
           margin: 0;
           padding: 20px;
           box-sizing: border-box;
       }
       #chart {
           width: 100%;
           height: 600px;
           min-height: 600px;
       }
   </style>
   ```
3. 重新上传或使用修改后的 HTML

### Q3: 图表在 iframe 中显示正常，但下载的截图不完整？

A: 这是因为截图时图表可能还没有完全渲染。可以：
- 等待几秒后再截图
- 使用"导出HTML文件"功能，在浏览器中打开后截图

## 技术细节

### Prompt 优化要点

1. **明确的尺寸要求**：
   - 使用具体的像素值（如 600px）而不是模糊的描述
   - 同时设置 height 和 min-height 确保最小高度

2. **提供示例代码**：
   - 完整的 HTML 结构示例
   - 正确的 CSS 样式设置
   - ECharts 初始化和响应式调整代码

3. **强制性语言**：
   - 使用"必须"、"必须严格遵守"等强制性词汇
   - 明确说明不遵守的后果（如"会导致图表超出显示范围"）

### iframe 高度调整逻辑

```typescript
// 1. 尝试读取 iframe 内容的实际高度
const height = Math.max(
  iframeDoc.body.scrollHeight,
  iframeDoc.documentElement.scrollHeight,
  600  // 最小高度
)

// 2. 设置 iframe 高度
iframe.style.height = `${height}px`

// 3. 如果无法访问 iframe 内容（跨域），使用固定高度
iframe.style.height = '800px'
```

## 后续优化建议

1. **添加图表预览功能**：
   - 在生成报告前预览图表
   - 允许用户调整图表参数

2. **提供图表模板**：
   - 预定义常用图表类型的 HTML 模板
   - 减少 AI 生成的不确定性

3. **图表编辑器**：
   - 允许用户在界面上直接编辑图表配置
   - 实时预览修改效果

## 相关文件

- `backend/app/services/bailian_service.py` - HTML 生成 prompt
- `frontend/src/views/Operation/components/ChartDrawer.vue` - 图表显示组件
- `frontend/src/views/Operation/DataAnalysis.vue` - 主页面

---

**更新时间**：2025-12-24
**版本**：v1.0
