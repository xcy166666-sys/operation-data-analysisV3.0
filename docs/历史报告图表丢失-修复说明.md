# 历史报告图表丢失 - 修复说明

## 问题描述

点击左侧历史会话列表中的项目后，报告内容消失或图表不显示。

## 问题原因

后端在保存报告到数据库时，**没有保存 `html_charts` 字段**到 `assistant_message` 中。

### 原始代码（有问题）

```python
assistant_message = {
    "role": "assistant",
    "content": cleaned_text,
    "timestamp": datetime.utcnow().isoformat()
}

if charts:
    assistant_message["charts"] = charts

if report_content.get("tables"):
    assistant_message["tables"] = report_content["tables"]

# ❌ 缺少：html_charts 没有被保存！
```

### 修复后的代码

```python
assistant_message = {
    "role": "assistant",
    "content": cleaned_text,
    "timestamp": datetime.utcnow().isoformat()
}

if charts:
    assistant_message["charts"] = charts

if html_charts:
    assistant_message["html_charts"] = html_charts  # ✅ 新增：保存html_charts

if report_content.get("tables"):
    assistant_message["tables"] = report_content["tables"]
```

## 影响范围

- **新报告**：修复后生成的报告会正确保存和显示图表
- **旧报告**：修复前生成的报告没有 `html_charts`，点击后图表不显示

## 解决方案

### 方案1：重新生成报告（推荐）

对于重要的报告：

1. 删除旧报告
2. 重新上传Excel文件
3. 重新生成报告

**优点**：
- 简单直接
- 确保数据完整
- 可以使用最新的图表生成功能

### 方案2：从localStorage恢复（部分有效）

前端代码已经实现了从 localStorage 恢复的逻辑：

```typescript
// 如果后端没有html_charts，尝试从localStorage恢复
if (!htmlCharts) {
    const storageKey = `html_charts_${sessionId}`
    const savedHtmlCharts = localStorage.getItem(storageKey)
    if (savedHtmlCharts) {
        htmlCharts = savedHtmlCharts
    }
}
```

**限制**：
- 只对在同一浏览器生成的报告有效
- 清除浏览器缓存后会丢失
- 不同设备无法访问

### 方案3：数据库迁移脚本（高级）

如果有大量旧报告需要修复，可以创建迁移脚本。

**注意**：这个方案需要重新调用大模型API生成图表，会产生API费用。

创建 `backend/scripts/migrate_add_html_charts.py`：

```python
"""
数据库迁移脚本：为旧报告添加html_charts字段
"""
import asyncio
from sqlalchemy.orm import Session
from app.core.database import SessionLocal
from app.models.session import AnalysisSession
from app.services.bailian_service import BailianService
from loguru import logger
from pathlib import Path

async def migrate_session(session_id: int, db: Session):
    """为单个会话添加html_charts"""
    try:
        conversation = db.query(AnalysisSession).filter(
            AnalysisSession.id == session_id
        ).first()
        
        if not conversation or not conversation.messages:
            return False
        
        # 查找最后一条assistant消息
        assistant_messages = [msg for msg in conversation.messages if msg.get("role") == "assistant"]
        if not assistant_messages:
            return False
        
        last_msg = assistant_messages[-1]
        
        # 如果已经有html_charts，跳过
        if last_msg.get("html_charts"):
            logger.info(f"会话 {session_id} 已有html_charts，跳过")
            return False
        
        # 查找对应的用户消息（获取文件路径）
        user_messages = [msg for msg in conversation.messages if msg.get("role") == "user"]
        if not user_messages:
            return False
        
        last_user_msg = user_messages[-1]
        file_name = last_user_msg.get("file_name")
        
        if not file_name:
            logger.warning(f"会话 {session_id} 没有文件名，跳过")
            return False
        
        # 构建文件路径
        file_path = Path(f"uploads/operation/project_1") / file_name
        if not file_path.exists():
            logger.warning(f"会话 {session_id} 的文件不存在: {file_path}")
            return False
        
        # 调用大模型生成HTML图表
        logger.info(f"开始为会话 {session_id} 生成HTML图表...")
        bailian_service = BailianService()
        
        result = await bailian_service.analyze_excel_and_generate_html(
            file_path=str(file_path),
            analysis_request=last_user_msg.get("content", ""),
            chart_customization=None
        )
        
        if result.get("success") and result.get("html_content"):
            # 更新消息
            last_msg["html_charts"] = result["html_content"]
            conversation.messages = conversation.messages  # 触发JSONB更新
            db.commit()
            logger.info(f"✅ 会话 {session_id} HTML图表生成成功，长度: {len(result['html_content'])}")
            return True
        else:
            logger.error(f"❌ 会话 {session_id} HTML图表生成失败: {result.get('error')}")
            return False
    
    except Exception as e:
        logger.error(f"❌ 迁移会话 {session_id} 失败: {str(e)}")
        db.rollback()
        return False

async def main():
    """主函数"""
    db = SessionLocal()
    try:
        # 查询所有需要迁移的会话
        sessions = db.query(AnalysisSession).filter(
            AnalysisSession.function_key == "operation_data_analysis"
        ).all()
        
        logger.info(f"找到 {len(sessions)} 个会话")
        
        success_count = 0
        skip_count = 0
        fail_count = 0
        
        for session in sessions:
            result = await migrate_session(session.id, db)
            if result:
                success_count += 1
            elif result is False:
                skip_count += 1
            else:
                fail_count += 1
        
        logger.info(f"迁移完成：成功 {success_count}，跳过 {skip_count}，失败 {fail_count}")
    
    finally:
        db.close()

if __name__ == "__main__":
    asyncio.run(main())
```

**运行迁移**：
```bash
docker exec operation-analysis-v2-backend python scripts/migrate_add_html_charts.py
```

**注意事项**：
- 会重新调用大模型API，产生费用
- 需要原始Excel文件仍然存在
- 建议先备份数据库
- 可以先测试单个会话

## 验证修复

### 1. 测试新报告

1. 生成一个新报告
2. 点击左侧历史会话列表中的这个报告
3. 检查图表是否正确显示

### 2. 检查数据库

```sql
-- 查看会话消息中是否包含html_charts
SELECT 
    id,
    title,
    jsonb_array_length(messages) as message_count,
    messages -> -1 -> 'html_charts' as last_html_charts
FROM analysis_sessions
WHERE function_key = 'operation_data_analysis'
ORDER BY updated_at DESC
LIMIT 10;
```

### 3. 检查localStorage

在浏览器控制台运行：
```javascript
// 查看所有保存的HTML图表
for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('html_charts_')) {
        const value = localStorage.getItem(key);
        console.log(key, '长度:', value.length);
    }
}
```

## 预防措施

1. **定期备份数据库**
2. **保留原始Excel文件**
3. **测试新功能后再删除旧报告**
4. **使用版本管理功能保存重要报告**

## 相关文件

- `backend/app/api/v1/operation.py` - 报告生成和保存逻辑
- `frontend/src/views/Operation/DataAnalysis.vue` - 前端加载和显示逻辑
- `backend/app/services/bailian_service.py` - 大模型API调用
