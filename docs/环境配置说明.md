# 阿里百炼API环境配置说明

## 1. 环境变量配置

在项目根目录的 `.env` 文件中添加以下配置：

```env
# 阿里百炼DashScope配置（Qwen-3 32B）
DASHSCOPE_API_KEY=sk-f72852ce679f42019f669589a51e2639
DASHSCOPE_MODEL=qwen-3-32b

# 如果使用OpenAI兼容接口，需要配置API基础URL
# DASHSCOPE_API_BASE=https://api.example.com
```

**注意**：API密钥已配置为 `sk-f72852ce679f42019f669589a51e2639`（Qwen-3 32B模型）

### 获取API密钥

1. 访问 [阿里云百炼平台](https://dashscope.console.aliyun.com/)
2. 登录您的阿里云账号
3. 进入"API-KEY管理"页面
4. 创建新的API密钥
5. 将密钥复制到 `.env` 文件中的 `DASHSCOPE_API_KEY`

### 模型选择

- `qwen-plus`: 推荐使用，性能平衡
- `qwen-turbo`: 速度更快，成本更低
- `qwen-max`: 性能最强，成本较高

## 2. 安装依赖

### Docker环境

```bash
# 进入后端容器
docker-compose exec backend bash

# 安装依赖
pip install pyecharts pandas numpy

# 或重建容器（推荐）
docker-compose build backend
docker-compose up -d
```

### 本地环境

```bash
cd backend
pip install -r requirements.txt
```

## 3. 验证配置

### 检查配置是否生效

```bash
# 进入后端容器
docker-compose exec backend python

# 测试配置
from app.core.config import settings
print(f"DASHSCOPE_API_KEY: {settings.DASHSCOPE_API_KEY[:10]}...")
print(f"DASHSCOPE_MODEL: {settings.DASHSCOPE_MODEL}")
```

### 测试API连接

```python
# 测试脚本 test_bailian.py
import asyncio
from app.services.bailian_service import BailianService

async def test():
    service = BailianService()
    # 这里需要一个测试Excel文件路径
    result = await service.analyze_excel_and_generate_chart_config(
        file_path="test.xlsx",
        analysis_request="分析数据趋势",
        generate_type="json"
    )
    print(result)

asyncio.run(test())
```

## 4. 常见问题

### 问题1: API密钥未配置

**错误信息**: `DASHSCOPE_API_KEY未配置`

**解决方法**: 
- 检查 `.env` 文件中是否添加了 `DASHSCOPE_API_KEY`
- 确保后端服务已重启以加载新的环境变量

### 问题2: API调用失败

**错误信息**: `DashScope API调用失败: HTTP 401`

**解决方法**:
- 检查API密钥是否正确
- 确认API密钥是否已激活
- 检查账户余额是否充足

### 问题3: JSON解析失败

**错误信息**: `无法从API响应中提取JSON配置`

**解决方法**:
- 检查API返回的内容格式
- 查看日志中的原始响应内容
- 可能需要调整Prompt以更好地引导AI生成JSON格式

## 5. 配置检查清单

- [ ] `.env` 文件中已添加 `DASHSCOPE_API_KEY`
- [ ] `.env` 文件中已添加 `DASHSCOPE_MODEL`（可选）
- [ ] 已安装 `pyecharts`、`pandas`、`numpy` 依赖
- [ ] 后端服务已重启
- [ ] API密钥有效且有余额
- [ ] 测试API调用成功

## 6. 下一步

配置完成后，可以：
1. 上传Excel文件进行测试
2. 提交分析需求
3. 验证图表和文字是否正常生成

如有问题，请查看后端日志：
```bash
docker-compose logs backend --tail 100
```

