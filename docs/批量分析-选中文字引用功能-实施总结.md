# 批量分析 - 选中文字引用功能实施总结

## 📋 需求背景

用户反馈：批量数据分析板块的AI编辑界面没有"选中文字自动引用到输入框"的功能，需要从单文件分析移植过来。

## ✅ 已完成工作

### 1. 功能分析

**单文件分析的实现：**
- 监听 `mouseup` 事件
- 使用 `window.getSelection()` 获取选中文字
- 检查选中文字是否在报告区域内
- 添加高亮动画效果
- 提取上下文（前后各500字符）
- 调用 `DialogPanel` 的 `setSelectedText` 方法

### 2. 代码移植

#### 2.1 批量分析页面 (BatchAnalysis.vue)

**新增函数：**

```typescript
// 文本选择监听
const handleTextSelection = () => {
  // 只在对话面板打开时监听
  if (!showDialogPanel.value) return
  
  const selection = window.getSelection()
  const selectedText = selection?.toString().trim()
  
  if (!selectedText || selectedText.length < 2) {
    return
  }
  
  // 检查选中的文本是否在报告区域内
  const reportArea = document.querySelector('.dialog-right-panel')
  if (!reportArea || !selection?.anchorNode) return
  
  if (!reportArea.contains(selection.anchorNode)) {
    return
  }
  
  console.log('[BatchAnalysis] 检测到文本选择:', selectedText.substring(0, 50) + '...')
  
  // 添加高亮动画效果
  addSelectionHighlight(selection)
  
  // 提取上下文
  const context = extractTextContext(selectedText, reportArea as HTMLElement)
  
  // 传递给DialogPanel
  if (dialogPanelRef.value) {
    dialogPanelRef.value.setSelectedText(selectedText, context)
  }
}

// 添加选中文字的高亮动画
const addSelectionHighlight = (selection: Selection) => {
  try {
    const range = selection.getRangeAt(0)
    
    // 创建高亮元素
    const highlight = document.createElement('span')
    highlight.className = 'text-selection-highlight'
    highlight.style.cssText = `
      background: linear-gradient(120deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
      border-radius: 4px;
      padding: 2px 0;
      animation: highlightPulse 0.5s ease-out;
    `
    
    // 包裹选中的内容
    range.surroundContents(highlight)
    
    // 2秒后移除高亮效果
    setTimeout(() => {
      if (highlight.parentNode) {
        const parent = highlight.parentNode
        while (highlight.firstChild) {
          parent.insertBefore(highlight.firstChild, highlight)
        }
        parent.removeChild(highlight)
      }
    }, 2000)
  } catch (e) {
    console.log('[BatchAnalysis] 无法添加高亮效果（可能是跨元素选择）')
  }
}

// 提取选中文字的上下文
const extractTextContext = (selectedText: string, container: HTMLElement) => {
  const fullText = container.innerText || ''
  const startIndex = fullText.indexOf(selectedText)
  
  if (startIndex === -1) {
    return {
      beforeContext: '',
      afterContext: '',
      fullText: fullText
    }
  }
  
  const endIndex = startIndex + selectedText.length
  const CONTEXT_LENGTH = 500
  
  return {
    beforeContext: fullText.substring(Math.max(0, startIndex - CONTEXT_LENGTH), startIndex),
    afterContext: fullText.substring(endIndex, Math.min(fullText.length, endIndex + CONTEXT_LENGTH)),
    fullText: fullText
  }
}
```

**生命周期钩子修改：**

```typescript
onMounted(async () => {
  // ... 原有代码 ...
  
  // 添加文本选择监听
  document.addEventListener('mouseup', handleTextSelection)
})

onBeforeUnmount(() => {
  stopStatusPolling()
  // 移除文本选择监听
  document.removeEventListener('mouseup', handleTextSelection)
})
```

#### 2.2 定制化批量分析页面 (CustomBatchAnalysis.vue)

完全相同的修改，只是日志标签改为 `[CustomBatchAnalysis]`。

### 3. 功能特性

#### 3.1 智能检测
- ✅ 只在AI对话面板打开时监听
- ✅ 只检测报告区域内的文字选择
- ✅ 过滤过短的选择（少于2个字符）

#### 3.2 视觉反馈
- ✅ 选中文字后显示渐变高亮效果
- ✅ 2秒后自动移除高亮
- ✅ 支持跨元素选择（优雅降级）

#### 3.3 上下文提取
- ✅ 提取选中文字前后各500字符
- ✅ 处理边界情况（文本开头/结尾）
- ✅ 传递完整文本供AI理解

#### 3.4 DialogPanel集成
- ✅ 调用 `setSelectedText` 方法
- ✅ 传递选中文字和上下文
- ✅ 显示在对话面板的引用区

## 🎯 使用流程

### 用户操作步骤

1. **打开AI对话面板**
   - 点击"AI对话"按钮

2. **选中报告文字**
   - 在右侧报告区域用鼠标选中文字
   - 选中后会看到渐变高亮效果

3. **查看引用区**
   - 对话面板底部会显示"已选中文字"引用区
   - 显示选中的文字内容

4. **输入修改指令**
   - 在输入框中输入指令
   - 或点击快捷按钮（润色、简化、扩写、改写）

5. **发送消息**
   - 点击"发送"按钮
   - AI会根据选中文字和指令进行修改

### 示例场景

**场景1：润色报告结论**
```
1. 选中："VIP用户的rmb_ltv比较高"
2. 点击"润色"快捷按钮
3. AI返回："VIP等级用户的生命周期价值（LTV）显著高于其他用户群体"
```

**场景2：简化复杂表达**
```
1. 选中："在深度分析部分，需要比较不同用户类型..."
2. 点击"简化"快捷按钮
3. AI返回："需要对比新用户和转化用户的表现差异"
```

**场景3：自定义修改**
```
1. 选中："建议优化新手引导"
2. 输入："扩写这段内容，添加具体建议"
3. AI返回详细的优化建议
```

## 📊 技术细节

### 事件监听
- **事件类型**：`mouseup`
- **监听范围**：整个文档
- **过滤条件**：
  - 对话面板必须打开
  - 选中文字长度 >= 2
  - 选中位置在报告区域内

### 高亮动画
- **背景色**：渐变紫色（rgba(102, 126, 234, 0.3) → rgba(118, 75, 162, 0.3)）
- **持续时间**：2秒
- **动画效果**：highlightPulse
- **错误处理**：跨元素选择时优雅降级

### 上下文提取
- **前后文长度**：各500字符
- **边界处理**：
  - 开头：`Math.max(0, startIndex - 500)`
  - 结尾：`Math.min(fullText.length, endIndex + 500)`
- **数据结构**：
  ```typescript
  {
    beforeContext: string,
    afterContext: string,
    fullText: string
  }
  ```

## 🔍 与单文件分析的差异

| 项目 | 单文件分析 | 批量分析 |
|------|-----------|---------|
| 报告区域选择器 | `reportDisplayRef.value` | `.dialog-right-panel` |
| 日志标签 | `[DataAnalysis]` | `[BatchAnalysis]` / `[CustomBatchAnalysis]` |
| 其他逻辑 | 完全相同 | 完全相同 |

## ✅ 测试清单

### 基础功能
- [ ] 打开AI对话面板
- [ ] 选中报告中的文字
- [ ] 查看高亮效果
- [ ] 查看引用区显示
- [ ] 点击快捷按钮
- [ ] 输入自定义指令
- [ ] 发送消息
- [ ] 查看AI响应

### 边界情况
- [ ] 选中少于2个字符
- [ ] 选中报告区域外的文字
- [ ] 对话面板关闭时选中文字
- [ ] 跨元素选择文字
- [ ] 选中文本开头/结尾

### 交互体验
- [ ] 高亮动画流畅
- [ ] 2秒后高亮消失
- [ ] 引用区可以清除
- [ ] 快捷按钮响应正常
- [ ] 发送后引用区清空

## 📝 注意事项

### 1. 报告区域选择器
批量分析使用 `.dialog-right-panel` 作为报告区域选择器，因为：
- 对话模式下，报告显示在右侧面板
- 需要确保只监听报告区域的文字选择
- 避免监听对话面板内的文字选择

### 2. 高亮效果的限制
- 跨元素选择时无法添加高亮（会被捕获并忽略）
- 这是正常行为，不影响功能使用
- 用户仍然可以看到引用区的显示

### 3. 性能考虑
- 只在对话面板打开时监听
- 使用 `querySelector` 而不是 `ref`（避免响应式开销）
- 高亮元素2秒后自动清理

## 🎉 完成状态

- ✅ 批量分析页面 (BatchAnalysis.vue)
- ✅ 定制化批量分析页面 (CustomBatchAnalysis.vue)
- ✅ 代码语法检查通过
- ✅ 功能逻辑完整
- ✅ 文档编写完成

## 🚀 下一步

建议进行以下测试：
1. 启动项目
2. 进入批量分析页面
3. 生成报告
4. 打开AI对话面板
5. 选中文字测试功能

---

**实施时间：** 2025-12-26  
**实施人员：** Kiro AI Assistant  
**相关文件：**
- `frontend/src/views/Operation/BatchAnalysis.vue`
- `frontend/src/views/Operation/CustomBatchAnalysis.vue`
- `frontend/src/views/Operation/components/DialogPanel.vue`
