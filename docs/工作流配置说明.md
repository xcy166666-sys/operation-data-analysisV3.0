# 工作流配置说明

## 工作流配置信息

根据原项目的运营数据分析API配置，工作流配置如下：

### Dify 工作流配置

- **工作流名称：** 运营数据分析工作流
- **Dify API地址：** http://118.89.16.95/v1
- **API Key：** app-enMcZvGV69jXZ8D7SMJUjCqF
- **工作流ID：** 1
- **工作流类型：** chatflow
- **输入变量名：** `excell`、`sys.query`
- **功能键：** `operation_data_analysis`

### 配置方法

#### 方法1：使用配置脚本（推荐）

```bash
cd backend
python scripts/bind_operation_workflow.py
```

#### 方法2：通过API配置

1. 登录系统（管理员账号）
2. 访问前端页面
3. 点击"设置"按钮
4. 填写以下信息：
   - **AI平台：** Dify
   - **工作流名称：** 运营数据分析工作流
   - **Dify API地址：** http://118.89.16.95/v1
   - **API Key：** app-enMcZvGV69jXZ8D7SMJUjCqF
   - **工作流ID：** 1
   - **工作流类型：** chatflow
   - **输入变量名：** excell,sys.query

#### 方法3：直接操作数据库

如果上述方法都不可用，可以直接在数据库中插入配置：

```sql
-- 1. 创建工作流
INSERT INTO workflows (name, category, platform, config, description, is_active, created_by, created_at, updated_at)
VALUES (
    '运营数据分析工作流',
    'operation',
    'dify',
    '{"api_url": "http://118.89.16.95/v1", "api_key": "app-enMcZvGV69jXZ8D7SMJUjCqF", "workflow_id": "1", "workflow_type": "chatflow", "input_field": "excell,sys.query"}'::jsonb,
    '运营数据分析工作流，用于分析Excel文件并生成报告',
    true,
    1,
    NOW(),
    NOW()
);

-- 2. 绑定工作流到功能
INSERT INTO workflow_bindings (workflow_id, function_key, created_at, updated_at)
VALUES (
    (SELECT id FROM workflows WHERE name = '运营数据分析工作流' LIMIT 1),
    'operation_data_analysis',
    NOW(),
    NOW()
)
ON CONFLICT (function_key) DO UPDATE
SET workflow_id = EXCLUDED.workflow_id, updated_at = NOW();
```

### 验证配置

配置完成后，可以通过以下方式验证：

1. **通过API验证：**
   ```bash
   curl -X GET "http://localhost:8000/api/v1/workflows/functions/operation_data_analysis" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

2. **通过前端验证：**
   - 访问数据分析页面
   - 如果配置正确，页面应该能正常加载工作流配置

### 数据流转说明

#### 文件上传流程

1. **前端上传文件**
   - 用户选择 Excel 文件
   - 前端调用 `POST /api/v1/operation/upload`
   - 文件保存到：`backend/uploads/operation/{session_id}_{uuid}.xlsx`

2. **生成报告流程**
   - 用户输入分析需求并点击"生成报告"
   - 前端调用 `POST /api/v1/operation/generate`
   - 后端处理：
     - 读取上传的 Excel 文件
     - 将文件内容转换为 base64 编码
     - 构建 Dify 工作流输入：
       ```json
       {
         "excell": "UEsDBBQAAAAIAG...",  // base64编码的文件内容
         "sys.query": "用户的分析需求文本"
       }
       ```
     - 调用 Dify API：`POST http://118.89.16.95/v1/workflows/run`
     - 传递工作流ID：`1`
     - 传递输入变量：`excell` 和 `sys.query`

3. **Dify 工作流处理**
   - Dify 工作流接收 `excell`（base64编码的Excel文件）
   - Dify 工作流接收 `sys.query`（用户的分析需求）
   - Dify 工作流内部：
     - 解码 base64 获取 Excel 文件
     - 解析 Excel 文件
     - 根据 `sys.query` 进行数据分析
     - 生成分析报告

4. **返回结果**
   - Dify 工作流返回分析报告
   - 后端解析 Dify 响应
   - 返回报告给前端显示

### 注意事项

1. **输入变量名必须匹配**
   - Dify 工作流的输入变量名必须是 `excell` 和 `sys.query`
   - 如果 Dify 工作流中的变量名不同，需要修改 `backend/app/api/v1/operation.py` 中的映射

2. **文件格式**
   - 支持 `.xlsx` 和 `.csv` 格式
   - 文件大小限制：10MB
   - 文件以 base64 编码形式传递给 Dify

3. **工作流配置**
   - 工作流配置已保存在数据库中
   - 可以通过前端页面的"设置"按钮查看和修改配置
   - 配置信息包括：API地址、API Key、工作流ID、输入变量名

### 故障排查

如果遇到问题，请检查：

1. **后端日志**
   - 查看 `backend/app/api/v1/operation.py` 中的日志输出
   - 确认文件路径、base64 编码、Dify API 调用等信息

2. **Dify 工作流配置**
   - 确认 Dify 工作流的输入变量名是 `excell` 和 `sys.query`
   - 确认 Dify 工作流ID是 `1`
   - 确认 API 地址和 API Key 正确

3. **数据库配置**
   - 确认工作流已正确绑定到功能
   - 检查 `workflows` 表和 `workflow_bindings` 表的数据

4. **网络连接**
   - 确认后端服务器可以访问 Dify API 地址：`http://118.89.16.95/v1`
   - 检查防火墙和网络配置

