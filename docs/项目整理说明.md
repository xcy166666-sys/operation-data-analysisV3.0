# 项目整理说明

## 整理目标

确保项目部署后自动配置好 Dify API，无需手动操作。

## 已完成的修改

### 1. 修改工作流配置脚本 (`backend/scripts/setup_all_workflows.py`)

**修改内容**：
- ✅ 修正功能键（function_key）：
  - `operation_data_analysis` - 单文件数据分析
  - `operation_batch_analysis` - 批量数据分析
  - `custom_operation_data_analysis` - 定制化批量分析（6个工作流，Sheet 0-5）
- ✅ 添加 `sheet_index` 支持，正确配置定制化批量分析的 6 个工作流
- ✅ 添加 `api_url` 字段到配置中
- ✅ 更新绑定逻辑，支持 `sheet_index` 匹配

**配置的工作流**：
1. 单文件数据分析工作流
2. 批量数据分析工作流
3. 定制化批量分析 - Sheet 0（最后操作分布）
4. 定制化批量分析 - Sheet 1（新手漏斗）
5. 定制化批量分析 - Sheet 2（回流用户）
6. 定制化批量分析 - Sheet 3（流失用户属性）
7. 定制化批量分析 - Sheet 4（留存率）
8. 定制化批量分析 - Sheet 5（LTV）

### 2. 创建完整初始化脚本 (`backend/scripts/init_all.py`)

**功能**：
- 整合功能模块初始化和工作流配置初始化
- 提供统一的初始化入口
- 验证初始化结果

### 3. 添加自动初始化逻辑 (`backend/main.py`)

**功能**：
- 应用启动时自动检查数据库初始化状态
- 如果未初始化，自动执行初始化
- 如果已初始化，跳过初始化（不覆盖现有配置）
- 记录初始化日志

**初始化时机**：
- 应用首次启动时
- 检测到数据库未初始化时
- 不会覆盖已存在的配置

### 4. 创建部署文档

**新增文件**：
- `部署说明.md` - 详细的部署文档
- `快速部署指南.md` - 简化的快速部署步骤
- `项目整理说明.md` - 本文档

**更新文件**：
- `README.md` - 添加自动初始化说明

## 部署流程

### 新部署环境

1. **解压项目文件**
2. **启动服务**：`docker-compose up -d`
3. **等待自动初始化**（约 1-2 分钟）
4. **创建管理员账号**：`docker-compose exec backend python scripts/create_admin.py`
5. **访问系统**：http://localhost:20800

**无需手动配置 API！**

### 验证初始化

查看后端日志：
```bash
docker-compose logs backend | grep "初始化"
```

应该看到：
```
✅ 数据库自动初始化成功（功能模块 + 工作流配置）
```

## API 配置位置

所有 Dify API 配置硬编码在：
```
backend/scripts/setup_all_workflows.py
```

**WORKFLOWS_CONFIG** 变量包含所有工作流配置，包括：
- API 地址
- API Key
- 文件上传 URL
- 工作流 URL
- 其他参数

## 修改 API 配置

### 方法 1：修改代码（推荐用于批量修改）

1. 编辑 `backend/scripts/setup_all_workflows.py`
2. 修改 `WORKFLOWS_CONFIG` 中的配置
3. 重启后端：`docker-compose restart backend`
4. 重新运行初始化：`docker-compose exec backend python scripts/init_all.py`

### 方法 2：通过前端管理界面（推荐用于单个修改）

1. 登录超级管理员账号
2. 进入"功能管理"页面
3. 点击"配置API"按钮
4. 修改配置并保存

## 文件清单

### 核心文件

- `backend/scripts/setup_all_workflows.py` - **工作流配置（API配置在这里）**
- `backend/scripts/init_all.py` - 完整初始化脚本
- `backend/scripts/init_function_modules.py` - 功能模块初始化
- `backend/main.py` - 应用入口（自动初始化逻辑）

### 文档文件

- `部署说明.md` - 详细部署文档
- `快速部署指南.md` - 快速部署步骤
- `README.md` - 项目说明（已更新）
- `项目整理说明.md` - 本文档

## 测试建议

部署到新环境后，建议测试：

1. ✅ 检查功能模块是否创建（3个）
2. ✅ 检查工作流配置是否创建（8个）
3. ✅ 测试单文件数据分析功能
4. ✅ 测试批量数据分析功能
5. ✅ 测试定制化批量分析功能（6个工作流）

## 注意事项

1. **API Key 安全**：API Key 已硬编码在代码中，如需修改请编辑 `setup_all_workflows.py`
2. **初始化时机**：只在首次启动时自动初始化，后续启动不会覆盖现有配置
3. **手动初始化**：如需重新初始化，运行 `python scripts/init_all.py`
4. **配置优先级**：用户级配置 > 全局配置（自动初始化的配置）

## 总结

✅ 所有 Dify API 配置已硬编码在代码中  
✅ 应用启动时自动初始化  
✅ 无需手动配置，开箱即用  
✅ 完整的部署文档已创建  

**项目已整理完成，可以直接打包发给别人使用！**

