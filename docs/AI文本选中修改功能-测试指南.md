# AI文本选中修改功能 - 测试指南

## 功能说明

这是一个类似Notion AI的"选中即修改"功能，用户可以选中报告中的任何文字，输入修改指令，AI会根据上下文生成新的文本并原地替换。

---

## 测试步骤

### 1. 启动服务

#### 后端（Docker）
```bash
# 后端应该已经在运行
docker ps | grep backend
```

#### 前端
```bash
cd frontend
npm run dev
```

### 2. 生成一份报告

1. 访问 http://localhost:5173
2. 上传Excel文件
3. 输入分析需求
4. 等待报告生成完成

### 3. 测试文本选中修改

#### 测试场景1：润色文本
1. 在生成的报告中，用鼠标选中一段文字（例如："数据显示用户流失率较高"）
2. 松开鼠标后，会弹出浮动工具栏
3. 在输入框中输入："润色这段话，使用更专业的表达"
4. 点击"提交"按钮
5. 等待AI处理（约5-15秒）
6. 原文本应该被替换为更专业的表达

#### 测试场景2：使用快捷指令
1. 选中一段文字
2. 点击浮动工具栏中的"润色"快捷按钮
3. 点击"提交"
4. 观察文本是否被润色

#### 测试场景3：简化表达
1. 选中一段复杂的技术描述
2. 输入指令："简化这段话，让非技术人员也能理解"
3. 提交并观察结果

#### 测试场景4：扩写内容
1. 选中一个简短的结论（例如："用户活跃度下降"）
2. 输入指令："扩写这个结论，增加具体数据支撑"
3. 提交并观察结果

### 4. 测试交互功能

#### 测试菜单关闭
- **点击空白处**：选中文本后，点击页面其他地方，菜单应该关闭
- **按ESC键**：选中文本后，按ESC键，菜单应该关闭
- **点击取消按钮**：点击工具栏的"取消"按钮，菜单应该关闭

#### 测试菜单定位
- 选中页面顶部的文字，菜单应该显示在选区下方
- 选中页面中部的文字，菜单应该显示在选区上方
- 选中页面右侧的文字，菜单应该不超出右边界

---

## 预期效果

### 成功标志
1. ✅ 选中文本后，浮动工具栏正确显示
2. ✅ 工具栏定位准确，不遮挡选中的文字
3. ✅ 输入指令后，AI能在5-15秒内返回结果
4. ✅ 原文本被正确替换为新文本
5. ✅ 替换后的文本符合上下文语境
6. ✅ 点击空白处或按ESC键，菜单正确关闭

### 性能指标
- **API响应时间**：5-15秒（远低于之前的60秒超时）
- **发送内容大小**：约1000-1500字符（比之前的6000字符减少83%）
- **成功率**：应该接近100%（不再出现超时）

---

## 常见问题排查

### 问题1：工具栏不显示
**可能原因**：
- 选中的文本不在目标元素内
- JavaScript错误

**排查方法**：
1. 打开浏览器控制台（F12）
2. 查看是否有错误信息
3. 确认选中的是报告内容区域的文字

### 问题2：AI返回失败
**可能原因**：
- 后端API未启动
- 阿里百炼API配置错误
- 网络问题

**排查方法**：
1. 检查后端日志：`docker logs operation-analysis-v2-backend`
2. 确认DASHSCOPE_API_KEY已配置
3. 查看浏览器Network标签，检查API请求状态

### 问题3：文本替换失败
**可能原因**：
- 选区信息丢失
- DOM结构变化

**排查方法**：
1. 查看浏览器控制台错误
2. 尝试重新选中文本
3. 刷新页面后重试

### 问题4：菜单定位不准确
**可能原因**：
- 页面滚动
- 窗口缩放

**解决方法**：
- 这是已知问题，可以通过监听scroll和resize事件优化（阶段3）

---

## 后端日志关键信息

### 成功的日志示例
```
[文本编辑API] 用户3请求编辑文本 - 指令: 润色这段话, 选中文本长度: 45
[BailianService] 调用API - model=qwen3-32b, format=DashScope, prompt_length=1234, stream=True
[BailianService] 流式响应完成，总长度: 89 字符
[文本编辑API] AI返回成功 - 原文本长度: 45, 新文本长度: 89
```

### 失败的日志示例
```
[文本编辑API] 处理失败: API调用失败
[BailianService] API调用异常: RemoteProtocolError
```

---

## 下一步优化（阶段3）

1. **添加加载动画**：显示更友好的加载状态
2. **优化菜单定位**：监听scroll和resize事件
3. **添加撤销功能**：替换后可以恢复原文本
4. **添加历史记录**：记录常用指令
5. **添加更多快捷指令**：翻译、总结、扩写等

---

## 技术亮点

### 1. 上下文控制
- 只发送选中文本前后各500字符
- 总内容控制在1200字符左右
- 比之前的6000字符减少83%

### 2. 快速响应
- API响应时间：5-15秒
- 比之前的60-112秒提升6-10倍
- 不再出现超时问题

### 3. 精准修改
- 用户明确指定修改位置
- AI理解更准确
- 支持多次迭代修改

### 4. 流畅交互
- 浮动工具栏定位准确
- 支持快捷指令
- 支持键盘快捷键

---

## 总结

这个功能通过"选中即修改"的方式，完美解决了之前AI对话功能中上下文过长导致的超时问题。用户可以像使用Notion AI一样，快速、精准地修改报告的任何部分。
