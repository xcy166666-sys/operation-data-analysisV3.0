# 版本历史查看功能 - 交互设计方案

## 📋 需求概述

用户希望在左侧历史会话列表中，点击某个会话项后，能够在下方展开显示该会话的所有历史版本，点击版本后可以查看该版本的完整报告内容。

---

## 🎨 交互设计

### 1. 版本列表展开/折叠

#### 触发方式
在每个会话项的右侧添加一个"版本历史"图标按钮（📄 或 🕐）

```
┌─────────────────────────────────────┐
│ 📄 LTV - 副本 (2)                    │
│    今天                    [📄]      │  ← 点击此图标
│    进行中                            │
└─────────────────────────────────────┘
```

#### 展开效果
点击图标后，在会话项下方展开版本列表面板

```
┌─────────────────────────────────────┐
│ 📄 LTV - 副本 (2)                    │
│    今天                    [📄]      │  ← 图标变为向下箭头
│    进行中                            │
├─────────────────────────────────────┤
│   📌 版本历史 (2个版本)              │  ← 版本面板标题
│   ┌───────────────────────────────┐ │
│   │ V2 - 添加了新的分析章节        │ │  ← 最新版本
│   │ 2分钟前              [当前]   │ │
│   └───────────────────────────────┘ │
│   ┌───────────────────────────────┐ │
│   │ V1 - 初始版本                 │ │
│   │ 10分钟前                      │ │
│   └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### 折叠效果
再次点击图标，版本面板平滑收起

---

### 2. 版本列表样式设计

#### 版本项布局
```
┌─────────────────────────────────────┐
│ V2 - 添加了新的分析章节              │  ← 版本号 + 说明
│ 2分钟前                    [当前]   │  ← 时间 + 标签
└─────────────────────────────────────┘
```

#### 视觉层次
- **当前版本**：高亮显示（蓝色边框 + 蓝色标签）
- **历史版本**：灰色背景，悬停时变亮
- **版本号**：粗体显示（V1, V2, V3...）
- **版本说明**：正常字体，灰色
- **时间**：小字体，浅灰色

#### 交互状态
- **默认**：灰色背景 `#f5f7fa`
- **悬停**：浅蓝色背景 `#ecf5ff`，显示"点击查看"提示
- **当前**：蓝色边框 `#409eff`，蓝色标签
- **点击**：加载动画，然后切换到该版本

---

### 3. 查看版本详情

#### 点击版本后的行为

**步骤1：加载提示**
```
┌─────────────────────────────────────┐
│ V1 - 初始版本                        │
│ 10分钟前              [加载中...]   │  ← 显示加载状态
└─────────────────────────────────────┘
```

**步骤2：切换报告内容**
- 右侧主内容区显示该版本的报告
- 顶部显示版本提示条：
  ```
  ℹ️ 正在查看历史版本 V1 - 初始版本 (10分钟前)  [返回当前版本]
  ```

**步骤3：更新版本列表状态**
- 被查看的版本标记为"查看中"
- 当前版本保持"当前"标签

---

### 4. 版本面板功能

#### 面板头部
```
┌─────────────────────────────────────┐
│ 📌 版本历史 (2个版本)    [刷新] [×] │  ← 标题 + 操作按钮
└─────────────────────────────────────┘
```

#### 操作按钮
- **刷新按钮**：重新加载版本列表
- **关闭按钮**：折叠版本面板

#### 空状态
```
┌─────────────────────────────────────┐
│ 📌 版本历史 (0个版本)               │
│                                     │
│   暂无保存的版本                     │
│   点击右上角"保存版本"按钮创建版本   │
│                                     │
└─────────────────────────────────────┘
```

---

## 🔧 技术实现方案

### 1. 数据结构

#### 会话项扩展
```typescript
interface SessionItem {
  id: number
  title: string
  status: string
  created_at: string
  updated_at: string
  message_count: number
  // 新增字段
  versions?: VersionMeta[]  // 版本列表（懒加载）
  versionsExpanded?: boolean  // 版本面板是否展开
  versionsLoading?: boolean  // 版本列表是否加载中
}
```

#### 版本元数据
```typescript
interface VersionMeta {
  id: number
  version_no: number
  summary?: string
  created_at: string
  is_current: boolean
}
```

### 2. 组件结构

#### HistorySidebar.vue 修改
```vue
<template>
  <div class="history-sidebar">
    <!-- 会话列表 -->
    <div v-for="session in sessions" :key="session.id">
      <!-- 会话项 -->
      <div class="session-item" @click="selectSession(session)">
        <div class="session-info">
          <h4>{{ session.title }}</h4>
          <span>{{ session.updated_at }}</span>
        </div>
        <!-- 版本历史按钮 -->
        <el-button 
          class="version-btn"
          :icon="session.versionsExpanded ? ArrowDown : Document"
          @click.stop="toggleVersions(session)"
        />
      </div>
      
      <!-- 版本面板（可折叠） -->
      <el-collapse-transition>
        <div v-if="session.versionsExpanded" class="versions-panel">
          <!-- 面板头部 -->
          <div class="panel-header">
            <span>📌 版本历史 ({{ session.versions?.length || 0 }}个版本)</span>
            <div class="panel-actions">
              <el-button size="small" :icon="Refresh" @click="refreshVersions(session)" />
              <el-button size="small" :icon="Close" @click="toggleVersions(session)" />
            </div>
          </div>
          
          <!-- 加载状态 -->
          <div v-if="session.versionsLoading" class="loading">
            <el-icon class="is-loading"><Loading /></el-icon>
            <span>加载中...</span>
          </div>
          
          <!-- 版本列表 -->
          <div v-else-if="session.versions?.length" class="versions-list">
            <div 
              v-for="version in session.versions" 
              :key="version.id"
              class="version-item"
              :class="{ 'is-current': version.is_current, 'is-viewing': isViewingVersion(version) }"
              @click="viewVersion(session, version)"
            >
              <div class="version-info">
                <span class="version-no">V{{ version.version_no }}</span>
                <span class="version-summary">{{ version.summary || '无说明' }}</span>
              </div>
              <div class="version-meta">
                <span class="version-time">{{ formatTime(version.created_at) }}</span>
                <el-tag v-if="version.is_current" size="small" type="primary">当前</el-tag>
                <el-tag v-else-if="isViewingVersion(version)" size="small" type="info">查看中</el-tag>
              </div>
            </div>
          </div>
          
          <!-- 空状态 -->
          <div v-else class="empty-state">
            <el-empty description="暂无保存的版本" :image-size="60">
              <template #description>
                <p>点击右上角"保存版本"按钮创建版本</p>
              </template>
            </el-empty>
          </div>
        </div>
      </el-collapse-transition>
    </div>
  </div>
</template>
```

### 3. 核心方法

#### 切换版本面板
```typescript
const toggleVersions = async (session: SessionItem) => {
  // 切换展开状态
  session.versionsExpanded = !session.versionsExpanded
  
  // 首次展开时加载版本列表
  if (session.versionsExpanded && !session.versions) {
    await loadVersions(session)
  }
}
```

#### 加载版本列表
```typescript
const loadVersions = async (session: SessionItem) => {
  try {
    session.versionsLoading = true
    const response = await getSessionVersions(session.id)
    session.versions = response.data.data
  } catch (error) {
    ElMessage.error('加载版本列表失败')
  } finally {
    session.versionsLoading = false
  }
}
```

#### 查看版本
```typescript
const viewVersion = async (session: SessionItem, version: VersionMeta) => {
  try {
    // 显示加载提示
    ElMessage.info(`正在加载版本 V${version.version_no}...`)
    
    // 获取版本详情
    const response = await getSessionVersionDetail(session.id, version.id)
    const versionDetail = response.data.data
    
    // 触发事件，通知父组件切换报告内容
    emit('version-selected', {
      sessionId: session.id,
      version: versionDetail
    })
    
    // 显示成功提示
    ElMessage.success(`已切换到版本 V${version.version_no}`)
  } catch (error) {
    ElMessage.error('加载版本失败')
  }
}
```

### 4. 父组件处理

#### DataAnalysis.vue 监听版本切换
```typescript
const handleVersionSelected = (payload: { sessionId: number, version: SessionVersionDetail }) => {
  // 标记为查看历史版本模式
  isViewingHistory.value = true
  currentSessionId.value = payload.sessionId
  
  // 更新报告内容
  operationStore.setReportContent({
    text: payload.version.report_text || '',
    html_charts: payload.version.report_html_charts || '',
    charts: payload.version.report_charts_json || []
  })
  
  // 显示版本提示条
  showVersionBanner(payload.version)
}
```

---

## 🎯 用户体验优化

### 1. 动画效果
- **展开/折叠**：使用 `el-collapse-transition` 平滑过渡（300ms）
- **版本切换**：淡入淡出效果（200ms）
- **悬停反馈**：背景色渐变（150ms）

### 2. 加载状态
- **首次加载**：显示骨架屏或加载动画
- **刷新**：显示刷新图标旋转动画
- **切换版本**：显示全局loading遮罩

### 3. 错误处理
- **加载失败**：显示错误提示，提供重试按钮
- **网络超时**：显示超时提示，自动重试
- **权限错误**：显示权限提示，引导用户登录

### 4. 性能优化
- **懒加载**：只在展开时加载版本列表
- **缓存**：已加载的版本列表缓存在内存中
- **虚拟滚动**：版本数量超过20个时使用虚拟滚动

---

## 📱 响应式设计

### 桌面端（>1200px）
- 版本面板宽度：280px（与会话列表同宽）
- 版本项高度：60px
- 字体大小：14px

### 平板端（768px-1200px）
- 版本面板宽度：240px
- 版本项高度：55px
- 字体大小：13px

### 移动端（<768px）
- 版本面板全屏显示
- 版本项高度：50px
- 字体大小：12px

---

## 🎨 样式规范

### 颜色方案
```scss
// 版本面板
$panel-bg: #f5f7fa;
$panel-border: #e4e7ed;

// 版本项
$version-default-bg: #ffffff;
$version-hover-bg: #ecf5ff;
$version-current-border: #409eff;
$version-viewing-bg: #f0f9ff;

// 文字
$text-primary: #303133;
$text-secondary: #606266;
$text-placeholder: #909399;
```

### 间距规范
```scss
$panel-padding: 12px;
$version-item-padding: 12px;
$version-item-margin: 8px;
$icon-size: 16px;
```

---

## 🔄 状态流转

```
[会话项] 
  ↓ 点击版本图标
[展开版本面板] 
  ↓ 首次展开
[加载版本列表] 
  ↓ 加载成功
[显示版本列表]
  ↓ 点击版本
[加载版本详情]
  ↓ 加载成功
[切换报告内容]
  ↓ 显示版本提示条
[查看历史版本]
  ↓ 点击"返回当前版本"
[恢复当前版本]
```

---

## ✅ 实现检查清单

### 后端API（已完成）
- [x] GET `/api/v1/operation/sessions/{id}/versions` - 获取版本列表
- [x] GET `/api/v1/operation/sessions/{id}/versions/{version_id}` - 获取版本详情
- [x] POST `/api/v1/operation/sessions/{id}/versions` - 创建版本

### 前端API（已完成）
- [x] `getSessionVersions(sessionId)` - 获取版本列表
- [x] `getSessionVersionDetail(sessionId, versionId)` - 获取版本详情
- [x] `createSessionVersion(sessionId, payload)` - 创建版本

### 前端组件（待实现）
- [ ] HistorySidebar - 添加版本面板
- [ ] HistorySidebar - 版本列表展示
- [ ] HistorySidebar - 版本切换逻辑
- [ ] DataAnalysis - 监听版本切换事件
- [ ] DataAnalysis - 显示版本提示条
- [ ] DataAnalysis - 返回当前版本功能

### 样式和动画（待实现）
- [ ] 版本面板样式
- [ ] 版本项样式
- [ ] 展开/折叠动画
- [ ] 悬停效果
- [ ] 加载状态

---

## 📝 后续优化

### 短期（1周内）
- [ ] 版本对比功能（对比两个版本的差异）
- [ ] 版本删除功能（删除不需要的版本）
- [ ] 版本重命名功能（修改版本说明）

### 中期（1个月内）
- [ ] 版本回滚功能（将历史版本设为当前版本）
- [ ] 版本导出功能（导出特定版本的报告）
- [ ] 版本搜索功能（按说明或时间搜索版本）

### 长期（3个月内）
- [ ] 版本分支功能（从历史版本创建新分支）
- [ ] 版本合并功能（合并多个版本的内容）
- [ ] 版本标签功能（为重要版本添加标签）

---

## 🎉 总结

这个设计方案提供了：
1. ✅ **直观的交互** - 点击图标展开，点击版本查看
2. ✅ **清晰的视觉** - 当前版本高亮，历史版本灰色
3. ✅ **流畅的动画** - 平滑的展开/折叠效果
4. ✅ **完善的反馈** - 加载状态、错误提示、成功提示
5. ✅ **良好的性能** - 懒加载、缓存、虚拟滚动

下一步可以开始实现前端组件！
