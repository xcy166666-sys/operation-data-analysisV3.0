# 删除会话500错误 - 修复说明

## 问题描述

用户在删除会话时遇到 500 Internal Server Error：
```
DELETE http://localhost:5173/api/v1/operation/sessions/16 500 (Internal Server Error)
```

## 问题原因

1. **缺少级联删除关系**：`AnalysisSession` 模型没有定义与 `AnalysisSessionVersion` 的关系，导致删除会话时无法正确处理关联的版本记录。

2. **数据库外键约束**：虽然 `AnalysisSessionVersion` 表的外键配置了 `ondelete="CASCADE"`，但 SQLAlchemy ORM 层面没有定义 `cascade="all, delete-orphan"`，可能导致删除时出现问题。

## 修复方案

### 1. 更新 AnalysisSession 模型

**文件**: `backend/app/models/session.py`

添加了与版本的关系定义：

```python
class AnalysisSession(Base):
    # ... 其他字段 ...
    
    # 关系
    user = relationship("User", back_populates="analysis_sessions")
    workflow = relationship("Workflow", back_populates="sessions")
    versions = relationship("AnalysisSessionVersion", back_populates="session", cascade="all, delete-orphan")  # 新增
```

**关键点**：
- 添加 `cascade="all, delete-orphan"` 确保删除会话时自动删除所有关联的版本
- 使用 `back_populates` 建立双向关系

### 2. 更新 AnalysisSessionVersion 模型

**文件**: `backend/app/models/session_version.py`

修改关系定义，从 `backref` 改为 `back_populates`：

```python
class AnalysisSessionVersion(Base):
    # ... 其他字段 ...
    
    session = relationship("AnalysisSession", back_populates="versions")  # 修改
```

**原因**：
- `backref` 会自动创建反向关系，但不够明确
- `back_populates` 需要在两边都定义，更清晰且可控

### 3. 增强删除会话 API

**文件**: `backend/app/api/v1/operation.py`

在 `delete_session` 方法中添加了显式删除版本的逻辑：

```python
@router.delete("/sessions/{id}", response_model=SuccessResponse)
async def delete_session(
    id: int = PathParam(..., description="会话ID"),
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    from app.models.session_version import AnalysisSessionVersion
    
    # ... 验证会话 ...
    
    # 2. 先删除所有关联的版本（虽然有CASCADE，但显式删除更安全）
    try:
        versions = db.query(AnalysisSessionVersion).filter(
            AnalysisSessionVersion.session_id == id
        ).all()
        
        if versions:
            logger.info(f"[运营数据分析] 找到 {len(versions)} 个版本，准备删除")
            for version in versions:
                db.delete(version)
            db.flush()  # 先刷新版本删除
            logger.info(f"[运营数据分析] 版本删除成功")
    except Exception as ve:
        logger.warning(f"[运营数据分析] 删除版本时出错（可能不存在）: {str(ve)}")
    
    # 3. 删除会话
    db.delete(conversation)
    db.commit()
```

**改进点**：
- 显式删除版本记录，确保删除顺序正确
- 使用 `db.flush()` 先提交版本删除
- 添加详细的日志记录
- 添加错误堆栈跟踪，便于调试

## 对比其他模型

检查了批量分析和定制化批量分析的模型，它们已经正确配置了级联删除：

### BatchAnalysisSession
```python
sheet_reports = relationship("SheetReport", back_populates="batch_session", cascade="all, delete-orphan")
```

### CustomBatchAnalysisSession
```python
custom_sheet_reports = relationship("CustomSheetReport", back_populates="custom_batch_session", cascade="all, delete-orphan")
```

这些模型的删除功能正常工作，证明了正确配置级联删除的重要性。

## 测试验证

修复后需要测试：

1. **删除没有版本的会话**
   - 创建新会话
   - 直接删除
   - 验证删除成功

2. **删除有版本的会话**
   - 创建会话
   - 保存多个版本
   - 删除会话
   - 验证会话和所有版本都被删除

3. **删除权限验证**
   - 尝试删除其他用户的会话
   - 验证返回 404 错误

## 部署说明

1. **重启后端服务**：
   ```bash
   docker-compose restart backend
   ```

2. **无需数据库迁移**：
   - 只修改了 ORM 层的关系定义
   - 数据库表结构没有变化
   - 外键约束已经存在

## 总结

通过以下三个改进修复了删除会话的 500 错误：

1. ✅ 在 `AnalysisSession` 模型中添加 `cascade="all, delete-orphan"`
2. ✅ 统一使用 `back_populates` 建立双向关系
3. ✅ 在删除 API 中添加显式版本删除和详细日志

这确保了删除会话时能够正确处理所有关联的版本记录，避免外键约束冲突。
