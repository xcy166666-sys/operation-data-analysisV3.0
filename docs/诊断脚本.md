# 前端诊断脚本

## 在浏览器控制台运行以下命令

### 1. 检查当前Store状态
```javascript
console.log('=== Store状态检查 ===')
console.log('currentSessionId:', window.$pinia?.state?.value?.operation?.currentSessionId)
console.log('reportContent:', window.$pinia?.state?.value?.operation?.reportContent)
console.log('html_charts存在:', !!window.$pinia?.state?.value?.operation?.reportContent?.html_charts)
console.log('html_charts长度:', window.$pinia?.state?.value?.operation?.reportContent?.html_charts?.length)
```

### 2. 手动调用API获取会话详情（替换40为你的会话ID）
```javascript
fetch('http://localhost:21810/api/v1/operation/sessions/40', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(res => res.json())
.then(data => {
  console.log('=== API响应 ===')
  console.log('完整响应:', data)
  if (data.data && data.data.messages) {
    const assistantMsg = data.data.messages.find(m => m.role === 'assistant')
    console.log('assistant消息:', assistantMsg)
    console.log('html_charts存在:', !!assistantMsg?.html_charts)
    console.log('html_charts长度:', assistantMsg?.html_charts?.length)
    console.log('html_charts前100字符:', assistantMsg?.html_charts?.substring(0, 100))
  }
})
```

### 3. 检查Storage
```javascript
console.log('=== Storage检查 ===')
console.log('sessionStorage keys:', Object.keys(sessionStorage).filter(k => k.includes('html_charts')))
console.log('localStorage keys:', Object.keys(localStorage).filter(k => k.includes('html_charts')))

// 查看具体内容（替换40为你的会话ID）
const key = 'html_charts_40'
console.log('sessionStorage[' + key + ']长度:', sessionStorage.getItem(key)?.length)
console.log('localStorage[' + key + ']长度:', localStorage.getItem(key)?.length)
```

### 4. 监听Store变化
```javascript
// 设置一个监听器，看Store何时被修改
const originalSet = window.$pinia?.state?.value?.operation?.setReportContent
if (originalSet) {
  console.log('=== 已设置Store监听器 ===')
  // 注意：这个可能不work，因为Pinia的响应式系统
}
```

## 完整诊断流程

1. **清空控制台**
2. **运行上面的检查脚本1-3**
3. **点击一个历史会话**
4. **观察控制台输出**
5. **再次运行检查脚本1**，看Store是否更新

## 预期结果

### 如果后端正常
- API响应中应该有`html_charts`字段
- `html_charts`长度应该>0
- `html_charts`内容应该是HTML代码

### 如果前端正常
- 点击会话后，Store中的`reportContent`应该被设置
- `reportContent.html_charts`应该存在且有内容
- 页面应该显示iframe

### 如果都不正常
- 检查是否有JavaScript错误
- 检查网络请求是否成功
- 检查是否有其他代码清空了Store
