# 图表显示问题 - 快速修复方案

## 问题分析

根据后端日志和前端日志的对比：
- **后端**：成功生成HTML图表（长度6107字符），并保存到数据库
- **前端**：`reportContent.text` 显示为 `undefined`，图表按钮禁用

这说明问题出在**前端接收或显示数据**的环节。

## 可能的原因

1. **API 响应格式问题**：后端返回的数据格式与前端期望的不一致
2. **Store 更新问题**：数据没有正确保存到 Pinia store
3. **Computed 响应性问题**：computed 的 `reportContent` 没有正确响应 store 的变化
4. **Watch 触发问题**：watch 监听器没有正确触发

## 修复步骤

### 步骤1：在浏览器控制台检查 API 响应

1. 打开浏览器开发者工具（F12）
2. 切换到 **Network** 标签
3. 点击"提交生成报告"按钮
4. 找到 `/api/v1/operation/generate` 请求
5. 点击该请求，查看 **Response** 标签
6. 检查返回的 JSON 数据结构

**预期的响应格式：**
```json
{
  "success": true,
  "data": {
    "report_id": "xxx",
    "content": {
      "text": "报告文字内容...",
      "charts": [],
      "html_charts": "<html>...</html>",
      "tables": [],
      "metrics": {}
    }
  },
  "message": "报告生成成功"
}
```

**如果响应格式不对，请截图或复制完整的响应内容。**

### 步骤2：检查前端 Console 日志

在浏览器控制台中，查找以下日志：

```
[报告生成] 接收到的API响应
[报告生成] 准备设置 reportContent
[报告生成] 已设置 reportContent 到 store
```

**如果看到这些日志，请复制完整的日志内容（包括数据对象）。**

### 步骤3：手动检查 Store 状态

在浏览器控制台中运行以下代码：

```javascript
// 获取 Vue DevTools 中的 store
// 方法1：如果安装了 Vue DevTools
// 打开 Vue DevTools -> Pinia -> operation store -> 查看 reportContent

// 方法2：在控制台直接访问
// 注意：这需要在 Vue 3 + Pinia 环境中运行
const app = document.querySelector('#app').__vue_app__
const pinia = app.config.globalProperties.$pinia
const operationStore = pinia._s.get('operation')
console.log('Store reportContent:', operationStore.reportContent)
console.log('Store reportContent.html_charts:', operationStore.reportContent?.html_charts)
console.log('Store reportContent.html_charts length:', operationStore.reportContent?.html_charts?.length)
```

### 步骤4：临时修复 - 强制刷新

如果数据在 store 中存在，但页面没有显示，可以尝试：

1. **刷新页面**（F5）
2. **清除浏览器缓存**（Ctrl+Shift+Delete）
3. **重新生成报告**

### 步骤5：检查历史报告

点击左侧的历史会话，在控制台中查找以下日志：

```
🔵🔵🔵 [DataAnalysis] 开始加载会话详情
🔵🔵🔵 [DataAnalysis] API响应
🔵🔵🔵 [DataAnalysis] 会话详情加载成功
🔵🔵🔵 [DataAnalysis] 最后一条assistant消息
🔵🔵🔵 [DataAnalysis] 准备设置reportContent
```

**如果看到这些日志，请复制完整的日志内容。**

## 临时解决方案

如果以上步骤都无法解决问题，可以尝试以下临时方案：

### 方案A：使用 localStorage 恢复

前端代码已经实现了 localStorage 备份机制。如果后端数据丢失，可以从 localStorage 恢复：

1. 打开浏览器控制台
2. 运行以下代码查看 localStorage 中的数据：

```javascript
// 查看所有 html_charts 相关的 key
Object.keys(localStorage).filter(key => key.startsWith('html_charts_'))

// 查看特定会话的 html_charts（替换 24 为你的会话ID）
const sessionId = 24
const htmlCharts = localStorage.getItem(`html_charts_${sessionId}`)
console.log('HTML Charts length:', htmlCharts?.length)
console.log('HTML Charts preview:', htmlCharts?.substring(0, 200))
```

### 方案B：重新生成报告

如果历史报告的图表丢失，最简单的方法是：

1. 点击左侧的历史会话
2. 重新上传相同的 Excel 文件
3. 输入相同的分析需求
4. 点击"提交生成报告"
5. 新生成的报告会包含图表

## 下一步

请按照以上步骤进行检查，并提供以下信息：

1. **API 响应的完整 JSON**（从 Network 标签复制）
2. **前端 Console 日志**（特别是带有 🔵🔵🔵 或 [报告生成] 前缀的日志）
3. **Store 状态**（运行上面的代码后的输出）
4. **localStorage 内容**（运行上面的代码后的输出）

有了这些信息，我可以准确定位问题并提供针对性的修复方案。
