# 超级管理员功能扩展设计文档

## 一、需求概述

### 1.1 背景
参考"游戏开发系统"的管理界面设计，为"运营数据分析系统"增加超级管理员功能，实现对三个数据分析功能的API配置统一管理。

### 1.2 目标
- **功能管理**：管理普通用户的三个数据分析功能的API配置
- **统一配置**：超级管理员可以通过管理界面统一配置和变更API配置
- **简化管理**：左侧栏仅保留"用户管理"和"功能管理"两个菜单

### 1.3 三个功能模块
1. **单文件数据分析** (`operation_data_analysis`)
   - 功能描述：上传单个Excel文件，快速生成数据分析报告
   - 路由：`/operation`
   
2. **批量数据分析** (`operation_batch_analysis`)
   - 功能描述：上传包含多个Sheet的Excel文件，批量生成分析报告
   - 路由：`/operation/batch`
   
3. **黄伟斌定制款数据分析工具** (`custom_operation_data_analysis`)
   - 功能描述：定制化批量分析，支持根据Sheet索引自动选择工作流
   - 路由：`/operation/custom-batch`

---

## 二、系统架构设计

### 2.1 整体架构

```
超级管理员界面
├── 侧边栏导航（简化版）
│   ├── 用户管理（已有）
│   └── 功能管理（新增）
│
└── 主内容区
    ├── 用户管理页面（已有）
    └── 功能管理页面（新增，参考项目管理布局）
        ├── 功能列表表格
        ├── API配置对话框
        └── 配置测试功能
```

### 2.2 侧边栏设计

参考图片，侧边栏包含：

```
┌─────────────────────┐
│ 运营数据分析系统      │
├─────────────────────┤
│ 📊 首页（可选）       │
│                     │
│ 全局管理            │
│ ├─ 👥 用户管理       │
│ └─ ⚙️ 功能管理       │
│                     │
│ [底部用户信息]       │
│ 👤 admin            │
│    超级管理员        │
│    localhost:20801  │
└─────────────────────┘
```

---

## 三、功能管理页面设计

### 3.1 页面布局（参考项目管理页面）

```
┌─────────────────────────────────────────────────────────┐
│  功能管理                                    [+创建功能]  │
├─────────────────────────────────────────────────────────┤
│  搜索: [____________]  筛选: [全部▼]                    │
├─────────────────────────────────────────────────────────┤
│  ID │ 功能名称 │ 功能键 │ 路由 │ 状态 │ 操作            │
├─────┼──────────┼────────┼──────┼──────┼─────────────────┤
│  1  │ 单文件数 │ oper.. │ /op..│ 启用 │ [配置API][删除] │
│  2  │ 批量数据 │ oper.. │ /op..│ 启用 │ [配置API][删除] │
│  3  │ 黄伟斌定 │ cust.. │ /op..│ 启用 │ [配置API][删除] │
└─────────────────────────────────────────────────────────┘
```

### 3.2 表格列设计

| 列名 | 说明 | 宽度 |
|------|------|------|
| **ID** | 功能模块ID | 80px |
| **功能名称** | 显示名称（如：单文件数据分析） | 200px |
| **功能键** | 功能标识符（如：operation_data_analysis） | 200px |
| **路由** | 前端路由路径 | 150px |
| **状态** | 启用/禁用状态 | 100px |
| **操作** | 配置API、删除等操作按钮 | 200px |

### 3.3 操作按钮

- **配置API**：打开API配置对话框，配置该功能的AI工作流
- **删除**：删除功能模块（需确认，且不能删除系统核心功能）

---

## 四、API配置对话框设计

### 4.1 对话框布局

点击"配置API"按钮后，弹出配置对话框：

```
┌─────────────────────────────────────────────────────┐
│  配置API - 单文件数据分析                    [×]     │
├─────────────────────────────────────────────────────┤
│  AI平台: [Dify ▼]                                   │
│                                                     │
│  ┌─ Dify配置 ───────────────────────────────────┐  │
│  │ API地址: [http://118.89.16.95/v1        ]    │  │
│  │ API Key: [app-enMcZvGV69jXZ8D7SMJUjCqF]    │  │
│  │ 文件上传URL: [http://118.89.16.95/v1/...]  │  │
│  │ 工作流URL: [http://118.89.16.95/v1/chat...]│  │
│  │ 工作流类型: [chatflow ▼]                    │  │
│  │ 文件参数名: [excell]                        │  │
│  │ 查询参数名: [sys.query]                     │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  [测试连接]  [取消]  [保存配置]                      │
└─────────────────────────────────────────────────────┘
```

### 4.2 配置项说明

#### Dify平台配置
- **API地址**：Dify API基础地址（如：`http://118.89.16.95/v1`）
- **API Key**：Dify API密钥
- **文件上传URL**：文件上传接口完整URL
- **工作流URL**：工作流执行接口完整URL
- **工作流类型**：`chatflow` 或 `workflow`
- **文件参数名**：文件输入参数名（默认：`excell`）
- **查询参数名**：查询输入参数名（默认：`sys.query`）

#### Langchain平台配置（可选）
- **API地址**：Langchain API地址
- **API Key**：Langchain API密钥
- **模型名称**：使用的模型名称

#### Ragflow平台配置（可选）
- **API地址**：Ragflow API地址
- **API Key**：Ragflow API密钥
- **知识库ID**：关联的知识库ID

### 4.3 配置保存逻辑

- 保存时创建或更新工作流（`Workflow`）
- 将工作流绑定到功能键（`WorkflowBinding`，`user_id = NULL` 表示全局配置）
- 如果已存在用户级配置，提示是否覆盖

---

## 五、后端API设计

### 5.1 功能管理API

#### 5.1.1 获取功能列表
```
GET /api/v1/admin/functions
响应: {
  "success": true,
  "data": [
    {
      "id": 1,
      "function_key": "operation_data_analysis",
      "name": "单文件数据分析",
      "description": "上传单个Excel文件，快速生成数据分析报告",
      "route_path": "/operation",
      "is_enabled": true,
      "workflow": {
        "id": 1,
        "name": "运营数据分析工作流",
        "platform": "dify",
        "is_active": true,
        "config": {
          "api_url": "http://118.89.16.95/v1",
          "api_key": "app-enMcZvGV69jXZ8D7SMJUjCqF",
          ...
        }
      }
    },
    ...
  ]
}
```

#### 5.1.2 获取单个功能的配置
```
GET /api/v1/admin/functions/{function_key}
响应: {
  "success": true,
  "data": {
    "id": 1,
    "function_key": "operation_data_analysis",
    "name": "单文件数据分析",
    "workflow": {
      "id": 1,
      "platform": "dify",
      "config": {...}
    }
  }
}
```

#### 5.1.3 配置功能的API（全局配置）
```
POST /api/v1/admin/functions/{function_key}/config
请求体: {
  "platform": "dify",
  "name": "运营数据分析工作流",
  "description": "单文件数据分析工作流配置",
  "config": {
    "api_url": "http://118.89.16.95/v1",
    "api_key": "app-enMcZvGV69jXZ8D7SMJUjCqF",
    "url_file": "http://118.89.16.95/v1/files/upload",
    "url_work": "http://118.89.16.95/v1/chat-messages",
    "workflow_type": "chatflow",
    "file_param": "excell",
    "query_param": "sys.query"
  }
}
响应: {
  "success": true,
  "message": "API配置成功",
  "data": {
    "workflow_id": 1,
    "function_key": "operation_data_analysis"
  }
}
```

#### 5.1.4 更新功能的API配置
```
PUT /api/v1/admin/functions/{function_key}/config
请求体: {
  "config": {
    "api_key": "new-api-key",
    ...
  }
}
```

#### 5.1.5 测试API连接
```
POST /api/v1/admin/functions/{function_key}/test-config
请求体: {
  "platform": "dify",
  "config": {
    "api_url": "http://118.89.16.95/v1",
    "api_key": "app-enMcZvGV69jXZ8D7SMJUjCqF",
    ...
  }
}
响应: {
  "success": true,
  "data": {
    "connected": true,
    "message": "连接成功"
  }
}
```

#### 5.1.6 删除功能的API配置
```
DELETE /api/v1/admin/functions/{function_key}/config
响应: {
  "success": true,
  "message": "API配置已删除"
}
```

#### 5.1.7 启用/禁用功能
```
PATCH /api/v1/admin/functions/{function_key}/toggle
请求体: {
  "is_enabled": true
}
```

---

## 六、前端页面设计

### 6.1 管理员布局组件

**文件路径**：`frontend/src/views/Admin/AdminLayout.vue`

**功能**：
- 左侧固定侧边栏
- 右侧主内容区（router-view）
- 底部用户信息显示

### 6.2 功能管理页面

**文件路径**：`frontend/src/views/Admin/FunctionManagement.vue`

**页面结构**：
```vue
<template>
  <div class="function-management">
    <!-- 页面头部 -->
    <div class="page-header">
      <h1>功能管理</h1>
      <el-button type="primary" :icon="Plus">创建功能</el-button>
    </div>
    
    <!-- 搜索和筛选栏 -->
    <div class="toolbar">
      <el-input placeholder="搜索功能名称或功能键" />
      <el-select placeholder="筛选状态">
        <el-option label="全部" value="" />
        <el-option label="启用" value="true" />
        <el-option label="禁用" value="false" />
      </el-select>
    </div>
    
    <!-- 功能列表表格 -->
    <el-table :data="functionList">
      <el-table-column prop="id" label="ID" width="80" />
      <el-table-column prop="name" label="功能名称" />
      <el-table-column prop="function_key" label="功能键" />
      <el-table-column prop="route_path" label="路由" />
      <el-table-column label="状态">
        <template #default="{ row }">
          <el-tag :type="row.is_enabled ? 'success' : 'danger'">
            {{ row.is_enabled ? '启用' : '禁用' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="200">
        <template #default="{ row }">
          <el-button type="primary" link @click="handleConfig(row)">
            配置API
          </el-button>
          <el-button type="danger" link @click="handleDelete(row)">
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <!-- API配置对话框 -->
    <FunctionConfigDialog
      v-model="configDialogVisible"
      :function-data="currentFunction"
      @saved="handleConfigSaved"
    />
  </div>
</template>
```

### 6.3 API配置对话框组件

**文件路径**：`frontend/src/views/Admin/components/FunctionConfigDialog.vue`

**功能**：
- 平台选择（Dify/Langchain/Ragflow）
- 动态表单（根据平台显示不同配置项）
- 配置验证
- 测试连接
- 保存配置

---

## 七、数据库设计

### 7.1 功能模块表（FunctionModule）

```sql
CREATE TABLE function_modules (
    id SERIAL PRIMARY KEY,
    function_key VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    route_path VARCHAR(200),
    icon VARCHAR(50),
    category VARCHAR(50) DEFAULT 'operation',
    is_enabled BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_function_modules_function_key ON function_modules(function_key);
CREATE INDEX idx_function_modules_is_enabled ON function_modules(is_enabled);
```

### 7.2 初始数据

```sql
INSERT INTO function_modules (function_key, name, description, route_path, icon, category, sort_order) VALUES
('operation_data_analysis', '单文件数据分析', '上传单个Excel文件，快速生成数据分析报告', '/operation', 'Document', 'operation', 1),
('operation_batch_analysis', '批量数据分析', '上传包含多个Sheet的Excel文件，批量生成分析报告', '/operation/batch', 'Files', 'operation', 2),
('custom_operation_data_analysis', '黄伟斌定制款数据分析工具', '定制化批量分析，支持根据Sheet索引自动选择工作流', '/operation/custom-batch', 'Setting', 'operation', 3);
```

### 7.3 工作流绑定（使用现有表）

`WorkflowBinding` 表已存在，使用规则：
- `function_key`：功能键
- `user_id = NULL`：全局配置（管理员配置）
- `user_id != NULL`：用户级配置（用户自定义）

---

## 八、路由设计

### 8.1 前端路由

```typescript
{
  path: '/admin',
  name: 'admin',
  component: () => import('@/views/Admin/AdminLayout.vue'),
  meta: { requiresAuth: true, requiresAdmin: true },
  children: [
    {
      path: 'users',
      name: 'admin-users',
      component: () => import('@/views/Admin/UserManagement.vue'),
      meta: { title: '用户管理' }
    },
    {
      path: 'functions',
      name: 'admin-functions',
      component: () => import('@/views/Admin/FunctionManagement.vue'),
      meta: { title: '功能管理' }
    }
  ]
}
```

### 8.2 后端路由

```python
# backend/app/api/v1/admin.py

router = APIRouter(prefix="/admin", tags=["管理员"])

@router.get("/functions")
async def get_functions(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """获取功能模块列表（仅管理员）"""

@router.get("/functions/{function_key}")
async def get_function(
    function_key: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """获取单个功能的配置"""

@router.post("/functions/{function_key}/config")
async def set_function_config(
    function_key: str,
    config_data: FunctionConfigRequest,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """配置功能的API（全局配置，仅管理员）"""

@router.put("/functions/{function_key}/config")
async def update_function_config(
    function_key: str,
    config_data: FunctionConfigRequest,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """更新功能的API配置"""

@router.post("/functions/{function_key}/test-config")
async def test_function_config(
    function_key: str,
    test_data: FunctionConfigRequest,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """测试API配置"""

@router.delete("/functions/{function_key}/config")
async def delete_function_config(
    function_key: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """删除功能的API配置"""

@router.patch("/functions/{function_key}/toggle")
async def toggle_function(
    function_key: str,
    toggle_data: FunctionToggleRequest,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_superadmin)
):
    """启用/禁用功能"""
```

---

## 九、数据模型设计

### 9.1 后端模型

```python
# backend/app/models/function_module.py

class FunctionModule(Base):
    """功能模块表"""
    __tablename__ = "function_modules"
    
    id = Column(Integer, primary_key=True, index=True)
    function_key = Column(String(50), unique=True, nullable=False)
    name = Column(String(100), nullable=False)
    description = Column(Text)
    route_path = Column(String(200))
    icon = Column(String(50))
    category = Column(String(50), default='operation')
    is_enabled = Column(Boolean, default=True)
    sort_order = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### 9.2 Schema定义

```python
# backend/app/schemas/function_module.py

class FunctionModuleBase(BaseModel):
    function_key: str
    name: str
    description: Optional[str] = None
    route_path: Optional[str] = None
    icon: Optional[str] = None
    category: str = "operation"
    is_enabled: bool = True
    sort_order: int = 0

class FunctionModuleResponse(FunctionModuleBase):
    id: int
    created_at: datetime
    updated_at: datetime
    workflow: Optional[WorkflowResponse] = None

class FunctionConfigRequest(BaseModel):
    platform: str  # dify/langchain/ragflow
    name: str
    description: Optional[str] = None
    config: dict  # API配置JSON

class FunctionToggleRequest(BaseModel):
    is_enabled: bool
```

---

## 十、实现步骤

### 阶段一：数据库和模型
1. ✅ 创建数据库迁移文件（添加 `function_modules` 表）
2. ✅ 创建 `FunctionModule` 模型
3. ✅ 插入初始功能模块数据（三个功能）
4. ✅ 创建 Schema 定义

### 阶段二：后端API
1. ✅ 创建 `admin.py` API路由文件
2. ✅ 实现功能列表获取API
3. ✅ 实现API配置保存/更新API
4. ✅ 实现API测试功能
5. ✅ 实现功能启用/禁用API

### 阶段三：前端页面
1. ✅ 创建管理员布局组件（`AdminLayout.vue`）
2. ✅ 创建功能管理页面（`FunctionManagement.vue`）
3. ✅ 创建API配置对话框组件（`FunctionConfigDialog.vue`）
4. ✅ 创建API接口文件（`admin.ts`）

### 阶段四：集成和测试
1. ✅ 更新路由配置
2. ✅ 更新侧边栏导航
3. ✅ 测试功能管理
4. ✅ 测试API配置功能
5. ✅ 测试权限控制

---

## 十一、界面设计细节

### 11.1 功能管理页面表格

参考图片中的项目管理表格样式：

- **表格样式**：白色背景，清晰的边框
- **表头**：灰色背景，加粗字体
- **行样式**：斑马纹（stripe）
- **操作按钮**：链接样式，不同颜色区分操作类型

### 11.2 状态显示

- **启用**：绿色标签/按钮
- **禁用**：红色标签/按钮

### 11.3 配置API按钮

- 主色调按钮（蓝色）
- 点击后打开配置对话框
- 如果已配置，显示当前工作流名称

### 11.4 配置对话框

- 模态对话框，居中显示
- 标题显示功能名称
- 表单布局清晰，分组显示
- 底部操作按钮：测试连接、取消、保存

---

## 十二、配置数据结构

### 12.1 工作流配置JSON（Dify）

```json
{
  "api_url": "http://118.89.16.95/v1",
  "api_key": "app-enMcZvGV69jXZ8D7SMJUjCqF",
  "url_file": "http://118.89.16.95/v1/files/upload",
  "url_work": "http://118.89.16.95/v1/chat-messages",
  "workflow_id": "1",
  "workflow_type": "chatflow",
  "file_param": "excell",
  "query_param": "sys.query",
  "input_field": "excell,sys.query"
}
```

### 12.2 功能模块数据示例

```json
{
  "id": 1,
  "function_key": "operation_data_analysis",
  "name": "单文件数据分析",
  "description": "上传单个Excel文件，快速生成数据分析报告",
  "route_path": "/operation",
  "icon": "Document",
  "category": "operation",
  "is_enabled": true,
  "sort_order": 1,
  "workflow": {
    "id": 1,
    "name": "运营数据分析工作流",
    "platform": "dify",
    "is_active": true,
    "config": {
      "api_url": "http://118.89.16.95/v1",
      "api_key": "app-enMcZvGV69jXZ8D7SMJUjCqF",
      ...
    }
  }
}
```

---

## 十三、权限控制

### 13.1 前端权限

- 侧边栏仅管理员可见
- 功能管理路由添加 `requiresAdmin: true`
- 路由守卫检查 `authStore.isSuperadmin`

### 13.2 后端权限

- 所有 `/api/v1/admin/*` 接口需要超级管理员权限
- 使用 `get_current_superadmin` 依赖注入
- 非管理员访问返回 403

---

## 十四、配置逻辑说明

### 14.1 全局配置 vs 用户配置

- **全局配置**：管理员在功能管理页面配置，`user_id = NULL`
- **用户配置**：用户在功能页面自行配置，`user_id != NULL`
- **优先级**：用户配置 > 全局配置

### 14.2 配置保存流程

1. 管理员在功能管理页面点击"配置API"
2. 填写API配置信息
3. 点击"测试连接"验证配置（可选）
4. 点击"保存配置"
5. 后端创建或更新工作流（`Workflow`）
6. 创建或更新工作流绑定（`WorkflowBinding`，`user_id = NULL`）
7. 所有用户默认使用此全局配置

### 14.3 配置变更影响

- 管理员修改全局配置后，所有使用全局配置的用户将使用新配置
- 如果用户已有自定义配置，不受影响
- 建议在修改前通知用户或提供配置版本管理

---

## 十五、注意事项

### 15.1 功能键唯一性

- 三个功能的 `function_key` 必须唯一
- 不能修改系统核心功能的 `function_key`
- 删除功能前需确认，避免影响现有数据

### 15.2 API配置验证

- 保存前验证必填项
- 验证URL格式
- 提供测试连接功能
- 配置错误时给出明确提示

### 15.3 向后兼容

- 确保现有用户的工作流配置不受影响
- 如果功能未配置API，使用默认配置或提示配置
- 迁移现有工作流绑定到新的功能模块系统

---

## 十六、总结

本设计文档提供了简化的超级管理员功能扩展方案：

1. ✅ **简化侧边栏**：仅保留"用户管理"和"功能管理"两个菜单
2. ✅ **功能管理页面**：参考项目管理页面布局，表格形式展示
3. ✅ **API配置管理**：为三个功能统一配置AI工作流API
4. ✅ **权限控制**：确保只有超级管理员可以访问和配置

实现后，超级管理员可以通过功能管理页面：
- 查看三个功能的当前配置状态
- 为每个功能配置对应的AI工作流API
- 测试API连接是否正常
- 统一管理所有功能的API配置

这将大大简化API配置管理，提升系统的可维护性。
