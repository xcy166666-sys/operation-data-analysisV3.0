# æŠ¥å‘Šç‰ˆæœ¬å†å²åŠŸèƒ½ - è‡ªåŠ¨ä¿å­˜å®ç°æ–¹æ¡ˆ

## ç›®æ ‡

å®ç°æŠ¥å‘Šçš„è‡ªåŠ¨ç‰ˆæœ¬ä¿å­˜åŠŸèƒ½ï¼Œåœ¨ä»¥ä¸‹åœºæ™¯è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ï¼š
1. æŠ¥å‘Šé¦–æ¬¡ç”Ÿæˆå®Œæˆæ—¶
2. AIå¯¹è¯ä¿®æ”¹æŠ¥å‘Šå
3. ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜æ—¶

---

## å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæŠ¥å‘Šç”Ÿæˆå®Œæˆæ—¶è‡ªåŠ¨ä¿å­˜ â­â­â­

#### è§¦å‘æ—¶æœº
- å•æ–‡ä»¶åˆ†ææŠ¥å‘Šç”Ÿæˆå®Œæˆ
- æ‰¹é‡åˆ†ææŠ¥å‘Šç”Ÿæˆå®Œæˆ
- å®šåˆ¶åŒ–æ‰¹é‡åˆ†ææŠ¥å‘Šç”Ÿæˆå®Œæˆ

#### å®ç°ä½ç½®
**æ–‡ä»¶**: `backend/app/api/v1/operation.py`

**ä¿®æ”¹**: åœ¨ `generate_report` æ¥å£ä¸­ï¼ŒæŠ¥å‘Šç”ŸæˆæˆåŠŸåè‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬

```python
@router.post("/generate-report", response_model=SuccessResponse[ReportResponse])
async def generate_report(
    request_data: GenerateReportRequest = Body(...),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    try:
        # ... ç°æœ‰çš„æŠ¥å‘Šç”Ÿæˆé€»è¾‘ ...
        
        # æŠ¥å‘Šç”ŸæˆæˆåŠŸåï¼Œè‡ªåŠ¨ä¿å­˜ä¸ºç¬¬ä¸€ä¸ªç‰ˆæœ¬
        await auto_save_version(
            db=db,
            session_id=session_id,
            summary="åˆå§‹æŠ¥å‘Š",
            report_text=report_content.get('text', ''),
            report_html_charts=report_content.get('html_charts', ''),
            report_charts_json=report_content.get('charts', []),
            user_id=current_user.id
        )
        
        return SuccessResponse(data=result, message="æŠ¥å‘Šç”ŸæˆæˆåŠŸ")
    except Exception as e:
        # ... é”™è¯¯å¤„ç† ...
```

#### è¾…åŠ©å‡½æ•°

```python
async def auto_save_version(
    db: Session,
    session_id: int,
    summary: str,
    report_text: str,
    report_html_charts: str,
    report_charts_json: Any,
    user_id: int
) -> AnalysisSessionVersion:
    """
    è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬
    
    Args:
        db: æ•°æ®åº“ä¼šè¯
        session_id: ä¼šè¯ID
        summary: ç‰ˆæœ¬æ‘˜è¦
        report_text: æŠ¥å‘Šæ–‡å­—
        report_html_charts: HTMLå›¾è¡¨
        report_charts_json: JSONå›¾è¡¨é…ç½®
        user_id: ç”¨æˆ·ID
    
    Returns:
        åˆ›å»ºçš„ç‰ˆæœ¬å¯¹è±¡
    """
    try:
        # è·å–å½“å‰æœ€å¤§ç‰ˆæœ¬å·
        max_version = db.query(AnalysisSessionVersion.version_no).filter(
            AnalysisSessionVersion.session_id == session_id
        ).order_by(AnalysisSessionVersion.version_no.desc()).first()
        
        next_version = (max_version[0] + 1) if max_version else 1
        
        # åˆ›å»ºæ–°ç‰ˆæœ¬
        version = AnalysisSessionVersion(
            session_id=session_id,
            version_no=next_version,
            summary=summary,
            report_text=report_text,
            report_html_charts=report_html_charts,
            report_charts_json=report_charts_json,
            created_by=user_id
        )
        
        db.add(version)
        db.commit()
        db.refresh(version)
        
        logger.info(f"[è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬] session_id={session_id}, version_no={next_version}, summary={summary}")
        
        return version
    except Exception as e:
        logger.error(f"[è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬] å¤±è´¥ - session_id={session_id}, error={str(e)}")
        db.rollback()
        # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“ä¸»æµç¨‹
        return None
```

---

### æ–¹æ¡ˆ2ï¼šAIå¯¹è¯ä¿®æ”¹æŠ¥å‘Šåè‡ªåŠ¨ä¿å­˜ â­â­â­

#### è§¦å‘æ—¶æœº
- AIå¯¹è¯ä¿®æ”¹äº†æŠ¥å‘Šæ–‡å­—
- AIå¯¹è¯ä¿®æ”¹äº†å›¾è¡¨
- AIå¯¹è¯æ·»åŠ äº†æ–°å†…å®¹
- AIå¯¹è¯åˆ é™¤äº†å†…å®¹

#### å®ç°ä½ç½®
**æ–‡ä»¶**: `backend/app/api/v1/operation.py` (å¯¹è¯API)

**ä¿®æ”¹**: åœ¨å¯¹è¯APIä¸­ï¼Œå½“AIè¿”å›ä¿®æ”¹åçš„æŠ¥å‘Šæ—¶ï¼Œè‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬

```python
@router.post("/dialog/stream")
async def dialog_stream(
    request_data: DialogRequest = Body(...),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    async def generate():
        # ... ç°æœ‰çš„æµå¼å¯¹è¯é€»è¾‘ ...
        
        # å½“å¯¹è¯å®Œæˆä¸”ä¿®æ”¹äº†æŠ¥å‘Šæ—¶
        if result.get('action_type') in ['modify_text', 'add_content', 'delete_content']:
            # è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬
            await auto_save_version(
                db=db,
                session_id=session_id,
                summary=f"AIä¿®æ”¹: {user_message[:20]}...",
                report_text=result.get('new_report_text', ''),
                report_html_charts=current_html_charts,
                report_charts_json=current_charts,
                user_id=current_user.id
            )
    
    return StreamingResponse(generate(), media_type="text/event-stream")
```

#### ç‰ˆæœ¬æ‘˜è¦ç”Ÿæˆç­–ç•¥

```python
def generate_version_summary(action_type: str, user_message: str) -> str:
    """
    æ ¹æ®æ“ä½œç±»å‹å’Œç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆç‰ˆæœ¬æ‘˜è¦
    
    Args:
        action_type: æ“ä½œç±»å‹ (modify_text, add_content, delete_content, chat)
        user_message: ç”¨æˆ·æ¶ˆæ¯
    
    Returns:
        ç‰ˆæœ¬æ‘˜è¦
    """
    summary_map = {
        'modify_text': f"ä¿®æ”¹æ–‡å­—: {user_message[:20]}",
        'add_content': f"æ·»åŠ å†…å®¹: {user_message[:20]}",
        'delete_content': f"åˆ é™¤å†…å®¹: {user_message[:20]}",
        'regenerate_report': f"é‡æ–°ç”Ÿæˆ: {user_message[:20]}"
    }
    
    summary = summary_map.get(action_type, f"AIå¯¹è¯: {user_message[:20]}")
    
    # å¦‚æœæ¶ˆæ¯å¤ªé•¿ï¼Œæ·»åŠ çœç•¥å·
    if len(user_message) > 20:
        summary += "..."
    
    return summary
```

---

### æ–¹æ¡ˆ3ï¼šç”¨æˆ·æ‰‹åŠ¨ä¿å­˜ â­â­

#### è§¦å‘æ—¶æœº
- ç”¨æˆ·ç‚¹å‡»"ä¿å­˜ç‰ˆæœ¬"æŒ‰é’®

#### å®ç°ä½ç½®
**å‰ç«¯**: `frontend/src/views/Operation/DataAnalysis.vue`

**æ·»åŠ **: ä¿å­˜ç‰ˆæœ¬æŒ‰é’®å’Œå¤„ç†å‡½æ•°

```vue
<template>
  <div class="data-analysis-page">
    <!-- ... ç°æœ‰å†…å®¹ ... -->
    
    <!-- æŠ¥å‘Šæ“ä½œæ  -->
    <div class="report-actions">
      <el-button 
        :icon="DocumentAdd" 
        @click="handleSaveVersion"
        :loading="savingVersion"
      >
        ä¿å­˜ç‰ˆæœ¬
      </el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { DocumentAdd } from '@element-plus/icons-vue'
import { createSessionVersion } from '@/api/operation'

const savingVersion = ref(false)

const handleSaveVersion = async () => {
  if (!currentSessionId.value) {
    ElMessage.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯')
    return
  }
  
  try {
    // å¼¹å‡ºå¯¹è¯æ¡†è®©ç”¨æˆ·è¾“å…¥ç‰ˆæœ¬æ‘˜è¦
    const { value: summary } = await ElMessageBox.prompt(
      'è¯·è¾“å…¥ç‰ˆæœ¬æ‘˜è¦ï¼ˆå¯é€‰ï¼‰',
      'ä¿å­˜ç‰ˆæœ¬',
      {
        confirmButtonText: 'ä¿å­˜',
        cancelButtonText: 'å–æ¶ˆ',
        inputPlaceholder: 'ä¾‹å¦‚ï¼šä¿®æ”¹äº†å›¾è¡¨é¢œè‰²'
      }
    )
    
    savingVersion.value = true
    
    // è·å–å½“å‰æŠ¥å‘Šå†…å®¹
    const reportContent = operationStore.reportContent
    
    // è°ƒç”¨APIä¿å­˜ç‰ˆæœ¬
    const res = await createSessionVersion(currentSessionId.value, {
      summary: summary || 'æ‰‹åŠ¨ä¿å­˜',
      report_text: reportContent.text,
      report_html_charts: reportContent.html_charts,
      report_charts_json: reportContent.charts
    })
    
    if (res.success) {
      ElMessage.success('ç‰ˆæœ¬ä¿å­˜æˆåŠŸ')
      
      // åˆ·æ–°ç‰ˆæœ¬åˆ—è¡¨ï¼ˆå¦‚æœç‰ˆæœ¬é¢æ¿æ˜¯å±•å¼€çš„ï¼‰
      if (sidebarRef.value) {
        // è§¦å‘ç‰ˆæœ¬åˆ—è¡¨åˆ·æ–°
        // è¿™é‡Œéœ€è¦åœ¨HistorySidebarä¸­æ·»åŠ åˆ·æ–°æ–¹æ³•
      }
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('ä¿å­˜ç‰ˆæœ¬å¤±è´¥:', error)
      ElMessage.error(error.response?.data?.detail || 'ä¿å­˜ç‰ˆæœ¬å¤±è´¥')
    }
  } finally {
    savingVersion.value = false
  }
}
</script>
```

---

## ç‰ˆæœ¬ä¿å­˜ç­–ç•¥

### ç­–ç•¥1ï¼šæ¯æ¬¡ä¿®æ”¹éƒ½ä¿å­˜ âš ï¸

**ä¼˜ç‚¹**:
- å®Œæ•´çš„ä¿®æ”¹å†å²
- å¯ä»¥å›æº¯åˆ°ä»»ä½•æ—¶åˆ»

**ç¼ºç‚¹**:
- ç‰ˆæœ¬æ•°é‡è¿‡å¤š
- æ•°æ®åº“å­˜å‚¨å‹åŠ›å¤§
- ç‰ˆæœ¬åˆ—è¡¨éš¾ä»¥ç®¡ç†

**é€‚ç”¨åœºæ™¯**: åä½œç¼–è¾‘ã€é‡è¦æ–‡æ¡£

### ç­–ç•¥2ï¼šæ™ºèƒ½åˆå¹¶ä¿å­˜ â­â­â­

**è§„åˆ™**:
- 5åˆ†é’Ÿå†…çš„å¤šæ¬¡ä¿®æ”¹åˆå¹¶ä¸ºä¸€ä¸ªç‰ˆæœ¬
- é‡è¦ä¿®æ”¹ï¼ˆå¦‚é‡æ–°ç”ŸæˆæŠ¥å‘Šï¼‰ç«‹å³ä¿å­˜
- ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜ç«‹å³åˆ›å»ºæ–°ç‰ˆæœ¬

**å®ç°**:
```python
# åœ¨auto_save_versionå‡½æ•°ä¸­æ·»åŠ 
def should_create_new_version(
    db: Session,
    session_id: int,
    action_type: str
) -> bool:
    """
    åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ›å»ºæ–°ç‰ˆæœ¬
    
    Args:
        db: æ•°æ®åº“ä¼šè¯
        session_id: ä¼šè¯ID
        action_type: æ“ä½œç±»å‹
    
    Returns:
        æ˜¯å¦åˆ›å»ºæ–°ç‰ˆæœ¬
    """
    # é‡è¦æ“ä½œç«‹å³ä¿å­˜
    important_actions = ['regenerate_report', 'manual_save']
    if action_type in important_actions:
        return True
    
    # è·å–æœ€åä¸€ä¸ªç‰ˆæœ¬
    last_version = db.query(AnalysisSessionVersion).filter(
        AnalysisSessionVersion.session_id == session_id
    ).order_by(AnalysisSessionVersion.created_at.desc()).first()
    
    if not last_version:
        return True
    
    # å¦‚æœæœ€åä¸€ä¸ªç‰ˆæœ¬æ˜¯5åˆ†é’Ÿå†…åˆ›å»ºçš„ï¼Œä¸åˆ›å»ºæ–°ç‰ˆæœ¬
    time_diff = datetime.utcnow() - last_version.created_at
    if time_diff.total_seconds() < 300:  # 5åˆ†é’Ÿ
        return False
    
    return True
```

### ç­–ç•¥3ï¼šæŒ‰æ“ä½œç±»å‹ä¿å­˜ â­â­

**è§„åˆ™**:
- æŠ¥å‘Šç”Ÿæˆï¼šç«‹å³ä¿å­˜
- æ–‡å­—ä¿®æ”¹ï¼š5åˆ†é’Ÿåˆå¹¶
- æ·»åŠ å†…å®¹ï¼šç«‹å³ä¿å­˜
- åˆ é™¤å†…å®¹ï¼šç«‹å³ä¿å­˜
- æ™®é€šå¯¹è¯ï¼šä¸ä¿å­˜

**å®ç°**:
```python
VERSION_SAVE_RULES = {
    'generate_report': {'immediate': True, 'merge_window': 0},
    'modify_text': {'immediate': False, 'merge_window': 300},
    'add_content': {'immediate': True, 'merge_window': 0},
    'delete_content': {'immediate': True, 'merge_window': 0},
    'chat': {'immediate': False, 'merge_window': 0}
}
```

---

## å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ·»åŠ è¾…åŠ©å‡½æ•° ğŸ”§

**æ–‡ä»¶**: `backend/app/services/version_service.py` (æ–°å»º)

```python
"""
ç‰ˆæœ¬ç®¡ç†æœåŠ¡
"""
from datetime import datetime
from typing import Optional, Any
from sqlalchemy.orm import Session
from loguru import logger

from app.models.session_version import AnalysisSessionVersion


class VersionService:
    """ç‰ˆæœ¬ç®¡ç†æœåŠ¡"""
    
    @staticmethod
    async def auto_save_version(
        db: Session,
        session_id: int,
        summary: str,
        report_text: str,
        report_html_charts: str,
        report_charts_json: Any,
        user_id: int,
        action_type: str = 'manual_save'
    ) -> Optional[AnalysisSessionVersion]:
        """è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬"""
        try:
            # åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ›å»ºæ–°ç‰ˆæœ¬
            if not VersionService._should_create_version(db, session_id, action_type):
                logger.info(f"[ç‰ˆæœ¬æœåŠ¡] è·³è¿‡ä¿å­˜ - session_id={session_id}, action_type={action_type}")
                return None
            
            # è·å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
            next_version = VersionService._get_next_version_no(db, session_id)
            
            # åˆ›å»ºç‰ˆæœ¬
            version = AnalysisSessionVersion(
                session_id=session_id,
                version_no=next_version,
                summary=summary,
                report_text=report_text,
                report_html_charts=report_html_charts,
                report_charts_json=report_charts_json,
                created_by=user_id
            )
            
            db.add(version)
            db.commit()
            db.refresh(version)
            
            logger.info(f"[ç‰ˆæœ¬æœåŠ¡] ä¿å­˜æˆåŠŸ - session_id={session_id}, version_no={next_version}")
            
            return version
        except Exception as e:
            logger.error(f"[ç‰ˆæœ¬æœåŠ¡] ä¿å­˜å¤±è´¥ - session_id={session_id}, error={str(e)}")
            db.rollback()
            return None
    
    @staticmethod
    def _should_create_version(
        db: Session,
        session_id: int,
        action_type: str
    ) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ›å»ºæ–°ç‰ˆæœ¬"""
        # é‡è¦æ“ä½œç«‹å³ä¿å­˜
        immediate_actions = ['generate_report', 'add_content', 'delete_content', 'manual_save']
        if action_type in immediate_actions:
            return True
        
        # è·å–æœ€åä¸€ä¸ªç‰ˆæœ¬
        last_version = db.query(AnalysisSessionVersion).filter(
            AnalysisSessionVersion.session_id == session_id
        ).order_by(AnalysisSessionVersion.created_at.desc()).first()
        
        if not last_version:
            return True
        
        # 5åˆ†é’Ÿå†…çš„ä¿®æ”¹ä¸åˆ›å»ºæ–°ç‰ˆæœ¬
        time_diff = datetime.utcnow() - last_version.created_at
        if time_diff.total_seconds() < 300:
            return False
        
        return True
    
    @staticmethod
    def _get_next_version_no(db: Session, session_id: int) -> int:
        """è·å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·"""
        max_version = db.query(AnalysisSessionVersion.version_no).filter(
            AnalysisSessionVersion.session_id == session_id
        ).order_by(AnalysisSessionVersion.version_no.desc()).first()
        
        return (max_version[0] + 1) if max_version else 1
    
    @staticmethod
    def generate_summary(action_type: str, user_message: str) -> str:
        """ç”Ÿæˆç‰ˆæœ¬æ‘˜è¦"""
        summary_map = {
            'generate_report': 'åˆå§‹æŠ¥å‘Š',
            'modify_text': f"ä¿®æ”¹æ–‡å­—: {user_message[:20]}",
            'add_content': f"æ·»åŠ å†…å®¹: {user_message[:20]}",
            'delete_content': f"åˆ é™¤å†…å®¹: {user_message[:20]}",
            'regenerate_report': f"é‡æ–°ç”Ÿæˆ: {user_message[:20]}",
            'manual_save': 'æ‰‹åŠ¨ä¿å­˜'
        }
        
        summary = summary_map.get(action_type, f"AIå¯¹è¯: {user_message[:20]}")
        
        if len(user_message) > 20:
            summary += "..."
        
        return summary
```

### æ­¥éª¤2ï¼šä¿®æ”¹æŠ¥å‘Šç”ŸæˆAPI ğŸ”§

**æ–‡ä»¶**: `backend/app/api/v1/operation.py`

åœ¨æŠ¥å‘Šç”ŸæˆæˆåŠŸåè°ƒç”¨ `VersionService.auto_save_version`

### æ­¥éª¤3ï¼šä¿®æ”¹å¯¹è¯API ğŸ”§

**æ–‡ä»¶**: `backend/app/api/v1/operation.py`

åœ¨å¯¹è¯ä¿®æ”¹æŠ¥å‘Šåè°ƒç”¨ `VersionService.auto_save_version`

### æ­¥éª¤4ï¼šæ·»åŠ å‰ç«¯ä¿å­˜æŒ‰é’® ğŸ¨

**æ–‡ä»¶**: `frontend/src/views/Operation/DataAnalysis.vue`

æ·»åŠ "ä¿å­˜ç‰ˆæœ¬"æŒ‰é’®å’Œå¤„ç†å‡½æ•°

### æ­¥éª¤5ï¼šæµ‹è¯•åŠŸèƒ½ âœ…

1. ç”Ÿæˆæ–°æŠ¥å‘Šï¼Œæ£€æŸ¥æ˜¯å¦è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬
2. AIå¯¹è¯ä¿®æ”¹æŠ¥å‘Šï¼Œæ£€æŸ¥æ˜¯å¦è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬
3. æ‰‹åŠ¨ä¿å­˜ç‰ˆæœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸ

---

## æ€»ç»“

### æ¨èæ–¹æ¡ˆ â­â­â­

**ç­–ç•¥2ï¼šæ™ºèƒ½åˆå¹¶ä¿å­˜**
- æŠ¥å‘Šç”Ÿæˆï¼šç«‹å³ä¿å­˜
- AIä¿®æ”¹ï¼š5åˆ†é’Ÿåˆå¹¶
- æ‰‹åŠ¨ä¿å­˜ï¼šç«‹å³ä¿å­˜

**ä¼˜ç‚¹**:
- å¹³è¡¡äº†ç‰ˆæœ¬æ•°é‡å’Œå†å²å®Œæ•´æ€§
- å‡å°‘æ•°æ®åº“å‹åŠ›
- ç”¨æˆ·ä½“éªŒå¥½

### å®æ–½ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§** â­â­â­
   - æŠ¥å‘Šç”Ÿæˆæ—¶è‡ªåŠ¨ä¿å­˜
   - ç‰ˆæœ¬æœåŠ¡åŸºç¡€åŠŸèƒ½

2. **ä¸­ä¼˜å…ˆçº§** â­â­
   - AIå¯¹è¯ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜
   - æ™ºèƒ½åˆå¹¶ç­–ç•¥

3. **ä½ä¼˜å…ˆçº§** â­
   - æ‰‹åŠ¨ä¿å­˜æŒ‰é’®
   - ç‰ˆæœ¬æ‘˜è¦ä¼˜åŒ–

---

**ä¸‹ä¸€æ­¥**: å®ç° `VersionService` å¹¶é›†æˆåˆ°ç°æœ‰APIä¸­
