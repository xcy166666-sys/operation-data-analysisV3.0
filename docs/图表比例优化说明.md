# 图表比例优化说明

## 问题描述

iframe 中生成的图表比例不协调，图表被压缩在上半部分，下面留了很多空白。

## 解决方案

### ✅ 已实施的修复

#### 1. **后端 Prompt 优化**（`backend/app/services/bailian_service.py`）

修改了 HTML 生成的 prompt，添加了更明确的图表尺寸要求：

```python
**图表尺寸要求**（必须遵守，除非用户在定制要求中明确覆盖）：
- 图表容器必须使用合理的高度，建议每个图表高度为 500-600px
- 如果有多个图表，每个图表应该独立占据足够的垂直空间
- 图表宽度使用100%自适应容器宽度
- 图表的 canvas 或 svg 元素必须设置明确的高度（不要使用百分比高度）
- 避免所有图表挤在页面顶部，应该合理分布在整个页面中
- 如果使用 Chart.js，必须在 canvas 上设置明确的 height 属性（如 height="500"）
- 如果使用 ECharts，容器 div 必须设置明确的 height 样式（如 style="height: 500px"）
- 页面整体布局应该让图表充满可视区域，避免大量空白
```

#### 2. **前端 iframe 样式优化**（`frontend/src/views/Operation/DataAnalysis.vue`）

修改了 iframe 的样式，增加最小高度并移除最大高度限制：

```css
.html-charts-iframe {
  width: 100%;
  min-height: 800px; /* 从 600px 增加到 800px */
  height: auto;
  border: none;
  display: block;
  background: white;
  transition: height 0.3s ease;
}
```

### 🎯 使用方法

#### 方法1：使用图表定制 Prompt（推荐）

在生成报告时，开启"图表定制 Prompt"功能，输入具体的尺寸要求：

**示例 Prompt**：
```
请生成一个包含折线图的HTML页面，要求：
1. 图表高度设置为 600px
2. 图表宽度占满容器（100%）
3. 使用 Chart.js 库
4. 图表标题：7天LTV数据对比
5. 图表类型：折线图
6. 确保图表在页面中居中显示，上下留有适当边距
7. 图表容器使用 padding: 20px
```

#### 方法2：让 AI 自动优化（默认）

不输入图表定制 Prompt，AI 会根据修改后的系统 prompt 自动生成合理比例的图表。

### 📊 预期效果

修复后，图表应该：
- ✅ 占据合理的垂直空间（不会挤在顶部）
- ✅ 图表高度适中（500-600px）
- ✅ 多个图表时，每个图表独立占据空间
- ✅ 页面布局协调，没有大量空白

### 🔄 重新生成报告

如果你已经有旧的报告，需要重新生成才能看到效果：

1. 上传 Excel 文件
2. 输入分析需求
3. （可选）开启图表定制 Prompt，输入具体要求
4. 点击"提交生成报告"
5. 等待生成完成

### 🛠️ 高级定制

如果你想要更精细的控制，可以在图表定制 Prompt 中指定：

**完整示例**：
```
请生成一个数据可视化页面，包含以下内容：

1. **页面布局**：
   - 使用 flexbox 或 grid 布局
   - 页面背景色：#f5f7fa
   - 内容区域最大宽度：1200px，居中显示

2. **图表要求**：
   - 使用 Chart.js 3.x 版本
   - 每个图表高度：600px
   - 图表容器背景：白色
   - 图表容器圆角：8px
   - 图表之间间距：20px

3. **图表类型**：
   - 第一个图表：折线图，展示 7天LTV 数据对比
   - 第二个图表：柱状图，展示不同用户类型的分布

4. **样式要求**：
   - 使用现代化的配色方案
   - 图表标题字体大小：18px，加粗
   - 图例位置：顶部居中
   - 数据标签：显示在数据点上

5. **响应式设计**：
   - 在小屏幕上（<768px），图表高度调整为 400px
   - 图表宽度始终为 100%
```

### 📝 注意事项

1. **重新构建前端**：修改已生效，前端正在重新构建中
2. **清除缓存**：如果看不到效果，尝试清除浏览器缓存（Ctrl+Shift+Delete）
3. **旧报告**：已生成的旧报告不会自动更新，需要重新生成
4. **Prompt 优先级**：用户的图表定制 Prompt 优先级最高，会覆盖系统默认设置

### 🔍 验证方法

1. 访问 http://localhost:20810
2. 上传 Excel 文件
3. 生成新报告
4. 检查图表是否占据合理的空间
5. 打开浏览器开发者工具（F12），检查 iframe 内部的 HTML 结构

### 🐛 如果问题仍然存在

如果修改后问题仍然存在，可以：

1. **检查生成的 HTML**：
   - 打开浏览器控制台（F12）
   - 找到 iframe 元素
   - 右键 → 检查元素
   - 查看 iframe 内部的 HTML 代码
   - 检查图表容器的高度设置

2. **手动调整 Prompt**：
   - 在图表定制 Prompt 中明确指定高度
   - 例如："每个图表的 canvas 高度必须设置为 600px"

3. **查看后端日志**：
   ```powershell
   docker logs operation-analysis-v2-backend --tail 100 | Select-String "ChartGenerator"
   ```

4. **联系开发者**：提供生成的 HTML 代码和截图

## 技术细节

### 为什么会出现这个问题？

1. **AI 生成的 HTML 可能没有明确设置高度**
   - Chart.js 默认使用父容器的高度
   - 如果父容器没有明确高度，图表会被压缩

2. **iframe 的高度限制**
   - 之前 iframe 的 `max-height: 1200px` 可能限制了内容显示
   - 现在已移除最大高度限制

3. **CSS 百分比高度问题**
   - 如果使用 `height: 100%`，但父容器没有明确高度，会导致高度为 0

### 修复原理

1. **Prompt 层面**：告诉 AI 必须设置明确的像素高度
2. **CSS 层面**：确保 iframe 有足够的最小高度
3. **用户控制**：允许用户通过 Prompt 完全控制布局

## 更新日志

- **2025-12-05**：
  - ✅ 优化后端 HTML 生成 Prompt
  - ✅ 增加前端 iframe 最小高度到 800px
  - ✅ 移除 iframe 最大高度限制
  - ✅ 添加详细的图表尺寸要求到 Prompt
