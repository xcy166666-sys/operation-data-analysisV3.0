# 运营数据分析系统 - 部署说明

## 一、系统概述

运营数据分析系统是一个基于 FastAPI + Vue.js 的数据分析平台，支持：
- 单文件数据分析
- 批量数据分析
- 定制化批量分析（6个工作流）

**重要特性**：
- ✅ **自动初始化**：部署后自动配置功能模块和 Dify API 工作流
- ✅ **开箱即用**：无需手动配置，直接运行即可使用
- ✅ **Docker 部署**：使用 Docker Compose 一键部署

---

## 二、快速部署

### 前置要求

- Docker Desktop（Windows/Mac）或 Docker + Docker Compose（Linux）
- 至少 4GB 可用内存
- 端口 20800, 21800, 22800, 22801 未被占用

### 部署步骤

1. **解压项目文件**
   ```bash
   # 解压到任意目录，例如：
   cd /path/to/project
   ```

2. **配置环境变量（可选）**
   
   创建 `.env` 文件（如果不存在）：
   ```bash
   # 数据库配置
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=your_password_here
   POSTGRES_DB=operation_analysis
   
   # JWT密钥（生产环境请修改）
   JWT_SECRET=your-super-secret-jwt-key-change-this
   SESSION_SECRET=your-super-secret-session-key-change-this
   ```

3. **启动服务**
   ```bash
   docker-compose up -d
   ```

4. **等待服务启动**（约 1-2 分钟）
   ```bash
   # 查看服务状态
   docker-compose ps
   
   # 查看日志
   docker-compose logs -f
   ```

5. **访问系统**
   - 前端地址：http://localhost:20800
   - 后端API文档：http://localhost:21800/docs
   - 健康检查：http://localhost:21800/health

---

## 三、自动初始化说明

### 初始化内容

系统首次启动时会自动执行以下初始化：

1. **功能模块初始化**
   - 创建 3 个功能模块（单文件分析、批量分析、定制化批量分析）
   - 数据来源：数据库迁移脚本

2. **工作流配置初始化**
   - 自动配置 8 个工作流：
     - 单文件数据分析工作流
     - 批量数据分析工作流
     - 定制化批量分析的 6 个工作流（Sheet 0-5）
   - **API 配置已硬编码在代码中**，无需手动配置

### 初始化时机

- 应用启动时自动检查
- 如果检测到数据库未初始化，自动执行初始化
- 如果已初始化，跳过初始化（不会覆盖现有配置）

### 手动初始化（可选）

如果需要手动重新初始化：

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行初始化脚本
python scripts/init_all.py
```

---

## 四、默认配置

### Dify API 配置

所有 Dify API 配置已硬编码在 `backend/scripts/setup_all_workflows.py` 中：

- **API 地址**：`http://118.89.16.95/v1`
- **文件上传URL**：`http://118.89.16.95/v1/files/upload`
- **工作流URL**：`http://118.89.16.95/v1/chat-messages`

### 工作流配置

| 功能 | 工作流名称 | API Key |
|------|-----------|---------|
| 单文件数据分析 | 运营数据分析工作流 | app-G5TRX6MyLsQdfj4V4NRWAplZ |
| 批量数据分析 | 批量数据分析工作流 | app-G5TRX6MyLsQdfj4V4NRWAplZ |
| 定制化批量分析 - Sheet 0 | 最后操作分布工作流 | app-bPuA3gTwoFUefEd9BYJexJ3l |
| 定制化批量分析 - Sheet 1 | 新手漏斗工作流 | app-sAIJG3ZFzdgIS82JbmRne4sX |
| 定制化批量分析 - Sheet 2 | 回流用户工作流 | app-1kzCXNaI1995gPPE3b9VATYr |
| 定制化批量分析 - Sheet 3 | 流失用户属性工作流 | app-F9cfBnTx0A6cvUzwCEps9KFN |
| 定制化批量分析 - Sheet 4 | 留存率分析工作流 | app-DDrJ34dOessai3io1zcvtq7n |
| 定制化批量分析 - Sheet 5 | LTV分析工作流 | app-EUzFTWScRAOV2a0AlT2AvRLm |

**如需修改 API 配置**，请编辑 `backend/scripts/setup_all_workflows.py` 文件。

---

## 五、创建管理员账号

系统首次部署后，需要创建管理员账号：

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行创建管理员脚本
python scripts/create_admin.py
```

按提示输入：
- 用户名（默认：admin）
- 密码
- 邮箱（可选）

---

## 六、服务管理

### 启动服务
```bash
docker-compose up -d
```

### 停止服务
```bash
docker-compose down
```

### 重启服务
```bash
docker-compose restart
```

### 查看日志
```bash
# 所有服务日志
docker-compose logs -f

# 特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

### 查看服务状态
```bash
docker-compose ps
```

---

## 七、端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| 前端 | 20800 | 用户界面 |
| 后端API | 21800 | API接口 |
| PostgreSQL | 22800 | 数据库（开发调试用） |
| Redis | 22801 | 缓存（开发调试用） |

**生产环境建议**：关闭 PostgreSQL 和 Redis 的外部端口映射。

---

## 八、数据备份

### 备份数据库
```bash
docker-compose exec postgres pg_dump -U postgres operation_analysis > backup.sql
```

### 恢复数据库
```bash
docker-compose exec -T postgres psql -U postgres operation_analysis < backup.sql
```

---

## 九、常见问题

### Q1: 服务启动失败
**A**: 检查端口是否被占用，查看日志：`docker-compose logs`

### Q2: 前端无法连接后端
**A**: 
1. 检查后端服务是否正常：`docker-compose ps`
2. 检查后端日志：`docker-compose logs backend`
3. 测试后端健康检查：访问 http://localhost:21800/health

### Q3: API 配置未生效
**A**: 
1. 检查初始化是否完成：查看后端启动日志
2. 手动运行初始化：`docker-compose exec backend python scripts/init_all.py`

### Q4: 如何修改 Dify API 配置
**A**: 
1. 编辑 `backend/scripts/setup_all_workflows.py`
2. 重启后端服务：`docker-compose restart backend`
3. 或通过前端管理界面修改（超级管理员 → 功能管理）

### Q5: 忘记管理员密码
**A**: 
```bash
docker-compose exec backend python scripts/update_admin_password.py
```

---

## 十、项目结构

```
operation-data-analysis/
├── backend/                 # 后端服务
│   ├── app/                # 应用代码
│   ├── scripts/            # 初始化脚本
│   │   ├── init_all.py     # 完整初始化脚本
│   │   ├── init_function_modules.py  # 功能模块初始化
│   │   └── setup_all_workflows.py    # 工作流配置（API配置在这里）
│   ├── migrations/         # 数据库迁移
│   └── main.py             # 应用入口（自动初始化逻辑）
├── frontend/               # 前端服务
├── nginx/                  # Nginx配置（可选）
├── docker-compose.yml      # Docker Compose配置
└── .env                    # 环境变量（需要创建）
```

---

## 十一、技术支持

如遇到问题，请检查：
1. Docker 服务是否正常运行
2. 端口是否被占用
3. 日志文件中的错误信息
4. 数据库连接是否正常

---

**部署完成后，系统会自动配置好所有 Dify API，无需手动操作！**

**文档版本**: 1.0  
**最后更新**: 2025-12-02

