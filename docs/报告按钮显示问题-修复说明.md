# 报告按钮显示问题 - 修复说明

## 问题描述

新生成的报告只显示"下载报告 (PDF)"一个按钮，而历史报告显示三个按钮：
- 查看图表详情
- 下载图表  
- 下载报告 (PDF)

## 问题原因

按钮的显示逻辑使用了 `v-if` 条件：

```vue
<el-button 
  v-if="reportContent.html_charts && reportContent.html_charts.length > 0"
  ...
>
  查看图表详情
</el-button>
```

当 `reportContent.html_charts` 为空或不存在时，前两个按钮不会显示。

**可能的原因**：
1. 后端生成图表失败（但只是 warning，不影响报告生成）
2. 用户没有填写"图表定制 Prompt"，且后端默认图表生成失败
3. 阿里百炼 API 调用失败或超时

## 解决方案

### 方案1：始终显示所有按钮（推荐）

将 `v-if` 改为 `:disabled`，让按钮始终显示，但在没有图表时禁用：

```vue
<el-button 
  type="primary" 
  :icon="View"
  size="large"
  @click="openChartDrawer"
  :disabled="!reportContent.html_charts || reportContent.html_charts.length === 0"
>
  查看图表详情
</el-button>
```

**优点**：
- 用户界面一致，不会困惑
- 清楚地表明功能存在，只是当前不可用
- 鼠标悬停时可以显示提示信息

### 方案2：检查后端图表生成逻辑

确保后端即使在没有定制需求时也能生成默认图表。

**需要检查**：
1. `backend/app/services/bailian_service.py` 中的图表生成方法
2. 阿里百炼 API 的调用是否成功
3. 后端日志中是否有图表生成失败的 warning

### 方案3：前端提供默认图表

如果后端无法生成图表，前端可以基于报告文本自动生成简单的图表。

## 实施步骤

### 步骤1：修改按钮显示逻辑

需要修改 `frontend/src/views/Operation/DataAnalysis.vue` 中的3处按钮代码：

1. **第一处**（约第176行）- 主报告区域
2. **第二处**（约第259行）- 只读模式
3. **第三处**（约第421行）- AI编辑模式

将所有的：
```vue
v-if="reportContent.html_charts && reportContent.html_charts.length > 0"
```

改为：
```vue
:disabled="!reportContent.html_charts || reportContent.html_charts.length === 0"
```

### 步骤2：添加提示信息

为禁用的按钮添加 tooltip：

```vue
<el-tooltip content="当前报告暂无图表" :disabled="reportContent.html_charts && reportContent.html_charts.length > 0">
  <el-button 
    type="primary" 
    :icon="View"
    size="large"
    @click="openChartDrawer"
    :disabled="!reportContent.html_charts || reportContent.html_charts.length === 0"
  >
    查看图表详情
  </el-button>
</el-tooltip>
```

### 步骤3：检查后端日志

生成报告后，查看后端日志：

```bash
docker logs operation-analysis-v2-backend --tail 100 | grep "HTML图表"
```

查找类似的日志：
- `[运营数据分析] HTML图表生成成功 - 长度: xxx`
- `[运营数据分析] HTML图表生成失败: xxx`

## 测试验证

1. **生成新报告**（不填写图表定制需求）
   - 检查是否显示三个按钮
   - 检查图表按钮是否正确禁用
   - 检查 tooltip 是否显示

2. **生成带图表的报告**（填写图表定制需求）
   - 检查是否显示三个按钮
   - 检查所有按钮是否可用
   - 检查图表是否正确显示

3. **查看历史报告**
   - 检查按钮显示是否一致
   - 检查功能是否正常

## 注意事项

1. 修改后需要重启前端开发服务器
2. 清除浏览器缓存以确保更改生效
3. 如果问题仍然存在，需要检查后端图表生成逻辑
4. 考虑在生成报告时给用户提示："图表生成中，请稍候..."

## 相关文件

- `frontend/src/views/Operation/DataAnalysis.vue` - 主页面，包含按钮显示逻辑
- `backend/app/api/v1/operation.py` - 后端报告生成 API
- `backend/app/services/bailian_service.py` - 阿里百炼服务，负责图表生成
