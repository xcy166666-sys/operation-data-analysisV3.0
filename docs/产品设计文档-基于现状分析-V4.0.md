# 运营数据分析平台 产品设计文档

> 基于项目现状的第一性原理分析与升级改版方案

**文档版本**: V4.0
**更新日期**: 2024-12-26
**项目版本**: operation-data-analysis V3.0

---

## 目录

1. [第一部分：第一性原理分析](#第一部分第一性原理分析)
2. [第二部分：项目现状诊断](#第二部分项目现状诊断)
3. [第三部分：用户与场景分析](#第三部分用户与场景分析)
4. [第四部分：产品需求定义](#第四部分产品需求定义)
5. [第五部分：总体架构设计](#第五部分总体架构设计)
6. [第六部分：功能模块详细设计](#第六部分功能模块详细设计)
7. [第七部分：升级改版建议](#第七部分升级改版建议)
8. [第八部分：实施路线图](#第八部分实施路线图)

---

# 第一部分：第一性原理分析

## 1.1 什么是数据分析产品的本质？

### 核心问题拆解

用户使用数据分析产品的根本目的是什么？

```
原始数据 → [???] → 业务决策
```

这个 `[???]` 就是数据分析产品要解决的核心问题。拆解后：

| 层次 | 用户问题 | 产品能力 |
|------|----------|----------|
| **理解层** | 数据说了什么？ | 数据解读、可视化 |
| **洞察层** | 为什么会这样？ | 归因分析、关联分析 |
| **预测层** | 接下来会怎样？ | 趋势预测、异常预警 |
| **行动层** | 我该怎么做？ | 决策建议、行动指引 |

### 你的项目定位

**当前项目聚焦于**：`理解层` + `洞察层`

```
Excel数据 → [AI分析 + 图表生成] → 可读的分析报告
```

这是一个**AI驱动的自动化报告生成工具**，核心价值是：
> 让不会写代码的运营人员，也能快速获得专业的数据分析报告

## 1.2 第一性原理推导

### 用户的真实需求链

```
我有一堆Excel数据
    ↓
我不想花3小时手动分析
    ↓
我需要在30分钟内出一份报告给老板
    ↓
报告要有图表，要专业，要有结论
    ↓
最好还能告诉我该怎么做
```

### 价值公式

```
产品价值 = (报告质量 × 洞察深度 × 行动指导) / (时间成本 × 学习成本 × 修改成本)
```

**要最大化产品价值，需要**：

| 最大化 | 当前项目表现 | 改进方向 |
|--------|-------------|----------|
| 报告质量 | ⭐⭐⭐ 中等 | AI生成质量依赖Prompt，需要模板化 |
| 洞察深度 | ⭐⭐ 较浅 | 目前只做基础分析，缺少深度归因 |
| 行动指导 | ⭐⭐ 较弱 | 报告有结论但缺少具体行动建议 |

| 最小化 | 当前项目表现 | 改进方向 |
|--------|-------------|----------|
| 时间成本 | ⭐⭐⭐⭐ 较好 | 30秒-2分钟生成报告 |
| 学习成本 | ⭐⭐⭐⭐ 较好 | 上传+输入需求即可 |
| 修改成本 | ⭐⭐ 较高 | 图表编辑功能不完善，修改困难 |

### 核心结论

你的项目在**时间成本**和**学习成本**上做得很好，但在**报告质量**、**洞察深度**和**修改成本**上有明显短板。

**改版的核心方向应该是**：
1. 降低修改成本 → 完善图表编辑功能
2. 提升报告质量 → 模板化、结构化的报告生成
3. 增加行动指导 → AI生成具体的运营建议

## 1.3 竞品对标分析

| 维度 | 你的项目 | 神策数据 | GrowingIO | 通用BI工具 |
|------|----------|----------|-----------|-----------|
| 目标用户 | 游戏运营 | 全行业 | 互联网 | 分析师 |
| 核心能力 | AI报告生成 | 行为分析 | 增长分析 | 可视化 |
| 数据接入 | Excel上传 | SDK埋点 | SDK埋点 | 数据库连接 |
| 学习成本 | 极低 | 中等 | 中等 | 较高 |
| 定制能力 | 弱 | 强 | 强 | 极强 |

**你的差异化优势**：
- 零代码、零配置
- AI驱动的自动分析
- 专注游戏运营场景

**你的劣势**：
- 数据接入方式单一（只有Excel）
- 定制化能力弱
- 图表编辑能力不足

---

# 第二部分：项目现状诊断

## 2.1 系统架构现状

### 技术栈

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端                                    │
│  Vue 3 + TypeScript + Element Plus + ECharts + Vite             │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ HTTP/REST
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                          后端                                    │
│  FastAPI + SQLAlchemy + Pydantic                                │
└─────────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
    ┌──────────┐        ┌──────────┐        ┌──────────┐
    │PostgreSQL│        │  Redis   │        │阿里百炼   │
    │ 数据存储  │        │   缓存   │        │ AI服务   │
    └──────────┘        └──────────┘        └──────────┘
```

### 代码规模统计

| 模块 | 文件数 | 代码行数 | 说明 |
|------|--------|----------|------|
| **前端** | | | |
| views/Operation | 4个 | ~4500行 | 核心业务页面 |
| views/Admin | 4个 | ~1200行 | 管理后台 |
| components | 8个 | ~1500行 | 公共组件 |
| api | 7个 | ~600行 | API调用 |
| **后端** | | | |
| api/v1 | 5个 | ~4000行 | API端点（operation.py最大，3000+行） |
| services | 8个 | ~3000行 | 业务逻辑 |
| models | 8个 | ~500行 | 数据模型 |

## 2.2 功能模块现状

### 2.2.1 单文件数据分析

**文件**: `frontend/src/views/Operation/DataAnalysis.vue`
**代码量**: ~2500行
**状态**: ✅ 功能完整

```
用户流程:
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│  上传文件   │ → │ 输入需求    │ → │  生成报告   │ → │  查看/导出  │
│  Excel/CSV │    │ 分析要求   │    │ 文字+图表  │    │  PDF下载   │
└────────────┘    └────────────┘    └────────────┘    └────────────┘
                                           │
                                           ▼
                                    ┌────────────┐
                                    │  AI对话    │
                                    │  深入分析  │
                                    └────────────┘
```

**现有功能清单**:
- [x] 拖拽上传Excel/CSV文件（10MB限制）
- [x] 自定义分析需求输入（1000字）
- [x] 图表定制Prompt输入（500字）
- [x] AI生成文字报告（Markdown格式）
- [x] AI生成HTML图表（ECharts）
- [x] 历史会话列表（侧边栏）
- [x] 会话版本管理
- [x] AI对话模式（左右分栏）
- [x] 报告PDF下载
- [x] 图表详情查看（Drawer）
- [x] Dify嵌入模式切换

**问题与不足**:
- ❌ 图表无法编辑修改
- ❌ 报告格式固定，无法自定义模板
- ❌ 对话历史可能丢失
- ❌ 版本对比功能缺失

### 2.2.2 批量数据分析

**文件**: `frontend/src/views/Operation/BatchAnalysis.vue`
**代码量**: ~1500行
**状态**: ✅ 功能完整

```
用户流程:
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│ 上传多Sheet │ → │ 自动拆分   │ → │ 并发分析    │ → │ 标签页查看  │
│  Excel文件  │    │ 单个文件   │    │ 每个Sheet  │    │ 各Sheet报告│
└────────────┘    └────────────┘    └────────────┘    └────────────┘
```

**现有功能清单**:
- [x] 多Sheet Excel上传
- [x] 自动拆分为单个Sheet文件
- [x] 并发处理（最多3个并发）
- [x] 实时进度显示
- [x] 标签页切换查看各Sheet报告
- [x] 批量会话历史管理

**问题与不足**:
- ❌ 无法选择性分析某些Sheet
- ❌ 无法为不同Sheet指定不同的分析需求
- ❌ 失败Sheet无法单独重试

### 2.2.3 定制化批量分析

**文件**: `frontend/src/views/Operation/CustomBatchAnalysis.vue`
**代码量**: ~1500行
**状态**: ⚠️ 过度定制化

```
硬编码的6个Sheet对应关系:
┌─────────────────────────────────────────────────────────────────┐
│ Sheet 0: 最后操作分布  →  CUSTOM_PROMPT_0 (流失用户行为分析)    │
│ Sheet 1: 新手漏斗      →  CUSTOM_PROMPT_1 (新手留存转化分析)    │
│ Sheet 2: 回流用户      →  CUSTOM_PROMPT_2 (回流数量质量分析)    │
│ Sheet 3: 流失用户属性  →  CUSTOM_PROMPT_3 (VIP等级分布分析)     │
│ Sheet 4: 留存率        →  CUSTOM_PROMPT_4 (new/roll用户对比)   │
│ Sheet 5: LTV           →  CUSTOM_PROMPT_5 (生命周期价值分析)    │
└─────────────────────────────────────────────────────────────────┘
```

**问题与不足**:
- ❌ 完全硬编码，无法扩展
- ❌ 只适用于特定客户"黄伟斌"
- ❌ 新增客户需要复制代码
- ❌ Prompt无法在线编辑

### 2.2.4 管理后台

**状态**: ✅ 功能完整

| 页面 | 功能 | 状态 |
|------|------|------|
| 用户管理 | 增删改查、权限设置 | ✅ |
| 功能管理 | 工作流配置、启用禁用 | ✅ |
| 个人设置 | 修改密码、个人信息 | ✅ |

## 2.3 数据模型现状

### 核心实体关系

```
┌─────────────┐
│    User     │
│  用户表     │
└──────┬──────┘
       │ 1:N
       ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │AnalysisSession  │  │BatchAnalysis    │  │CustomBatchAnalysis│ │
│  │  单文件分析      │  │Session 批量分析 │  │Session 定制化    │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │            │
│           │ 1:N                │ 1:N                │ 1:N        │
│           ▼                    ▼                    ▼            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │SessionVersion   │  │  SheetReport    │  │CustomSheetReport│  │
│  │  会话版本       │  │  Sheet报告      │  │  定制报告       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 关键字段设计

**analysis_sessions.messages** (JSONB):
```json
[
  {
    "role": "user",
    "content": "用户的分析需求",
    "timestamp": "2024-12-26T10:00:00Z"
  },
  {
    "role": "assistant",
    "content": "AI生成的报告文本",
    "html_charts": "<html>...</html>",
    "charts": [...],
    "timestamp": "2024-12-26T10:00:30Z"
  }
]
```

**sheet_reports.report_content** (JSONB):
```json
{
  "text": "文字报告内容（Markdown）",
  "html_charts": "<html>图表代码</html>",
  "charts": [],
  "tables": [],
  "metrics": {}
}
```

## 2.4 核心服务现状

### AI服务调用链

```
API请求
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ChartGenerator                               │
│                    图表生成协调器                                │
└───────────────────────────┬─────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │BailianService│ │PyechartsGen  │ │ CodeExecutor │
    │ 阿里百炼API  │ │  本地图表    │ │  代码执行    │
    └──────────────┘ └──────────────┘ └──────────────┘
```

### BailianService 核心方法

| 方法 | 功能 | 调用场景 |
|------|------|----------|
| `analyze_excel_and_generate_html()` | 生成HTML图表代码 | 所有分析 |
| `analyze_excel_and_generate_text_report()` | 生成文字报告 | 所有分析 |
| `analyze_excel_and_generate_chart_config()` | 生成JSON配置 | 备用方式 |

### Prompt 管理现状

| Prompt类型 | 存储位置 | 可配置性 |
|-----------|----------|----------|
| HTML图表生成Prompt | 代码硬编码 | ❌ 不可配置 |
| 文字报告Prompt | 代码硬编码 | ❌ 不可配置 |
| 定制化Prompt (6个) | 代码硬编码 | ❌ 不可配置 |

## 2.5 问题汇总

### 严重问题 (P0)

| 问题 | 影响 | 当前状态 |
|------|------|----------|
| 图表无法编辑 | 用户无法修改AI生成的图表 | 正在开发中 |
| 定制化功能无法扩展 | 只能服务特定客户 | 完全硬编码 |
| operation.py过大 | 难以维护，容易出bug | 3000+行单文件 |

### 重要问题 (P1)

| 问题 | 影响 | 当前状态 |
|------|------|----------|
| Prompt无法在线编辑 | 调整分析效果需要改代码 | 无配置界面 |
| 对话历史管理混乱 | 对话可能丢失 | 存储逻辑不清晰 |
| 版本对比缺失 | 无法比较不同版本差异 | 只能查看历史 |
| 报告模板固定 | 无法适应不同场景 | 无模板系统 |

### 一般问题 (P2)

| 问题 | 影响 | 当前状态 |
|------|------|----------|
| 缺少API文档 | 前后端协作困难 | 无OpenAPI |
| 测试覆盖不足 | 质量无法保证 | 几乎无测试 |
| 错误提示不友好 | 用户困惑 | 只有技术错误信息 |

---

# 第三部分：用户与场景分析

## 3.1 用户画像

### 画像A：游戏运营专员（主要用户）

```
┌─────────────────────────────────────────────────────────────────┐
│  👤 小王 - 游戏运营专员                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  基本信息:                                                       │
│  • 年龄: 25-30岁                                                │
│  • 工作经验: 1-3年                                              │
│  • 技术能力: 熟练使用Excel，不会SQL/Python                       │
│                                                                 │
│  工作场景:                                                       │
│  • 每天需要出一份运营日报                                        │
│  • 每周需要做周报复盘                                            │
│  • 经常需要临时分析数据回答老板问题                               │
│                                                                 │
│  痛点:                                                          │
│  • "数据从后台导出来一堆Excel，整理要花2小时"                    │
│  • "做图表要用Excel调半天，还不好看"                             │
│  • "老板突然问个数据，现查现算很慌"                              │
│                                                                 │
│  期望:                                                          │
│  • 上传数据就能自动出报告                                        │
│  • 图表要能直接用，最好能改改颜色                                │
│  • 导出PDF直接发给老板                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 画像B：数据分析师（高级用户）

```
┌─────────────────────────────────────────────────────────────────┐
│  👤 小李 - 数据分析师                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  基本信息:                                                       │
│  • 年龄: 28-35岁                                                │
│  • 工作经验: 3-5年                                              │
│  • 技术能力: SQL熟练，Python基础，会用BI工具                     │
│                                                                 │
│  工作场景:                                                       │
│  • 做专项分析（如流失原因分析、付费转化分析）                     │
│  • 支持运营团队的数据需求                                        │
│  • 制作给管理层的分析报告                                        │
│                                                                 │
│  痛点:                                                          │
│  • "每次分析都要写很多重复的代码"                                │
│  • "给运营出的报告格式都差不多，能不能模板化"                    │
│  • "AI生成的分析太浅了，我需要能深入调整"                        │
│                                                                 │
│  期望:                                                          │
│  • 能自定义分析模板和Prompt                                     │
│  • 图表要能完全控制（颜色、样式、数据）                          │
│  • 能保存常用的分析配置                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 画像C：运营总监（决策者）

```
┌─────────────────────────────────────────────────────────────────┐
│  👤 张总 - 运营总监                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  基本信息:                                                       │
│  • 年龄: 35-45岁                                                │
│  • 工作经验: 8年以上                                             │
│  • 技术能力: 只看报告，不做分析                                  │
│                                                                 │
│  工作场景:                                                       │
│  • 每周看运营周报                                                │
│  • 每月做运营复盘                                                │
│  • 向管理层汇报                                                  │
│                                                                 │
│  痛点:                                                          │
│  • "报告太长了，我只想看结论"                                    │
│  • "数据给我了，所以我该怎么做？"                                │
│  • "能不能每周自动发报告给我"                                    │
│                                                                 │
│  期望:                                                          │
│  • 报告要有清晰的执行摘要                                        │
│  • 要有具体的行动建议                                            │
│  • 支持定时推送                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 3.2 使用场景分析

### 场景1：日报生成（高频）

```
频率: 每天
用户: 运营专员
数据: 当日运营数据Excel
需求: 快速生成包含DAU、收入等核心指标的日报

当前体验:
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│ 上传   │ → │ 输入   │ → │ 等待   │ → │ 下载   │
│ Excel  │   │ 需求   │   │ 30秒   │   │ PDF    │
└────────┘   └────────┘   └────────┘   └────────┘
     ✓ 体验较好              ✓ 速度可接受

痛点:
• 每天都要手动输入类似的分析需求
• 图表样式每次都不一样，想统一风格很难
• 想调整图表颜色，只能重新生成

改进方向:
• 支持"日报模板"，一键生成
• 记住用户的图表偏好设置
• 支持简单的图表颜色修改
```

### 场景2：周报复盘（高频）

```
频率: 每周
用户: 运营专员/分析师
数据: 一周运营数据 + 上周数据对比
需求: 生成周度趋势分析，对比上周变化

当前体验:
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│ 上传   │ → │ 输入   │ → │ 生成   │ → │ 对话   │
│ 周数据 │   │ 对比需求│   │ 报告   │   │ 深入   │
└────────┘   └────────┘   └────────┘   └────────┘
                               │
                               ▼
                         缺少环比对比图表

痛点:
• AI不一定能自动做环比对比
• 需要手动告诉AI"对比上周"
• 生成的对比图表可能不是想要的样式

改进方向:
• 支持上传多个文件（本周+上周）
• 自动识别时间维度做对比
• 专门的"周报模板"
```

### 场景3：批量Sheet分析（中频）

```
频率: 每周/每月
用户: 分析师
数据: 包含多个Sheet的复杂Excel
需求: 分别分析每个Sheet，生成综合报告

当前体验:
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│ 上传   │ → │ 自动   │ → │ 并发   │ → │ 标签页 │
│ Excel  │   │ 拆分   │   │ 分析   │   │ 查看   │
└────────┘   └────────┘   └────────┘   └────────┘
                               │
                               ▼
                         所有Sheet用同一个Prompt

痛点:
• 不同Sheet内容不同，但分析Prompt一样
• 无法为特定Sheet指定特殊的分析要求
• 失败的Sheet无法单独重试

改进方向:
• 支持选择性分析某些Sheet
• 支持为不同Sheet指定不同Prompt
• 支持单个Sheet重新分析
```

### 场景4：定制化分析（当前只有黄伟斌）

```
频率: 每周
用户: 特定客户
数据: 固定格式的6个Sheet
需求: 每个Sheet用专门的Prompt分析

当前实现:
┌────────────────────────────────────────────────────────────────┐
│  完全硬编码在CustomBatchAnalysis中                              │
│  • 6个固定Sheet名称                                             │
│  • 6个固定Prompt                                                │
│  • 无法扩展到其他客户                                           │
└────────────────────────────────────────────────────────────────┘

痛点:
• 新客户需要复制代码
• Prompt调整需要改代码部署
• 无法在线配置

改进方向:
• 抽象为"分析模板"概念
• 模板包含：Sheet映射规则 + Prompt配置
• 支持在线创建和编辑模板
```

## 3.3 场景优先级矩阵

| 场景 | 频率 | 用户量 | 当前体验 | 改进优先级 |
|------|------|--------|----------|-----------|
| 日报生成 | 每天 | 多 | ⭐⭐⭐ | P1 |
| 周报复盘 | 每周 | 多 | ⭐⭐⭐ | P1 |
| 批量分析 | 每周 | 少 | ⭐⭐⭐ | P2 |
| 定制化分析 | 每周 | 极少 | ⭐⭐ | P1（需要泛化） |
| 图表编辑 | 随时 | 多 | ⭐ | P0 |

---

# 第四部分：产品需求定义

## 4.1 产品愿景

### 一句话定位

> **让游戏运营人员的数据分析效率提升10倍**

### 核心价值主张

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   上传Excel → 选择模板 → 一键生成 → 轻松修改 → 快速导出         │
│                                                                 │
│   从3小时 → 3分钟                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 4.2 核心功能需求

### 4.2.1 图表编辑器（P0 - 当前缺失）

**用户故事**:
```
作为 运营专员
我想要 编辑AI生成的图表
以便于 调整颜色和样式，让图表符合公司品牌规范
```

**功能规格**:

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 图表类型切换 | 柱状图/折线图/饼图互换 | P0 |
| 颜色修改 | 修改图表配色方案 | P0 |
| 标题编辑 | 修改图表标题和副标题 | P0 |
| 图例控制 | 显示/隐藏图例 | P1 |
| 数据标签 | 显示/隐藏数据标签 | P1 |
| 坐标轴设置 | 设置坐标轴范围和格式 | P2 |
| 撤销/重做 | 操作历史管理 | P1 |
| 实时预览 | 修改后即时预览效果 | P0 |

**UI设计**:
```
┌─────────────────────────────────────────────────────────────────┐
│  图表编辑器                                      [保存] [取消]  │
├──────────────┬──────────────────────────┬───────────────────────┤
│              │                          │                       │
│  工具栏      │      图表预览区          │     属性面板          │
│              │                          │                       │
│  📊 类型     │  ┌──────────────────┐   │  图表类型             │
│  🎨 颜色     │  │                  │   │  [柱状图 ▼]           │
│  📝 标题     │  │   实时预览图表   │   │                       │
│  📏 坐标轴   │  │                  │   │  配色方案             │
│  📍 标签     │  │                  │   │  [默认蓝 ▼]           │
│              │  └──────────────────┘   │                       │
│  ↩️ 撤销     │                          │  标题: [___________]  │
│  ↪️ 重做     │                          │                       │
│              │                          │  显示图例 [✓]         │
│              │                          │  显示标签 [✓]         │
│              │                          │                       │
└──────────────┴──────────────────────────┴───────────────────────┘
```

### 4.2.2 分析模板系统（P1 - 解决定制化问题）

**用户故事**:
```
作为 数据分析师
我想要 创建和管理分析模板
以便于 为不同客户/场景配置专属的分析方案
```

**功能规格**:

| 功能 | 描述 | 优先级 |
|------|------|------|
| 模板创建 | 创建新的分析模板 | P0 |
| Sheet映射 | 配置Sheet名称与分析Prompt的对应关系 | P0 |
| Prompt编辑 | 在线编辑分析Prompt | P0 |
| 模板复制 | 基于现有模板创建新模板 | P1 |
| 模板分享 | 分享模板给其他用户 | P2 |
| 系统模板 | 提供预置的常用模板 | P1 |

**数据模型**:
```json
{
  "id": 1,
  "name": "游戏运营周报模板",
  "description": "适用于游戏运营数据的周度分析",
  "created_by": 1,
  "is_system": false,
  "sheet_configs": [
    {
      "sheet_pattern": "最后操作*",
      "prompt": "请分析用户最后操作的分布情况...",
      "chart_type_hint": "pie"
    },
    {
      "sheet_pattern": "新手漏斗*",
      "prompt": "请分析新手漏斗转化情况...",
      "chart_type_hint": "funnel"
    }
  ],
  "default_prompt": "请分析这份数据...",
  "output_format": {
    "include_summary": true,
    "include_recommendations": true
  }
}
```

### 4.2.3 报告模板系统（P1）

**用户故事**:
```
作为 运营专员
我想要 使用预设的报告模板
以便于 每天快速生成格式统一的日报
```

**功能规格**:

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 日报模板 | 预置的日报格式 | P0 |
| 周报模板 | 预置的周报格式 | P0 |
| 自定义模板 | 用户创建自己的报告模板 | P1 |
| 模板变量 | 支持日期等动态变量 | P1 |

### 4.2.4 对话增强（P2）

**用户故事**:
```
作为 运营专员
我想要 通过对话修改报告内容
以便于 不用重新生成就能微调报告
```

**功能规格**:

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 对话编辑报告 | "帮我把第二段改成..." | P1 |
| 对话修改图表 | "把图表换成折线图" | P1 |
| 对话问答 | 基于数据回答问题 | P0（已有） |
| 上下文记忆 | 记住之前的对话内容 | P1 |

## 4.3 非功能需求

### 性能需求

| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| 单文件分析时间 | 30-60秒 | <30秒 |
| 批量分析并发数 | 3 | 5 |
| 页面加载时间 | ~2秒 | <1秒 |
| 文件大小限制 | 10MB | 50MB |

### 可用性需求

| 指标 | 目标值 |
|------|--------|
| 系统可用性 | 99.5% |
| 错误恢复时间 | <5分钟 |
| 数据备份频率 | 每日 |

### 安全需求

| 需求 | 说明 |
|------|------|
| 数据隔离 | 用户只能访问自己的数据 |
| 传输加密 | HTTPS |
| 敏感数据 | 不存储原始Excel文件超过7天 |

---

# 第五部分：总体架构设计

## 5.1 系统架构（升级版）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              前端层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │   分析模块    │  │   编辑模块    │  │   管理模块    │                  │
│  │  DataAnalysis │  │ ChartEditor  │  │    Admin     │                  │
│  │  BatchAnalysis│  │ ReportEditor │  │  Templates   │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                         │
│  技术栈: Vue 3 + Arco Design + ECharts + TypeScript                    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/REST + WebSocket
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              后端层                                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         API Gateway                              │   │
│  │  • 认证授权 • 限流 • 日志 • 错误处理                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │  分析服务    │  │  报告服务    │  │  模板服务    │  │  用户服务   │ │
│  │AnalysisServ  │  │ ReportServ   │  │TemplateServ  │  │  UserServ  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │
│                                                                         │
│  技术栈: FastAPI + SQLAlchemy + Pydantic                               │
└─────────────────────────────────────────────────────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
           ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
           │  PostgreSQL  │     │    Redis     │     │   AI服务      │
           │   数据存储    │     │  缓存/队列   │     │  阿里百炼     │
           └──────────────┘     └──────────────┘     └──────────────┘
```

## 5.2 模块划分（重构后）

### 后端模块重构

**当前问题**：`operation.py` 3000+行，包含所有分析相关逻辑

**重构方案**：

```
backend/app/api/v1/
├── analysis/                    # 分析相关API（拆分）
│   ├── __init__.py
│   ├── single.py               # 单文件分析 API
│   ├── batch.py                # 批量分析 API
│   └── template_based.py       # 模板化分析 API（替代custom_batch）
├── report/                      # 报告相关API
│   ├── __init__.py
│   ├── export.py               # 导出功能
│   └── version.py              # 版本管理
├── template/                    # 模板管理API（新增）
│   ├── __init__.py
│   ├── analysis_template.py    # 分析模板
│   └── report_template.py      # 报告模板
├── chart/                       # 图表相关API（新增）
│   ├── __init__.py
│   └── editor.py               # 图表编辑
├── auth.py                      # 认证
├── admin.py                     # 管理
└── user.py                      # 用户
```

### 前端模块重构

```
frontend/src/views/
├── Analysis/                    # 分析功能（重组）
│   ├── SingleAnalysis.vue      # 单文件分析
│   ├── BatchAnalysis.vue       # 批量分析
│   ├── TemplateAnalysis.vue    # 模板化分析（新）
│   └── components/
│       ├── FileUploader.vue
│       ├── PromptInput.vue
│       ├── ReportViewer.vue
│       └── DialogPanel.vue
├── Editor/                      # 编辑功能（新增）
│   ├── ChartEditor.vue         # 图表编辑器
│   ├── ReportEditor.vue        # 报告编辑器
│   └── components/
│       ├── ChartTypeSelector.vue
│       ├── ColorPicker.vue
│       └── PropertyPanel.vue
├── Template/                    # 模板管理（新增）
│   ├── TemplateList.vue
│   ├── TemplateEditor.vue
│   └── components/
│       ├── SheetConfigEditor.vue
│       └── PromptEditor.vue
├── Admin/                       # 管理后台
└── Home.vue                     # 首页
```

## 5.3 数据模型（升级版）

### 新增：分析模板表

```sql
CREATE TABLE analysis_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_by INTEGER REFERENCES users(id),
    is_system BOOLEAN DEFAULT false,
    is_public BOOLEAN DEFAULT false,

    -- 模板配置
    sheet_configs JSONB NOT NULL DEFAULT '[]',
    default_prompt TEXT,
    chart_style_config JSONB DEFAULT '{}',
    output_format JSONB DEFAULT '{}',

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- sheet_configs 结构:
-- [
--   {
--     "sheet_pattern": "最后操作*",  -- 支持通配符
--     "prompt": "分析Prompt...",
--     "chart_type_hint": "pie"
--   }
-- ]
```

### 新增：报告模板表

```sql
CREATE TABLE report_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_by INTEGER REFERENCES users(id),
    is_system BOOLEAN DEFAULT false,

    -- 模板内容
    template_type VARCHAR(50) NOT NULL,  -- daily, weekly, monthly, custom
    structure JSONB NOT NULL,  -- 报告结构定义
    style_config JSONB DEFAULT '{}',  -- 样式配置

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- structure 结构:
-- {
--   "sections": [
--     { "type": "summary", "title": "执行摘要" },
--     { "type": "metrics", "title": "核心指标" },
--     { "type": "charts", "title": "图表分析" },
--     { "type": "recommendations", "title": "行动建议" }
--   ]
-- }
```

### 新增：图表配置表

```sql
CREATE TABLE chart_configs (
    id SERIAL PRIMARY KEY,
    report_id INTEGER,  -- 关联报告
    session_id INTEGER, -- 关联会话

    -- 图表配置
    chart_type VARCHAR(50) NOT NULL,
    title VARCHAR(200),
    config JSONB NOT NULL,  -- ECharts完整配置
    data JSONB,  -- 图表数据

    -- 编辑历史
    version INTEGER DEFAULT 1,
    edit_history JSONB DEFAULT '[]',

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 5.4 API设计（升级版）

### 分析相关API

```yaml
# 单文件分析
POST   /api/v1/analysis/single/sessions          # 创建会话
POST   /api/v1/analysis/single/sessions/{id}/upload  # 上传文件
POST   /api/v1/analysis/single/sessions/{id}/analyze # 执行分析
GET    /api/v1/analysis/single/sessions/{id}     # 获取会话详情
DELETE /api/v1/analysis/single/sessions/{id}     # 删除会话

# 批量分析
POST   /api/v1/analysis/batch/sessions           # 创建批量会话
POST   /api/v1/analysis/batch/sessions/{id}/upload   # 上传文件
POST   /api/v1/analysis/batch/sessions/{id}/analyze  # 执行批量分析
GET    /api/v1/analysis/batch/sessions/{id}/status   # 获取进度
GET    /api/v1/analysis/batch/sessions/{id}/reports  # 获取所有报告

# 模板化分析（替代custom_batch）
POST   /api/v1/analysis/template/sessions        # 创建模板分析会话
POST   /api/v1/analysis/template/sessions/{id}/upload    # 上传文件
POST   /api/v1/analysis/template/sessions/{id}/analyze   # 使用模板分析
```

### 模板管理API

```yaml
# 分析模板
GET    /api/v1/templates/analysis                # 获取分析模板列表
POST   /api/v1/templates/analysis                # 创建分析模板
GET    /api/v1/templates/analysis/{id}           # 获取模板详情
PUT    /api/v1/templates/analysis/{id}           # 更新模板
DELETE /api/v1/templates/analysis/{id}           # 删除模板
POST   /api/v1/templates/analysis/{id}/duplicate # 复制模板

# 报告模板
GET    /api/v1/templates/report                  # 获取报告模板列表
POST   /api/v1/templates/report                  # 创建报告模板
GET    /api/v1/templates/report/{id}             # 获取模板详情
PUT    /api/v1/templates/report/{id}             # 更新模板
DELETE /api/v1/templates/report/{id}             # 删除模板
```

### 图表编辑API

```yaml
# 图表编辑
GET    /api/v1/charts/{id}                       # 获取图表配置
PUT    /api/v1/charts/{id}                       # 更新图表配置
POST   /api/v1/charts/{id}/preview               # 预览图表
GET    /api/v1/charts/{id}/history               # 获取编辑历史
POST   /api/v1/charts/{id}/revert/{version}      # 回退到历史版本
```

---

# 第六部分：功能模块详细设计

## 6.1 图表编辑器模块

### 6.1.1 功能架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        图表编辑器                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    编辑器核心                            │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │   │
│  │  │ConfigMgr  │  │HistoryMgr │  │ PreviewMgr│           │   │
│  │  │ 配置管理  │  │ 历史管理  │  │ 预览管理  │           │   │
│  │  └───────────┘  └───────────┘  └───────────┘           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    编辑功能                              │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │   │
│  │  │TypeChanger│  │ColorEditor│  │ TitleEdit │           │   │
│  │  │ 类型切换  │  │ 颜色编辑  │  │ 标题编辑  │           │   │
│  │  └───────────┘  └───────────┘  └───────────┘           │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │   │
│  │  │AxisEditor │  │LegendEdit │  │ LabelEdit │           │   │
│  │  │ 坐标轴    │  │ 图例编辑  │  │ 标签编辑  │           │   │
│  │  └───────────┘  └───────────┘  └───────────┘           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.1.2 类型切换矩阵

| 原类型 | 可切换为 | 数据兼容性 |
|--------|----------|-----------|
| 柱状图 | 折线图、面积图 | 完全兼容 |
| 折线图 | 柱状图、面积图 | 完全兼容 |
| 饼图 | 环形图、玫瑰图 | 完全兼容 |
| 散点图 | 气泡图 | 需要补充size字段 |

### 6.1.3 配色方案预设

```javascript
const COLOR_SCHEMES = {
  default: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de'],
  business: ['#2E5BFF', '#8C54FF', '#00C1D4', '#FAD961', '#FF6B6B'],
  nature: ['#2E7D32', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B'],
  ocean: ['#0077B6', '#00B4D8', '#90E0EF', '#CAF0F8', '#03045E'],
  sunset: ['#FF6B35', '#F7931E', '#FFD23F', '#3D5A80', '#293241'],
  monochrome: ['#212121', '#424242', '#616161', '#9E9E9E', '#BDBDBD']
};
```

### 6.1.4 编辑操作接口

```typescript
interface ChartEditorAPI {
  // 类型操作
  changeType(chartId: string, newType: ChartType): Promise<void>;

  // 样式操作
  updateColors(chartId: string, colors: string[]): Promise<void>;
  updateTitle(chartId: string, title: TitleConfig): Promise<void>;
  updateLegend(chartId: string, legend: LegendConfig): Promise<void>;
  updateAxis(chartId: string, axis: AxisConfig): Promise<void>;

  // 历史操作
  undo(chartId: string): Promise<void>;
  redo(chartId: string): Promise<void>;
  getHistory(chartId: string): Promise<EditHistory[]>;
  revertTo(chartId: string, version: number): Promise<void>;

  // 预览
  preview(config: EChartsOption): Promise<string>; // 返回预览图URL

  // 保存
  save(chartId: string): Promise<void>;
}
```

## 6.2 分析模板模块

### 6.2.1 模板结构设计

```typescript
interface AnalysisTemplate {
  id: number;
  name: string;
  description: string;
  createdBy: number;
  isSystem: boolean;
  isPublic: boolean;

  // 核心配置
  sheetConfigs: SheetConfig[];
  defaultPrompt: string;
  chartStyleConfig: ChartStyleConfig;
  outputFormat: OutputFormat;
}

interface SheetConfig {
  // Sheet匹配规则
  sheetPattern: string;  // 支持通配符，如 "流失*", "*漏斗*"
  matchType: 'exact' | 'prefix' | 'suffix' | 'contains' | 'regex';

  // 分析配置
  prompt: string;
  chartTypeHint?: 'bar' | 'line' | 'pie' | 'funnel' | 'auto';
  analysisDepth?: 'basic' | 'detailed' | 'comprehensive';

  // 输出配置
  includeRecommendations: boolean;
  customSections?: string[];
}

interface OutputFormat {
  includeSummary: boolean;
  includeRecommendations: boolean;
  includeRawData: boolean;
  maxCharts: number;
  language: 'zh-CN' | 'en-US';
}
```

### 6.2.2 模板编辑界面

```
┌─────────────────────────────────────────────────────────────────┐
│  编辑分析模板: 游戏运营周报                       [保存] [取消] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  基本信息                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 模板名称: [游戏运营周报_______________]                  │   │
│  │ 模板描述: [适用于游戏运营数据的周度分析报告__]          │   │
│  │ 公开模板: [✓]                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Sheet配置                                          [+ 添加规则]│
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ #1 匹配规则                                              │   │
│  │ ┌─────────────────────────────────────────────────────┐ │   │
│  │ │ Sheet名称包含: [最后操作_______]                     │ │   │
│  │ │ 分析Prompt:                                          │ │   │
│  │ │ ┌─────────────────────────────────────────────────┐ │ │   │
│  │ │ │ 请分析用户最后操作的分布情况，重点关注：        │ │ │   │
│  │ │ │ 1. 各操作类型的占比                              │ │ │   │
│  │ │ │ 2. 流失用户的最后行为特征                        │ │ │   │
│  │ │ │ 3. 给出降低流失的具体建议                        │ │ │   │
│  │ │ └─────────────────────────────────────────────────┘ │ │   │
│  │ │ 推荐图表: [饼图 ▼]                                   │ │   │
│  │ └─────────────────────────────────────────────────────┘ │   │
│  │                                                    [删除] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ #2 匹配规则                                              │   │
│  │ ┌─────────────────────────────────────────────────────┐ │   │
│  │ │ Sheet名称包含: [新手漏斗_______]                     │ │   │
│  │ │ ...                                                  │ │   │
│  │ └─────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  默认Prompt（不匹配任何规则时使用）                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 请对这份数据进行分析，生成包含图表的分析报告...         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2.3 将现有定制化分析迁移为模板

**当前硬编码**（CustomBatchAnalysis）:
```python
# 现在: 代码中硬编码
CUSTOM_BATCH_PROMPTS = {
    0: "分析流失用户最后行为...",
    1: "分析新手漏斗转化...",
    # ...
}
```

**迁移后**（数据库模板）:
```json
{
  "name": "黄伟斌定制模板",
  "sheetConfigs": [
    {
      "sheetPattern": "最后操作",
      "matchType": "prefix",
      "prompt": "分析流失用户最后行为..."
    },
    {
      "sheetPattern": "新手漏斗",
      "matchType": "prefix",
      "prompt": "分析新手漏斗转化..."
    }
  ]
}
```

## 6.3 报告展示模块优化

### 6.3.1 报告结构

```
┌─────────────────────────────────────────────────────────────────┐
│                        分析报告                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📋 执行摘要                                              │   │
│  │ ─────────────────────────────────────────────────────── │   │
│  │ • 本周DAU环比增长12%，达到峰值15万                       │   │
│  │ • 新手留存率提升3个百分点                                │   │
│  │ • 付费转化率略有下降，需要关注                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📊 核心指标                                              │   │
│  │ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐│   │
│  │ │ DAU       │ │ 新增用户  │ │ 留存率    │ │ 收入      ││   │
│  │ │ 150,000   │ │ 12,500    │ │ 45.2%     │ │ ¥125万   ││   │
│  │ │ ↑12%      │ │ ↑8%       │ │ ↑3pp      │ │ ↓5%      ││   │
│  │ └───────────┘ └───────────┘ └───────────┘ └───────────┘│   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📈 趋势分析                                              │   │
│  │ ┌─────────────────────────────────────────────────────┐ │   │
│  │ │         [DAU趋势图表 - 可编辑]            [✏️编辑]  │ │   │
│  │ │  150k ──────────────────────────────────────        │ │   │
│  │ │                         ●                           │ │   │
│  │ │  100k ─────────────────╱─╲──────────────────        │ │   │
│  │ │                       ╱   ╲                         │ │   │
│  │ │   50k ───────────────╱─────╲────────────────        │ │   │
│  │ │       ─────┬────┬────┬────┬────┬────┬────          │ │   │
│  │ │           周一  周二  周三  周四  周五  周六          │ │   │
│  │ └─────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │ 分析: 本周DAU呈现稳步上升趋势，周四达到峰值...          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💡 行动建议                                              │   │
│  │ ─────────────────────────────────────────────────────── │   │
│  │ 1. 【高优先级】针对付费转化下降，建议优化首充礼包        │   │
│  │ 2. 【中优先级】继续加强新手引导，保持留存提升势头        │   │
│  │ 3. 【低优先级】关注周末活跃度下降原因                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3.2 报告交互设计

| 区域 | 交互方式 | 功能 |
|------|----------|------|
| 执行摘要 | 点击展开/收起 | 查看详细摘要 |
| 核心指标 | 悬停显示详情 | 查看指标计算方式 |
| 图表 | 点击编辑按钮 | 进入图表编辑器 |
| 行动建议 | 点击复制 | 复制建议文本 |
| 整体报告 | 右上角按钮 | 导出PDF/分享链接 |

## 6.4 对话模块优化

### 6.4.1 对话能力增强

```
┌─────────────────────────────────────────────────────────────────┐
│  💬 AI分析助手                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  支持的对话类型:                                                │
│                                                                 │
│  📊 数据查询                                                    │
│  "本周DAU最高是哪天？"                                          │
│  "付费用户和免费用户的留存有什么差异？"                          │
│                                                                 │
│  ✏️ 报告修改                                                    │
│  "把执行摘要改得更简洁一些"                                      │
│  "添加一个关于地区分布的分析段落"                                │
│                                                                 │
│  📈 图表调整                                                    │
│  "把DAU趋势图换成柱状图"                                        │
│  "给图表加上数据标签"                                           │
│                                                                 │
│  💡 深入分析                                                    │
│  "为什么周四的数据特别高？"                                      │
│  "预测下周的DAU趋势"                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4.2 意图识别

```typescript
enum DialogIntent {
  DATA_QUERY = 'data_query',        // 数据查询
  REPORT_EDIT = 'report_edit',      // 报告修改
  CHART_MODIFY = 'chart_modify',    // 图表修改
  DEEP_ANALYSIS = 'deep_analysis',  // 深入分析
  GENERAL_CHAT = 'general_chat'     // 一般对话
}

interface IntentResult {
  intent: DialogIntent;
  confidence: number;
  entities: {
    metric?: string;      // 涉及的指标
    timeRange?: string;   // 时间范围
    chartId?: string;     // 图表ID
    action?: string;      // 具体动作
  };
}
```

---

# 第七部分：升级改版建议

## 7.1 短期优化（1-2周）

### 7.1.1 完成图表编辑器 MVP

**目标**: 让用户能够修改图表的基本属性

**范围**:
- [ ] 图表类型切换（柱状图↔折线图↔饼图）
- [ ] 颜色方案选择（5个预设方案）
- [ ] 标题修改
- [ ] 保存和撤销

**实现步骤**:
1. 完善 `ModificationEngine.ts` 核心逻辑
2. 实现 `ChartEditor.vue` 编辑界面
3. 添加后端 `/api/v1/charts/{id}` API
4. 集成到现有报告展示流程

### 7.1.2 UI框架迁移准备

**目标**: 为 Arco Design 迁移做准备

**范围**:
- [ ] 梳理所有 Element Plus 组件使用情况
- [ ] 建立组件映射表
- [ ] 评估自定义样式迁移工作量

## 7.2 中期改进（1-2月）

### 7.2.1 分析模板系统

**目标**: 将定制化分析抽象为可配置的模板

**范围**:
- [ ] 设计模板数据模型
- [ ] 实现模板CRUD API
- [ ] 实现模板编辑界面
- [ ] 迁移现有"黄伟斌定制"为模板

**业务价值**:
- 新客户定制从"改代码"变成"配置模板"
- 运营团队可以自助创建分析模板
- Prompt调优不需要重新部署

### 7.2.2 UI框架迁移

**目标**: 从 Element Plus 迁移到 Arco Design

**范围**:
- 参考已生成的《Arco-Design-迁移建议.md》

### 7.2.3 后端代码重构

**目标**: 拆分过大的 operation.py

**范围**:
- [ ] 将 operation.py 拆分为 single.py、batch.py、template_based.py
- [ ] 提取公共逻辑到 service 层
- [ ] 添加单元测试

## 7.3 长期规划（3-6月）

### 7.3.1 报告模板系统

**目标**: 支持自定义报告格式和结构

**功能**:
- 日报/周报/月报模板
- 自定义报告章节
- 品牌定制（Logo、颜色）

### 7.3.2 高级对话功能

**目标**: 增强AI对话能力

**功能**:
- 对话修改报告内容
- 对话调整图表
- 多轮对话上下文记忆

### 7.3.3 协作功能

**目标**: 支持团队协作

**功能**:
- 报告分享链接
- 评论和批注
- 多人协作编辑

### 7.3.4 数据源扩展

**目标**: 支持更多数据接入方式

**功能**:
- 数据库直连（MySQL、PostgreSQL）
- API数据接入
- 定时自动拉取

## 7.4 技术债务清理

| 债务 | 影响 | 优先级 | 建议时间 |
|------|------|--------|----------|
| operation.py 过大 | 维护困难 | P0 | 1-2月内 |
| 缺少单元测试 | 质量风险 | P1 | 持续进行 |
| 无API文档 | 协作困难 | P2 | 2-3月内 |
| 错误处理不完善 | 用户体验差 | P1 | 1-2月内 |
| 日志记录不足 | 排查困难 | P2 | 2-3月内 |

---

# 第八部分：实施路线图

## 8.1 版本规划

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           版本路线图                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  V3.1 (当前迭代)              V3.2                    V4.0              │
│  图表编辑器 MVP              模板系统                 全面升级          │
│  ─────────────              ─────────               ─────────          │
│  • 图表类型切换             • 分析模板                • UI框架迁移      │
│  • 颜色修改                 • 报告模板                • 后端重构        │
│  • 标题编辑                 • Prompt在线编辑          • 高级对话        │
│  • 撤销/重做                • 模板管理界面            • 协作功能        │
│                                                                         │
│  预计: 2周                  预计: 4周                 预计: 8周         │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  V4.1                       V5.0                                        │
│  扩展功能                   平台化                                      │
│  ─────────                 ─────────                                   │
│  • 数据库连接               • 多租户                                    │
│  • 定时报告                 • 开放API                                   │
│  • 邮件推送                 • 插件系统                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 8.2 V3.1 详细任务分解

### Sprint 1（第1周）

| 任务 | 负责模块 | 预估工时 | 优先级 |
|------|----------|----------|--------|
| ModificationEngine 核��逻辑完善 | 前端 | 8h | P0 |
| ChartEditor.vue 基础框架 | 前端 | 8h | P0 |
| 图表类型切换功能 | 前端 | 4h | P0 |
| 颜色方案选择功能 | 前端 | 4h | P0 |
| 后端图表更新API | 后端 | 4h | P0 |

### Sprint 2（第2周）

| 任务 | 负责模块 | 预估工时 | 优先级 |
|------|----------|----------|--------|
| 标题编辑功能 | 前端 | 4h | P0 |
| 撤销/重做功能 | 前端 | 8h | P1 |
| 实时预览优化 | 前端 | 4h | P1 |
| 编辑器集成到报告页面 | 前端 | 4h | P0 |
| 测试和修复 | 全栈 | 8h | P0 |

## 8.3 成功指标

### 业务指标

| 指标 | 当前基线 | V3.1目标 | V4.0目标 |
|------|----------|----------|----------|
| 用户报告生成次数/周 | - | +20% | +50% |
| 图表修改使用率 | 0% | 30% | 60% |
| 用户满意度 | - | 4.0/5 | 4.5/5 |

### 技术指标

| 指标 | 当前基线 | V3.1目标 | V4.0目标 |
|------|----------|----------|----------|
| 单元测试覆盖率 | <5% | 20% | 60% |
| API响应时间P95 | ~2s | <1.5s | <1s |
| 前端首屏加载 | ~3s | <2s | <1s |

## 8.4 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 图表编辑器复杂度超预期 | 中 | 高 | 先做MVP，迭代完善 |
| UI迁移影响现有功能 | 中 | 中 | 分阶段迁移，充分测试 |
| AI服务不稳定 | 低 | 高 | 增加重试和降级机制 |
| 模板系统设计不合理 | 中 | 中 | 先与用户验证需求 |

---

# 附录

## A. 术语表

| 术语 | 定义 |
|------|------|
| 分析模板 | 预定义的Sheet-Prompt映射配置 |
| 报告模板 | 预定义的报告结构和格式 |
| Sheet配置 | 单个Sheet的分析规则 |
| Prompt | 发送给AI的分析指令 |

## B. 参考文档

- [Arco Design Vue 官方文档](https://arco.design/vue)
- [ECharts 配置手册](https://echarts.apache.org/zh/option.html)
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [项目现有文档](./docs/)

## C. 修订历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024-12-26 | 初稿，基于项目现状分析 | AI Assistant |

---

*本文档基于 operation-data-analysis V3.0 项目现状，结合第一性原理分析，提出了详细的产品需求和升级改版方案。*
