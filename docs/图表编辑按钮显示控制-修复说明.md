# 图表编辑按钮显示控制 - 修复说明

## 问题描述
在查看报告的普通模式下，点击"查看图表详情"打开图表抽屉时，也会显示"编辑图表"按钮。这个按钮应该只在AI编辑模式下才显示。

## 问题原因
ChartDrawer组件中的悬浮式"编辑图表"按钮是无条件显示的，没有根据当前模式（普通查看 vs AI编辑）来控制显示。

## 解决方案

### 1. ChartDrawer组件 - 添加显示控制prop
**文件**: `frontend/src/views/Operation/components/ChartDrawer.vue`

添加`showEditButton` prop来控制编辑按钮的显示：

```typescript
interface Props {
  modelValue: boolean
  htmlContent?: string
  title?: string
  showEditButton?: boolean  // 是否显示编辑按钮，默认false
}

const props = withDefaults(defineProps<Props>(), {
  modelValue: false,
  htmlContent: '',
  title: '图表详情',
  showEditButton: false  // 默认不显示编辑按钮
})
```

在模板中添加条件渲染：

```vue
<!-- 悬浮式编辑按钮 - 只在AI编辑模式下显示 -->
<div v-if="showEditButton" class="chart-edit-overlay" @click="handleEditChart">
  <div class="edit-button">
    <el-icon><Edit /></el-icon>
    <span>编辑图表</span>
  </div>
</div>
```

### 2. ReportDisplay组件 - 传递模式标识
**文件**: `frontend/src/views/Operation/components/ReportDisplay.vue`

添加`isDialogMode` prop并传递给ChartDrawer：

```typescript
interface Props {
  report: SheetReportDetail | null
  loading?: boolean
  isCustomBatch?: boolean  // 是否为定制化批量分析
  isDialogMode?: boolean  // 是否在AI对话模式下
}
```

```vue
<ChartDrawer
  v-if="report"
  v-model="showChartDrawer"
  :html-content="report.report_content?.html_charts"
  :title="report.sheet_name || '图表详情'"
  :show-edit-button="isDialogMode"
  @close="handleChartDrawerClose"
  @edit-chart="handleEditChart"
/>
```

### 3. DataAnalysis.vue - 根据对话面板状态控制
**文件**: `frontend/src/views/Operation/DataAnalysis.vue`

使用`showDialogPanel`状态来控制编辑按钮显示：

```vue
<ChartDrawer
  v-model="showChartDrawer"
  :html-content="reportContent?.html_charts"
  title="图表详情"
  :show-edit-button="showDialogPanel"
  @close="handleChartDrawerClose"
  @edit-chart="handleEditChartFromDrawer"
/>
```

### 4. BatchAnalysis.vue - 传递对话模式标识
**文件**: `frontend/src/views/Operation/BatchAnalysis.vue`

在AI对话模式下传递`is-dialog-mode="true"`：

```vue
<!-- AI对话模式 -->
<ReportDisplay
  :report="currentReportDetail"
  :loading="isLoadingReport"
  :is-dialog-mode="true"
  @edit-chart="handleEditChartFromReport"
/>

<!-- 普通模式 -->
<ReportDisplay
  v-else
  :report="currentReportDetail"
  :loading="isLoadingReport"
  :is-dialog-mode="false"
  @edit-chart="handleEditChartFromReport"
/>
```

### 5. CustomBatchAnalysis.vue - 传递对话模式标识
**文件**: `frontend/src/views/Operation/CustomBatchAnalysis.vue`

同样在AI对话模式下传递`is-dialog-mode="true"`：

```vue
<!-- AI对话模式 -->
<ReportDisplay
  :report="currentReportDetail"
  :loading="isLoadingReport"
  :is-custom-batch="true"
  :is-dialog-mode="true"
  @edit-chart="handleEditChartFromReport"
/>

<!-- 普通模式 -->
<ReportDisplay
  v-else
  :report="currentReportDetail"
  :loading="isLoadingReport"
  :is-custom-batch="true"
  :is-dialog-mode="false"
  @edit-chart="handleEditChartFromReport"
/>
```

## 修改的文件
1. ✅ `frontend/src/views/Operation/components/ChartDrawer.vue` - 添加showEditButton prop
2. ✅ `frontend/src/views/Operation/components/ReportDisplay.vue` - 添加isDialogMode prop
3. ✅ `frontend/src/views/Operation/DataAnalysis.vue` - 根据showDialogPanel控制
4. ✅ `frontend/src/views/Operation/BatchAnalysis.vue` - 传递is-dialog-mode
5. ✅ `frontend/src/views/Operation/CustomBatchAnalysis.vue` - 传递is-dialog-mode

## 显示逻辑

### 编辑按钮显示条件
- ✅ **单文件分析 - AI编辑模式**: 显示（showDialogPanel = true）
- ❌ **单文件分析 - 普通查看**: 不显示（showDialogPanel = false）
- ✅ **批量分析 - AI编辑模式**: 显示（isDialogMode = true）
- ❌ **批量分析 - 普通查看**: 不显示（isDialogMode = false）
- ✅ **定制批量分析 - AI编辑模式**: 显示（isDialogMode = true）
- ❌ **定制批量分析 - 普通查看**: 不显示（isDialogMode = false）

## 测试验证

### 单文件分析
1. 上传文件并生成报告
2. 在普通模式下点击"查看图表详情" → 不应显示"编辑图表"按钮 ✓
3. 点击"AI编辑"进入对话模式
4. 在对话模式下点击"查看图表详情" → 应显示"编辑图表"按钮 ✓

### 批量分析
1. 上传Excel文件并生成批量报告
2. 在普通模式下点击某个Sheet的"查看图表详情" → 不应显示"编辑图表"按钮 ✓
3. 点击某个Sheet的"AI编辑"进入对话模式
4. 在对话模式下点击"查看图表详情" → 应显示"编辑图表"按钮 ✓

### 定制批量分析
1. 上传Excel文件并生成定制批量报告
2. 在普通模式下点击某个Sheet的"查看图表详情" → 不应显示"编辑图表"按钮 ✓
3. 点击某个Sheet的"AI编辑"进入对话模式
4. 在对话模式下点击"查看图表详情" → 应显示"编辑图表"按钮 ✓

## 完成时间
2025-12-26
