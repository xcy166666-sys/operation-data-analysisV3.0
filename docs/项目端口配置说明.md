# 项目端口配置说明

## 一、Docker Compose 端口映射

### 1. PostgreSQL 数据库
- **容器内部端口**: 5432
- **宿主机映射端口**: 22800
- **访问地址**: `localhost:22800`
- **说明**: 开发环境暴露端口，生产环境可注释（使用22000~22999区间后半段）

### 2. Redis 缓存
- **容器内部端口**: 6379
- **宿主机映射端口**: 22801
- **访问地址**: `localhost:22801`
- **说明**: 开发环境暴露端口，生产环境可注释（使用22000~22999区间后半段）

### 3. FastAPI 后端服务
- **容器内部端口**: 8000
- **宿主机映射端口**: 21800
- **访问地址**: `http://localhost:21800`
- **API基础路径**: `http://localhost:21800/api/v1`
- **说明**: 后端端口使用21000~21999区间后半段
- **健康检查**: `http://localhost:21800/health`

### 4. Vue 前端服务
- **容器内部端口**: 80 (Nginx)
- **宿主机映射端口**: 20800
- **访问地址**: `http://localhost:20800`
- **说明**: 前端端口使用20000~20999区间后半段
- **开发模式端口**: 5173 (Vite开发服务器，仅在开发时使用)

### 5. Nginx 反向代理（可选）
- **HTTP端口**: 80
- **HTTPS端口**: 443
- **访问地址**: 
  - HTTP: `http://localhost`
  - HTTPS: `https://localhost`
- **说明**: 用于生产环境，统一代理前端和后端服务

---

## 二、容器内部服务通信

### 服务间通信（使用Docker网络）
- **后端访问数据库**: `postgres:5432`
- **后端访问Redis**: `redis:6379`
- **前端访问后端**: `backend:8000` (通过Vite代理 `/api` 路径)
- **Nginx代理后端**: `backend:8000`
- **Nginx代理前端**: `frontend:80`

---

## 三、端口分配规则

### 端口区间划分
- **20000-20999**: 前端服务端口区间
  - 前端: 20800
- **21000-21999**: 后端服务端口区间
  - 后端: 21800
- **22000-22999**: 数据存储服务端口区间
  - PostgreSQL: 22800
  - Redis: 22801

---

## 四、环境变量配置

### 前端环境变量
- **VITE_API_BASE_URL**: API基础URL（默认: `/api/v1`）
- **VITE_API_URL**: 开发环境API地址（默认: `http://backend:8000`）

### 后端环境变量
- **DATABASE_URL**: 数据库连接URL（格式: `postgresql://user:password@postgres:5432/dbname`）
- **REDIS_URL**: Redis连接URL（格式: `redis://redis:6379/0`）

---

## 五、访问地址汇总

### 开发环境
| 服务 | 访问地址 | 说明 |
|------|---------|------|
| 前端 | http://localhost:20800 | 用户界面 |
| 后端API | http://localhost:21800/api/v1 | API接口 |
| 后端健康检查 | http://localhost:21800/health | 健康检查 |
| PostgreSQL | localhost:22800 | 数据库（开发调试用） |
| Redis | localhost:22801 | 缓存（开发调试用） |

### 生产环境（使用Nginx）
| 服务 | 访问地址 | 说明 |
|------|---------|------|
| 前端 | http://localhost | 通过Nginx代理 |
| 后端API | http://localhost/api/v1 | 通过Nginx代理 |
| HTTPS | https://localhost | 如果配置了SSL证书 |

---

## 六、端口修改说明

### 修改端口映射
如需修改端口，请编辑 `docker-compose.yml` 文件中的 `ports` 配置：

```yaml
services:
  backend:
    ports:
      - "新端口:8000"  # 修改宿主机端口
```

### 修改后需要执行
1. 停止容器: `docker-compose down`
2. 重新启动: `docker-compose up -d`
3. 更新前端API配置（如需要）

---

## 七、防火墙配置

如果服务器开启了防火墙，需要开放以下端口：
- **20800**: 前端访问
- **21800**: 后端API访问
- **22800**: PostgreSQL（仅开发环境）
- **22801**: Redis（仅开发环境）
- **80**: HTTP（生产环境）
- **443**: HTTPS（生产环境）

---

## 八、注意事项

1. **生产环境建议**:
   - 关闭PostgreSQL和Redis的外部端口映射
   - 使用Nginx反向代理统一管理端口
   - 配置SSL证书启用HTTPS

2. **开发环境**:
   - 保持所有端口映射以便调试
   - 前端开发时可以使用Vite的5173端口进行热重载

3. **端口冲突**:
   - 如果端口被占用，请修改docker-compose.yml中的映射端口
   - 确保修改后的端口在对应区间内

---

## 九、快速检查端口占用

### Windows
```powershell
netstat -ano | findstr :20800
netstat -ano | findstr :21800
netstat -ano | findstr :22800
netstat -ano | findstr :22801
```

### Linux/Mac
```bash
lsof -i :20800
lsof -i :21800
lsof -i :22800
lsof -i :22801
```

---

## 十、服务启动顺序

1. PostgreSQL (postgres)
2. Redis (redis)
3. Backend (backend) - 依赖postgres和redis
4. Frontend (frontend) - 依赖backend
5. Nginx (nginx) - 依赖backend和frontend（可选）

---

**文档生成时间**: 2025-12-02
**项目名称**: 运营数据分析系统
**版本**: 1.0


