# 报告版本历史功能 - 部署与测试指南

## 实施完成时间
2025-12-22

---

## 功能概述

会话版本历史管理功能已完成开发，本文档提供完整的部署和测试指南。

---

## 已修复的问题 ✅

### 1. HTML结构修复 ✅
**文件**: `frontend/src/views/Operation/components/HistorySidebar.vue`

**修复内容**:
- 将版本面板移到 `v-for` 循环内部
- 使用 `<template>` 包裹会话项和版本面板
- 确保版本面板正确关联到对应的会话

### 2. 模型导入修复 ✅
**文件**: `backend/app/models/__init__.py`

**修复内容**:
- 在 `__all__` 中添加 `AnalysisSessionVersion`
- 确保模型可以被正确导入

---

## 部署步骤

### 步骤1：运行数据库迁移 🗄️

```bash
# 进入后端容器
docker-compose exec backend bash

# 查看当前迁移状态
alembic current

# 运行迁移（创建版本表）
alembic upgrade head

# 验证迁移成功
alembic current
```

**预期输出**:
```
INFO  [alembic.runtime.migration] Running upgrade -> add_session_versions
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
```

### 步骤2：重启后端服务 🔄

```bash
# 退出容器
exit

# 重启后端容器
docker-compose restart backend

# 查看日志确认启动成功
docker-compose logs -f backend
```

**预期输出**:
```
backend_1  | INFO:     Application startup complete.
backend_1  | INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 步骤3：重新编译前端 🎨

```bash
# 进入前端目录
cd frontend

# 安装依赖（如果需要）
npm install

# 编译前端
npm run build

# 或者在开发模式下运行
npm run dev
```

### 步骤4：刷新浏览器 🌐

- 清除浏览器缓存（Ctrl+Shift+Delete）
- 硬刷新页面（Ctrl+F5）
- 或者使用无痕模式打开

---

## 功能测试

### 测试前准备

1. **确保有测试数据**
   - 至少有1个已完成的会话
   - 会话中有生成的报告

2. **登录系统**
   - 使用测试账号登录
   - 进入数据分析页面

### 测试用例1：展开版本列表 ✅

**操作步骤**:
1. 在左侧历史会话列表中找到一个会话
2. 点击会话右侧的"文档"图标按钮
3. 观察版本列表是否展开

**预期结果**:
- ✅ 版本列表在会话下方展开
- ✅ 显示"正在加载版本..."提示
- ✅ 加载完成后显示版本列表或"暂无版本"

**可能的问题**:
- ❌ 点击后没有反应 → 检查浏览器控制台是否有错误
- ❌ 显示"暂无版本" → 这是正常的，需要先保存版本

### 测试用例2：保存第一个版本 ✅

由于当前系统可能还没有自动保存版本的功能，我们需要手动触发保存。

**方法1：通过浏览器控制台手动保存**

```javascript
// 打开浏览器控制台（F12）
// 执行以下代码（替换sessionId为实际的会话ID）

const sessionId = 66; // 替换为你的会话ID

// 获取当前报告内容
const reportContent = {
  summary: "初始版本",
  report_text: "这是测试报告的文字内容",
  report_html_charts: "<div>测试图表</div>",
  report_charts_json: []
};

// 调用API保存版本
fetch(`/api/v1/operation/sessions/${sessionId}/versions`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify(reportContent)
})
.then(res => res.json())
.then(data => console.log('版本保存成功:', data))
.catch(err => console.error('保存失败:', err));
```

**方法2：通过后端直接插入测试数据**

```bash
# 进入后端容器
docker-compose exec backend bash

# 进入Python shell
python

# 执行以下代码
from app.core.database import SessionLocal
from app.models.session_version import AnalysisSessionVersion
from datetime import datetime

db = SessionLocal()

# 创建测试版本（替换session_id为实际的会话ID）
version = AnalysisSessionVersion(
    session_id=66,  # 替换为实际的会话ID
    version_no=1,
    summary="初始版本",
    report_text="这是测试报告的文字内容",
    report_html_charts="<div>测试图表</div>",
    report_charts_json=[],
    created_at=datetime.utcnow(),
    created_by=1  # 替换为实际的用户ID
)

db.add(version)
db.commit()
print(f"版本已创建: ID={version.id}")

db.close()
exit()
```

### 测试用例3：查看版本列表 ✅

**操作步骤**:
1. 保存版本后，再次点击会话的"文档"图标
2. 观察版本列表内容

**预期结果**:
- ✅ 显示版本号（V1）
- ✅ 显示创建时间（如"今天"、"昨天"）
- ✅ 显示版本摘要（如果有）
- ✅ 当前版本有绿色"当前"标签

### 测试用例4：切换版本 ✅

**操作步骤**:
1. 在版本列表中点击某个版本
2. 观察右侧报告区域的变化

**预期结果**:
- ✅ 显示成功提示："已切换到版本 V1"
- ✅ 右侧报告内容更新为该版本的内容
- ✅ 图表（如果有）正确显示

**可能的问题**:
- ❌ 点击后报告没有更新 → 检查 `handleVersionSelected` 是否被正确调用
- ❌ 图表显示错误 → 检查版本数据中的 `report_charts_json` 格式

### 测试用例5：折叠版本列表 ✅

**操作步骤**:
1. 版本列表展开后，再次点击"文档"图标
2. 观察版本列表是否折叠

**预期结果**:
- ✅ 版本列表平滑折叠
- ✅ 不会重新请求API

### 测试用例6：多个会话的版本管理 ✅

**操作步骤**:
1. 展开会话A的版本列表
2. 展开会话B的版本列表
3. 观察两个版本列表的状态

**预期结果**:
- ✅ 会话A的版本列表自动折叠
- ✅ 会话B的版本列表正确展开
- ✅ 两个会话的版本不会混淆

---

## 调试技巧

### 1. 查看浏览器控制台

打开浏览器开发者工具（F12），查看：
- **Console** - 查看JavaScript错误和日志
- **Network** - 查看API请求和响应
- **Vue DevTools** - 查看组件状态

### 2. 查看后端日志

```bash
# 实时查看后端日志
docker-compose logs -f backend

# 查看最近100行日志
docker-compose logs --tail=100 backend
```

### 3. 检查数据库

```bash
# 进入数据库容器
docker-compose exec postgres psql -U postgres -d operation_analysis

# 查看版本表
SELECT * FROM analysis_session_versions;

# 查看某个会话的所有版本
SELECT * FROM analysis_session_versions WHERE session_id = 66;

# 退出
\q
```

### 4. 常见错误排查

#### 错误1：点击展开按钮没有反应

**可能原因**:
- JavaScript错误
- API请求失败
- 权限问题

**排查方法**:
```javascript
// 在浏览器控制台执行
console.log('expandedSessionId:', expandedSessionId.value)
console.log('versionsMap:', versionsMap.value)
console.log('versionsLoading:', versionsLoading.value)
```

#### 错误2：版本列表显示"暂无版本"

**可能原因**:
- 确实没有保存过版本
- API返回空数组
- 数据库查询失败

**排查方法**:
```bash
# 检查数据库
docker-compose exec postgres psql -U postgres -d operation_analysis
SELECT COUNT(*) FROM analysis_session_versions WHERE session_id = 66;
```

#### 错误3：切换版本后报告没有更新

**可能原因**:
- `handleVersionSelected` 没有被调用
- `operationStore.setReportContent` 失败
- 数据格式不正确

**排查方法**:
```javascript
// 在 DataAnalysis.vue 的 handleVersionSelected 中添加日志
console.log('[DataAnalysis] 版本数据:', version)
console.log('[DataAnalysis] 新内容:', newContent)
```

---

## 性能优化建议

### 1. 版本列表缓存

当前实现已经支持缓存，但可以进一步优化：

```typescript
// 添加缓存过期时间
const versionsCacheTime = ref<Record<number, number>>({})
const CACHE_DURATION = 5 * 60 * 1000 // 5分钟

const loadVersions = async (sessionId: number) => {
  const now = Date.now()
  const cacheTime = versionsCacheTime.value[sessionId]
  
  // 如果缓存未过期，直接返回
  if (cacheTime && now - cacheTime < CACHE_DURATION) {
    return
  }
  
  // 加载版本...
  versionsCacheTime.value[sessionId] = now
}
```

### 2. 懒加载优化

只在用户展开时才加载版本列表（当前已实现）

### 3. 分页加载

如果版本数量很多，可以考虑分页：

```typescript
const loadVersions = async (sessionId: number, page = 1, pageSize = 10) => {
  const res = await getSessionVersions(sessionId, { page, pageSize })
  // ...
}
```

---

## 后续开发建议

### 短期（本周内）

1. **自动保存版本** ⭐⭐⭐
   - 在报告生成完成时自动保存第一个版本
   - 在AI修改报告后自动保存新版本

2. **版本对比** ⭐⭐
   - 支持选择两个版本进行对比
   - 高亮显示差异部分

3. **版本回滚** ⭐⭐⭐
   - 添加"回滚到此版本"按钮
   - 回滚后自动保存新版本

### 中期（本月内）

1. **版本命名** ⭐
   - 允许用户编辑版本摘要
   - 支持版本标签（初稿、终稿等）

2. **版本删除** ⭐
   - 支持删除旧版本
   - 保护当前版本不被删除

3. **版本导出** ⭐⭐
   - 支持导出特定版本的报告
   - 支持批量导出多个版本

### 长期（下个月）

1. **版本分支** ⭐⭐
   - 支持从某个版本创建分支
   - 支持分支合并

2. **协作版本** ⭐⭐⭐
   - 支持多人协作编辑
   - 显示版本创建者

3. **版本权限** ⭐
   - 支持版本级别的权限控制
   - 支持版本锁定

---

## 总结

### 已完成 ✅

1. ✅ 数据库表和模型
2. ✅ 后端API接口（3个）
3. ✅ 前端API封装
4. ✅ HistorySidebar组件
5. ✅ DataAnalysis版本切换
6. ✅ HTML结构修复
7. ✅ 模型导入修复

### 待完成 ⏳

1. ⏳ 运行数据库迁移
2. ⏳ 自动保存版本功能
3. ⏳ 版本回滚功能
4. ⏳ 版本对比功能

### 下一步行动 🎯

1. **立即执行**: 运行数据库迁移
2. **今天完成**: 测试所有功能
3. **本周完成**: 实现自动保存版本
4. **下周完成**: 实现版本回滚和对比

---

## 相关文档

- [问题诊断与修复](./报告版本历史功能-问题诊断与修复.md)
- [数据库模型](../backend/app/models/session_version.py)
- [API接口](../backend/app/api/v1/operation.py)
- [前端组件](../frontend/src/views/Operation/components/HistorySidebar.vue)

---

**祝测试顺利！如有问题，请查看调试技巧部分或联系开发团队。** 🚀
