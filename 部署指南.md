# 运营数据分析系统 - 部署指南

## 目录

1. [环境要求](#环境要求)
2. [快速部署](#快速部署)
3. [配置说明](#配置说明)
4. [数据库初始化](#数据库初始化)
5. [生产环境部署](#生产环境部署)
6. [故障排查](#故障排查)

## 环境要求

### 必需软件

- **Docker**: 20.10 或更高版本
- **Docker Compose**: 2.0 或更高版本

### 系统要求

- **CPU**: 2核心或以上
- **内存**: 4GB或以上
- **磁盘**: 20GB或以上可用空间

## 快速部署

### 1. 获取代码

```bash
git clone <repository-url>
cd operation-data-analysis
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量（必须修改以下配置）
vim .env
```

**必须修改的配置项：**

```env
# 数据库密码（必须修改）
POSTGRES_PASSWORD=your_secure_password_here

# JWT密钥（必须修改，建议使用随机字符串）
JWT_SECRET=your_random_jwt_secret_key_here

# Dify API密钥（如果使用Dify）
DIFY_API_KEY=your_dify_api_key_here
```

### 3. 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 初始化数据库

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行数据库迁移
alembic upgrade head

# 创建初始管理员用户（可选）
python scripts/create_admin.py
```

### 5. 访问系统

- **前端界面**: http://localhost:80
- **后端API**: http://localhost:8000
- **API文档**: http://localhost:8000/docs

## 配置说明

### 环境变量详解

#### 应用配置

```env
APP_NAME=运营数据分析系统          # 应用名称
APP_VERSION=1.0.0                  # 应用版本
DEBUG=false                        # 调试模式（生产环境设为false）
DEPLOYMENT_MODE=production         # 部署模式
```

#### 数据库配置

```env
POSTGRES_USER=postgres             # PostgreSQL用户名
POSTGRES_PASSWORD=your_password    # PostgreSQL密码（必须修改）
POSTGRES_DB=operation_analysis     # 数据库名称
```

#### Redis配置

```env
REDIS_URL=redis://redis:6379/0     # Redis连接URL
```

#### JWT配置

```env
JWT_SECRET=your_secret_key         # JWT密钥（必须修改）
JWT_ALGORITHM=HS256                # JWT算法
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=1440  # Token过期时间（分钟）
```

#### Dify配置

```env
DIFY_API_KEY=your_api_key          # Dify API密钥
DIFY_API_URL=https://api.dify.ai/v1  # Dify API地址
```

#### CORS配置

```env
CORS_ORIGINS=http://localhost:80   # 允许的跨域来源（多个用逗号分隔）
```

## 数据库初始化

### 自动迁移

系统启动后会自动运行数据库迁移，创建必要的表结构。

### 手动迁移

如果需要手动执行迁移：

```bash
docker-compose exec backend alembic upgrade head
```

### 创建初始用户

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行创建用户脚本
python scripts/create_admin.py

# 按提示输入用户名和密码
```

## 生产环境部署

### 1. 安全配置

#### 修改默认密码

确保所有默认密码都已修改：

```env
POSTGRES_PASSWORD=<强密码>
JWT_SECRET=<随机字符串>
```

#### 禁用调试模式

```env
DEBUG=false
```

#### 配置HTTPS

在 `nginx/conf.d/default.conf` 中添加SSL配置：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # ... 其他配置
}
```

### 2. 数据持久化

确保Docker volumes已正确配置，数据会持久化到本地：

```yaml
volumes:
  postgres_data:    # 数据库数据
  redis_data:      # Redis数据
  backend_uploads: # 上传文件
```

### 3. 备份策略

#### 数据库备份

```bash
# 创建备份
docker-compose exec postgres pg_dump -U postgres operation_analysis > backup_$(date +%Y%m%d).sql

# 恢复备份
docker-compose exec -T postgres psql -U postgres operation_analysis < backup_20240101.sql
```

#### 文件备份

```bash
# 备份上传文件
docker run --rm -v operation-data-analysis_backend_uploads:/data -v $(pwd):/backup alpine tar czf /backup/uploads_backup.tar.gz /data
```

### 4. 监控和日志

#### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f nginx
```

#### 日志位置

- **后端日志**: `/var/log/operation-analysis/app.log`（容器内）
- **Nginx日志**: `/var/log/nginx/`（容器内）

## 故障排查

### 1. 服务无法启动

**检查Docker服务状态：**

```bash
docker-compose ps
```

**查看错误日志：**

```bash
docker-compose logs backend
docker-compose logs frontend
```

**常见问题：**

- 端口被占用：修改 `docker-compose.yml` 中的端口映射
- 环境变量未配置：检查 `.env` 文件是否存在且配置正确
- 数据库连接失败：检查 `POSTGRES_PASSWORD` 是否正确

### 2. 数据库连接失败

**检查PostgreSQL容器：**

```bash
docker-compose exec postgres psql -U postgres -c "SELECT version();"
```

**检查环境变量：**

```bash
docker-compose exec backend env | grep DATABASE_URL
```

### 3. Dify工作流执行失败

**检查Dify配置：**

1. 登录系统，进入"配置工作流"
2. 确认API地址、API Key和工作流ID是否正确
3. 查看后端日志获取详细错误信息

**常见错误：**

- `401 Unauthorized`: API Key错误
- `404 Not Found`: 工作流ID不存在
- `500 Internal Server Error`: Dify服务异常

### 4. 文件上传失败

**检查文件大小限制：**

- 单文件分析：最大10MB
- 批量分析：最大20MB

**检查上传目录权限：**

```bash
docker-compose exec backend ls -la /app/uploads
```

### 5. 前端无法访问后端API

**检查Nginx配置：**

```bash
docker-compose exec nginx nginx -t
```

**检查API代理：**

访问 http://localhost/api/v1/health 查看是否正常响应。

## 性能优化

### 1. 数据库优化

```sql
-- 创建索引（如果需要）
CREATE INDEX idx_conversation_user_id ON conversations(user_id);
CREATE INDEX idx_conversation_function_key ON conversations(function_key);
```

### 2. Redis缓存

确保Redis正常运行，用于会话管理和缓存。

### 3. Nginx优化

调整 `nginx/nginx.conf` 中的worker进程数和连接数。

## 更新升级

### 1. 备份数据

```bash
# 备份数据库
docker-compose exec postgres pg_dump -U postgres operation_analysis > backup.sql
```

### 2. 更新代码

```bash
git pull origin main
```

### 3. 重建镜像

```bash
docker-compose build
docker-compose up -d
```

### 4. 运行迁移

```bash
docker-compose exec backend alembic upgrade head
```

## 卸载

```bash
# 停止并删除容器
docker-compose down

# 删除数据卷（谨慎操作，会删除所有数据）
docker-compose down -v
```

## 技术支持

如遇到问题，请：

1. 查看日志文件
2. 检查环境变量配置
3. 查看本文档的故障排查部分
4. 提交Issue到项目仓库

