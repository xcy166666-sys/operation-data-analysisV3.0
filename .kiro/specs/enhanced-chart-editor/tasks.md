# 实施计划：增强图表编辑器

## 概述

本实施计划将增强图表编辑器分解为离散的、增量的任务。该方法首先优先考虑核心解析和渲染功能，然后添加编辑功能，最后集成AI辅助。每个任务都建立在之前的工作基础上，并通过测试进行验证。

## 任务

- [x] 1. 设置项目结构和核心工具
  - 为图表编辑器组件创建目录结构
  - 为ECharts配置设置TypeScript类型
  - 配置fast-check用于基于属性的测试
  - 使用Vitest设置测试基础设施
  - _需求：全部（基础）_

- [x] 2. 实现HTML图表解析器
  - [x] 2.1 创建带有HTML解析逻辑的ChartParser类
    - 解析HTML文档并提取嵌入的JavaScript
    - 从script标签中提取ECharts选项对象
    - 处理多种script标签格式和变体
    - _需求：1.1_

  - [ ]* 2.2 编写HTML解析往返的属性测试
    - **属性1：HTML解析往返**
    - **验证：需求1.1, 9.1**

  - [x] 2.3 实现从HTML和CSS提取主题
    - 解析内联样式和style标签
    - 提取背景颜色、文本颜色、网格颜色
    - 识别自定义字体和CSS类
    - _需求：1.2_

  - [ ]* 2.4 编写主题保留的属性测试
    - **属性2：主题保留**
    - **验证：需求1.2, 3.1**

  - [x] 2.5 实现系列识别和提取
    - 从ECharts配置中解析系列数组
    - 提取系列属性（名称、类型、颜色、数据）
    - 处理嵌套的系列配置
    - _需求：1.3_

  - [ ]* 2.6 编写系列识别完整性的属性测试
    - **属性3：系列识别完整性**
    - **验证：需求1.3, 2.1**

  - [x] 2.7 添加颜色调色板提取
    - 从配置中提取颜色数组
    - 处理顶级和系列级颜色
    - 支持渐变颜色对象
    - _需求：1.4_

  - [ ]* 2.8 编写颜色调色板提取的属性测试
    - **属性4：颜色调色板提取**
    - **验证：需求1.4**

  - [x] 2.9 实现无效HTML的错误处理
    - 在解析前验证HTML结构
    - 提供描述性错误消息
    - 优雅地处理格式错误的JSON
    - _需求：1.5_

  - [ ]* 2.10 编写错误处理的属性测试
    - **属性5：无效输入的错误处理**
    - **验证：需求1.5**

- [x] 3. 检查点 - 确保解析测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [-] 4. 实现图表渲染器
  - [x] 4.1 创建ChartRenderer类
    - 初始化ECharts实例
    - 处理容器大小和响应式
    - 实现带错误处理的渲染方法
    - _需求：7.1, 7.5_

  - [ ]* 4.2 编写渲染性能的属性测试
    - **属性14：实时更新性能**
    - **验证：需求4.5, 7.1**

  - [x] 4.3 添加实时预览更新
    - 实现配置更改时的响应式渲染
    - 添加状态之间的平滑过渡
    - 优化重新渲染性能
    - _需求：7.1, 7.2_

  - [ ]* 4.4 编写渲染失败恢复的属性测试
    - **属性24：渲染失败恢复**
    - **验证：需求7.5**

  - [ ] 4.5 实现从配置生成HTML
    - 生成完整的HTML5文档
    - 嵌入ECharts配置
    - 包含主题样式
    - _需求：9.1_

  - [ ]* 4.6 编写HTML生成的单元测试
    - 测试各种图表类型
    - 测试主题嵌入
    - 测试边缘情况（空系列、特殊字符）
    - _需求：9.1_

- [ ] 5. 实现修改引擎
  - [ ] 5.1 创建ModificationEngine类
    - 实现修改路由逻辑
    - 添加本地修改处理器
    - 设置撤销/重做堆栈管理
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5_

  - [ ]* 5.2 编写撤销-重做往返的属性测试
    - **属性21：撤销-重做往返**
    - **验证：需求8.2, 8.3**

  - [ ]* 5.3 编写重做堆栈清除的属性测试
    - **属性22：重做堆栈清除**
    - **验证：需求8.4**

  - [ ]* 5.4 编写撤销历史容量的属性测试
    - **属性23：撤销历史容量**
    - **验证：需求8.5**

  - [ ] 5.5 实现系列修改处理器
    - 添加颜色修改
    - 添加可见性切换
    - 添加线条样式修改
    - 确保系列隔离
    - _需求：2.2, 2.3, 2.4, 4.4_

  - [ ]* 5.6 编写系列隔离的属性测试
    - **属性6：系列隔离**
    - **验证：需求2.3**

  - [ ]* 5.7 编写切换幂等性的属性测试
    - **属性7：切换幂等性**
    - **验证：需求2.4, 5.1**

  - [ ]* 5.8 编写线条样式应用的属性测试
    - **属性13：线条样式应用**
    - **验证：需求4.4**

- [ ] 6. 检查点 - 确保修改引擎测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 7. 实现主题管理
  - [ ] 7.1 创建主题编辑器逻辑
    - 实现主题属性修改
    - 添加预设主题库
    - 实现主题保存/加载功能
    - _需求：3.1, 3.2, 3.3, 3.5_

  - [ ]* 7.2 编写主题应用完整性的属性测试
    - **属性9：主题应用完整性**
    - **验证：需求3.2**

  - [ ]* 7.3 编写预设主题应用的属性测试
    - **属性10：预设主题应用**
    - **验证：需求3.3**

  - [ ]* 7.4 编写主题持久性的属性测试
    - **属性12：主题持久性**
    - **验证：需求3.5**

  - [ ] 7.5 实现深色模式对比度验证
    - 计算对比度比率
    - 根据WCAG标准验证
    - 如需要自动调整颜色
    - _需求：3.4_

  - [ ]* 7.6 编写深色模式对比度的属性测试
    - **属性11：深色模式对比度**
    - **验证：需求3.4**

- [ ] 8. 实现数据显示配置
  - [ ] 8.1 添加标签格式化逻辑
    - 支持小数格式化
    - 支持百分比格式化
    - 支持自定义格式字符串
    - _需求：5.2_

  - [ ]* 8.2 编写标签格式应用的属性测试
    - **属性15：标签格式应用**
    - **验证：需求5.2**

  - [ ] 8.3 添加坐标轴配置逻辑
    - 实现最小/最大值设置
    - 实现间隔配置
    - 实现标签旋转
    - _需求：5.3_

  - [ ]* 8.4 编写坐标轴配置应用的属性测试
    - **属性16：坐标轴配置应用**
    - **验证：需求5.3**

  - [ ] 8.5 添加图例配置逻辑
    - 实现位置设置
    - 实现方向设置
    - 实现项目样式
    - _需求：5.5_

  - [ ]* 8.6 编写图例配置应用的属性测试
    - **属性17：图例配置应用**
    - **验证：需求5.5**

  - [ ] 8.7 实现系列重新排序
    - 添加拖放或上下移动控件
    - 更新图表显示顺序
    - 更新图例顺序
    - _需求：2.5_

  - [ ]* 8.8 编写系列顺序一致性的属性测试
    - **属性8：系列顺序一致性**
    - **验证：需求2.5**

- [ ] 9. 构建UI组件
  - [ ] 9.1 创建ChartEditorModal组件
    - 实现全屏模态布局
    - 添加带保存/取消按钮的标题
    - 设置三列布局（工具栏、预览、属性）
    - _需求：全部（UI基础）_

  - [ ]* 9.2 编写模态生命周期的单元测试
    - 测试打开/关闭行为
    - 测试保存/取消操作
    - 测试键盘快捷键
    - _需求：全部_

  - [ ] 9.3 创建SeriesEditorPanel组件
    - 显示所有系列的列表
    - 选中时显示系列属性
    - 添加颜色、可见性、样式的控件
    - _需求：2.1, 2.2, 2.3, 2.4_

  - [ ]* 9.4 编写系列编辑器交互的单元测试
    - 测试系列选择
    - 测试属性更新
    - 测试可见性切换
    - _需求：2.1, 2.2, 2.3, 2.4_

  - [ ] 9.5 创建ThemeEditorPanel组件
    - 显示当前主题属性
    - 显示预设主题选项
    - 添加主题颜色的颜色选择器
    - 添加保存自定义主题按钮
    - _需求：3.1, 3.2, 3.3, 3.5_

  - [ ]* 9.6 编写主题编辑器交互的单元测试
    - 测试主题属性更新
    - 测试预设应用
    - 测试自定义主题保存
    - _需求：3.1, 3.2, 3.3, 3.5_

  - [ ] 9.7 创建StyleEditorPanel组件
    - 添加渐变颜色控件
    - 添加阴影控件
    - 添加动画控件
    - 添加线条样式控件
    - _需求：4.1, 4.2, 4.3, 4.4_

  - [ ]* 9.8 编写样式编辑器交互的单元测试
    - 测试渐变配置
    - 测试阴影配置
    - 测试动画配置
    - _需求：4.1, 4.2, 4.3, 4.4_

- [ ] 10. 检查点 - 确保UI组件正确渲染
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 11. 与现有DataAnalysis组件集成
  - [ ] 11.1 向DataAnalysis添加图表点击处理器
    - 检测报告显示中的图表点击
    - 从点击的元素中提取图表HTML
    - 使用图表数据打开ChartEditorModal
    - _需求：全部（集成）_

  - [ ]* 11.2 编写图表编辑工作流的集成测试
    - 测试从报告打开编辑器
    - 测试将更改保存回报告
    - 测试取消而不更改
    - _需求：全部_

  - [ ] 11.3 实现保存处理器
    - 使用修改后的图表更新报告HTML
    - 通过API保存到后端
    - 更新UI以显示新图表
    - _需求：9.1_

  - [ ]* 11.4 编写保存功能的单元测试
    - 测试HTML更新
    - 测试API调用
    - 测试UI刷新
    - _需求：9.1_

- [ ] 12. 实现导出功能
  - [ ] 12.1 添加PNG导出
    - 使用ECharts内置导出
    - 支持自定义分辨率
    - 处理导出错误
    - _需求：9.2_

  - [ ]* 12.2 编写PNG导出的属性测试
    - **属性25：导出格式正确性（PNG）**
    - **验证：需求9.2**

  - [ ] 12.3 添加SVG导出
    - 使用ECharts SVG渲染器
    - 保留所有样式
    - 处理导出错误
    - _需求：9.3_

  - [ ]* 12.4 编写SVG导出的属性测试
    - **属性25：导出格式正确性（SVG）**
    - **验证：需求9.3**

  - [ ] 12.5 添加JSON配置导出
    - 序列化ECharts配置
    - 格式化JSON以提高可读性
    - 添加复制到剪贴板
    - _需求：9.4_

  - [ ]* 12.6 编写配置导出往返的属性测试
    - **属性26：配置导出往返**
    - **验证：需求9.4**

- [ ] 13. 实现AI修改服务（后端）
  - [ ] 13.1 创建ChartModificationService
    - 添加修改验证
    - 添加配置合并逻辑
    - 添加修改历史跟踪
    - _需求：6.1, 6.4, 6.5_

  - [ ]* 13.2 编写修改服务的单元测试
    - 测试验证逻辑
    - 测试配置合并
    - 测试历史跟踪
    - _需求：6.1, 6.4, 6.5_

  - [ ] 13.3 增强AIService以支持图表修改
    - 构建用于图表修改理解的提示
    - 将AI响应解析为结构化更改
    - 处理模糊指令
    - _需求：6.1, 6.4_

  - [ ]* 13.4 编写AI指令理解的属性测试
    - **属性18：AI指令理解**
    - **验证：需求6.1**

  - [ ]* 13.5 编写AI错误处理的属性测试
    - **属性19：AI错误处理**
    - **验证：需求6.4**

  - [ ] 13.6 添加AI修改的API端点
    - 创建POST /api/v1/charts/modify端点
    - 接受图表配置和指令
    - 返回修改后的配置
    - _需求：6.1, 6.2, 6.3_

  - [ ]* 13.7 编写AI修改API的集成测试
    - 测试成功的修改
    - 测试错误处理
    - 测试超时处理
    - _需求：6.1, 6.2, 6.3_

- [ ] 14. 在前端集成AI修改
  - [ ] 14.1 添加AI修改UI
    - 向编辑器添加"AI助手"按钮
    - 创建AI指令输入对话框
    - 在处理期间显示加载指示器
    - 在应用前显示预览
    - _需求：6.2, 6.3_

  - [ ]* 14.2 编写AI UI交互的单元测试
    - 测试对话框打开/关闭
    - 测试指令提交
    - 测试加载状态
    - 测试预览显示
    - _需求：6.2, 6.3_

  - [ ] 14.3 实现AI修改路由
    - 确定何时使用AI与本地处理
    - 将复杂修改路由到AI服务
    - 优雅地处理AI服务错误
    - _需求：6.1, 6.4_

  - [ ]* 14.4 编写修改历史保留的属性测试
    - **属性20：修改历史保留**
    - **验证：需求6.5, 8.1**

- [ ] 15. 检查点 - 确保AI集成端到端工作
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 16. 实现性能优化
  - [ ] 16.1 为大数据集添加数据采样
    - 检测具有>1000个数据点的图表
    - 实现采样算法
    - 使用采样数据进行预览
    - 使用完整数据进行导出
    - _需求：10.3_

  - [ ]* 16.2 编写复杂图表性能的属性测试
    - **属性27：复杂图表性能**
    - **验证：需求10.1, 10.2, 10.3**

  - [ ] 16.3 实现内存管理
    - 监控内存使用
    - 在阈值处清除未使用的预览状态
    - 实现状态压缩
    - _需求：10.4_

  - [ ] 16.4 为非活动标签页添加资源节约
    - 检测标签页可见性更改
    - 非活动时暂停更新
    - 活动时恢复
    - _需求：10.5_

  - [ ]* 16.5 编写资源管理的属性测试
    - **属性28：资源管理**
    - **验证：需求10.4, 10.5**

  - [ ] 16.6 优化渲染管道
    - 批量处理多个配置更改
    - 防抖快速更新
    - 使用requestAnimationFrame实现平滑动画
    - _需求：7.2_

- [ ] 17. 添加全面的错误处理
  - [ ] 17.1 实现错误恢复机制
    - 为渲染错误添加自动恢复
    - 为AI服务失败添加重试逻辑
    - 添加回退到最后有效状态
    - _需求：1.5, 6.4, 7.5_

  - [ ]* 17.2 编写错误恢复的单元测试
    - 测试渲染错误恢复
    - 测试AI服务错误恢复
    - 测试状态恢复
    - _需求：1.5, 6.4, 7.5_

  - [ ] 17.3 添加用户发起的恢复选项
    - 添加"重置为原始"按钮
    - 添加"全部撤销"按钮
    - 添加"重新加载图表"按钮
    - 添加"导出当前状态"按钮
    - _需求：8.2, 9.1_

- [ ] 18. 最终测试和完善
  - [ ]* 18.1 运行完整的基于属性的测试套件
    - 执行所有28个属性测试，每个100次迭代
    - 验证所有属性通过
    - 修复任何失败
    - _需求：全部_

  - [ ]* 18.2 运行集成测试套件
    - 测试完整的编辑工作流
    - 测试错误场景
    - 测试负载下的性能
    - _需求：全部_

  - [ ] 18.3 执行手动测试
    - 使用系统中真实的AI生成图表进行测试
    - 使用复杂的多系列图表进行测试
    - 使用自定义主题进行测试
    - 验证所有UI交互
    - _需求：全部_

  - [ ] 18.4 优化包大小
    - 分析包组成
    - 延迟加载重型组件
    - 树摇未使用的代码
    - _需求：10.1, 10.2_

  - [ ] 18.5 添加用户文档
    - 创建内联帮助工具提示
    - 添加键盘快捷键指南
    - 创建示例工作流
    - _需求：全部_

- [ ] 19. 最终检查点 - 确保所有测试通过且功能完整
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 标记为`*`的任务是可选的，可以跳过以实现更快的MVP
- 每个任务都引用特定需求以实现可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 集成测试验证端到端工作流
- 实施遵循自下而上的方法：工具 → 核心逻辑 → UI → 集成
