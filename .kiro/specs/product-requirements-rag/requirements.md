# 需求文档：RAG增强数据分析平台

## 引言

本文档定义了如何通过RAG（检索增强生成）技术增强现有的运营数据分析系统。RAG将把系统从无状态的分析工具转变为智能平台，能够从每次分析中学习，记住成功模式，并随着时间推移提供越来越准确的洞察。

### 当前系统痛点

1. **每次分析都是从零开始** - 系统不记住之前的分析结果，用户需要重复输入相似的需求
2. **缺乏历史对比** - 无法自动对比当前数据与历史趋势
3. **图表生成不稳定** - 相同类型的数据，每次生成的图表可能不一致
4. **缺少最佳实践** - 系统不知道哪些分析方法和图表类型最有效
5. **无法复用成功案例** - 优秀的分析报告无法被系统学习和复用

### RAG技术带来的价值

RAG技术通过以下方式解决这些问题：

1. **记忆功能** - 自动存储每次分析的关键洞察和成功模式
2. **智能检索** - 根据当前分析需求，自动查找相关的历史分析
3. **上下文增强** - 将历史洞察注入到AI提示词中，提高分析质量
4. **持续学习** - 系统从用户反馈中学习，不断优化分析效果

## 术语表

- **系统**：RAG增强数据分析平台
- **RAG**：检索增强生成（Retrieval-Augmented Generation）- 一种通过从知识库检索相关上下文来增强大语言模型响应的技术
- **向量存储**：存储文档嵌入向量用于语义搜索的数据库
- **知识库**：存储在向量存储中的历史分析、领域知识和最佳实践的集合
- **嵌入向量**：捕获语义含义的文本数值向量表示
- **会话**：用户与系统之间的单次分析对话
- **报告**：系统生成的包含文本分析和可视化的输出
- **图表配置**：定义如何渲染可视化的配置数据
- **用户**：使用系统分析数据的人
- **管理员**：具有管理系统权限的用户
- **工作流**：定义数据如何被分析的已配置AI处理流程

## 需求

### 需求1：自动记忆历史分析（核心功能）

**用户故事：** 作为数据分析师，我希望系统能够记住之前的分析结果，这样在分析相似数据时可以参考历史经验，提高分析质量。

**实际应用场景：**
- 用户上传"11月新用户留存数据"并生成报告后，系统自动存储关键发现（如"新手引导完成率影响7日留存"）
- 下次用户上传"12月新用户留存数据"时，系统自动检索到11月的分析，并在新报告中对比两个月的差异
- 系统记住哪些图表类型（折线图、漏斗图）对留存分析最有效

#### 验收标准

1. 当用户完成分析会话时，系统应自动提取并存储关键洞察到知识库
2. 当存储洞察时，系统应使用阿里云DashScope嵌入API生成嵌入向量
3. 当收到新的分析请求时，系统应从知识库检索相关的历史洞察
4. 系统应支持阿里云DashScope text-embedding-v3模型
5. 当知识库包含相关上下文时，系统应将其包含在分析提示词中
6. 当检索上下文时，系统应按语义相似度分数排序结果
7. 系统应限制检索的上下文以防止token溢出（最大4000 tokens）
8. 系统应存储分析元数据（日期、用户、数据特征、使用的图表类型）

### 需求2：智能历史对比（增强现有功能）

**用户故事：** 作为运营人员，我希望系统能够自动对比当前数据与历史趋势，这样我可以快速发现异常和变化。

**实际应用场景：**
- 用户上传"本周活跃用户数据"，系统自动检索过去4周的相同类型分析
- 报告中自动生成"本周 vs 上周"、"本周 vs 月平均"的对比分析
- 系统自动标注异常指标（如"本周新增用户下降30%，为近8周最低"）
- 图表中自动添加历史基准线，方便对比

#### 验收标准

1. 当用户上传数据时，系统应识别数据类型（留存、活跃、付费等）
2. 系统应检索过去12周的相似历史分析
3. 当生成报告时，系统应包含与历史数据的自动对比
4. 系统应突出显示与历史平均值显著偏离的指标（>20%变化）
5. 当显示图表时，系统应添加历史基准线参考
6. 系统应生成趋势分析语句（上升、下降、稳定）
7. 系统应支持可配置的对比周期（周环比、月环比）

### 需求3：图表模板学习（解决图表不稳定问题）

**用户故事：** 作为用户，我希望系统能够记住成功的图表配置，这样相同类型的数据总是生成一致且有效的图表。

**实际应用场景：**
- 用户生成"用户留存漏斗图"后，系统记住这个图表配置（颜色、布局、数据标签）
- 下次分析留存数据时，系统自动使用相同的图表模板，保证一致性
- 用户可以对图表进行微调（如修改颜色），系统将新配置保存为改进版本
- 系统学习哪些图表类型对特定数据最有效（如时间序列用折线图，占比用饼图）

#### 验收标准

1. 当成功生成图表时，系统应存储图表配置及数据特征
2. 系统应提取数据特征（列类型、行数、时间模式）
3. 当生成新图表时，系统应基于数据特征检索相似的图表配置
4. 系统应使用历史图表配置作为新可视化的模板
5. 当用户修改图表时，系统应将修改存储为改进版本
6. 系统应跟踪图表有效性指标（用户交互、反馈、复用次数）
7. 系统应基于相似数据的历史成功率推荐图表类型
8. 系统应按数据类型维护经过验证的图表模板库

### 需求4：智能分析建议（新功能）

**用户故事：** 作为用户，我希望系统能够基于历史经验主动提供分析建议，这样我可以发现之前没有注意到的洞察角度。

**实际应用场景：**
- 用户上传"付费用户数据"后，系统提示："根据历史分析，建议关注首次付费时间与LTV的关系"
- 系统推荐："类似数据通常需要分析付费等级分布和复购率"
- 系统提醒："上次分析发现VIP3用户流失率异常，建议本次重点关注"
- 系统建议额外的分析维度："建议按渠道拆分分析，历史数据显示不同渠道差异显著"

#### 验收标准

1. 当用户上传数据时，系统应分析数据特征
2. 系统应检索相似数据类型的成功分析模式
3. 系统应基于历史洞察生成3-5条分析建议
4. 当显示建议时，系统应解释理由（如"历史数据显示..."）
5. 系统应允许用户接受或拒绝建议
6. 当建议被接受时，系统应将其纳入分析提示词
7. 系统应学习用户认为哪些建议最有价值
8. 系统应优先推荐过去导致可操作洞察的建议

### 需求5：快速复用成功案例（提升效率）

**用户故事：** 作为用户，我希望能够快速找到并复用之前成功的分析案例，这样可以节省时间并保证分析质量。

**实际应用场景：**
- 用户在输入框输入"留存分析"，系统自动显示历史上最成功的3个留存分析案例
- 用户可以一键应用历史案例的分析prompt和图表配置
- 系统显示每个案例的成功指标（如"被复用15次"、"用户评分4.8/5"）
- 用户可以收藏常用的分析模板，形成个人分析工具箱

#### 验收标准

1. 系统应提供历史分析的搜索界面
2. 当搜索时，系统应支持自然语言查询（如"新手留存分析"）
3. 系统应按成功指标排序结果（复用次数、用户评分、反馈分数）
4. 系统应显示每个历史分析的预览（标题、日期、关键发现）
5. 当用户选择历史分析时，系统应允许一键复用
6. 系统应支持收藏喜爱的分析
7. 系统应提供"我的模板"部分用于常用模式
8. 系统应允许用户与团队成员分享成功的分析

### 需求6：游戏运营领域知识库（行业专业化）

**用户故事：** 作为游戏运营人员，我希望系统理解游戏行业的专业术语和最佳实践，这样分析更加专业和准确。

**实际应用场景：**
- 系统预置游戏运营领域知识：DAU、MAU、ARPU、LTV、留存率等指标定义
- 系统理解游戏特有概念：新手引导、付费转化、流失预警、回流召回等
- 系统知道游戏行业的分析框架：AARRR模型、用户生命周期分析、付费漏斗等
- 系统提供游戏行业的benchmark数据：如"行业平均次日留存率为40%"

#### 验收标准

1. 管理员应能够上传游戏行业知识文档
2. 系统应预加载常见游戏指标定义（DAU、MAU、ARPU、LTV等）
3. 系统应识别分析请求中的游戏特定术语
4. 当分析数据时，系统应应用游戏行业最佳实践
5. 系统应在可用时提供行业基准对比
6. 管理员应能够为特定游戏类型定制领域知识
7. 系统应支持领域术语的多语言（中文和英文）
8. 系统应维护用户可访问的游戏行业术语表

### 需求7：用户反馈学习系统（持续优化）

**用户故事：** 作为用户，我希望能够对分析结果进行评价，这样系统可以不断改进分析质量。

**实际应用场景：**
- 每个报告底部有"有用"/"无用"按钮和评分功能
- 用户标记"无用"时，系统询问具体问题（图表不准确、分析不深入、建议不实用等）
- 系统根据反馈调整：如果某个图表类型经常被标记为无用，降低其推荐权重
- 管理员可以查看反馈统计，了解哪些分析模式最受欢迎

#### 验收标准

1. 当生成报告时，系统应显示反馈按钮（点赞/点踩、5星评分）
2. 当收到负面反馈时，系统应提示具体问题
3. 系统应将反馈与相应的知识库条目一起存储
4. 系统应使用反馈分数调整检索相关性权重
5. 当分析模式持续收到负面反馈时，系统应降低其优先级
6. 管理员应能够查看反馈统计和趋势
7. 系统应在搜索结果中突出显示高评分的分析
8. 系统应定期发送基于反馈的系统改进报告

### 需求8：批量分析智能化（增强批量分析功能）

**用户故事：** 作为用户，我希望批量分析时系统能够自动识别Sheet类型并应用最佳分析模式，这样可以提高批量分析的质量和一致性。

**实际应用场景：**
- 用户上传包含6个Sheet的Excel（留存、LTV、流失、回流、新手漏斗、付费）
- 系统自动识别每个Sheet的数据类型（通过列名、数据特征）
- 系统为每个Sheet应用历史上最成功的分析模板
- 系统在生成报告时自动添加Sheet之间的关联分析（如"留存率下降与新手漏斗第3步流失增加相关"）

#### 验收标准

1. 当处理批量分析时，系统应识别每个Sheet的数据类型
2. 系统应为每个识别的数据类型检索最优分析模板
3. 系统应在相似Sheet之间应用一致的分析模式
4. 当检测到关系时，系统应生成跨Sheet洞察
5. 系统应使用历史批量分析结果改进Sheet分类
6. 系统应提供突出所有Sheet关键发现的摘要报告
7. 系统应允许用户覆盖自动Sheet类型检测
8. 系统应从用户更正中学习以改进未来分类

### 需求9：AI对话增强（提升对话质量）

**用户故事：** 作为用户，我希望AI对话功能能够记住之前的讨论内容和分析结果，这样对话更加连贯和智能。

**实际应用场景：**
- 用户在对话中问"为什么本周留存率下降？"，系统检索历史分析发现"上周也出现过类似情况，原因是新手引导改版"
- 用户问"如何提升付费转化？"，系统基于历史成功案例提供具体建议
- 系统记住用户的分析偏好（如喜欢看漏斗图、关注特定指标）
- 对话中系统可以引用之前的图表和数据，无需用户重复描述

#### 验收标准

1. 当用户在对话中提问时，系统应检索相关的历史上下文
2. 系统应在当前会话中维护对话历史
3. 系统应在回答问题时引用之前的分析
4. 当提供建议时，系统应引用成功的历史案例
5. 系统应记住用户偏好（喜爱的指标、图表类型）
6. 系统应支持引用之前对话轮次的后续问题
7. 系统应为历史洞察提供来源引用
8. 系统应允许用户探索被引用的历史分析

### 需求10：知识库管理界面（管理员功能）

**用户故事：** 作为管理员，我希望能够管理知识库内容，这样可以确保知识库的质量和相关性。

**实际应用场景：**
- 管理员可以查看所有存储的分析案例和洞察
- 管理员可以删除过时或错误的条目
- 管理员可以手动添加行业最佳实践文档
- 管理员可以查看知识库使用统计（哪些内容被检索最多、哪些最有用）
- 管理员可以导出知识库用于备份或迁移

#### 验收标准

1. 管理员应能够查看知识库中的所有条目
2. 管理员应能够搜索和过滤知识库条目
3. 管理员应能够删除或归档过时的条目
4. 管理员应能够手动添加文档（PDF、DOCX、TXT、MD）
5. 管理员应能够查看使用统计（检索次数、反馈分数）
6. 管理员应能够导出知识库用于备份
7. 管理员应能够从备份导入知识库
8. 系统应提供数据保留策略配置

### 需求11：RAG系统配置（灵活配置）

**用户故事：** 作为管理员，我希望能够配置RAG系统参数，这样可以针对具体使用场景优化性能。

**实际应用场景：**
- 管理员配置使用阿里云DashScope的text-embedding-v3模型
- 管理员设置检索数量（默认检索最相关的5个历史案例）
- 管理员调整相似度阈值（只有相似度>0.7的才被使用）
- 管理员配置token限制，避免prompt过长
- 管理员可以为不同工作流启用/禁用RAG功能

#### 验收标准

1. 管理员应能够配置嵌入模型（DashScope text-embedding-v3）
2. 管理员应能够设置检索上下文数量（K参数，默认5）
3. 管理员应能够调整相似度阈值（默认0.7）
4. 管理员应能够配置最大上下文tokens（默认4000）
5. 管理员应能够为特定工作流启用/禁用RAG
6. 管理员应能够配置文档分割的块大小（默认500 tokens）
7. 系统应在应用前验证配置更改
8. 系统应为常见场景提供配置预设

### 需求12：性能监控和优化（系统稳定性）

**用户故事：** 作为管理员，我希望能够监控RAG系统的性能，这样可以及时发现和解决问题。

**实际应用场景：**
- 管理员查看RAG检索的平均响应时间（目标<500ms）
- 系统记录embedding生成的耗时和成本
- 管理员查看检索准确率（用户反馈的有用率）
- 系统在性能下降时自动告警
- 管理员可以查看token使用量和API调用成本

#### 验收标准

1. 系统应跟踪每次查询的检索延迟
2. 系统应测量嵌入生成时间和成本
3. 系统应基于用户反馈记录检索准确率指标
4. 管理员应能够查看性能仪表板
5. 当检索延迟超过1秒时，系统应警告管理员
6. 系统应跟踪token使用量和API成本
7. 系统应提供每日/每周性能报告
8. 系统应支持不同时间段的性能对比

### 需求13：数据隐私和安全（合规要求）

**用户故事：** 作为管理员，我希望能够控制哪些数据被存储到知识库，这样可以保护敏感信息。

**实际应用场景：**
- 管理员配置数据保留策略（如只保留最近6个月的分析）
- 系统在存储前自动脱敏敏感数据（如用户ID、手机号）
- 管理员可以标记某些会话为"不存储"
- 系统提供完整的访问审计日志
- 管理员可以一键删除特定用户或项目的所有数据

#### 验收标准

1. 管理员应能够配置数据保留策略（默认6个月）
2. 系统应在存储前自动匿名化敏感数据
3. 管理员应能够将会话标记为"不存储"
4. 系统应提供所有知识库访问的审计日志
5. 系统应遵守配置的数据治理规则
6. 管理员应能够清除特定用户或项目的所有数据
7. 系统应加密存储的内容和嵌入向量
8. 系统应支持符合GDPR的数据删除请求

### 需求14：团队协作和知识共享（新功能）

**用户故事：** 作为团队成员，我希望能够与同事分享优秀的分析案例，这样整个团队都能受益。

**实际应用场景：**
- 用户完成一个优秀的分析后，可以标记为"团队共享"
- 其他团队成员在分析相似数据时，系统会推荐这个共享案例
- 团队成员可以对共享案例进行评论和讨论
- 系统统计哪些分析师的案例被复用最多，形成内部最佳实践
- 新员工可以快速学习团队的分析方法和标准

#### 验收标准

1. 系统应允许用户将分析标记为"可共享"或"私有"
2. 当分析被标记为可共享时，系统应使其对团队成员可用
3. 系统应支持对共享分析的评论
4. 系统应在相关共享分析可用时通知用户
5. 系统应跟踪哪些团队成员查看了共享分析
6. 系统应提供"团队最佳实践"部分
7. 系统应按贡献排名分析师（共享分析、复用次数）
8. 系统应支持与个人知识库分离的团队级知识库

## 实施优先级

### 第一阶段：核心RAG基础设施（MVP）
1. **需求1**：自动记忆历史分析 - 建立基础的知识库存储和检索能力
2. **需求3**：图表模板学习 - 解决图表不稳定问题
3. **需求11**：RAG系统配置 - 提供基础的配置能力

### 第二阶段：智能增强
4. **需求2**：智能历史对比 - 增强分析深度
5. **需求4**：智能分析建议 - 提供主动建议
6. **需求5**：快速复用成功案例 - 提升用户效率

### 第三阶段：领域专业化
7. **需求6**：游戏运营领域知识库 - 行业专业化
8. **需求8**：批量分析智能化 - 增强批量分析功能
9. **需求9**：AI对话增强 - 提升对话质量

### 第四阶段：管理和协作
10. **需求7**：用户反馈学习系统 - 持续优化
11. **需求10**：知识库管理界面 - 管理员功能
12. **需求12**：性能监控和优化 - 系统稳定性
13. **需求13**：数据隐私和安全 - 合规要求
14. **需求14**：团队协作和知识共享 - 团队功能

## 预期收益

### 对用户的价值
1. **节省时间** - 无需重复输入相似的分析需求，一键复用成功案例
2. **提高质量** - 基于历史经验的分析更加准确和深入
3. **降低门槛** - 系统主动提供建议，新手也能做出专业分析
4. **保持一致** - 图表和分析方法保持一致，便于对比

### 对系统的价值
1. **持续改进** - 系统从每次使用中学习，越用越智能
2. **知识沉淀** - 优秀的分析经验被保留和传承
3. **差异化竞争** - RAG能力是核心竞争力，难以被复制
4. **用户粘性** - 用户使用越多，系统对其越了解，切换成本越高

### 技术指标
1. **检索速度** - 平均检索延迟 < 500ms
2. **检索准确率** - 用户反馈有用率 > 70%
3. **系统可用性** - 99.5% uptime
4. **成本控制** - embedding和检索成本 < ¥0.01/次分析

## 技术约束

1. **嵌入模型**：必须使用阿里云DashScope text-embedding-v3（已有API key）
2. **向量数据库**：推荐使用PostgreSQL + pgvector扩展（与现有数据库集成）
3. **存储**：知识库预计每月增长约10GB（包含embeddings和原始内容）
4. **性能**：检索延迟必须 < 1秒，避免影响用户体验
5. **成本**：embedding API调用成本需要控制，考虑缓存策略
6. **兼容性**：必须与现有的FastAPI后端和Vue3前端兼容

## 成功指标

### 用户采用率
- 30天内，50%的活跃用户使用RAG功能（复用历史案例或接受智能建议）
- 用户平均每周复用历史案例 ≥ 2次

### 质量提升
- 用户对分析结果的满意度评分从当前3.5/5提升到4.2/5
- 图表生成一致性提升50%（相同数据类型生成相同图表的比例）

### 效率提升
- 用户完成一次分析的平均时间从15分钟降低到8分钟
- 重复性分析任务减少60%（通过复用历史案例）

### 系统性能
- RAG检索平均延迟 < 500ms
- 检索准确率（用户反馈有用率）> 70%
- 系统可用性 > 99.5%

