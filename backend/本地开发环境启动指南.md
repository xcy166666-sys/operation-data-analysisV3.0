# 本地开发环境启动指南

## 概述
在开发环境中，我们不使用 Docker，直接在本地运行后端服务，避免 Docker 网络问题。

## 前置条件

### 1. Python 环境
- Python 3.11 或更高版本
- pip 包管理器

### 2. PostgreSQL 数据库
- 可以使用 Docker 运行（只运行数据库）
- 或者本地安装 PostgreSQL

### 3. Redis 缓存
- 可以使用 Docker 运行（只运行 Redis）
- 或者本地安装 Redis

## 快速启动步骤

### 步骤 1: 启动数据库和 Redis（使用 Docker）

```powershell
# 只启动数据库和 Redis，不启动后端
docker-compose up -d postgres redis
```

### 步骤 2: 安装 Python 依赖

```powershell
cd backend
pip install -r requirements.txt
```

### 步骤 3: 配置环境变量

创建或修改 `backend/.env.local` 文件：

```env
# ==================== 应用配置 ====================
APP_NAME=运营数据分析系统
APP_VERSION=3.0.0
DEBUG=true

# ==================== 数据库配置（本地连接）====================
DATABASE_URL=postgresql://postgres:CEi7EwD8VslMGy1#fBT475b912c-66c9-4fce-abb5-9a98070b408aMJ@localhost:22810/operation_analysis_v2

# ==================== Redis配置（本地连接）====================
REDIS_URL=redis://localhost:22811/0

# ==================== JWT配置 ====================
JWT_SECRET=!%Ej*!jKddACbR%UVpaTEYB4hXlGMu#k%Pm#thR$IyDAAaArZbGY7Qk6WXa$Q7l2
JWT_ALGORITHM=HS256
JWT_EXPIRE_HOURS=24

# ==================== Session配置 ====================
SESSION_SECRET=your-super-secret-session-key-change-this
SESSION_EXPIRE_HOURS=24

# ==================== 阿里百炼DashScope配置 ====================
DASHSCOPE_API_KEY=sk-f72852ce679f42019f669589a51e2639
DASHSCOPE_MODEL=qwen3-32b

# ==================== CORS配置 ====================
CORS_ORIGINS=http://localhost:5173,http://localhost:80,http://localhost:3000

# ==================== 文件上传配置 ====================
UPLOAD_DIR=uploads/operation/project_1
MAX_UPLOAD_SIZE=20971520

# ==================== 日志配置 ====================
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
```

### 步骤 4: 运行数据库迁移（首次运行）

```powershell
cd backend
# 如果需要初始化数据库
python -c "from app.db.init_db import init_db; import asyncio; asyncio.run(init_db())"
```

### 步骤 5: 启动后端服务

```powershell
cd backend
# 使用本地环境变量文件
$env:ENV_FILE=".env.local"
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

或者创建启动脚本 `backend/start_local.bat`：

```batch
@echo off
echo 启动本地开发环境后端服务...
set ENV_FILE=.env.local
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 步骤 6: 启动前端服务

```powershell
cd frontend
npm run dev
```

## 访问地址

- 前端: http://localhost:5173
- 后端 API: http://localhost:8000
- API 文档: http://localhost:8000/docs
- PostgreSQL: localhost:22810
- Redis: localhost:22811

## 优势

1. **无 Docker 网络问题**: 直接使用本地网络，避免 DNS 解析和代理问题
2. **更快的开发体验**: 代码修改后立即生效，无需重建容器
3. **更容易调试**: 可以直接使用 IDE 的调试功能
4. **更低的资源占用**: 不需要运行完整的容器

## 生产部署

生产环境仍然使用 Docker：

```powershell
docker-compose up -d
```

## 常见问题

### Q: 如何切换回 Docker 模式？
A: 停止本地后端服务，然后运行 `docker-compose up -d backend`

### Q: 数据库连接失败？
A: 确保 PostgreSQL 容器正在运行：`docker ps | findstr postgres`

### Q: Redis 连接失败？
A: 确保 Redis 容器正在运行：`docker ps | findstr redis`

### Q: 端口冲突？
A: 修改 uvicorn 启动命令中的端口号，同时更新前端的 API 地址配置
