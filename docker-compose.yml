version: '3.8'

# ==================== 重要说明 ====================
# 此Docker配置用于生产部署，不是日常开发使用
# 
# 日常开发请使用：
#   后端：backend/start_local.bat
#   前端：frontend/npm run dev
#
# 仅在以下情况使用Docker：
#   1. 部署到生产服务器
#   2. 团队协作需要统一环境
#   3. 演示给客户
#
# 启动Docker：docker-compose up -d
# 停止Docker：docker-compose down
# ================================================

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: operation-analysis-v2-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-operation_analysis_v2}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    volumes:
      - postgres_data_v2:/var/lib/postgresql/data
    ports:
      - "22810:5432"  # V2.0端口：22810（V1.0使用22800）
    networks:
      - app-network-v2
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: operation-analysis-v2-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data_v2:/data
    ports:
      - "22811:6379"  # V2.0端口：22811（V1.0使用22801）
    networks:
      - app-network-v2
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI后端
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: operation-analysis-v2-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-operation_analysis_v2}
      - REDIS_URL=redis://redis:6379/0
      # - HTTP_PROXY=http://host.docker.internal:7890
      # - HTTPS_PROXY=http://host.docker.internal:7890
      - NO_PROXY=localhost,127.0.0.1,postgres,redis
    dns:
      - 8.8.8.8
      - 223.5.5.5
      - 114.114.114.114
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./backend:/app
      - backend_uploads_v2:/app/uploads
      - backend_logs_v2:/var/log/operation-analysis
    ports:
      - "21810:8000"  # V2.0后端端口：21810（V1.0使用21800）
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network-v2
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload  # 容器内部仍使用8000

  # Vue前端（已改为本地运行，不再使用Docker）
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: operation-analysis-v2-frontend
  #   restart: unless-stopped
  #   ports:
  #     - "20810:80"  # V2.0前端端口：20810（V1.0使用20800）
  #   depends_on:
  #     - backend
  #   networks:
  #     - app-network-v2

  # Nginx反向代理（可选，用于生产环境）
  # 注意：如果前端本地运行，nginx可能不需要，或者需要修改配置
  # nginx:
  #   build:
  #     context: ./nginx
  #     dockerfile: Dockerfile
  #   container_name: operation-analysis-v2-nginx
  #   restart: unless-stopped
  #   ports:
  #     - "8080:80"  # V2.0 Nginx端口：8080（V1.0使用80）
  #     - "8443:443"  # V2.0 Nginx HTTPS端口：8443（V1.0使用443）
  #   volumes:
  #     - ./nginx/conf.d:/etc/nginx/conf.d:ro
  #     - nginx_logs_v2:/var/log/nginx
  #   depends_on:
  #     - backend
  #     - frontend
  #   networks:
  #     - app-network-v2

volumes:
  postgres_data_v2:
    driver: local
  redis_data_v2:
    driver: local
  backend_uploads_v2:
    driver: local
  backend_logs_v2:
    driver: local
  nginx_logs_v2:
    driver: local

networks:
  app-network-v2:
    driver: bridge

